"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("@genx/july");

const defaultUserAuth = require("./defaultUserAuth");

let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry;
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = this.serverEntry ? require(this.serverEntry) : require.main.require("../../src/index.js");
    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      throw err;
    }
  }

  async startRestClient_(serviceName, authenticator, testToRun, options) {
    return this.startWorker_(async app => {
      if (typeof options === "undefined") {
        if (typeof testToRun === "undefined") {
          testToRun = authenticator;
          authenticator = null;
        } else if (typeof testToRun === "object") {
          options = testToRun;
          testToRun = authenticator;
          authenticator = null;
        }
      }

      if (typeof authenticator === "string") {
        authenticator = defaultUserAuth(app, authenticator);
      }

      const client = await this._getRestClient_(app, serviceName, authenticator);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      const step_ = allure ? allure.createStep(`start ${story}`, () => body(data)) : () => body(data);

      if (cleanUp) {
        try {
          await step_();
        } finally {
          await cleanUp();
        }
      } else {
        await step_();
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    const stepFn_ = allure ? allure.createStep(step, () => body()) : body;

    if (this.verbose) {
      console.log("Step: ", step);
    }

    await stepFn_();
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, authenticator) {
    const client = app.getService(this.webServer ? `superTest-${name}` : `restClient-${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!authenticator) {
      delete client.onSend;
      return client;
    }

    await authenticator(client);
    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJkZWZhdWx0VXNlckF1dGgiLCJhbGx1cmUiLCJTdWl0ZSIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJzZXJ2ZXJFbnRyeSIsInZlcmJvc2UiLCJzdGFydFdlYlNlcnZlcl8iLCJ3ZWJTZXJ2ZXIiLCJFcnJvciIsImNyZWF0ZVdlYlNlcnZlciIsIm1haW4iLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0V29ya2VyXyIsInRlc3RUb1J1biIsIlN0YXJ0ZXJzIiwic3RhcnRXb3JrZXIiLCJlcnIiLCJhcHAiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsInN0YXJ0UmVzdENsaWVudF8iLCJzZXJ2aWNlTmFtZSIsImF1dGhlbnRpY2F0b3IiLCJjbGllbnQiLCJfZ2V0UmVzdENsaWVudF8iLCJpbml0QWxsdXJlIiwiYWxsdXJlTW9jaGEiLCJ0ZXN0Q2FzZSIsInN0b3J5IiwiYm9keSIsImRhdGEiLCJjbGVhblVwIiwic2tpcCIsIm9ubHkiLCJzZWxmIiwib3B0IiwiaXQiLCJjb25zb2xlIiwibG9nIiwiZGVzY3JpcHRpb24iLCJlcGljIiwiZmVhdHVyZSIsIm93bmVyIiwidGFnIiwiaXNzdWVzIiwic2V2ZXJpdHkiLCJpc0VtcHR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwicGFyYW1zIiwidiIsImsiLCJwYXJhbWV0ZXIiLCJhdHRhY2hPYmplY3QiLCJzdGVwXyIsImNyZWF0ZVN0ZXAiLCJ0ZXN0Q2FzZUZyb21GaXh0dXJlcyIsInAiLCJyZXNvbHZlIiwic3VpdGVEYXRhIiwiY2FzZXMiLCJvdGhlcnMiLCJzdG9yeURhdGEiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY2FzZURhdGEiLCJpIiwicHJlcGFyZWREYXRhIiwibWFwVmFsdWVzIiwiZXhwZWN0ZWQiLCJiZW5jaG1hcmtfIiwibWFwT2ZNZXRob2RzIiwicGF5bG9hZCIsIkJlbmNobWFyayIsInN1aXRlIiwiZWFjaCIsImYiLCJhZGQiLCJQcm9taXNlIiwicmVqZWN0Iiwib24iLCJldmVudCIsImN5Y2xlTWVzc2FnZSIsIlN0cmluZyIsInRhcmdldCIsImNvbXBsZXRlTWVzc2FnZSIsImZpbHRlciIsIm1hcCIsInJ1biIsImFzeW5jIiwidGVzdFN0ZXBfIiwic3RlcCIsInN0ZXBGbl8iLCJvYmoiLCJ0eXBlIiwiY29udGVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJjcmVhdGVBdHRhY2htZW50IiwiZ2V0U2VydmljZSIsInNlcnZlciIsImh0dHBTZXJ2ZXIiLCJvblNlbnQiLCJ1cmwiLCJyZXN1bHQiLCJvblNlbmQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUQsT0FBTyxDQUFDLFlBQUQsQ0FBckI7O0FBRUEsTUFBTUUsZUFBZSxHQUFHRixPQUFPLENBQUMsbUJBQUQsQ0FBL0I7O0FBRUEsSUFBSUcsTUFBSjs7QUF5QkEsTUFBTUMsS0FBTixDQUFZO0FBUVJDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFNBQUtELElBQUwsR0FBWUEsSUFBWjtBQUNBLFVBQU07QUFBRUUsTUFBQUEsV0FBRjtBQUFlQyxNQUFBQTtBQUFmLFFBQTJCRixPQUFPLElBQUksSUFBWCxHQUFrQixFQUFsQixHQUF1QkEsT0FBeEQ7QUFFQSxTQUFLQyxXQUFMLEdBQW1CQSxXQUFuQjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNIOztBQU9vQixRQUFmQyxlQUFlLEdBQUc7QUFDcEIsUUFB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LE1BQVA7QUFDSDs7QUFqVU87O0FBb1VacUYsTUFBTSxDQUFDQyxPQUFQLEdBQWlCekgsS0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuXG5jb25zdCBkZWZhdWx0VXNlckF1dGggPSByZXF1aXJlKFwiLi9kZWZhdWx0VXNlckF1dGhcIik7XG5cbmxldCBhbGx1cmU7XG5cbi8qKlxuICogVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICogQGNhbGxiYWNrIHRlc3RXaXRoUmVzdENsaWVudFxuICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBhcHBcbiAqIEBwYXJhbSB7UmVzdENsaWVudH0gY2xpZW50IC0gVGhlIHJlc3QgY2xpZW50XG4gKi9cblxuLyoqXG4gKiBUZXN0IGZ1bmN0aW9uIHdpdGggYSB3b3JrZXIgYXBwLlxuICogQGNhbGxiYWNrIHRlc3RXaXRoQXBwXG4gKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcFxuICovXG5cbi8qKlxuICogVGVzdCBjYXNlIGJvZHkuXG4gKiBAY2FsbGJhY2sgdGVzdENhc2VCb2R5XG4gKiBAcGFyYW0geyp9IGRhdGEgLSBUZXN0IGRhdGFcbiAqL1xuXG4vKipcbiAqIFRlc3Qgc3VpdGUgb2JqZWN0LlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIFN1aXRlIHtcbiAgICAvKipcbiAgICAgKiBbcHJpdmF0ZV0gU3VpdGUgd2lsbCBiZSBjcmVhdGVkIGJ5IHRlc3RTdWl0ZSBjcmVhdG9yLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gU3VpdGUgbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBTdWl0ZSBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnNlcnZlckVudHJ5PVwiLi4vLi4vc3JjL2luZGV4LmpzXCJdIC0gVGhlIGVudHJ5IGZpbGUgb2YgQGdlbngvc2VydmVyIGluc3RhbmNlLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudmVyYm9zZT1mYWxzZV0gLSBWZXJib3NlIG1vZGUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICBjb25zdCB7IHNlcnZlckVudHJ5LCB2ZXJib3NlIH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG5cbiAgICAgICAgdGhpcy5zZXJ2ZXJFbnRyeSA9IHNlcnZlckVudHJ5O1xuICAgICAgICB0aGlzLnZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBAZ2VueC9zZXJ2ZXIgaW5zdGFjZSBmb3IgY29kZSBjb3ZlcmFnZSB0ZXN0aW5nLlxuICAgICAqIEBhc3luY1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRXZWJTZXJ2ZXJfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIldlYiBzZXJ2ZXIgYWxyZWFkeSBzdGFydGVkLlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVdlYlNlcnZlciA9IHRoaXMuc2VydmVyRW50cnlcbiAgICAgICAgICAgID8gcmVxdWlyZSh0aGlzLnNlcnZlckVudHJ5KVxuICAgICAgICAgICAgOiByZXF1aXJlLm1haW4ucmVxdWlyZShcIi4uLy4uL3NyYy9pbmRleC5qc1wiKTtcbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIgPSBjcmVhdGVXZWJTZXJ2ZXIoe1xuICAgICAgICAgICAgZXhpdE9uVW5jYXVnaHQ6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCA9PSBudWxsIHx8IHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLm5vdC5iZS5vaygpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0YXJ0XygpO1xuXG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLmJlLm9rKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMud2ViU2VydmVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIHNlcnZlciBpZiBpdCBpcyBzdGFydGVkLlxuICAgICAqIEBhc3luY1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgYXN5bmMgc3RvcFdlYlNlcnZlcklmU3RhcnRlZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLndlYlNlcnZlci5zdG9wXygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy53ZWJTZXJ2ZXI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBhIHdvcmtlciBhcHAgZm9yIHRlc3RpbmdcbiAgICAgKiBAcGFyYW0ge3Rlc3RXaXRoUmVzdENsaWVudH0gdGVzdFRvUnVuIC0gVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyAtIE9wdGlvbnMgcGFzc2VkIHRoZSB0ZXN0IHdvcmtlciwgc2VlIHN0YXJ0V29ya2VyIG9mIEBnZW54L2FwcC5cbiAgICAgKiBAYXN5bmNcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdvcmtlcl8odGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIFN0YXJ0ZXJzOiB7IHN0YXJ0V29ya2VyIH0sXG4gICAgICAgIH0gPSByZXF1aXJlKFwiQGdlbngvYXBwXCIpO1xuXG4gICAgICAgIGxldCBlcnI7XG5cbiAgICAgICAgYXdhaXQgc3RhcnRXb3JrZXIoXG4gICAgICAgICAgICBhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGVzdFRvUnVuKGFwcCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgd29ya2VyTmFtZTogXCJ0ZXN0ZXJcIixcbiAgICAgICAgICAgICAgICBjb25maWdOYW1lOiBcInRlc3RcIixcbiAgICAgICAgICAgICAgICBjb25maWdQYXRoOiBcIi4vdGVzdC9jb25mXCIsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlc1BhdGg6IFwiYXBwX21vZHVsZXNcIixcbiAgICAgICAgICAgICAgICBpZ25vcmVVbmNhdWdodDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgcmVzdCBjbGllbnQgZm9yIHRlc3RpbmdcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZU5hbWUgLSBUaGUgY29uZmlnIGtleSBvZiB0YXJnZXQgZW5kcG9pbnRcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufHN0cmluZ30gW2F1dGhlbnRpY2F0b3JdIC0gQXV0aGVudGljYXRvciB0byBiZSB1c2VkLCBhc3luYyAoY2xpZW50KSA9PiB7fSwgb3IgcGFzcyBhIHVzZXJUYWcgdG8gdXNlIGRlZmF1bHQgYXV0aGVudGljYXRvci5cbiAgICAgKiBAcGFyYW0ge3Rlc3RXaXRoUmVzdENsaWVudH0gdGVzdFRvUnVuIC0gVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICAgICAqIEBwYXJhbSB7Kn0gW29wdGlvbnNdIC0gT3B0aW9ucyBwYXNzZWQgdGhlIHRlc3Qgd29ya2VyLCBzZWUgc3RhcnRXb3JrZXIgb2YgQGdlbngvYXBwLlxuICAgICAqIEBhc3luY1xuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0UmVzdENsaWVudF8oc2VydmljZU5hbWUsIGF1dGhlbnRpY2F0b3IsIHRlc3RUb1J1biwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGFydFdvcmtlcl8oYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZXN0VG9SdW4gPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVzdFRvUnVuID0gYXV0aGVudGljYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgYXV0aGVudGljYXRvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGVzdFRvUnVuID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZXN0VG9SdW47XG4gICAgICAgICAgICAgICAgICAgIHRlc3RUb1J1biA9IGF1dGhlbnRpY2F0b3I7XG4gICAgICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0b3IgPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhdXRoZW50aWNhdG9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgYXV0aGVudGljYXRvciA9IGRlZmF1bHRVc2VyQXV0aChhcHAsIGF1dGhlbnRpY2F0b3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLl9nZXRSZXN0Q2xpZW50XyhhcHAsIHNlcnZpY2VOYW1lLCBhdXRoZW50aWNhdG9yKTtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0VG9SdW4oYXBwLCBjbGllbnQpO1xuICAgICAgICB9LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGluaXRBbGx1cmUoKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSB7XG4gICAgICAgICAgICBjb25zdCBhbGx1cmVNb2NoYSA9IHJlcXVpcmUoXCJhbGx1cmUtbW9jaGEvcnVudGltZVwiKTtcbiAgICAgICAgICAgIGFsbHVyZSA9IGFsbHVyZU1vY2hhLmFsbHVyZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmluZSBhIHRlc3QgY2FzZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RvcnkgLSBUZXN0IGNhc2UgdGl0bGUuXG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHkgLSBUZXN0IGNhc2UgYm9keSB0byB3cml0ZSBhY3R1YWwgdGVzdCBjb2RlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc11cbiAgICAgKiBAcHJvcGVydHkgeyp9IG9wdGlvbnMuZGF0YSAtIFRlc3QgZGF0YVxuICAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9wdGlvbnMuY2xlYW5VcCAtIENsZWFudXAgYWZ0ZXIgdGhlIGNhc2UgZW5kcyByZWdhcmRsZXNzIHdoZXRoZXIgaXQgaXMgc3VjY2Vzc2Z1bCBvciBub3QuXG4gICAgICovXG4gICAgdGVzdENhc2Uoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBjbGVhblVwLCBza2lwLCBvbmx5IH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIGxldCBvcHQ7XG5cbiAgICAgICAgaWYgKG9ubHkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2UgaWYgKHNraXApIHtcbiAgICAgICAgICAgIG9wdCA9IFwic2tpcFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgKG9wdCA/IGl0W29wdF0gOiBpdCkoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChzZWxmLnZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN0b3J5OlwiLCBzdG9yeSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcblxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiAmJiBhbGx1cmUuZGVzY3JpcHRpb24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlICYmIGFsbHVyZS5mZWF0dXJlKGZlYXR1cmUpO1xuICAgICAgICAgICAgICAgICAgICBvd25lciAmJiBhbGx1cmUub3duZXIob3duZXIpO1xuICAgICAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgICAgICBzZXZlcml0eSAmJiBhbGx1cmUuc2V2ZXJpdHkoc2V2ZXJpdHkpO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uaXNFbXB0eShpc3N1ZXMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvck93bihpc3N1ZXMsIChsaW5rLCBudW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUuaXNzdWUobnVtLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnBhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgXCIqc2VlIGF0dGFjaG1lbnQqXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXR0YWNoT2JqZWN0KGBwYXJhbVske2t9XWAsIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHN0ZXBfID0gYWxsdXJlID8gYWxsdXJlLmNyZWF0ZVN0ZXAoYHN0YXJ0ICR7c3Rvcnl9YCwgKCkgPT4gYm9keShkYXRhKSkgOiAoKSA9PiBib2R5KGRhdGEpO1xuXG4gICAgICAgICAgICBpZiAoY2xlYW5VcCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHN0ZXBfKCk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xlYW5VcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgc3RlcF8oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVzdCBjYXNlIHdpdGggZml4dHVyZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0b3J5XG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHlcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXG4gICAgICovXG4gICAgdGVzdENhc2VGcm9tRml4dHVyZXMoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3RoaXMubmFtZX0uanNgKTtcbiAgICAgICAgY29uc3Qgc3VpdGVEYXRhID0gcmVxdWlyZShwKTtcbiAgICAgICAgaWYgKCFzdWl0ZURhdGEpIHRocm93IG5ldyBFcnJvcihgU3VpdGUgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX1gKTtcblxuICAgICAgICBjb25zdCB7IGNhc2VzLCAuLi5vdGhlcnMgfSA9IHN1aXRlRGF0YTtcblxuICAgICAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07XG4gICAgICAgIGlmICghc3RvcnlEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN0b3J5IGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9LCBzdG9yeTogJHtzdG9yeX1gKTtcblxuICAgICAgICBfLmNhc3RBcnJheShzdG9yeURhdGEpLmZvckVhY2goKGNhc2VEYXRhLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmVwYXJlZERhdGEgPSB7XG4gICAgICAgICAgICAgICAgYWxsdXJlOiBvdGhlcnMsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiBfLm1hcFZhbHVlcyhjYXNlRGF0YS5wYXJhbXMsICh2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gdigpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZDogY2FzZURhdGEuZXhwZWN0ZWQsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLnRlc3RDYXNlKGAke3N0b3J5fSMke2kgKyAxfWAsIGJvZHksIHsgLi4ub3B0aW9ucywgZGF0YTogcHJlcGFyZWREYXRhIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gYmVuY2htYXJrIGFnYWluc3QgZ2l2ZW4gbWV0aG9kcy5cbiAgICAgKiBAcGFyYW0geyp9IG1hcE9mTWV0aG9kcyAtIE1hcCBvZiBuYW1lIHRvIGZ1bmN0aW9uIHdpdGggcGF5bG9hZFxuICAgICAqIEBwYXJhbSB7Kn0gcGF5bG9hZFxuICAgICAqL1xuICAgIGFzeW5jIGJlbmNobWFya18obWFwT2ZNZXRob2RzLCBwYXlsb2FkKSB7XG4gICAgICAgIGNvbnN0IEJlbmNobWFyayA9IHJlcXVpcmUoXCJiZW5jaG1hcmtcIik7XG4gICAgICAgIGNvbnN0IHN1aXRlID0gbmV3IEJlbmNobWFyay5TdWl0ZSgpO1xuXG4gICAgICAgIF8uZWFjaChtYXBPZk1ldGhvZHMsIChmLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBzdWl0ZS5hZGQobmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGYocGF5bG9hZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgICAgICBzdWl0ZVxuICAgICAgICAgICAgICAgIC5vbihcImN5Y2xlXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjeWNsZU1lc3NhZ2UgPSBTdHJpbmcoZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QoXCJjeWNsZVwiLCBjeWNsZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiY29tcGxldGVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wbGV0ZU1lc3NhZ2UgPSBcIlRoZSBmYXN0ZXN0IGlzIFwiICsgdGhpcy5maWx0ZXIoXCJmYXN0ZXN0XCIpLm1hcChcIm5hbWVcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbXBsZXRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuYXR0YWNoT2JqZWN0KFwiY29tcGxldGVcIiwgY29tcGxldGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiZXJyb3JcIiwgKGV2ZW50KSA9PiByZWplY3QoU3RyaW5nKGV2ZW50LnRhcmdldCkpKVxuICAgICAgICAgICAgICAgIC5ydW4oeyBhc3luYzogdHJ1ZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lIGEgdGVzdCBzdGVwLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2JvZHldIC0gVGVzdCBzdGVwIGJvZHlcbiAgICAgKi9cbiAgICBhc3luYyB0ZXN0U3RlcF8oc3RlcCwgYm9keSkge1xuICAgICAgICBjb25zdCBzdGVwRm5fID0gYWxsdXJlID8gYWxsdXJlLmNyZWF0ZVN0ZXAoc3RlcCwgKCkgPT4gYm9keSgpKSA6IGJvZHk7XG5cbiAgICAgICAgaWYgKHRoaXMudmVyYm9zZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdGVwOiBcIiwgc3RlcCk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBzdGVwRm5fKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoIGFuIG9iamVjdCB0byB0aGUgdGVzdCByZXBvcnQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IG9ialxuICAgICAqL1xuICAgIGF0dGFjaE9iamVjdChuYW1lLCBvYmopIHtcbiAgICAgICAgaWYgKCFhbGx1cmUpIHJldHVybjtcblxuICAgICAgICBsZXQgdHlwZSA9IFwidGV4dC9wbGFpblwiLFxuICAgICAgICAgICAgY29udGVudCA9IG9iajtcblxuICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgICAgICB0eXBlID0gXCJhcHBsaWNhdGlvbi9qc29uXCI7XG4gICAgICAgIH1cblxuICAgICAgICBhbGx1cmUuY3JlYXRlQXR0YWNobWVudChuYW1lLCBjb250ZW50LCB0eXBlKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0UmVzdENsaWVudF8oYXBwLCBuYW1lLCBhdXRoZW50aWNhdG9yKSB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGFwcC5nZXRTZXJ2aWNlKHRoaXMud2ViU2VydmVyID8gYHN1cGVyVGVzdC0ke25hbWV9YCA6IGByZXN0Q2xpZW50LSR7bmFtZX1gKTtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBjbGllbnQuc2VydmVyID0gdGhpcy53ZWJTZXJ2ZXIuaHR0cFNlcnZlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2xpZW50Lm9uU2VudCkge1xuICAgICAgICAgICAgY2xpZW50Lm9uU2VudCA9ICh1cmwsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KHVybCwgcmVzdWx0KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWF1dGhlbnRpY2F0b3IpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBjbGllbnQub25TZW5kO1xuICAgICAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IGF1dGhlbnRpY2F0b3IoY2xpZW50KTtcblxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdWl0ZTtcbiJdfQ==