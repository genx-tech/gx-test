"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

const tokenCache = {};

class Suite {
  constructor(name, {
    serverEntry,
    verbose
  }) {
    this.name = name;
    this.serverEntry = serverEntry || '../../src/index.js';
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error('Web server already started.');
    }

    const createWebServer = require(this.serverEntry);

    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    let err;
    await startWorker(async app => {
      const client = await this._getRestClient_(app, name, userTag);

      try {
        await testToRun(app, client);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  testCase(story, body, data) {
    it(story, async function () {
      if (this.verbose) {
        console.log('Starting story:', story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === 'object') {
              allure.parameter(k, '*see attachment*');
              attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      await body(data);
    });
  }

  testCaseFromFixtures(story, body) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === 'function') return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, preparedData);
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log('Step: ', step);
    }

    await body();
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = 'plain/text',
        content = obj;

    if (typeof obj !== 'string') {
      content = JSON.stringify(obj, null, 4);
      type = 'application/json';
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest.${name}` : `restClient.${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });
      token = res.token;
      tokenCache[userTag] = token;
      app.log('info', `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set('Authorization', `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJTdGFydGVycyIsInN0YXJ0V29ya2VyIiwidG9rZW5DYWNoZSIsIlN1aXRlIiwiY29uc3RydWN0b3IiLCJuYW1lIiwic2VydmVyRW50cnkiLCJ2ZXJib3NlIiwic3RhcnRXZWJTZXJ2ZXJfIiwid2ViU2VydmVyIiwiRXJyb3IiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0UmVzdENsaWVudF8iLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsIl9nZXRSZXN0Q2xpZW50XyIsImUiLCJ3b3JrZXJOYW1lIiwiY29uZmlnTmFtZSIsImNvbmZpZ1BhdGgiLCJhcHBNb2R1bGVzUGF0aCIsImlnbm9yZVVuY2F1Z2h0IiwiZXhpc3QiLCJtZXNzYWdlIiwidGVzdENhc2UiLCJzdG9yeSIsImJvZHkiLCJkYXRhIiwiaXQiLCJjb25zb2xlIiwibG9nIiwiYWxsdXJlIiwiZGVzY3JpcHRpb24iLCJlcGljIiwiZmVhdHVyZSIsIm93bmVyIiwidGFnIiwiaXNzdWVzIiwic2V2ZXJpdHkiLCJpc0VtcHR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwiY3JlYXRlU3RlcCIsInBhcmFtcyIsInYiLCJrIiwicGFyYW1ldGVyIiwiYXR0YWNoT2JqZWN0IiwidGVzdENhc2VGcm9tRml4dHVyZXMiLCJwIiwicmVzb2x2ZSIsInN1aXRlRGF0YSIsImNhc2VzIiwib3RoZXJzIiwic3RvcnlEYXRhIiwiY2FzdEFycmF5IiwiZm9yRWFjaCIsImNhc2VEYXRhIiwiaSIsInByZXBhcmVkRGF0YSIsIm1hcFZhbHVlcyIsImV4cGVjdGVkIiwidGVzdFN0ZXBfIiwic3RlcCIsIm9iaiIsInR5cGUiLCJjb250ZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZUF0dGFjaG1lbnQiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwicmVxIiwic2V0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsUUFBUSxFQUFFO0FBQUVDLElBQUFBO0FBQUY7QUFBWixJQUFnQ0gsT0FBTyxDQUFDLFdBQUQsQ0FBN0M7O0FBRUEsTUFBTUksVUFBVSxHQUFHLEVBQW5COztBQUVBLE1BQU1DLEtBQU4sQ0FBWTtBQUNSQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBTztBQUFFQyxJQUFBQSxXQUFGO0FBQWVDLElBQUFBO0FBQWYsR0FBUCxFQUFpQztBQUN4QyxTQUFLRixJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLQyxXQUFMLEdBQW1CQSxXQUFXLElBQUksb0JBQWxDO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0g7O0FBTUQsUUFBTUMsZUFBTixHQUF3QjtBQUNwQixRQUFJLEtBQUtDLFNBQVQsRUFBb0I7QUFDaEIsWUFBTSxJQUFJQyxLQUFKLENBQVUsNkJBQVYsQ0FBTjtBQUNIOztBQUVELFVBQU1DLGVBQWUsR0FBR2IsT0FBTyxDQUFDLEtBQUtRLFdBQU4sQ0FBL0I7O0FBQ0EsU0FBS0csU0FBTCxHQUFpQkUsZUFBZSxDQUFDO0FBQzdCQyxNQUFBQSxjQUFjLEVBQUU7QUFEYSxLQUFELENBQWhDO0FBR0EsU0FB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QyxPQUFQLEdBQWlCckcsS0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBTdGFydGVyczogeyBzdGFydFdvcmtlciB9IH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcblxuY29uc3QgdG9rZW5DYWNoZSA9IHt9O1xuXG5jbGFzcyBTdWl0ZSB7XG4gICAgY29uc3RydWN0b3IobmFtZSwgeyBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSB9KSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIHRoaXMuc2VydmVyRW50cnkgPSBzZXJ2ZXJFbnRyeSB8fCAnLi4vLi4vc3JjL2luZGV4LmpzJztcbiAgICAgICAgdGhpcy52ZXJib3NlID0gdmVyYm9zZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0geyp9IHNlcnZlckVudHJ5IC0gU2VydmVyIGVudHJ5IGZpbGUgcGF0aCAocmVsYXRpdmUgdG8gdGVzdCB3b3JraW5nIHBhdGgpXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRXZWJTZXJ2ZXJfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV2ViIHNlcnZlciBhbHJlYWR5IHN0YXJ0ZWQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjcmVhdGVXZWJTZXJ2ZXIgPSByZXF1aXJlKHRoaXMuc2VydmVyRW50cnkpO1xuICAgICAgICB0aGlzLndlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgICAgICBleGl0T25VbmNhdWdodDogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQgPT0gbnVsbCB8fCB0aGlzLndlYlNlcnZlci5zdGFydGVkLnNob3VsZC5ub3QuYmUub2soKTtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0YXJ0XygpO1xuXG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLmJlLm9rKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMud2ViU2VydmVyO1xuICAgIH07XG5cbiAgICBhc3luYyBzdG9wV2ViU2VydmVySWZTdGFydGVkXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0b3BfKCk7ICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndlYlNlcnZlcjtcbiAgICAgICAgfSAgICAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIGEgdGVzdCBmdW5jdGlvbiBpbiBhIHdvcmtlclxuICAgICAqIEBwYXJhbSB7Kn0gdGVzdFRvUnVuIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFJlc3RDbGllbnRfKG5hbWUsIHVzZXJUYWcsIHRlc3RUb1J1biwgb3B0aW9ucykge1xuICAgICAgICBsZXQgZXJyO1xuXG4gICAgICAgIGF3YWl0IHN0YXJ0V29ya2VyKGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMuX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgdXNlclRhZyk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRlc3RUb1J1bihhcHAsIGNsaWVudCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9LCB7XG4gICAgICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLCAgICAgICAgXG4gICAgICAgICAgICBjb25maWdOYW1lOiBcInRlc3RcIixcbiAgICAgICAgICAgIGNvbmZpZ1BhdGg6IFwiLi90ZXN0L2NvbmZcIixcbiAgICAgICAgICAgIGFwcE1vZHVsZXNQYXRoOiBcImFwcF9tb2R1bGVzXCIsXG4gICAgICAgICAgICBpZ25vcmVVbmNhdWdodDogdHJ1ZSxcbiAgICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgc2hvdWxkLm5vdC5leGlzdChlcnIsIGVyci5tZXNzYWdlIHx8IGVycik7XG4gICAgICAgIH0gICAgXG4gICAgfVxuXG4gICAgdGVzdENhc2Uoc3RvcnksIGJvZHksIGRhdGEpIHtcbiAgICAgICAgaXQoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU3RhcnRpbmcgc3Rvcnk6Jywgc3RvcnkpO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGVzY3JpcHRpb24sIGVwaWMsIGZlYXR1cmUsIG93bmVyLCB0YWcsIGlzc3Vlcywgc2V2ZXJpdHkgfSA9IGRhdGEuYWxsdXJlO1xuICAgIFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiAmJiBhbGx1cmUuZGVzY3JpcHRpb24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlICYmIGFsbHVyZS5mZWF0dXJlKGZlYXR1cmUpO1xuICAgICAgICAgICAgICAgICAgICBvd25lciAmJiBhbGx1cmUub3duZXIob3duZXIpO1xuICAgICAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgICAgICBzZXZlcml0eSAmJiBhbGx1cmUuc2V2ZXJpdHkoc2V2ZXJpdHkpO1xuICAgIFxuICAgICAgICAgICAgICAgICAgICBfLmlzRW1wdHkoaXNzdWVzKSB8fCAoXy5mb3JPd24oaXNzdWVzLCAobGluaywgbnVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUuaXNzdWUobnVtLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgXG4gICAgICAgICAgICAgICAgYWxsdXJlLnN0b3J5KHN0b3J5KTtcbiAgICAgICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChgc3RhcnQgJHtzdG9yeX1gLCAoKSA9PiB7fSkoKTsgICAgICAgICAgICBcbiAgICBcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnBhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssICcqc2VlIGF0dGFjaG1lbnQqJyk7ICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dGFjaE9iamVjdChgcGFyYW1bJHtrfV1gLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgdGVzdENhc2VGcm9tRml4dHVyZXMoc3RvcnksIGJvZHkpIHtcbiAgICAgICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3RoaXMubmFtZX0uanNgKTtcbiAgICAgICAgY29uc3Qgc3VpdGVEYXRhID0gcmVxdWlyZShwKTtcbiAgICAgICAgaWYgKCFzdWl0ZURhdGEpIHRocm93IG5ldyBFcnJvcihgU3VpdGUgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX1gKTtcbiAgICBcbiAgICAgICAgY29uc3QgeyBjYXNlcywgLi4ub3RoZXJzIH0gPSBzdWl0ZURhdGE7ICAgIFxuICAgIFxuICAgICAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07ICAgXG4gICAgICAgIGlmICghc3RvcnlEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN0b3J5IGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9LCBzdG9yeTogJHtzdG9yeX1gKTtcbiAgICBcbiAgICAgICAgXy5jYXN0QXJyYXkoc3RvcnlEYXRhKS5mb3JFYWNoKChjYXNlRGF0YSwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJlcGFyZWREYXRhID0ge1xuICAgICAgICAgICAgICAgIGFsbHVyZTogb3RoZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtczogXy5tYXBWYWx1ZXMoY2FzZURhdGEucGFyYW1zLCAodikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdmdW5jdGlvbicpIHJldHVybiB2KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBjYXNlRGF0YS5leHBlY3RlZFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLnRlc3RDYXNlKGAke3N0b3J5fSMke2krMX1gLCBib2R5LCBwcmVwYXJlZERhdGEpOyBcbiAgICAgICAgfSk7ICAgIFxuICAgIH1cblxuICAgIGFzeW5jIHRlc3RTdGVwXyhzdGVwLCBib2R5KSB7ICAgIFxuICAgICAgICBpZiAoYWxsdXJlKSB7ICAgICAgICBcbiAgICAgICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IHt9KSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudmVyYm9zZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1N0ZXA6ICcsIHN0ZXApO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgYm9keSgpO1xuICAgIH0gICAgXG5cbiAgICBhdHRhY2hPYmplY3QobmFtZSwgb2JqKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSByZXR1cm47XG4gICAgXG4gICAgICAgIGxldCB0eXBlID0gJ3BsYWluL3RleHQnLCBjb250ZW50ID0gb2JqO1xuICAgIFxuICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDQpO1xuICAgICAgICAgICAgdHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBhbGx1cmUuY3JlYXRlQXR0YWNobWVudChuYW1lLCBjb250ZW50LCB0eXBlKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0UmVzdENsaWVudF8oYXBwLCBuYW1lLCB1c2VyVGFnKSB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGFwcC5nZXRTZXJ2aWNlKHRoaXMud2ViU2VydmVyID8gYHN1cGVyVGVzdC4ke25hbWV9YCA6IGByZXN0Q2xpZW50LiR7bmFtZX1gKTtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBjbGllbnQuc2VydmVyID0gdGhpcy53ZWJTZXJ2ZXIuaHR0cFNlcnZlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2xpZW50Lm9uU2VudCkge1xuICAgICAgICAgICAgY2xpZW50Lm9uU2VudCA9ICh1cmwsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KHVybCwgcmVzdWx0KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXVzZXJUYWcpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBjbGllbnQub25TZW5kOyBcbiAgICAgICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgICAgIH0gICAgXG5cbiAgICAgICAgbGV0IHRva2VuLCB1c2VyQXV0aDtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHVzZXJUYWcpKSB7XG4gICAgICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZy51c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gdXNlclRhZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gYXBwLnNldHRpbmdzLnVzZXJBdXRoW3VzZXJUYWddO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGNsaWVudC5wb3N0KHVzZXJBdXRoLmVuZHBvaW50LCB7IHVzZXJuYW1lOiB1c2VyQXV0aC51c2VybmFtZSwgcGFzc3dvcmQ6IHVzZXJBdXRoLnBhc3N3b3JkIH0pO1xuICAgICAgICAgICAgdG9rZW4gPSByZXMudG9rZW47XG4gICAgICAgICAgICB0b2tlbkNhY2hlW3VzZXJUYWddID0gdG9rZW47ICAgICAgICBcblxuICAgICAgICAgICAgYXBwLmxvZygnaW5mbycsIGBMb2dnZWQgaW4gd2l0aCBbJHt1c2VyVGFnfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQub25TZW5kID0gKHJlcSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHJlcS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdWl0ZTsiXX0=