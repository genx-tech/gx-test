"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("@genx/july");

const defaultUserAuth = require("./defaultUserAuth");

let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry;
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = this.serverEntry ? require(this.serverEntry) : require.main.require("../../src/index.js");
    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      throw err;
    }
  }

  async startRestClient_(serviceName, authenticator, testToRun, options) {
    return this.startWorker_(async app => {
      if (typeof options === "undefined") {
        if (typeof testToRun === "undefined") {
          testToRun = authenticator;
          authenticator = null;
        } else if (typeof testToRun === "object") {
          options = testToRun;
          testToRun = authenticator;
          authenticator = null;
        }
      }

      if (typeof authenticator === "string") {
        authenticator = defaultUserAuth(app, authenticator);
      }

      const client = await this._getRestClient_(app, serviceName, authenticator);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    const stepFn_ = allure ? allure.createStep(step, () => body()) : body;

    if (this.verbose) {
      console.log("Step: ", step);
    }

    await stepFn_();
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, authenticator) {
    const client = app.getService(this.webServer ? `superTest-${name}` : `restClient-${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!authenticator) {
      delete client.onSend;
      return client;
    }

    await authenticator(client);
    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJkZWZhdWx0VXNlckF1dGgiLCJhbGx1cmUiLCJTdWl0ZSIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJzZXJ2ZXJFbnRyeSIsInZlcmJvc2UiLCJzdGFydFdlYlNlcnZlcl8iLCJ3ZWJTZXJ2ZXIiLCJFcnJvciIsImNyZWF0ZVdlYlNlcnZlciIsIm1haW4iLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0V29ya2VyXyIsInRlc3RUb1J1biIsIlN0YXJ0ZXJzIiwic3RhcnRXb3JrZXIiLCJlcnIiLCJhcHAiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsInN0YXJ0UmVzdENsaWVudF8iLCJzZXJ2aWNlTmFtZSIsImF1dGhlbnRpY2F0b3IiLCJjbGllbnQiLCJfZ2V0UmVzdENsaWVudF8iLCJpbml0QWxsdXJlIiwiYWxsdXJlTW9jaGEiLCJ0ZXN0Q2FzZSIsInN0b3J5IiwiYm9keSIsImRhdGEiLCJjbGVhblVwIiwic2tpcCIsIm9ubHkiLCJzZWxmIiwib3B0IiwiaXQiLCJjb25zb2xlIiwibG9nIiwiZGVzY3JpcHRpb24iLCJlcGljIiwiZmVhdHVyZSIsIm93bmVyIiwidGFnIiwiaXNzdWVzIiwic2V2ZXJpdHkiLCJpc0VtcHR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwiY3JlYXRlU3RlcCIsInBhcmFtcyIsInYiLCJrIiwicGFyYW1ldGVyIiwiYXR0YWNoT2JqZWN0IiwidGVzdENhc2VGcm9tRml4dHVyZXMiLCJwIiwicmVzb2x2ZSIsInN1aXRlRGF0YSIsImNhc2VzIiwib3RoZXJzIiwic3RvcnlEYXRhIiwiY2FzdEFycmF5IiwiZm9yRWFjaCIsImNhc2VEYXRhIiwiaSIsInByZXBhcmVkRGF0YSIsIm1hcFZhbHVlcyIsImV4cGVjdGVkIiwiYmVuY2htYXJrXyIsIm1hcE9mTWV0aG9kcyIsInBheWxvYWQiLCJCZW5jaG1hcmsiLCJzdWl0ZSIsImVhY2giLCJmIiwiYWRkIiwiUHJvbWlzZSIsInJlamVjdCIsIm9uIiwiZXZlbnQiLCJjeWNsZU1lc3NhZ2UiLCJTdHJpbmciLCJ0YXJnZXQiLCJjb21wbGV0ZU1lc3NhZ2UiLCJmaWx0ZXIiLCJtYXAiLCJydW4iLCJhc3luYyIsInRlc3RTdGVwXyIsInN0ZXAiLCJzdGVwRm5fIiwib2JqIiwidHlwZSIsImNvbnRlbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiY3JlYXRlQXR0YWNobWVudCIsImdldFNlcnZpY2UiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib25TZW50IiwidXJsIiwicmVzdWx0Iiwib25TZW5kIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLE1BQU1FLGVBQWUsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBQS9COztBQUVBLElBQUlHLE1BQUo7O0FBeUJBLE1BQU1DLEtBQU4sQ0FBWTtBQVFSQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBT0MsT0FBUCxFQUFnQjtBQUN2QixTQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxVQUFNO0FBQUVFLE1BQUFBLFdBQUY7QUFBZUMsTUFBQUE7QUFBZixRQUEyQkYsT0FBTyxJQUFJLElBQVgsR0FBa0IsRUFBbEIsR0FBdUJBLE9BQXhEO0FBRUEsU0FBS0MsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDSDs7QUFPb0IsUUFBZkMsZUFBZSxHQUFHO0FBQ3BCLFFBQUksS0FBS0Ms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dXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZShcIkBnZW54L2p1bHlcIik7XG5cbmNvbnN0IGRlZmF1bHRVc2VyQXV0aCA9IHJlcXVpcmUoXCIuL2RlZmF1bHRVc2VyQXV0aFwiKTtcblxubGV0IGFsbHVyZTtcblxuLyoqXG4gKiBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gKiBAY2FsbGJhY2sgdGVzdFdpdGhSZXN0Q2xpZW50XG4gKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcFxuICogQHBhcmFtIHtSZXN0Q2xpZW50fSBjbGllbnQgLSBUaGUgcmVzdCBjbGllbnRcbiAqL1xuXG4vKipcbiAqIFRlc3QgZnVuY3Rpb24gd2l0aCBhIHdvcmtlciBhcHAuXG4gKiBAY2FsbGJhY2sgdGVzdFdpdGhBcHBcbiAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgYXBwXG4gKi9cblxuLyoqXG4gKiBUZXN0IGNhc2UgYm9keS5cbiAqIEBjYWxsYmFjayB0ZXN0Q2FzZUJvZHlcbiAqIEBwYXJhbSB7Kn0gZGF0YSAtIFRlc3QgZGF0YVxuICovXG5cbi8qKlxuICogVGVzdCBzdWl0ZSBvYmplY3QuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgU3VpdGUge1xuICAgIC8qKlxuICAgICAqIFtwcml2YXRlXSBTdWl0ZSB3aWxsIGJlIGNyZWF0ZWQgYnkgdGVzdFN1aXRlIGNyZWF0b3IuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBTdWl0ZSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFN1aXRlIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuc2VydmVyRW50cnk9XCIuLi8uLi9zcmMvaW5kZXguanNcIl0gLSBUaGUgZW50cnkgZmlsZSBvZiBAZ2VueC9zZXJ2ZXIgaW5zdGFuY2UuXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy52ZXJib3NlPWZhbHNlXSAtIFZlcmJvc2UgbW9kZS5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIGNvbnN0IHsgc2VydmVyRW50cnksIHZlcmJvc2UgfSA9IG9wdGlvbnMgPT0gbnVsbCA/IHt9IDogb3B0aW9ucztcblxuICAgICAgICB0aGlzLnNlcnZlckVudHJ5ID0gc2VydmVyRW50cnk7XG4gICAgICAgIHRoaXMudmVyYm9zZSA9IHZlcmJvc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIEBnZW54L3NlcnZlciBpbnN0YWNlIGZvciBjb2RlIGNvdmVyYWdlIHRlc3RpbmcuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdlYlNlcnZlcl8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2ViIHNlcnZlciBhbHJlYWR5IHN0YXJ0ZWQuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3JlYXRlV2ViU2VydmVyID0gdGhpcy5zZXJ2ZXJFbnRyeVxuICAgICAgICAgICAgPyByZXF1aXJlKHRoaXMuc2VydmVyRW50cnkpXG4gICAgICAgICAgICA6IHJlcXVpcmUubWFpbi5yZXF1aXJlKFwiLi4vLi4vc3JjL2luZGV4LmpzXCIpO1xuICAgICAgICB0aGlzLndlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgICAgICBleGl0T25VbmNhdWdodDogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLndlYlNlcnZlci5zdGFydGVkID09IG51bGwgfHwgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQubm90LmJlLm9rKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQuYmUub2soKTtcblxuICAgICAgICByZXR1cm4gdGhpcy53ZWJTZXJ2ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB0aGUgc2VydmVyIGlmIGl0IGlzIHN0YXJ0ZWQuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdG9wV2ViU2VydmVySWZTdGFydGVkXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndlYlNlcnZlcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgd29ya2VyIGFwcCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIC0gT3B0aW9ucyBwYXNzZWQgdGhlIHRlc3Qgd29ya2VyLCBzZWUgc3RhcnRXb3JrZXIgb2YgQGdlbngvYXBwLlxuICAgICAqIEBhc3luY1xuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0V29ya2VyXyh0ZXN0VG9SdW4sIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSxcbiAgICAgICAgfSA9IHJlcXVpcmUoXCJAZ2VueC9hcHBcIik7XG5cbiAgICAgICAgbGV0IGVycjtcblxuICAgICAgICBhd2FpdCBzdGFydFdvcmtlcihcbiAgICAgICAgICAgIGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0ZXN0VG9SdW4oYXBwKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ1BhdGg6IFwiLi90ZXN0L2NvbmZcIixcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGVzUGF0aDogXCJhcHBfbW9kdWxlc1wiLFxuICAgICAgICAgICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgYSByZXN0IGNsaWVudCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlTmFtZSAtIFRoZSBjb25maWcga2V5IG9mIHRhcmdldCBlbmRwb2ludFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258c3RyaW5nfSBbYXV0aGVudGljYXRvcl0gLSBBdXRoZW50aWNhdG9yIHRvIGJlIHVzZWQsIGFzeW5jIChjbGllbnQpID0+IHt9LCBvciBwYXNzIGEgdXNlclRhZyB0byB1c2UgZGVmYXVsdCBhdXRoZW50aWNhdG9yLlxuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBbb3B0aW9uc10gLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRSZXN0Q2xpZW50XyhzZXJ2aWNlTmFtZSwgYXV0aGVudGljYXRvciwgdGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXJ0V29ya2VyXyhhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlc3RUb1J1biA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAgICAgICAgICAgICB0ZXN0VG9SdW4gPSBhdXRoZW50aWNhdG9yO1xuICAgICAgICAgICAgICAgICAgICBhdXRoZW50aWNhdG9yID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZXN0VG9SdW4gPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IHRlc3RUb1J1bjtcbiAgICAgICAgICAgICAgICAgICAgdGVzdFRvUnVuID0gYXV0aGVudGljYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgYXV0aGVudGljYXRvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGF1dGhlbnRpY2F0b3IgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICBhdXRoZW50aWNhdG9yID0gZGVmYXVsdFVzZXJBdXRoKGFwcCwgYXV0aGVudGljYXRvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMuX2dldFJlc3RDbGllbnRfKGFwcCwgc2VydmljZU5hbWUsIGF1dGhlbnRpY2F0b3IpO1xuICAgICAgICAgICAgcmV0dXJuIHRlc3RUb1J1bihhcHAsIGNsaWVudCk7XG4gICAgICAgIH0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgaW5pdEFsbHVyZSgpIHtcbiAgICAgICAgaWYgKCFhbGx1cmUpIHtcbiAgICAgICAgICAgIGNvbnN0IGFsbHVyZU1vY2hhID0gcmVxdWlyZShcImFsbHVyZS1tb2NoYS9ydW50aW1lXCIpO1xuICAgICAgICAgICAgYWxsdXJlID0gYWxsdXJlTW9jaGEuYWxsdXJlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lIGEgdGVzdCBjYXNlLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdG9yeSAtIFRlc3QgY2FzZSB0aXRsZS5cbiAgICAgKiBAcGFyYW0ge3Rlc3RDYXNlQm9keX0gYm9keSAtIFRlc3QgY2FzZSBib2R5IHRvIHdyaXRlIGFjdHVhbCB0ZXN0IGNvZGUuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXVxuICAgICAqIEBwcm9wZXJ0eSB7Kn0gb3B0aW9ucy5kYXRhIC0gVGVzdCBkYXRhXG4gICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5jbGVhblVwIC0gQ2xlYW51cCBhZnRlciB0aGUgY2FzZSBlbmRzIHJlZ2FyZGxlc3Mgd2hldGhlciBpdCBpcyBzdWNjZXNzZnVsIG9yIG5vdC5cbiAgICAgKi9cbiAgICB0ZXN0Q2FzZShzdG9yeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCB7IGRhdGEsIGNsZWFuVXAsIHNraXAsIG9ubHkgfSA9IG9wdGlvbnMgPT0gbnVsbCA/IHt9IDogb3B0aW9ucztcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IG9wdDtcblxuICAgICAgICBpZiAob25seSkge1xuICAgICAgICAgICAgb3B0ID0gXCJvbmx5XCI7XG4gICAgICAgIH0gZWxzZSBpZiAoc2tpcCkge1xuICAgICAgICAgICAgb3B0ID0gXCJza2lwXCI7XG4gICAgICAgIH1cblxuICAgICAgICAob3B0ID8gaXRbb3B0XSA6IGl0KShzdG9yeSwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHNlbGYudmVyYm9zZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgc3Rvcnk6XCIsIHN0b3J5KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGVzY3JpcHRpb24sIGVwaWMsIGZlYXR1cmUsIG93bmVyLCB0YWcsIGlzc3Vlcywgc2V2ZXJpdHkgfSA9IGRhdGEuYWxsdXJlO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uICYmIGFsbHVyZS5kZXNjcmlwdGlvbihkZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGVwaWMgJiYgYWxsdXJlLmVwaWMoZXBpYyk7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmUgJiYgYWxsdXJlLmZlYXR1cmUoZmVhdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgIG93bmVyICYmIGFsbHVyZS5vd25lcihvd25lcik7XG4gICAgICAgICAgICAgICAgICAgIHRhZyAmJiBhbGx1cmUudGFnKHRhZyk7XG4gICAgICAgICAgICAgICAgICAgIHNldmVyaXR5ICYmIGFsbHVyZS5zZXZlcml0eShzZXZlcml0eSk7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5pc0VtcHR5KGlzc3VlcykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGlzc3VlcywgKGxpbmssIG51bSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5pc3N1ZShudW0sIGxpbmspO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYWxsdXJlLnN0b3J5KHN0b3J5KTtcbiAgICAgICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChgc3RhcnQgJHtzdG9yeX1gLCAoKSA9PiB7fSkoKTtcblxuICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGRhdGEucGFyYW1zLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCBcIipzZWUgYXR0YWNobWVudCpcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hdHRhY2hPYmplY3QoYHBhcmFtWyR7a31dYCwgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGNsZWFuVXApIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgICAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNsZWFuVXAoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlc3QgY2FzZSB3aXRoIGZpeHR1cmVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdG9yeVxuICAgICAqIEBwYXJhbSB7dGVzdENhc2VCb2R5fSBib2R5XG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxuICAgICAqL1xuICAgIHRlc3RDYXNlRnJvbUZpeHR1cmVzKHN0b3J5LCBib2R5LCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHAgPSBwYXRoLnJlc29sdmUoYHRlc3QvZml4dHVyZXMvJHt0aGlzLm5hbWV9LmpzYCk7XG4gICAgICAgIGNvbnN0IHN1aXRlRGF0YSA9IHJlcXVpcmUocCk7XG4gICAgICAgIGlmICghc3VpdGVEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN1aXRlIGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9YCk7XG5cbiAgICAgICAgY29uc3QgeyBjYXNlcywgLi4ub3RoZXJzIH0gPSBzdWl0ZURhdGE7XG5cbiAgICAgICAgY29uc3Qgc3RvcnlEYXRhID0gY2FzZXMgJiYgY2FzZXNbc3RvcnldO1xuICAgICAgICBpZiAoIXN0b3J5RGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdG9yeSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7dGhpcy5uYW1lfSwgc3Rvcnk6ICR7c3Rvcnl9YCk7XG5cbiAgICAgICAgXy5jYXN0QXJyYXkoc3RvcnlEYXRhKS5mb3JFYWNoKChjYXNlRGF0YSwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJlcGFyZWREYXRhID0ge1xuICAgICAgICAgICAgICAgIGFsbHVyZTogb3RoZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtczogXy5tYXBWYWx1ZXMoY2FzZURhdGEucGFyYW1zLCAodikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIHYoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZXhwZWN0ZWQ6IGNhc2VEYXRhLmV4cGVjdGVkLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy50ZXN0Q2FzZShgJHtzdG9yeX0jJHtpICsgMX1gLCBib2R5LCB7IC4uLm9wdGlvbnMsIGRhdGE6IHByZXBhcmVkRGF0YSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIGJlbmNobWFyayBhZ2FpbnN0IGdpdmVuIG1ldGhvZHMuXG4gICAgICogQHBhcmFtIHsqfSBtYXBPZk1ldGhvZHMgLSBNYXAgb2YgbmFtZSB0byBmdW5jdGlvbiB3aXRoIHBheWxvYWRcbiAgICAgKiBAcGFyYW0geyp9IHBheWxvYWRcbiAgICAgKi9cbiAgICBhc3luYyBiZW5jaG1hcmtfKG1hcE9mTWV0aG9kcywgcGF5bG9hZCkge1xuICAgICAgICBjb25zdCBCZW5jaG1hcmsgPSByZXF1aXJlKFwiYmVuY2htYXJrXCIpO1xuICAgICAgICBjb25zdCBzdWl0ZSA9IG5ldyBCZW5jaG1hcmsuU3VpdGUoKTtcblxuICAgICAgICBfLmVhY2gobWFwT2ZNZXRob2RzLCAoZiwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgc3VpdGUuYWRkKG5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBmKHBheWxvYWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgICAgICAgICAgc3VpdGVcbiAgICAgICAgICAgICAgICAub24oXCJjeWNsZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3ljbGVNZXNzYWdlID0gU3RyaW5nKGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGN5Y2xlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KFwiY3ljbGVcIiwgY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5vbihcImNvbXBsZXRlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcGxldGVNZXNzYWdlID0gXCJUaGUgZmFzdGVzdCBpcyBcIiArIHRoaXMuZmlsdGVyKFwiZmFzdGVzdFwiKS5tYXAoXCJuYW1lXCIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb21wbGV0ZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICBzZWxmLmF0dGFjaE9iamVjdChcImNvbXBsZXRlXCIsIGNvbXBsZXRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5vbihcImVycm9yXCIsIChldmVudCkgPT4gcmVqZWN0KFN0cmluZyhldmVudC50YXJnZXQpKSlcbiAgICAgICAgICAgICAgICAucnVuKHsgYXN5bmM6IHRydWUgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmluZSBhIHRlc3Qgc3RlcC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RlcFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtib2R5XSAtIFRlc3Qgc3RlcCBib2R5XG4gICAgICovXG4gICAgYXN5bmMgdGVzdFN0ZXBfKHN0ZXAsIGJvZHkpIHtcbiAgICAgICAgY29uc3Qgc3RlcEZuXyA9IGFsbHVyZSA/IGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IGJvZHkoKSkgOiBib2R5O1xuXG4gICAgICAgIGlmICh0aGlzLnZlcmJvc2UpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3RlcDogXCIsIHN0ZXApO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgc3RlcEZuXygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhbiBvYmplY3QgdG8gdGhlIHRlc3QgcmVwb3J0LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBvYmpcbiAgICAgKi9cbiAgICBhdHRhY2hPYmplY3QobmFtZSwgb2JqKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSByZXR1cm47XG5cbiAgICAgICAgbGV0IHR5cGUgPSBcInRleHQvcGxhaW5cIixcbiAgICAgICAgICAgIGNvbnRlbnQgPSBvYmo7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDQpO1xuICAgICAgICAgICAgdHlwZSA9IFwiYXBwbGljYXRpb24vanNvblwiO1xuICAgICAgICB9XG5cbiAgICAgICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgYXV0aGVudGljYXRvcikge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBhcHAuZ2V0U2VydmljZSh0aGlzLndlYlNlcnZlciA/IGBzdXBlclRlc3QtJHtuYW1lfWAgOiBgcmVzdENsaWVudC0ke25hbWV9YCk7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgY2xpZW50LnNlcnZlciA9IHRoaXMud2ViU2VydmVyLmh0dHBTZXJ2ZXI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNsaWVudC5vblNlbnQpIHtcbiAgICAgICAgICAgIGNsaWVudC5vblNlbnQgPSAodXJsLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaE9iamVjdCh1cmwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFhdXRoZW50aWNhdG9yKSB7XG4gICAgICAgICAgICBkZWxldGUgY2xpZW50Lm9uU2VuZDtcbiAgICAgICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBhdXRoZW50aWNhdG9yKGNsaWVudCk7XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3VpdGU7XG4iXX0=