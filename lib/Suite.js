"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("@genx/july");

const tokenCache = {};
let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry || require.main.require("../../src/index.js");
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = require(this.serverEntry);

    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    return this.startWorker_(async app => {
      const client = await this._getRestClient_(app, name, userTag);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log("Step: ", step);
    }

    if (body) {
      await body();
    }
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest-${name}` : `restClient-${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });
      token = res.token;
      tokenCache[userTag] = token;
      app.log("info", `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set("Authorization", `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJ0b2tlbkNhY2hlIiwiYWxsdXJlIiwiU3VpdGUiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwic2VydmVyRW50cnkiLCJ2ZXJib3NlIiwibWFpbiIsInN0YXJ0V2ViU2VydmVyXyIsIndlYlNlcnZlciIsIkVycm9yIiwiY3JlYXRlV2ViU2VydmVyIiwiZXhpdE9uVW5jYXVnaHQiLCJzdGFydGVkIiwic2hvdWxkIiwibm90IiwiYmUiLCJvayIsInN0YXJ0XyIsInN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfIiwic3RvcF8iLCJzdGFydFdvcmtlcl8iLCJ0ZXN0VG9SdW4iLCJTdGFydGVycyIsInN0YXJ0V29ya2VyIiwiZXJyIiwiYXBwIiwiZSIsIndvcmtlck5hbWUiLCJjb25maWdOYW1lIiwiY29uZmlnUGF0aCIsImFwcE1vZHVsZXNQYXRoIiwiaWdub3JlVW5jYXVnaHQiLCJleGlzdCIsIm1lc3NhZ2UiLCJzdGFydFJlc3RDbGllbnRfIiwidXNlclRhZyIsImNsaWVudCIsIl9nZXRSZXN0Q2xpZW50XyIsImluaXRBbGx1cmUiLCJhbGx1cmVNb2NoYSIsInRlc3RDYXNlIiwic3RvcnkiLCJib2R5IiwiZGF0YSIsImNsZWFuVXAiLCJza2lwIiwib25seSIsInNlbGYiLCJvcHQiLCJpdCIsImNvbnNvbGUiLCJsb2ciLCJkZXNjcmlwdGlvbiIsImVwaWMiLCJmZWF0dXJlIiwib3duZXIiLCJ0YWciLCJpc3N1ZXMiLCJzZXZlcml0eSIsImlzRW1wdHkiLCJmb3JPd24iLCJsaW5rIiwibnVtIiwiaXNzdWUiLCJjcmVhdGVTdGVwIiwicGFyYW1zIiwidiIsImsiLCJwYXJhbWV0ZXIiLCJhdHRhY2hPYmplY3QiLCJ0ZXN0Q2FzZUZyb21GaXh0dXJlcyIsInAiLCJyZXNvbHZlIiwic3VpdGVEYXRhIiwiY2FzZXMiLCJvdGhlcnMiLCJzdG9yeURhdGEiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY2FzZURhdGEiLCJpIiwicHJlcGFyZWREYXRhIiwibWFwVmFsdWVzIiwiZXhwZWN0ZWQiLCJiZW5jaG1hcmtfIiwibWFwT2ZNZXRob2RzIiwicGF5bG9hZCIsIkJlbmNobWFyayIsInN1aXRlIiwiZWFjaCIsImYiLCJhZGQiLCJQcm9taXNlIiwicmVqZWN0Iiwib24iLCJldmVudCIsImN5Y2xlTWVzc2FnZSIsIlN0cmluZyIsInRhcmdldCIsImNvbXBsZXRlTWVzc2FnZSIsImZpbHRlciIsIm1hcCIsInJ1biIsImFzeW5jIiwidGVzdFN0ZXBfIiwic3RlcCIsIm9iaiIsInR5cGUiLCJjb250ZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZUF0dGFjaG1lbnQiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwicmVxIiwic2V0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLE1BQU1FLFVBQVUsR0FBRyxFQUFuQjtBQUNBLElBQUlDLE1BQUo7O0FBeUJBLE1BQU1DLEtBQU4sQ0FBWTtBQVFSQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBT0MsT0FBUCxFQUFnQjtBQUN2QixTQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxVQUFNO0FBQUVFLE1BQUFBLFdBQUY7QUFBZUMsTUFBQUE7QUFBZixRQUEyQkYsT0FBTyxJQUFJLElBQVgsR0FBa0IsRUFBbEIsR0FBdUJBLE9BQXhEO0FBRUEsU0FBS0MsV0FBTCxHQUFtQkEsV0FBVyxJQUFJUixPQUFPLENBQUNVLElBQVIsQ0FBYVYsT0FBYixDQUFxQixvQkFBckIsQ0FBbEM7QUFDQSxTQUFLUyxPQUFMLEdBQWVBLE9BQWY7QUFDSDs7QUFPRCxRQUFNRSxlQUFOLEdBQXdCO0FBQ3BCLFFBQUksS0FBS0MsU0FBVCxFQUFvQjtBQUNoQixZQUFNLElBQUlDLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0g7O0FBRUQsVUFBTUMsZUFBZSxHQUFHZCxPQUFPLENBQUMsS0FBS1EsV0FBTixDQUEvQjs7QUFDQSxTQUFLSSxTQUFMLEdBQWlCRSxlQUFlLENBQUM7QUFDN0JDLE1BQUFBLGNBQWMsRUFBRTtBQURhLEtBQUQsQ0FBaEM7QUFHQSxTQUFLSCxTQUFMLENBQWVJLE9BQWYsSUFBMEIsSUFBMUIsSUFBa0MsS0FBS0osU0FBTCxDQUFlSSxPQUFmLENBQXVCQyxNQUF2QixDQUE4QkMsR0FBOUIsQ0FBa0NDLEVBQWxDLENBQXFDQyxFQUFyQyxFQUFsQztBQUVBLFVBQU0sS0FBS1IsU0FBTCxDQUFlUyxNQUFmLEVBQU47QUFFQSxTQUFLVCxTQUFMLENBQWVJLE9BQWYsQ0FBdUJDLE1BQXZCLENBQThCRSxFQUE5QixDQUFpQ0MsRUFBakM7QUFFQSxXQUFPLEtBQUtSLFNBQVo7QUFDSDs7QUFPRCxRQUFNVSx1QkFBTixHQUFnQztBQUM1QixRQUFJLEtBQUtWLFNBQVQsRUFBb0I7QUFDaEIsVUFBSSxLQUFLQSxTQUFMLENBQWVJLE9BQW5CLEVBQTRCO0FBQ3hCLGNBQU0sS0FBS0osU0FBTCxDQUFlVyxLQUFmLEVBQU47QUFDSDs7QUFFRCxhQUFPLEtBQUtYLFNBQVo7QUFDSDtBQUNKOztBQVFELFFBQU1ZLFlBQU4sQ0FBbUJDLFNBQW5CLEVBQThCbEIsT0FBOUIsRUFBdUM7QUFDbkMsVUFBTTtBQUNGbUIsTUFBQUEsUUFBUSxFQUFFO0FBQUVDLFFBQUFBO0FBQUY7QUFEUixRQUVGM0IsT0FBTyxDQUFDLFdBQUQsQ0FGWDs7QUFJQSxRQUFJNEIsR0FBSjtBQUVBLFVBQU1ELFdBQVcsQ0FDYixNQUFPRSxHQUFQLElBQWU7QUFDWCxVQUFJO0FBQ0EsY0FBTUosU0FBUyxDQUFDSSxHQUFELENBQWY7QUFDSCxPQUZELENBRUUsT0FBT0MsQ0FBUCxFQUFVO0FBQ1JGLFFBQUFBLEdBQUcsR0FBR0UsQ0FBTjtBQUNIO0FBQ0osS0FQWSxFQVFiO0FBQ0lDLE1BQUFBLFVBQVUsRUFBRSxRQURoQjtBQUVJQyxNQUFBQSxVQUFVLEVBQUUsTUFGaEI7QUFHSUMsTUFBQUEsVUFBVSxFQUFFLGFBSGhCO0FBSUlDLE1BQUFBLGNBQWMsRUFBRSxhQUpwQjtBQUtJQyxNQUFBQSxjQUFjLEVBQUUsSUFMcEI7QUFNSSxTQUFHNUI7QUFOUCxLQVJhLENBQWpCOztBQWtCQSxRQUFJcUIsR0FBSixFQUFTO0FBQ0xYLE1BQUFBLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXa0IsS0FBWCxDQUFpQlIsR0FBakIsRUFBc0JBLEdBQUcsQ0FBQ1MsT0FBSixJQUFlVCxHQUFyQztBQUNIO0FBQ0o7O0FBVUQsUUFBTVUsZ0JBQU4sQ0FBdUJoQyxJQUF2QixFQUE2QmlDLE9BQTdCLEVBQXNDZCxTQUF0QyxFQUFpRGxCLE9BQWpELEVBQTBEO0FBQ3RELFdBQU8sS0FBS2lCLFlBQUwsQ0FBa0IsTUFBT0ssR0FBUCxJQUFlO0FBQ3BDLFlBQU1XLE1BQU0sR0FBRyxNQUFNLEtBQUtDLGVBQUwsQ0FBcUJaLEdBQXJCLEVBQTBCdkIsSUFBMUIsRUFBZ0NpQyxPQUFoQyxDQUFyQjtBQUNBLGFBQU9kLFNBQVMsQ0FBQ0ksR0FBRCxFQUFNVyxNQUFOLENBQWhCO0FBQ0gsS0FITSxFQUdKakMsT0FISSxDQUFQO0FBSUg7O0FBS0RtQyxFQUFBQSxVQUFVLEdBQUc7QUFDVCxRQUFJLENBQUN2QyxNQUFMLEVBQWE7QUFDVCxZQUFNd0MsV0FBVyxHQUFHM0MsT0FBTyxDQUFDLHNCQUFELENBQTNCOztBQUNBRyxNQUFBQSxNQUFNLEdBQUd3QyxXQUFXLENBQUN4QyxNQUFyQjtBQUNIO0FBQ0o7O0FBVUR5QyxFQUFBQSxRQUFRLENBQUNDLEtBQUQsRUFBUUMsSUFBUixFQUFjdkMsT0FBZCxFQUF1QjtBQUMzQixVQUFNO0FBQUV3QyxNQUFBQSxJQUFGO0FBQVFDLE1BQUFBLE9BQVI7QUFBaUJDLE1BQUFBLElBQWpCO0FBQXVCQyxNQUFBQTtBQUF2QixRQUFnQzNDLE9BQU8sSUFBSSxJQUFYLEdBQWtCLEVBQWxCLEdBQXVCQSxPQUE3RDtBQUNBLFVBQU00QyxJQUFJLEdBQUcsSUFBYjtBQUVBLFFBQUlDLEdBQUo7O0FBRUEsUUFBSUYsSUFBSixFQUFVO0FBQ05FLE1BQUFBLEdBQUcsR0FBRyxNQUFOO0FBQ0gsS0FGRCxNQUVPLElBQUlILElBQUosRUFBVTtBQUNiRyxNQUFBQSxHQUFHLEdBQUcsTUFBTjtBQUNIOztBQUVELEtBQUNBLEdBQUcsR0FBR0MsRUFBRSxDQUFDRCxHQUFELENBQUwsR0FBYUMsRUFBakIsRUFBcUJSLEtBQXJCLEVBQTRCLGtCQUFrQjtBQUMxQyxVQUFJTSxJQUFJLENBQUMxQyxPQUFULEVBQWtCO0FBQ2Q2QyxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxpQkFBWixFQUErQlYsS0FBL0I7QUFDSDs7QUFFRCxVQUFJMUMsTUFBSixFQUFZO0FBQ1IsWUFBSTRDLElBQUosRUFBVTtBQUNOLGdCQUFNO0FBQUVTLFlBQUFBLFdBQUY7QUFBZUMsWUFBQUEsSUFBZjtBQUFxQkMsWUFBQUEsT0FBckI7QUFBOEJDLFlBQUFBLEtBQTlCO0FBQXFDQyxZQUFBQSxHQUFyQztBQUEwQ0MsWUFBQUEsTUFBMUM7QUFBa0RDLFlBQUFBO0FBQWxELGNBQStEZixJQUFJLENBQUM1QyxNQUExRTtBQUVBcUQsVUFBQUEsV0FBVyxJQUFJckQsTUFBTSxDQUFDcUQsV0FBUCxDQUFtQkEsV0FBbkIsQ0FBZjtBQUNBQyxVQUFBQSxJQUFJLElBQUl0RCxNQUFNLENBQUNzRCxJQUFQLENBQVlBLElBQVosQ0FBUjtBQUNBQyxVQUFBQSxPQUFPLElBQUl2RCxNQUFNLENBQUN1RCxPQUFQLENBQWVBLE9BQWYsQ0FBWDtBQUNBQyxVQUFBQSxLQUFLLElBQUl4RCxNQUFNLENBQUN3RCxLQUFQLENBQWFBLEtBQWIsQ0FBVDtBQUNBQyxVQUFBQSxHQUFHLElBQUl6RCxNQUFNLENBQUN5RCxHQUFQLENBQVdBLEdBQVgsQ0FBUDtBQUNBRSxVQUFBQSxRQUFRLElBQUkzRCxNQUFNLENBQUMyRCxRQUFQLENBQWdCQSxRQUFoQixDQUFaO0FBRUE3RCxVQUFBQSxDQUFDLENBQUM4RCxPQUFGLENBQVVGLE1BQVYsS0FDSTVELENBQUMsQ0FBQytELE1BQUYsQ0FBU0gsTUFBVCxFQUFpQixDQUFDSSxJQUFELEVBQU9DLEdBQVAsS0FBZTtBQUM1Qi9ELFlBQUFBLE1BQU0sQ0FBQ2dFLEtBQVAsQ0FBYUQsR0FBYixFQUFrQkQsSUFBbEI7QUFDSCxXQUZELENBREo7QUFJSDs7QUFFRDlELFFBQUFBLE1BQU0sQ0FBQzBDLEtBQVAsQ0FBYUEsS0FBYjtBQUNBMUMsUUFBQUEsTUFBTSxDQUFDaUUsVUFBUCxDQUFtQixTQUFRdkIsS0FBTSxFQUFqQyxFQUFvQyxNQUFNLENBQUUsQ0FBNUM7O0FBRUEsWUFBSUUsSUFBSSxJQUFJQSxJQUFJLENBQUNzQixNQUFqQixFQUF5QjtBQUNyQnBFLFVBQUFBLENBQUMsQ0FBQytELE1BQUYsQ0FBU2pCLElBQUksQ0FBQ3NCLE1BQWQsRUFBc0IsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVU7QUFDNUIsZ0JBQUksT0FBT0QsQ0FBUCxLQUFhLFFBQWpCLEVBQTJCO0FBQ3ZCbkUsY0FBQUEsTUFBTSxDQUFDcUUsU0FBUCxDQUFpQkQsQ0FBakIsRUFBb0Isa0JBQXBCO0FBQ0FwQixjQUFBQSxJQUFJLENBQUNzQixZQUFMLENBQW1CLFNBQVFGLENBQUUsR0FBN0IsRUFBaUNELENBQWpDO0FBQ0gsYUFIRCxNQUdPO0FBQ0huRSxjQUFBQSxNQUFNLENBQUNxRSxTQUFQLENBQWlCRCxDQUFqQixFQUFvQkQsQ0FBcEI7QUFDSDtBQUNKLFdBUEQ7QUFRSDtBQUNKOztBQUVELFVBQUl0QixPQUFKLEVBQWE7QUFDVCxZQUFJO0FBQ0EsZ0JBQU1GLElBQUksQ0FBQ0MsSUFBRCxDQUFWO0FBQ0gsU0FGRCxTQUVVO0FBQ04sZ0JBQU1DLE9BQU8sRUFBYjtBQUNIO0FBQ0osT0FORCxNQU1PO0FBQ0gsY0FBTUYsSUFBSSxDQUFDQyxJQUFELENBQVY7QUFDSDtBQUNKLEtBOUNEO0FBK0NIOztBQVFEMkIsRUFBQUEsb0JBQW9CLENBQUM3QixLQUFELEVBQVFDLElBQVIsRUFBY3ZDLE9BQWQsRUFBdUI7QUFDdkMsVUFBTW9FLENBQUMsR0FBRzVFLElBQUksQ0FBQzZFLE9BQUwsQ0FBYyxpQkFBZ0IsS0FBS3RFLElBQUssS0FBeEMsQ0FBVjs7QUFDQSxVQUFNdUUsU0FBUyxHQUFHN0UsT0FBTyxDQUFDMkUsQ0FBRCxDQUF6Qjs7QUFDQSxRQUFJLENBQUNFLFNBQUwsRUFBZ0IsTUFBTSxJQUFJaEUsS0FBSixDQUFXLGdDQUErQixLQUFLUCxJQUFLLEVBQXBELENBQU47QUFFaEIsVUFBTTtBQUFFd0UsTUFBQUEsS0FBRjtBQUFTLFNBQUdDO0FBQVosUUFBdUJGLFNBQTdCO0FBRUEsVUFBTUcsU0FBUyxHQUFHRixLQUFLLElBQUlBLEtBQUssQ0FBQ2pDLEtBQUQsQ0FBaEM7QUFDQSxRQUFJLENBQUNtQyxTQUFMLEVBQWdCLE1BQU0sSUFBSW5FLEtBQUosQ0FBVyxnQ0FBK0IsS0FBS1AsSUFBSyxZQUFXdUMsS0FBTSxFQUFyRSxDQUFOOztBQUVoQjVDLElBQUFBLENBQUMsQ0FBQ2dGLFNBQUYsQ0FBWUQsU0FBWixFQUF1QkUsT0FBdkIsQ0FBK0IsQ0FBQ0MsUUFBRCxFQUFXQyxDQUFYLEtBQWlCO0FBQzVDLFlBQU1DLFlBQVksR0FBRztBQUNqQmxGLFFBQUFBLE1BQU0sRUFBRTRFLE1BRFM7QUFFakJWLFFBQUFBLE1BQU0sRUFBRXBFLENBQUMsQ0FBQ3FGLFNBQUYsQ0FBWUgsUUFBUSxDQUFDZCxNQUFyQixFQUE4QkMsQ0FBRCxJQUFPO0FBQ3hDLGNBQUksT0FBT0EsQ0FBUCxLQUFhLFVBQWpCLEVBQTZCLE9BQU9BLENBQUMsRUFBUjtBQUM3QixpQkFBT0EsQ0FBUDtBQUNILFNBSE8sQ0FGUztBQU1qQmlCLFFBQUFBLFFBQVEsRUFBRUosUUFBUSxDQUFDSTtBQU5GLE9BQXJCO0FBU0EsV0FBSzNDLFFBQUwsQ0FBZSxHQUFFQyxLQUFNLElBQUd1QyxDQUFDLEdBQUcsQ0FBRSxFQUFoQyxFQUFtQ3RDLElBQW5DLEVBQXlDLEVBQUUsR0FBR3ZDLE9BQUw7QUFBY3dDLFFBQUFBLElBQUksRUFBRXNDO0FBQXBCLE9BQXpDO0FBQ0gsS0FYRDtBQVlIOztBQU9ELFFBQU1HLFVBQU4sQ0FBaUJDLFlBQWpCLEVBQStCQyxPQUEvQixFQUF3QztBQUNwQyxVQUFNQyxTQUFTLEdBQUczRixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxVQUFNNEYsS0FBSyxHQUFHLElBQUlELFNBQVMsQ0FBQ3ZGLEtBQWQsRUFBZDs7QUFFQUgsSUFBQUEsQ0FBQyxDQUFDNEYsSUFBRixDQUFPSixZQUFQLEVBQXFCLENBQUNLLENBQUQsRUFBSXhGLElBQUosS0FBYTtBQUM5QnNGLE1BQUFBLEtBQUssQ0FBQ0csR0FBTixDQUFVekYsSUFBVixFQUFnQixZQUFZO0FBQ3hCd0YsUUFBQUEsQ0FBQyxDQUFDSixPQUFELENBQUQ7QUFDSCxPQUZEO0FBR0gsS0FKRDs7QUFNQSxXQUFPLElBQUlNLE9BQUosQ0FBWSxDQUFDcEIsT0FBRCxFQUFVcUIsTUFBVixLQUFxQjtBQUNwQyxZQUFNOUMsSUFBSSxHQUFHLElBQWI7QUFFQXlDLE1BQUFBLEtBQUssQ0FDQU0sRUFETCxDQUNRLE9BRFIsRUFDa0JDLEtBQUQsSUFBVztBQUNwQixjQUFNQyxZQUFZLEdBQUdDLE1BQU0sQ0FBQ0YsS0FBSyxDQUFDRyxNQUFQLENBQTNCO0FBQ0FoRCxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWTZDLFlBQVo7QUFDQSxhQUFLM0IsWUFBTCxDQUFrQixPQUFsQixFQUEyQjJCLFlBQTNCO0FBQ0gsT0FMTCxFQU1LRixFQU5MLENBTVEsVUFOUixFQU1vQixZQUFZO0FBQ3hCLGNBQU1LLGVBQWUsR0FBRyxvQkFBb0IsS0FBS0MsTUFBTCxDQUFZLFNBQVosRUFBdUJDLEdBQXZCLENBQTJCLE1BQTNCLENBQTVDO0FBQ0FuRCxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWdELGVBQVo7QUFDQXBELFFBQUFBLElBQUksQ0FBQ3NCLFlBQUwsQ0FBa0IsVUFBbEIsRUFBOEI4QixlQUE5QjtBQUNBM0IsUUFBQUEsT0FBTztBQUNWLE9BWEwsRUFZS3NCLEVBWkwsQ0FZUSxPQVpSLEVBWWtCQyxLQUFELElBQVdGLE1BQU0sQ0FBQ0ksTUFBTSxDQUFDRixLQUFLLENBQUNHLE1BQVAsQ0FBUCxDQVpsQyxFQWFLSSxHQWJMLENBYVM7QUFBRUMsUUFBQUEsS0FBSyxFQUFFO0FBQVQsT0FiVDtBQWNILEtBakJNLENBQVA7QUFrQkg7O0FBT0QsUUFBTUMsU0FBTixDQUFnQkMsSUFBaEIsRUFBc0IvRCxJQUF0QixFQUE0QjtBQUN4QixRQUFJM0MsTUFBSixFQUFZO0FBQ1JBLE1BQUFBLE1BQU0sQ0FBQ2lFLFVBQVAsQ0FBa0J5QyxJQUFsQixFQUF3QixNQUFNLENBQUUsQ0FBaEM7QUFDSDs7QUFFRCxRQUFJLEtBQUtwRyxPQUFULEVBQWtCO0FBQ2Q2QyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxRQUFaLEVBQXNCc0QsSUFBdEI7QUFDSDs7QUFFRCxRQUFJL0QsSUFBSixFQUFVO0FBQ04sWUFBTUEsSUFBSSxFQUFWO0FBQ0g7QUFDSjs7QUFPRDJCLEVBQUFBLFlBQVksQ0FBQ25FLElBQUQsRUFBT3dHLEdBQVAsRUFBWTtBQUNwQixRQUFJLENBQUMzRyxNQUFMLEVBQWE7QUFFYixRQUFJNEcsSUFBSSxHQUFHLFlBQVg7QUFBQSxRQUNJQyxPQUFPLEdBQUdGLEdBRGQ7O0FBR0EsUUFBSSxPQUFPQSxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDekJFLE1BQUFBLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEIsQ0FBMUIsQ0FBVjtBQUNBQyxNQUFBQSxJQUFJLEdBQUcsa0JBQVA7QUFDSDs7QUFFRDVHLElBQUFBLE1BQU0sQ0FBQ2dILGdCQUFQLENBQXdCN0csSUFBeEIsRUFBOEIwRyxPQUE5QixFQUF1Q0QsSUFBdkM7QUFDSDs7QUFFRCxRQUFNdEUsZUFBTixDQUFzQlosR0FBdEIsRUFBMkJ2QixJQUEzQixFQUFpQ2lDLE9BQWpDLEVBQTBDO0FBQ3RDLFVBQU1DLE1BQU0sR0FBR1gsR0FBRyxDQUFDdUYsVUFBSixDQUFlLEtBQUt4RyxTQUFMLEdBQWtCLGFBQVlOLElBQUssRUFBbkMsR0FBd0MsY0FBYUEsSUFBSyxFQUF6RSxDQUFmOztBQUNBLFFBQUksS0FBS00sU0FBVCxFQUFvQjtBQUNoQjRCLE1BQUFBLE1BQU0sQ0FBQzZFLE1BQVAsR0FBZ0IsS0FBS3pHLFNBQUwsQ0FBZTBHLFVBQS9CO0FBQ0g7O0FBRUQsUUFBSSxDQUFDOUUsTUFBTSxDQUFDK0UsTUFBWixFQUFvQjtBQUNoQi9FLE1BQUFBLE1BQU0sQ0FBQytFLE1BQVAsR0FBZ0IsQ0FBQ0MsR0FBRCxFQUFNQyxNQUFOLEtBQWlCO0FBQzdCLGFBQUtoRCxZQUFMLENBQWtCK0MsR0FBbEIsRUFBdUJDLE1BQXZCO0FBQ0gsT0FGRDtBQUdIOztBQUVELFFBQUksQ0FBQ2xGLE9BQUwsRUFBYztBQUNWLGFBQU9DLE1BQU0sQ0FBQ2tGLE1BQWQ7QUFDQSxhQUFPbEYsTUFBUDtBQUNIOztBQUVELFFBQUltRixLQUFKLEVBQVdDLFFBQVg7O0FBRUEsUUFBSTNILENBQUMsQ0FBQzRILGFBQUYsQ0FBZ0J0RixPQUFoQixDQUFKLEVBQThCO0FBQzFCb0YsTUFBQUEsS0FBSyxHQUFHekgsVUFBVSxDQUFDcUMsT0FBTyxDQUFDQSxPQUFULENBQWxCO0FBQ0FxRixNQUFBQSxRQUFRLEdBQUdyRixPQUFYO0FBQ0gsS0FIRCxNQUdPO0FBQ0hvRixNQUFBQSxLQUFLLEdBQUd6SCxVQUFVLENBQUNxQyxPQUFELENBQWxCO0FBQ0FxRixNQUFBQSxRQUFRLEdBQUcvRixHQUFHLENBQUNpRyxRQUFKLENBQWFGLFFBQWIsQ0FBc0JyRixPQUF0QixDQUFYO0FBQ0g7O0FBRUQsUUFBSSxDQUFDb0YsS0FBTCxFQUFZO0FBQ1IsVUFBSUksR0FBRyxHQUFHLE1BQU12RixNQUFNLENBQUN3RixJQUFQLENBQVlKLFFBQVEsQ0FBQ0ssUUFBckIsRUFBK0I7QUFDM0NDLFFBQUFBLFFBQVEsRUFBRU4sUUFBUSxDQUFDTSxRQUR3QjtBQUUzQ0MsUUFBQUEsUUFBUSxFQUFFUCxRQUFRLENBQUNPO0FBRndCLE9BQS9CLENBQWhCO0FBSUFSLE1BQUFBLEtBQUssR0FBR0ksR0FBRyxDQUFDSixLQUFaO0FBQ0F6SCxNQUFBQSxVQUFVLENBQUNxQyxPQUFELENBQVYsR0FBc0JvRixLQUF0QjtBQUVBOUYsTUFBQUEsR0FBRyxDQUFDMEIsR0FBSixDQUFRLE1BQVIsRUFBaUIsbUJBQWtCaEIsT0FBUSxJQUEzQztBQUNIOztBQUVEQyxJQUFBQSxNQUFNLENBQUNrRixNQUFQLEdBQWlCVSxHQUFELElBQVM7QUFDckJBLE1BQUFBLEdBQUcsQ0FBQ0MsR0FBSixDQUFRLGVBQVIsRUFBMEIsVUFBU1YsS0FBTSxFQUF6QztBQUNILEtBRkQ7O0FBSUEsV0FBT25GLE1BQVA7QUFDSDs7QUExVU87O0FBNlVaOEYsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbkksS0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuXG5jb25zdCB0b2tlbkNhY2hlID0ge307XG5sZXQgYWxsdXJlO1xuXG4vKipcbiAqIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aFJlc3RDbGllbnRcbiAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgYXBwXG4gKiBAcGFyYW0ge1Jlc3RDbGllbnR9IGNsaWVudCAtIFRoZSByZXN0IGNsaWVudFxuICovXG5cbi8qKlxuICogVGVzdCBmdW5jdGlvbiB3aXRoIGEgd29ya2VyIGFwcC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aEFwcFxuICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBhcHBcbiAqL1xuXG4vKipcbiAqIFRlc3QgY2FzZSBib2R5LlxuICogQGNhbGxiYWNrIHRlc3RDYXNlQm9keVxuICogQHBhcmFtIHsqfSBkYXRhIC0gVGVzdCBkYXRhXG4gKi9cblxuLyoqXG4gKiBUZXN0IHN1aXRlIG9iamVjdC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBTdWl0ZSB7XG4gICAgLyoqXG4gICAgICogW3ByaXZhdGVdIFN1aXRlIHdpbGwgYmUgY3JlYXRlZCBieSB0ZXN0U3VpdGUgY3JlYXRvci5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFN1aXRlIG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gU3VpdGUgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5zZXJ2ZXJFbnRyeT1cIi4uLy4uL3NyYy9pbmRleC5qc1wiXSAtIFRoZSBlbnRyeSBmaWxlIG9mIEBnZW54L3NlcnZlciBpbnN0YW5jZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnZlcmJvc2U9ZmFsc2VdIC0gVmVyYm9zZSBtb2RlLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgY29uc3QgeyBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuc2VydmVyRW50cnkgPSBzZXJ2ZXJFbnRyeSB8fCByZXF1aXJlLm1haW4ucmVxdWlyZShcIi4uLy4uL3NyYy9pbmRleC5qc1wiKTtcbiAgICAgICAgdGhpcy52ZXJib3NlID0gdmVyYm9zZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCB0aGUgQGdlbngvc2VydmVyIGluc3RhY2UgZm9yIGNvZGUgY292ZXJhZ2UgdGVzdGluZy5cbiAgICAgKiBAYXN5bmNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0V2ViU2VydmVyXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXZWIgc2VydmVyIGFscmVhZHkgc3RhcnRlZC5cIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjcmVhdGVXZWJTZXJ2ZXIgPSByZXF1aXJlKHRoaXMuc2VydmVyRW50cnkpO1xuICAgICAgICB0aGlzLndlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgICAgICBleGl0T25VbmNhdWdodDogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLndlYlNlcnZlci5zdGFydGVkID09IG51bGwgfHwgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQubm90LmJlLm9rKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQuYmUub2soKTtcblxuICAgICAgICByZXR1cm4gdGhpcy53ZWJTZXJ2ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB0aGUgc2VydmVyIGlmIGl0IGlzIHN0YXJ0ZWQuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdG9wV2ViU2VydmVySWZTdGFydGVkXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndlYlNlcnZlcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgd29ya2VyIGFwcCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIC0gT3B0aW9ucyBwYXNzZWQgdGhlIHRlc3Qgd29ya2VyLCBzZWUgc3RhcnRXb3JrZXIgb2YgQGdlbngvYXBwLlxuICAgICAqIEBhc3luY1xuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0V29ya2VyXyh0ZXN0VG9SdW4sIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSxcbiAgICAgICAgfSA9IHJlcXVpcmUoXCJAZ2VueC9hcHBcIik7XG4gICAgICAgIFxuICAgICAgICBsZXQgZXJyO1xuXG4gICAgICAgIGF3YWl0IHN0YXJ0V29ya2VyKFxuICAgICAgICAgICAgYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRlc3RUb1J1bihhcHApO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHdvcmtlck5hbWU6IFwidGVzdGVyXCIsXG4gICAgICAgICAgICAgICAgY29uZmlnTmFtZTogXCJ0ZXN0XCIsXG4gICAgICAgICAgICAgICAgY29uZmlnUGF0aDogXCIuL3Rlc3QvY29uZlwiLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZXNQYXRoOiBcImFwcF9tb2R1bGVzXCIsXG4gICAgICAgICAgICAgICAgaWdub3JlVW5jYXVnaHQ6IHRydWUsXG4gICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBzaG91bGQubm90LmV4aXN0KGVyciwgZXJyLm1lc3NhZ2UgfHwgZXJyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgcmVzdCBjbGllbnQgZm9yIHRlc3RpbmdcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBjb25maWcga2V5IG9mIHRhcmdldCBlbmRwb2ludFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VyVGFnIC0gVGhlIGNvbmZpZyBrZXkgb2YgcHJlZGVmaW5lZCB1c2VyIGlkZW50aXR5LCBwYXNzIG51bGwgZm9yIGd1ZXN0IG1vZGUuXG4gICAgICogQHBhcmFtIHt0ZXN0V2l0aFJlc3RDbGllbnR9IHRlc3RUb1J1biAtIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRSZXN0Q2xpZW50XyhuYW1lLCB1c2VyVGFnLCB0ZXN0VG9SdW4sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRXb3JrZXJfKGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMuX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgdXNlclRhZyk7XG4gICAgICAgICAgICByZXR1cm4gdGVzdFRvUnVuKGFwcCwgY2xpZW50KTtcbiAgICAgICAgfSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBpbml0QWxsdXJlKCkge1xuICAgICAgICBpZiAoIWFsbHVyZSkge1xuICAgICAgICAgICAgY29uc3QgYWxsdXJlTW9jaGEgPSByZXF1aXJlKFwiYWxsdXJlLW1vY2hhL3J1bnRpbWVcIik7XG4gICAgICAgICAgICBhbGx1cmUgPSBhbGx1cmVNb2NoYS5hbGx1cmU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWZpbmUgYSB0ZXN0IGNhc2UuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0b3J5IC0gVGVzdCBjYXNlIHRpdGxlLlxuICAgICAqIEBwYXJhbSB7dGVzdENhc2VCb2R5fSBib2R5IC0gVGVzdCBjYXNlIGJvZHkgdG8gd3JpdGUgYWN0dWFsIHRlc3QgY29kZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdXG4gICAgICogQHByb3BlcnR5IHsqfSBvcHRpb25zLmRhdGEgLSBUZXN0IGRhdGFcbiAgICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvcHRpb25zLmNsZWFuVXAgLSBDbGVhbnVwIGFmdGVyIHRoZSBjYXNlIGVuZHMgcmVnYXJkbGVzcyB3aGV0aGVyIGl0IGlzIHN1Y2Nlc3NmdWwgb3Igbm90LlxuICAgICAqL1xuICAgIHRlc3RDYXNlKHN0b3J5LCBib2R5LCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHsgZGF0YSwgY2xlYW5VcCwgc2tpcCwgb25seSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgICAgICBsZXQgb3B0O1xuXG4gICAgICAgIGlmIChvbmx5KSB7XG4gICAgICAgICAgICBvcHQgPSBcIm9ubHlcIjtcbiAgICAgICAgfSBlbHNlIGlmIChza2lwKSB7XG4gICAgICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIChvcHQgPyBpdFtvcHRdIDogaXQpKHN0b3J5LCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoc2VsZi52ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdGFydGluZyBzdG9yeTpcIiwgc3RvcnkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBkZXNjcmlwdGlvbiwgZXBpYywgZmVhdHVyZSwgb3duZXIsIHRhZywgaXNzdWVzLCBzZXZlcml0eSB9ID0gZGF0YS5hbGx1cmU7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gJiYgYWxsdXJlLmRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgZXBpYyAmJiBhbGx1cmUuZXBpYyhlcGljKTtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZSAmJiBhbGx1cmUuZmVhdHVyZShmZWF0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgb3duZXIgJiYgYWxsdXJlLm93bmVyKG93bmVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGFnICYmIGFsbHVyZS50YWcodGFnKTtcbiAgICAgICAgICAgICAgICAgICAgc2V2ZXJpdHkgJiYgYWxsdXJlLnNldmVyaXR5KHNldmVyaXR5KTtcblxuICAgICAgICAgICAgICAgICAgICBfLmlzRW1wdHkoaXNzdWVzKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oaXNzdWVzLCAobGluaywgbnVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLmlzc3VlKG51bSwgbGluayk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhbGx1cmUuc3Rvcnkoc3RvcnkpO1xuICAgICAgICAgICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKGBzdGFydCAke3N0b3J5fWAsICgpID0+IHt9KSgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oZGF0YS5wYXJhbXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIFwiKnNlZSBhdHRhY2htZW50KlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmF0dGFjaE9iamVjdChgcGFyYW1bJHtrfV1gLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2xlYW5VcCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xlYW5VcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVzdCBjYXNlIHdpdGggZml4dHVyZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0b3J5XG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHlcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXG4gICAgICovXG4gICAgdGVzdENhc2VGcm9tRml4dHVyZXMoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3RoaXMubmFtZX0uanNgKTtcbiAgICAgICAgY29uc3Qgc3VpdGVEYXRhID0gcmVxdWlyZShwKTtcbiAgICAgICAgaWYgKCFzdWl0ZURhdGEpIHRocm93IG5ldyBFcnJvcihgU3VpdGUgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX1gKTtcblxuICAgICAgICBjb25zdCB7IGNhc2VzLCAuLi5vdGhlcnMgfSA9IHN1aXRlRGF0YTtcblxuICAgICAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07XG4gICAgICAgIGlmICghc3RvcnlEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN0b3J5IGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9LCBzdG9yeTogJHtzdG9yeX1gKTtcblxuICAgICAgICBfLmNhc3RBcnJheShzdG9yeURhdGEpLmZvckVhY2goKGNhc2VEYXRhLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmVwYXJlZERhdGEgPSB7XG4gICAgICAgICAgICAgICAgYWxsdXJlOiBvdGhlcnMsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiBfLm1hcFZhbHVlcyhjYXNlRGF0YS5wYXJhbXMsICh2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gdigpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZDogY2FzZURhdGEuZXhwZWN0ZWQsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLnRlc3RDYXNlKGAke3N0b3J5fSMke2kgKyAxfWAsIGJvZHksIHsgLi4ub3B0aW9ucywgZGF0YTogcHJlcGFyZWREYXRhIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gYmVuY2htYXJrIGFnYWluc3QgZ2l2ZW4gbWV0aG9kcy5cbiAgICAgKiBAcGFyYW0geyp9IG1hcE9mTWV0aG9kcyAtIE1hcCBvZiBuYW1lIHRvIGZ1bmN0aW9uIHdpdGggcGF5bG9hZFxuICAgICAqIEBwYXJhbSB7Kn0gcGF5bG9hZCBcbiAgICAgKi9cbiAgICBhc3luYyBiZW5jaG1hcmtfKG1hcE9mTWV0aG9kcywgcGF5bG9hZCkge1xuICAgICAgICBjb25zdCBCZW5jaG1hcmsgPSByZXF1aXJlKFwiYmVuY2htYXJrXCIpO1xuICAgICAgICBjb25zdCBzdWl0ZSA9IG5ldyBCZW5jaG1hcmsuU3VpdGUoKTtcblxuICAgICAgICBfLmVhY2gobWFwT2ZNZXRob2RzLCAoZiwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgc3VpdGUuYWRkKG5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBmKHBheWxvYWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgICAgICAgICAgc3VpdGVcbiAgICAgICAgICAgICAgICAub24oXCJjeWNsZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3ljbGVNZXNzYWdlID0gU3RyaW5nKGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGN5Y2xlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KFwiY3ljbGVcIiwgY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5vbihcImNvbXBsZXRlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcGxldGVNZXNzYWdlID0gXCJUaGUgZmFzdGVzdCBpcyBcIiArIHRoaXMuZmlsdGVyKFwiZmFzdGVzdFwiKS5tYXAoXCJuYW1lXCIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb21wbGV0ZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICBzZWxmLmF0dGFjaE9iamVjdChcImNvbXBsZXRlXCIsIGNvbXBsZXRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5vbihcImVycm9yXCIsIChldmVudCkgPT4gcmVqZWN0KFN0cmluZyhldmVudC50YXJnZXQpKSlcbiAgICAgICAgICAgICAgICAucnVuKHsgYXN5bmM6IHRydWUgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmluZSBhIHRlc3Qgc3RlcC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RlcFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtib2R5XSAtIFRlc3Qgc3RlcCBib2R5XG4gICAgICovXG4gICAgYXN5bmMgdGVzdFN0ZXBfKHN0ZXAsIGJvZHkpIHtcbiAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoc3RlcCwgKCkgPT4ge30pKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy52ZXJib3NlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0ZXA6IFwiLCBzdGVwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChib2R5KSB7XG4gICAgICAgICAgICBhd2FpdCBib2R5KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYW4gb2JqZWN0IHRvIHRoZSB0ZXN0IHJlcG9ydC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gb2JqXG4gICAgICovXG4gICAgYXR0YWNoT2JqZWN0KG5hbWUsIG9iaikge1xuICAgICAgICBpZiAoIWFsbHVyZSkgcmV0dXJuO1xuXG4gICAgICAgIGxldCB0eXBlID0gXCJ0ZXh0L3BsYWluXCIsXG4gICAgICAgICAgICBjb250ZW50ID0gb2JqO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCA0KTtcbiAgICAgICAgICAgIHR5cGUgPSBcImFwcGxpY2F0aW9uL2pzb25cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGFsbHVyZS5jcmVhdGVBdHRhY2htZW50KG5hbWUsIGNvbnRlbnQsIHR5cGUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRSZXN0Q2xpZW50XyhhcHAsIG5hbWUsIHVzZXJUYWcpIHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gYXBwLmdldFNlcnZpY2UodGhpcy53ZWJTZXJ2ZXIgPyBgc3VwZXJUZXN0LSR7bmFtZX1gIDogYHJlc3RDbGllbnQtJHtuYW1lfWApO1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGNsaWVudC5zZXJ2ZXIgPSB0aGlzLndlYlNlcnZlci5odHRwU2VydmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjbGllbnQub25TZW50KSB7XG4gICAgICAgICAgICBjbGllbnQub25TZW50ID0gKHVybCwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QodXJsLCByZXN1bHQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdXNlclRhZykge1xuICAgICAgICAgICAgZGVsZXRlIGNsaWVudC5vblNlbmQ7XG4gICAgICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRva2VuLCB1c2VyQXV0aDtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHVzZXJUYWcpKSB7XG4gICAgICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZy51c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gdXNlclRhZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gYXBwLnNldHRpbmdzLnVzZXJBdXRoW3VzZXJUYWddO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGNsaWVudC5wb3N0KHVzZXJBdXRoLmVuZHBvaW50LCB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJBdXRoLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB1c2VyQXV0aC5wYXNzd29yZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdG9rZW4gPSByZXMudG9rZW47XG4gICAgICAgICAgICB0b2tlbkNhY2hlW3VzZXJUYWddID0gdG9rZW47XG5cbiAgICAgICAgICAgIGFwcC5sb2coXCJpbmZvXCIsIGBMb2dnZWQgaW4gd2l0aCBbJHt1c2VyVGFnfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICBjbGllbnQub25TZW5kID0gKHJlcSkgPT4ge1xuICAgICAgICAgICAgcmVxLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke3Rva2VufWApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN1aXRlO1xuIl19