"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("rk-utils");

const tokenCache = {};
let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry || "../../src/index.js";
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = require(this.serverEntry);

    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    return this.startWorker_(async app => {
      const client = await this._getRestClient_(app, name, userTag);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log("Step: ", step);
    }

    if (body) {
      await body();
    }
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest.${name}` : `restClient.${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });
      token = res.token;
      tokenCache[userTag] = token;
      app.log("info", `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set("Authorization", `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJ0b2tlbkNhY2hlIiwiYWxsdXJlIiwiU3VpdGUiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwic2VydmVyRW50cnkiLCJ2ZXJib3NlIiwic3RhcnRXZWJTZXJ2ZXJfIiwid2ViU2VydmVyIiwiRXJyb3IiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0V29ya2VyXyIsInRlc3RUb1J1biIsIlN0YXJ0ZXJzIiwic3RhcnRXb3JrZXIiLCJlcnIiLCJhcHAiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInN0YXJ0UmVzdENsaWVudF8iLCJ1c2VyVGFnIiwiY2xpZW50IiwiX2dldFJlc3RDbGllbnRfIiwiaW5pdEFsbHVyZSIsImFsbHVyZU1vY2hhIiwidGVzdENhc2UiLCJzdG9yeSIsImJvZHkiLCJkYXRhIiwiY2xlYW5VcCIsInNraXAiLCJvbmx5Iiwic2VsZiIsIm9wdCIsIml0IiwiY29uc29sZSIsImxvZyIsImRlc2NyaXB0aW9uIiwiZXBpYyIsImZlYXR1cmUiLCJvd25lciIsInRhZyIsImlzc3VlcyIsInNldmVyaXR5IiwiaXNFbXB0eSIsImZvck93biIsImxpbmsiLCJudW0iLCJpc3N1ZSIsImNyZWF0ZVN0ZXAiLCJwYXJhbXMiLCJ2IiwiayIsInBhcmFtZXRlciIsImF0dGFjaE9iamVjdCIsInRlc3RDYXNlRnJvbUZpeHR1cmVzIiwicCIsInJlc29sdmUiLCJzdWl0ZURhdGEiLCJjYXNlcyIsIm90aGVycyIsInN0b3J5RGF0YSIsImNhc3RBcnJheSIsImZvckVhY2giLCJjYXNlRGF0YSIsImkiLCJwcmVwYXJlZERhdGEiLCJtYXBWYWx1ZXMiLCJleHBlY3RlZCIsImJlbmNobWFya18iLCJtYXBPZk1ldGhvZHMiLCJwYXlsb2FkIiwiQmVuY2htYXJrIiwic3VpdGUiLCJlYWNoIiwiZiIsImFkZCIsIlByb21pc2UiLCJyZWplY3QiLCJvbiIsImV2ZW50IiwiY3ljbGVNZXNzYWdlIiwiU3RyaW5nIiwidGFyZ2V0IiwiY29tcGxldGVNZXNzYWdlIiwiZmlsdGVyIiwibWFwIiwicnVuIiwiYXN5bmMiLCJ0ZXN0U3RlcF8iLCJzdGVwIiwib2JqIiwidHlwZSIsImNvbnRlbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiY3JlYXRlQXR0YWNobWVudCIsImdldFNlcnZpY2UiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib25TZW50IiwidXJsIiwicmVzdWx0Iiwib25TZW5kIiwidG9rZW4iLCJ1c2VyQXV0aCIsImlzUGxhaW5PYmplY3QiLCJzZXR0aW5ncyIsInJlcyIsInBvc3QiLCJlbmRwb2ludCIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJyZXEiLCJzZXQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUQsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBRUEsTUFBTUUsVUFBVSxHQUFHLEVBQW5CO0FBQ0EsSUFBSUMsTUFBSjs7QUF5QkEsTUFBTUMsS0FBTixDQUFZO0FBUVJDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFNBQUtELElBQUwsR0FBWUEsSUFBWjtBQUNBLFVBQU07QUFBRUUsTUFBQUEsV0FBRjtBQUFlQyxNQUFBQTtBQUFmLFFBQTJCRixPQUFPLElBQUksSUFBWCxHQUFrQixFQUFsQixHQUF1QkEsT0FBeEQ7QUFFQSxTQUFLQyxXQUFMLEdBQW1CQSxXQUFXLElBQUksb0JBQWxDO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0g7O0FBT0QsUUFBTUMsZUFBTixHQUF3QjtBQUNwQixRQUFJLEtBQUtDLFNBQVQsRUFBb0I7QUFDaEIsWUFBTSxJQUFJQyxLQUFKLENBQVUsNkJBQVYsQ0FBTjtBQUNIOztBQUVELFVBQU1DLGVBQWUsR0FBR2IsT0FBTyxDQUFDLEtBQUtRLFdBQU4sQ0FBL0I7O0FBQ0EsU0FBS0csU0FBTCxHQUFpQkUsZUFBZSxDQUFDO0FBQzdCQyxNQUFBQSxjQUFjLEVBQUU7QUFEYSxLQUFELENBQWhDO0FBR0EsU0FBS0gsU0FBTCxDQUFlSSxPQUFmLElBQTBCLElBQTFCLElBQWtDLEtBQUtKLFNBQUwsQ0FBZUksT0FBZixDQUF1QkMsTUFBdkIsQ0FBOEJDLEdBQTlCLENBQWtDQyxFQUFsQyxDQUFxQ0MsRUFBckMsRUFBbEM7QUFFQSxVQUFNLEtBQUtSLFNBQUwsQ0FBZVMsTUFBZixFQUFOO0FBRUEsU0FBS1QsU0FBTCxDQUFlSSxPQUFmLENBQXVCQyxNQUF2QixDQUE4QkUsRUFBOUIsQ0FBaUNDLEVBQWpDO0FBRUEsV0FBTyxLQUFLUixTQUFaO0FBQ0g7O0FBT0QsUUFBTVUsdUJBQU4sR0FBZ0M7QUFDNUIsUUFBSSxLQUFLVixTQUFULEVBQW9CO0FBQ2hCLFVBQUksS0FBS0EsU0FBTCxDQUFlSSxPQUFuQixFQUE0QjtBQUN4QixjQUFNLEtBQUtKLFNBQUwsQ0FBZVcsS0FBZixFQUFOO0FBQ0g7O0FBRUQsYUFBTyxLQUFLWCxTQUFaO0FBQ0g7QUFDSjs7QUFRRCxRQUFNWSxZQUFOLENBQW1CQyxTQUFuQixFQUE4QmpCLE9BQTlCLEVBQXVDO0FBQ25DLFVBQU07QUFDRmtCLE1BQUFBLFFBQVEsRUFBRTtBQUFFQyxRQUFBQTtBQUFGO0FBRFIsUUFFRjFCLE9BQU8sQ0FBQyxXQUFELENBRlg7O0FBSUEsUUFBSTJCLEdBQUo7QUFFQSxVQUFNRCxXQUFXLENBQ2IsTUFBT0UsR0FBUCxJQUFlO0FBQ1gsVUFBSTtBQUNBLGNBQU1KLFNBQVMsQ0FBQ0ksR0FBRCxDQUFmO0FBQ0gsT0FGRCxDQUVFLE9BQU9DLENBQVAsRUFBVTtBQUNSRixRQUFBQSxHQUFHLEdBQUdFLENBQU47QUFDSDtBQUNKLEtBUFksRUFRYjtBQUNJQyxNQUFBQSxVQUFVLEVBQUUsUUFEaEI7QUFFSUMsTUFBQUEsVUFBVSxFQUFFLE1BRmhCO0FBR0lDLE1BQUFBLFVBQVUsRUFBRSxhQUhoQjtBQUlJQyxNQUFBQSxjQUFjLEVBQUUsYUFKcEI7QUFLSUMsTUFBQUEsY0FBYyxFQUFFLElBTHBCO0FBTUksU0FBRzNCO0FBTlAsS0FSYSxDQUFqQjs7QUFrQkEsUUFBSW9CLEdBQUosRUFBUztBQUNMWCxNQUFBQSxNQUFNLENBQUNDLEdBQVAsQ0FBV2tCLEtBQVgsQ0FBaUJSLEdBQWpCLEVBQXNCQSxHQUFHLENBQUNTLE9BQUosSUFBZVQsR0FBckM7QUFDSDtBQUNKOztBQVVELFFBQU1VLGdCQUFOLENBQXVCL0IsSUFBdkIsRUFBNkJnQyxPQUE3QixFQUFzQ2QsU0FBdEMsRUFBaURqQixPQUFqRCxFQUEwRDtBQUN0RCxXQUFPLEtBQUtnQixZQUFMLENBQWtCLE1BQU9LLEdBQVAsSUFBZTtBQUNwQyxZQUFNVyxNQUFNLEdBQUcsTUFBTSxLQUFLQyxlQUFMLENBQXFCWixHQUFyQixFQUEwQnRCLElBQTFCLEVBQWdDZ0MsT0FBaEMsQ0FBckI7QUFDQSxhQUFPZCxTQUFTLENBQUNJLEdBQUQsRUFBTVcsTUFBTixDQUFoQjtBQUNILEtBSE0sRUFHSmhDLE9BSEksQ0FBUDtBQUlIOztBQUtEa0MsRUFBQUEsVUFBVSxHQUFHO0FBQ1QsUUFBSSxDQUFDdEMsTUFBTCxFQUFhO0FBQ1QsWUFBTXVDLFdBQVcsR0FBRzFDLE9BQU8sQ0FBQyxzQkFBRCxDQUEzQjs7QUFDQUcsTUFBQUEsTUFBTSxHQUFHdUMsV0FBVyxDQUFDdkMsTUFBckI7QUFDSDtBQUNKOztBQVVEd0MsRUFBQUEsUUFBUSxDQUFDQyxLQUFELEVBQVFDLElBQVIsRUFBY3RDLE9BQWQsRUFBdUI7QUFDM0IsVUFBTTtBQUFFdUMsTUFBQUEsSUFBRjtBQUFRQyxNQUFBQSxPQUFSO0FBQWlCQyxNQUFBQSxJQUFqQjtBQUF1QkMsTUFBQUE7QUFBdkIsUUFBZ0MxQyxPQUFPLElBQUksSUFBWCxHQUFrQixFQUFsQixHQUF1QkEsT0FBN0Q7QUFDQSxVQUFNMkMsSUFBSSxHQUFHLElBQWI7QUFFQSxRQUFJQyxHQUFKOztBQUVBLFFBQUlGLElBQUosRUFBVTtBQUNORSxNQUFBQSxHQUFHLEdBQUcsTUFBTjtBQUNILEtBRkQsTUFFTyxJQUFJSCxJQUFKLEVBQVU7QUFDYkcsTUFBQUEsR0FBRyxHQUFHLE1BQU47QUFDSDs7QUFFRCxLQUFDQSxHQUFHLEdBQUdDLEVBQUUsQ0FBQ0QsR0FBRCxDQUFMLEdBQWFDLEVBQWpCLEVBQXFCUixLQUFyQixFQUE0QixrQkFBa0I7QUFDMUMsVUFBSU0sSUFBSSxDQUFDekMsT0FBVCxFQUFrQjtBQUNkNEMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksaUJBQVosRUFBK0JWLEtBQS9CO0FBQ0g7O0FBRUQsVUFBSXpDLE1BQUosRUFBWTtBQUNSLFlBQUkyQyxJQUFKLEVBQVU7QUFDTixnQkFBTTtBQUFFUyxZQUFBQSxXQUFGO0FBQWVDLFlBQUFBLElBQWY7QUFBcUJDLFlBQUFBLE9BQXJCO0FBQThCQyxZQUFBQSxLQUE5QjtBQUFxQ0MsWUFBQUEsR0FBckM7QUFBMENDLFlBQUFBLE1BQTFDO0FBQWtEQyxZQUFBQTtBQUFsRCxjQUErRGYsSUFBSSxDQUFDM0MsTUFBMUU7QUFFQW9ELFVBQUFBLFdBQVcsSUFBSXBELE1BQU0sQ0FBQ29ELFdBQVAsQ0FBbUJBLFdBQW5CLENBQWY7QUFDQUMsVUFBQUEsSUFBSSxJQUFJckQsTUFBTSxDQUFDcUQsSUFBUCxDQUFZQSxJQUFaLENBQVI7QUFDQUMsVUFBQUEsT0FBTyxJQUFJdEQsTUFBTSxDQUFDc0QsT0FBUCxDQUFlQSxPQUFmLENBQVg7QUFDQUMsVUFBQUEsS0FBSyxJQUFJdkQsTUFBTSxDQUFDdUQsS0FBUCxDQUFhQSxLQUFiLENBQVQ7QUFDQUMsVUFBQUEsR0FBRyxJQUFJeEQsTUFBTSxDQUFDd0QsR0FBUCxDQUFXQSxHQUFYLENBQVA7QUFDQUUsVUFBQUEsUUFBUSxJQUFJMUQsTUFBTSxDQUFDMEQsUUFBUCxDQUFnQkEsUUFBaEIsQ0FBWjtBQUVBNUQsVUFBQUEsQ0FBQyxDQUFDNkQsT0FBRixDQUFVRixNQUFWLEtBQ0kzRCxDQUFDLENBQUM4RCxNQUFGLENBQVNILE1BQVQsRUFBaUIsQ0FBQ0ksSUFBRCxFQUFPQyxHQUFQLEtBQWU7QUFDNUI5RCxZQUFBQSxNQUFNLENBQUMrRCxLQUFQLENBQWFELEdBQWIsRUFBa0JELElBQWxCO0FBQ0gsV0FGRCxDQURKO0FBSUg7O0FBRUQ3RCxRQUFBQSxNQUFNLENBQUN5QyxLQUFQLENBQWFBLEtBQWI7QUFDQXpDLFFBQUFBLE1BQU0sQ0FBQ2dFLFVBQVAsQ0FBbUIsU0FBUXZCLEtBQU0sRUFBakMsRUFBb0MsTUFBTSxDQUFFLENBQTVDOztBQUVBLFlBQUlFLElBQUksSUFBSUEsSUFBSSxDQUFDc0IsTUFBakIsRUFBeUI7QUFDckJuRSxVQUFBQSxDQUFDLENBQUM4RCxNQUFGLENBQVNqQixJQUFJLENBQUNzQixNQUFkLEVBQXNCLENBQUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVO0FBQzVCLGdCQUFJLE9BQU9ELENBQVAsS0FBYSxRQUFqQixFQUEyQjtBQUN2QmxFLGNBQUFBLE1BQU0sQ0FBQ29FLFNBQVAsQ0FBaUJELENBQWpCLEVBQW9CLGtCQUFwQjtBQUNBcEIsY0FBQUEsSUFBSSxDQUFDc0IsWUFBTCxDQUFtQixTQUFRRixDQUFFLEdBQTdCLEVBQWlDRCxDQUFqQztBQUNILGFBSEQsTUFHTztBQUNIbEUsY0FBQUEsTUFBTSxDQUFDb0UsU0FBUCxDQUFpQkQsQ0FBakIsRUFBb0JELENBQXBCO0FBQ0g7QUFDSixXQVBEO0FBUUg7QUFDSjs7QUFFRCxVQUFJdEIsT0FBSixFQUFhO0FBQ1QsWUFBSTtBQUNBLGdCQUFNRixJQUFJLENBQUNDLElBQUQsQ0FBVjtBQUNILFNBRkQsU0FFVTtBQUNOLGdCQUFNQyxPQUFPLEVBQWI7QUFDSDtBQUNKLE9BTkQsTUFNTztBQUNILGNBQU1GLElBQUksQ0FBQ0MsSUFBRCxDQUFWO0FBQ0g7QUFDSixLQTlDRDtBQStDSDs7QUFRRDJCLEVBQUFBLG9CQUFvQixDQUFDN0IsS0FBRCxFQUFRQyxJQUFSLEVBQWN0QyxPQUFkLEVBQXVCO0FBQ3ZDLFVBQU1tRSxDQUFDLEdBQUczRSxJQUFJLENBQUM0RSxPQUFMLENBQWMsaUJBQWdCLEtBQUtyRSxJQUFLLEtBQXhDLENBQVY7O0FBQ0EsVUFBTXNFLFNBQVMsR0FBRzVFLE9BQU8sQ0FBQzBFLENBQUQsQ0FBekI7O0FBQ0EsUUFBSSxDQUFDRSxTQUFMLEVBQWdCLE1BQU0sSUFBSWhFLEtBQUosQ0FBVyxnQ0FBK0IsS0FBS04sSUFBSyxFQUFwRCxDQUFOO0FBRWhCLFVBQU07QUFBRXVFLE1BQUFBLEtBQUY7QUFBUyxTQUFHQztBQUFaLFFBQXVCRixTQUE3QjtBQUVBLFVBQU1HLFNBQVMsR0FBR0YsS0FBSyxJQUFJQSxLQUFLLENBQUNqQyxLQUFELENBQWhDO0FBQ0EsUUFBSSxDQUFDbUMsU0FBTCxFQUFnQixNQUFNLElBQUluRSxLQUFKLENBQVcsZ0NBQStCLEtBQUtOLElBQUssWUFBV3NDLEtBQU0sRUFBckUsQ0FBTjs7QUFFaEIzQyxJQUFBQSxDQUFDLENBQUMrRSxTQUFGLENBQVlELFNBQVosRUFBdUJFLE9BQXZCLENBQStCLENBQUNDLFFBQUQsRUFBV0MsQ0FBWCxLQUFpQjtBQUM1QyxZQUFNQyxZQUFZLEdBQUc7QUFDakJqRixRQUFBQSxNQUFNLEVBQUUyRSxNQURTO0FBRWpCVixRQUFBQSxNQUFNLEVBQUVuRSxDQUFDLENBQUNvRixTQUFGLENBQVlILFFBQVEsQ0FBQ2QsTUFBckIsRUFBOEJDLENBQUQsSUFBTztBQUN4QyxjQUFJLE9BQU9BLENBQVAsS0FBYSxVQUFqQixFQUE2QixPQUFPQSxDQUFDLEVBQVI7QUFDN0IsaUJBQU9BLENBQVA7QUFDSCxTQUhPLENBRlM7QUFNakJpQixRQUFBQSxRQUFRLEVBQUVKLFFBQVEsQ0FBQ0k7QUFORixPQUFyQjtBQVNBLFdBQUszQyxRQUFMLENBQWUsR0FBRUMsS0FBTSxJQUFHdUMsQ0FBQyxHQUFHLENBQUUsRUFBaEMsRUFBbUN0QyxJQUFuQyxFQUF5QyxFQUFFLEdBQUd0QyxPQUFMO0FBQWN1QyxRQUFBQSxJQUFJLEVBQUVzQztBQUFwQixPQUF6QztBQUNILEtBWEQ7QUFZSDs7QUFPRCxRQUFNRyxVQUFOLENBQWlCQyxZQUFqQixFQUErQkMsT0FBL0IsRUFBd0M7QUFDcEMsVUFBTUMsU0FBUyxHQUFHMUYsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsVUFBTTJGLEtBQUssR0FBRyxJQUFJRCxTQUFTLENBQUN0RixLQUFkLEVBQWQ7O0FBRUFILElBQUFBLENBQUMsQ0FBQzJGLElBQUYsQ0FBT0osWUFBUCxFQUFxQixDQUFDSyxDQUFELEVBQUl2RixJQUFKLEtBQWE7QUFDOUJxRixNQUFBQSxLQUFLLENBQUNHLEdBQU4sQ0FBVXhGLElBQVYsRUFBZ0IsWUFBWTtBQUN4QnVGLFFBQUFBLENBQUMsQ0FBQ0osT0FBRCxDQUFEO0FBQ0gsT0FGRDtBQUdILEtBSkQ7O0FBTUEsV0FBTyxJQUFJTSxPQUFKLENBQVksQ0FBQ3BCLE9BQUQsRUFBVXFCLE1BQVYsS0FBcUI7QUFDcEMsWUFBTTlDLElBQUksR0FBRyxJQUFiO0FBRUF5QyxNQUFBQSxLQUFLLENBQ0FNLEVBREwsQ0FDUSxPQURSLEVBQ2tCQyxLQUFELElBQVc7QUFDcEIsY0FBTUMsWUFBWSxHQUFHQyxNQUFNLENBQUNGLEtBQUssQ0FBQ0csTUFBUCxDQUEzQjtBQUNBaEQsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVk2QyxZQUFaO0FBQ0EsYUFBSzNCLFlBQUwsQ0FBa0IsT0FBbEIsRUFBMkIyQixZQUEzQjtBQUNILE9BTEwsRUFNS0YsRUFOTCxDQU1RLFVBTlIsRUFNb0IsWUFBWTtBQUN4QixjQUFNSyxlQUFlLEdBQUcsb0JBQW9CLEtBQUtDLE1BQUwsQ0FBWSxTQUFaLEVBQXVCQyxHQUF2QixDQUEyQixNQUEzQixDQUE1QztBQUNBbkQsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlnRCxlQUFaO0FBQ0FwRCxRQUFBQSxJQUFJLENBQUNzQixZQUFMLENBQWtCLFVBQWxCLEVBQThCOEIsZUFBOUI7QUFDQTNCLFFBQUFBLE9BQU87QUFDVixPQVhMLEVBWUtzQixFQVpMLENBWVEsT0FaUixFQVlrQkMsS0FBRCxJQUFXRixNQUFNLENBQUNJLE1BQU0sQ0FBQ0YsS0FBSyxDQUFDRyxNQUFQLENBQVAsQ0FabEMsRUFhS0ksR0FiTCxDQWFTO0FBQUVDLFFBQUFBLEtBQUssRUFBRTtBQUFULE9BYlQ7QUFjSCxLQWpCTSxDQUFQO0FBa0JIOztBQU9ELFFBQU1DLFNBQU4sQ0FBZ0JDLElBQWhCLEVBQXNCL0QsSUFBdEIsRUFBNEI7QUFDeEIsUUFBSTFDLE1BQUosRUFBWTtBQUNSQSxNQUFBQSxNQUFNLENBQUNnRSxVQUFQLENBQWtCeUMsSUFBbEIsRUFBd0IsTUFBTSxDQUFFLENBQWhDO0FBQ0g7O0FBRUQsUUFBSSxLQUFLbkcsT0FBVCxFQUFrQjtBQUNkNEMsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksUUFBWixFQUFzQnNELElBQXRCO0FBQ0g7O0FBRUQsUUFBSS9ELElBQUosRUFBVTtBQUNOLFlBQU1BLElBQUksRUFBVjtBQUNIO0FBQ0o7O0FBT0QyQixFQUFBQSxZQUFZLENBQUNsRSxJQUFELEVBQU91RyxHQUFQLEVBQVk7QUFDcEIsUUFBSSxDQUFDMUcsTUFBTCxFQUFhO0FBRWIsUUFBSTJHLElBQUksR0FBRyxZQUFYO0FBQUEsUUFDSUMsT0FBTyxHQUFHRixHQURkOztBQUdBLFFBQUksT0FBT0EsR0FBUCxLQUFlLFFBQW5CLEVBQTZCO0FBQ3pCRSxNQUFBQSxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsU0FBTCxDQUFlSixHQUFmLEVBQW9CLElBQXBCLEVBQTBCLENBQTFCLENBQVY7QUFDQUMsTUFBQUEsSUFBSSxHQUFHLGtCQUFQO0FBQ0g7O0FBRUQzRyxJQUFBQSxNQUFNLENBQUMrRyxnQkFBUCxDQUF3QjVHLElBQXhCLEVBQThCeUcsT0FBOUIsRUFBdUNELElBQXZDO0FBQ0g7O0FBRUQsUUFBTXRFLGVBQU4sQ0FBc0JaLEdBQXRCLEVBQTJCdEIsSUFBM0IsRUFBaUNnQyxPQUFqQyxFQUEwQztBQUN0QyxVQUFNQyxNQUFNLEdBQUdYLEdBQUcsQ0FBQ3VGLFVBQUosQ0FBZSxLQUFLeEcsU0FBTCxHQUFrQixhQUFZTCxJQUFLLEVBQW5DLEdBQXdDLGNBQWFBLElBQUssRUFBekUsQ0FBZjs7QUFDQSxRQUFJLEtBQUtLLFNBQVQsRUFBb0I7QUFDaEI0QixNQUFBQSxNQUFNLENBQUM2RSxNQUFQLEdBQWdCLEtBQUt6RyxTQUFMLENBQWUwRyxVQUEvQjtBQUNIOztBQUVELFFBQUksQ0FBQzlFLE1BQU0sQ0FBQytFLE1BQVosRUFBb0I7QUFDaEIvRSxNQUFBQSxNQUFNLENBQUMrRSxNQUFQLEdBQWdCLENBQUNDLEdBQUQsRUFBTUMsTUFBTixLQUFpQjtBQUM3QixhQUFLaEQsWUFBTCxDQUFrQitDLEdBQWxCLEVBQXVCQyxNQUF2QjtBQUNILE9BRkQ7QUFHSDs7QUFFRCxRQUFJLENBQUNsRixPQUFMLEVBQWM7QUFDVixhQUFPQyxNQUFNLENBQUNrRixNQUFkO0FBQ0EsYUFBT2xGLE1BQVA7QUFDSDs7QUFFRCxRQUFJbUYsS0FBSixFQUFXQyxRQUFYOztBQUVBLFFBQUkxSCxDQUFDLENBQUMySCxhQUFGLENBQWdCdEYsT0FBaEIsQ0FBSixFQUE4QjtBQUMxQm9GLE1BQUFBLEtBQUssR0FBR3hILFVBQVUsQ0FBQ29DLE9BQU8sQ0FBQ0EsT0FBVCxDQUFsQjtBQUNBcUYsTUFBQUEsUUFBUSxHQUFHckYsT0FBWDtBQUNILEtBSEQsTUFHTztBQUNIb0YsTUFBQUEsS0FBSyxHQUFHeEgsVUFBVSxDQUFDb0MsT0FBRCxDQUFsQjtBQUNBcUYsTUFBQUEsUUFBUSxHQUFHL0YsR0FBRyxDQUFDaUcsUUFBSixDQUFhRixRQUFiLENBQXNCckYsT0FBdEIsQ0FBWDtBQUNIOztBQUVELFFBQUksQ0FBQ29GLEtBQUwsRUFBWTtBQUNSLFVBQUlJLEdBQUcsR0FBRyxNQUFNdkYsTUFBTSxDQUFDd0YsSUFBUCxDQUFZSixRQUFRLENBQUNLLFFBQXJCLEVBQStCO0FBQzNDQyxRQUFBQSxRQUFRLEVBQUVOLFFBQVEsQ0FBQ00sUUFEd0I7QUFFM0NDLFFBQUFBLFFBQVEsRUFBRVAsUUFBUSxDQUFDTztBQUZ3QixPQUEvQixDQUFoQjtBQUlBUixNQUFBQSxLQUFLLEdBQUdJLEdBQUcsQ0FBQ0osS0FBWjtBQUNBeEgsTUFBQUEsVUFBVSxDQUFDb0MsT0FBRCxDQUFWLEdBQXNCb0YsS0FBdEI7QUFFQTlGLE1BQUFBLEdBQUcsQ0FBQzBCLEdBQUosQ0FBUSxNQUFSLEVBQWlCLG1CQUFrQmhCLE9BQVEsSUFBM0M7QUFDSDs7QUFFREMsSUFBQUEsTUFBTSxDQUFDa0YsTUFBUCxHQUFpQlUsR0FBRCxJQUFTO0FBQ3JCQSxNQUFBQSxHQUFHLENBQUNDLEdBQUosQ0FBUSxlQUFSLEVBQTBCLFVBQVNWLEtBQU0sRUFBekM7QUFDSCxLQUZEOztBQUlBLFdBQU9uRixNQUFQO0FBQ0g7O0FBMVVPOztBQTZVWjhGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmxJLEtBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKFwicmstdXRpbHNcIik7XG5cbmNvbnN0IHRva2VuQ2FjaGUgPSB7fTtcbmxldCBhbGx1cmU7XG5cbi8qKlxuICogVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICogQGNhbGxiYWNrIHRlc3RXaXRoUmVzdENsaWVudFxuICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBhcHBcbiAqIEBwYXJhbSB7UmVzdENsaWVudH0gY2xpZW50IC0gVGhlIHJlc3QgY2xpZW50XG4gKi9cblxuLyoqXG4gKiBUZXN0IGZ1bmN0aW9uIHdpdGggYSB3b3JrZXIgYXBwLlxuICogQGNhbGxiYWNrIHRlc3RXaXRoQXBwXG4gKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcFxuICovXG5cbi8qKlxuICogVGVzdCBjYXNlIGJvZHkuXG4gKiBAY2FsbGJhY2sgdGVzdENhc2VCb2R5XG4gKiBAcGFyYW0geyp9IGRhdGEgLSBUZXN0IGRhdGFcbiAqL1xuXG4vKipcbiAqIFRlc3Qgc3VpdGUgb2JqZWN0LlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIFN1aXRlIHtcbiAgICAvKipcbiAgICAgKiBbcHJpdmF0ZV0gU3VpdGUgd2lsbCBiZSBjcmVhdGVkIGJ5IHRlc3RTdWl0ZSBjcmVhdG9yLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gU3VpdGUgbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBTdWl0ZSBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnNlcnZlckVudHJ5PVwiLi4vLi4vc3JjL2luZGV4LmpzXCJdIC0gVGhlIGVudHJ5IGZpbGUgb2YgQGdlbngvc2VydmVyIGluc3RhbmNlLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudmVyYm9zZT1mYWxzZV0gLSBWZXJib3NlIG1vZGUuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICBjb25zdCB7IHNlcnZlckVudHJ5LCB2ZXJib3NlIH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG5cbiAgICAgICAgdGhpcy5zZXJ2ZXJFbnRyeSA9IHNlcnZlckVudHJ5IHx8IFwiLi4vLi4vc3JjL2luZGV4LmpzXCI7XG4gICAgICAgIHRoaXMudmVyYm9zZSA9IHZlcmJvc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIEBnZW54L3NlcnZlciBpbnN0YWNlIGZvciBjb2RlIGNvdmVyYWdlIHRlc3RpbmcuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdlYlNlcnZlcl8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2ViIHNlcnZlciBhbHJlYWR5IHN0YXJ0ZWQuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3JlYXRlV2ViU2VydmVyID0gcmVxdWlyZSh0aGlzLnNlcnZlckVudHJ5KTtcbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIgPSBjcmVhdGVXZWJTZXJ2ZXIoe1xuICAgICAgICAgICAgZXhpdE9uVW5jYXVnaHQ6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCA9PSBudWxsIHx8IHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLm5vdC5iZS5vaygpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0YXJ0XygpO1xuXG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLmJlLm9rKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMud2ViU2VydmVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIHNlcnZlciBpZiBpdCBpcyBzdGFydGVkLlxuICAgICAqIEBhc3luY1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgYXN5bmMgc3RvcFdlYlNlcnZlcklmU3RhcnRlZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLndlYlNlcnZlci5zdG9wXygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy53ZWJTZXJ2ZXI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBhIHdvcmtlciBhcHAgZm9yIHRlc3RpbmdcbiAgICAgKiBAcGFyYW0ge3Rlc3RXaXRoUmVzdENsaWVudH0gdGVzdFRvUnVuIC0gVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyAtIE9wdGlvbnMgcGFzc2VkIHRoZSB0ZXN0IHdvcmtlciwgc2VlIHN0YXJ0V29ya2VyIG9mIEBnZW54L2FwcC5cbiAgICAgKiBAYXN5bmNcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdvcmtlcl8odGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIFN0YXJ0ZXJzOiB7IHN0YXJ0V29ya2VyIH0sXG4gICAgICAgIH0gPSByZXF1aXJlKFwiQGdlbngvYXBwXCIpO1xuICAgICAgICBcbiAgICAgICAgbGV0IGVycjtcblxuICAgICAgICBhd2FpdCBzdGFydFdvcmtlcihcbiAgICAgICAgICAgIGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0ZXN0VG9SdW4oYXBwKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ1BhdGg6IFwiLi90ZXN0L2NvbmZcIixcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGVzUGF0aDogXCJhcHBfbW9kdWxlc1wiLFxuICAgICAgICAgICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgc2hvdWxkLm5vdC5leGlzdChlcnIsIGVyci5tZXNzYWdlIHx8IGVycik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBhIHJlc3QgY2xpZW50IGZvciB0ZXN0aW5nXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgY29uZmlnIGtleSBvZiB0YXJnZXQgZW5kcG9pbnRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXNlclRhZyAtIFRoZSBjb25maWcga2V5IG9mIHByZWRlZmluZWQgdXNlciBpZGVudGl0eSwgcGFzcyBudWxsIGZvciBndWVzdCBtb2RlLlxuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIC0gT3B0aW9ucyBwYXNzZWQgdGhlIHRlc3Qgd29ya2VyLCBzZWUgc3RhcnRXb3JrZXIgb2YgQGdlbngvYXBwLlxuICAgICAqIEBhc3luY1xuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0UmVzdENsaWVudF8obmFtZSwgdXNlclRhZywgdGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXJ0V29ya2VyXyhhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLl9nZXRSZXN0Q2xpZW50XyhhcHAsIG5hbWUsIHVzZXJUYWcpO1xuICAgICAgICAgICAgcmV0dXJuIHRlc3RUb1J1bihhcHAsIGNsaWVudCk7XG4gICAgICAgIH0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgaW5pdEFsbHVyZSgpIHtcbiAgICAgICAgaWYgKCFhbGx1cmUpIHtcbiAgICAgICAgICAgIGNvbnN0IGFsbHVyZU1vY2hhID0gcmVxdWlyZShcImFsbHVyZS1tb2NoYS9ydW50aW1lXCIpO1xuICAgICAgICAgICAgYWxsdXJlID0gYWxsdXJlTW9jaGEuYWxsdXJlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lIGEgdGVzdCBjYXNlLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdG9yeSAtIFRlc3QgY2FzZSB0aXRsZS5cbiAgICAgKiBAcGFyYW0ge3Rlc3RDYXNlQm9keX0gYm9keSAtIFRlc3QgY2FzZSBib2R5IHRvIHdyaXRlIGFjdHVhbCB0ZXN0IGNvZGUuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXVxuICAgICAqIEBwcm9wZXJ0eSB7Kn0gb3B0aW9ucy5kYXRhIC0gVGVzdCBkYXRhXG4gICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5jbGVhblVwIC0gQ2xlYW51cCBhZnRlciB0aGUgY2FzZSBlbmRzIHJlZ2FyZGxlc3Mgd2hldGhlciBpdCBpcyBzdWNjZXNzZnVsIG9yIG5vdC5cbiAgICAgKi9cbiAgICB0ZXN0Q2FzZShzdG9yeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCB7IGRhdGEsIGNsZWFuVXAsIHNraXAsIG9ubHkgfSA9IG9wdGlvbnMgPT0gbnVsbCA/IHt9IDogb3B0aW9ucztcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IG9wdDtcblxuICAgICAgICBpZiAob25seSkge1xuICAgICAgICAgICAgb3B0ID0gXCJvbmx5XCI7XG4gICAgICAgIH0gZWxzZSBpZiAoc2tpcCkge1xuICAgICAgICAgICAgb3B0ID0gXCJza2lwXCI7XG4gICAgICAgIH1cblxuICAgICAgICAob3B0ID8gaXRbb3B0XSA6IGl0KShzdG9yeSwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHNlbGYudmVyYm9zZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgc3Rvcnk6XCIsIHN0b3J5KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGVzY3JpcHRpb24sIGVwaWMsIGZlYXR1cmUsIG93bmVyLCB0YWcsIGlzc3Vlcywgc2V2ZXJpdHkgfSA9IGRhdGEuYWxsdXJlO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uICYmIGFsbHVyZS5kZXNjcmlwdGlvbihkZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGVwaWMgJiYgYWxsdXJlLmVwaWMoZXBpYyk7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmUgJiYgYWxsdXJlLmZlYXR1cmUoZmVhdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgIG93bmVyICYmIGFsbHVyZS5vd25lcihvd25lcik7XG4gICAgICAgICAgICAgICAgICAgIHRhZyAmJiBhbGx1cmUudGFnKHRhZyk7XG4gICAgICAgICAgICAgICAgICAgIHNldmVyaXR5ICYmIGFsbHVyZS5zZXZlcml0eShzZXZlcml0eSk7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5pc0VtcHR5KGlzc3VlcykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGlzc3VlcywgKGxpbmssIG51bSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5pc3N1ZShudW0sIGxpbmspO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYWxsdXJlLnN0b3J5KHN0b3J5KTtcbiAgICAgICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChgc3RhcnQgJHtzdG9yeX1gLCAoKSA9PiB7fSkoKTtcblxuICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgICAgIF8uZm9yT3duKGRhdGEucGFyYW1zLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCBcIipzZWUgYXR0YWNobWVudCpcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hdHRhY2hPYmplY3QoYHBhcmFtWyR7a31dYCwgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNsZWFuVXApIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgICAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNsZWFuVXAoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRlc3QgY2FzZSB3aXRoIGZpeHR1cmVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdG9yeVxuICAgICAqIEBwYXJhbSB7dGVzdENhc2VCb2R5fSBib2R5XG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxuICAgICAqL1xuICAgIHRlc3RDYXNlRnJvbUZpeHR1cmVzKHN0b3J5LCBib2R5LCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHAgPSBwYXRoLnJlc29sdmUoYHRlc3QvZml4dHVyZXMvJHt0aGlzLm5hbWV9LmpzYCk7XG4gICAgICAgIGNvbnN0IHN1aXRlRGF0YSA9IHJlcXVpcmUocCk7XG4gICAgICAgIGlmICghc3VpdGVEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN1aXRlIGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9YCk7XG5cbiAgICAgICAgY29uc3QgeyBjYXNlcywgLi4ub3RoZXJzIH0gPSBzdWl0ZURhdGE7XG5cbiAgICAgICAgY29uc3Qgc3RvcnlEYXRhID0gY2FzZXMgJiYgY2FzZXNbc3RvcnldO1xuICAgICAgICBpZiAoIXN0b3J5RGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdG9yeSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7dGhpcy5uYW1lfSwgc3Rvcnk6ICR7c3Rvcnl9YCk7XG5cbiAgICAgICAgXy5jYXN0QXJyYXkoc3RvcnlEYXRhKS5mb3JFYWNoKChjYXNlRGF0YSwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJlcGFyZWREYXRhID0ge1xuICAgICAgICAgICAgICAgIGFsbHVyZTogb3RoZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtczogXy5tYXBWYWx1ZXMoY2FzZURhdGEucGFyYW1zLCAodikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIHYoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZXhwZWN0ZWQ6IGNhc2VEYXRhLmV4cGVjdGVkLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy50ZXN0Q2FzZShgJHtzdG9yeX0jJHtpICsgMX1gLCBib2R5LCB7IC4uLm9wdGlvbnMsIGRhdGE6IHByZXBhcmVkRGF0YSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIGJlbmNobWFyayBhZ2FpbnN0IGdpdmVuIG1ldGhvZHMuXG4gICAgICogQHBhcmFtIHsqfSBtYXBPZk1ldGhvZHMgLSBNYXAgb2YgbmFtZSB0byBmdW5jdGlvbiB3aXRoIHBheWxvYWRcbiAgICAgKiBAcGFyYW0geyp9IHBheWxvYWQgXG4gICAgICovXG4gICAgYXN5bmMgYmVuY2htYXJrXyhtYXBPZk1ldGhvZHMsIHBheWxvYWQpIHtcbiAgICAgICAgY29uc3QgQmVuY2htYXJrID0gcmVxdWlyZShcImJlbmNobWFya1wiKTtcbiAgICAgICAgY29uc3Qgc3VpdGUgPSBuZXcgQmVuY2htYXJrLlN1aXRlKCk7XG5cbiAgICAgICAgXy5lYWNoKG1hcE9mTWV0aG9kcywgKGYsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHN1aXRlLmFkZChuYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZihwYXlsb2FkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgICAgIHN1aXRlXG4gICAgICAgICAgICAgICAgLm9uKFwiY3ljbGVcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5Y2xlTWVzc2FnZSA9IFN0cmluZyhldmVudC50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjeWNsZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaE9iamVjdChcImN5Y2xlXCIsIGN5Y2xlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAub24oXCJjb21wbGV0ZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRlTWVzc2FnZSA9IFwiVGhlIGZhc3Rlc3QgaXMgXCIgKyB0aGlzLmZpbHRlcihcImZhc3Rlc3RcIikubWFwKFwibmFtZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY29tcGxldGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5hdHRhY2hPYmplY3QoXCJjb21wbGV0ZVwiLCBjb21wbGV0ZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAub24oXCJlcnJvclwiLCAoZXZlbnQpID0+IHJlamVjdChTdHJpbmcoZXZlbnQudGFyZ2V0KSkpXG4gICAgICAgICAgICAgICAgLnJ1bih7IGFzeW5jOiB0cnVlIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWZpbmUgYSB0ZXN0IHN0ZXAuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0ZXBcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbYm9keV0gLSBUZXN0IHN0ZXAgYm9keVxuICAgICAqL1xuICAgIGFzeW5jIHRlc3RTdGVwXyhzdGVwLCBib2R5KSB7XG4gICAgICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IHt9KSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudmVyYm9zZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdGVwOiBcIiwgc3RlcCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYm9keSkge1xuICAgICAgICAgICAgYXdhaXQgYm9keSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoIGFuIG9iamVjdCB0byB0aGUgdGVzdCByZXBvcnQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IG9ialxuICAgICAqL1xuICAgIGF0dGFjaE9iamVjdChuYW1lLCBvYmopIHtcbiAgICAgICAgaWYgKCFhbGx1cmUpIHJldHVybjtcblxuICAgICAgICBsZXQgdHlwZSA9IFwidGV4dC9wbGFpblwiLFxuICAgICAgICAgICAgY29udGVudCA9IG9iajtcblxuICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgICAgICB0eXBlID0gXCJhcHBsaWNhdGlvbi9qc29uXCI7XG4gICAgICAgIH1cblxuICAgICAgICBhbGx1cmUuY3JlYXRlQXR0YWNobWVudChuYW1lLCBjb250ZW50LCB0eXBlKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0UmVzdENsaWVudF8oYXBwLCBuYW1lLCB1c2VyVGFnKSB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGFwcC5nZXRTZXJ2aWNlKHRoaXMud2ViU2VydmVyID8gYHN1cGVyVGVzdC4ke25hbWV9YCA6IGByZXN0Q2xpZW50LiR7bmFtZX1gKTtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBjbGllbnQuc2VydmVyID0gdGhpcy53ZWJTZXJ2ZXIuaHR0cFNlcnZlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY2xpZW50Lm9uU2VudCkge1xuICAgICAgICAgICAgY2xpZW50Lm9uU2VudCA9ICh1cmwsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KHVybCwgcmVzdWx0KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXVzZXJUYWcpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBjbGllbnQub25TZW5kO1xuICAgICAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0b2tlbiwgdXNlckF1dGg7XG5cbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdCh1c2VyVGFnKSkge1xuICAgICAgICAgICAgdG9rZW4gPSB0b2tlbkNhY2hlW3VzZXJUYWcudXNlclRhZ107XG4gICAgICAgICAgICB1c2VyQXV0aCA9IHVzZXJUYWc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZ107XG4gICAgICAgICAgICB1c2VyQXV0aCA9IGFwcC5zZXR0aW5ncy51c2VyQXV0aFt1c2VyVGFnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICAgIGxldCByZXMgPSBhd2FpdCBjbGllbnQucG9zdCh1c2VyQXV0aC5lbmRwb2ludCwge1xuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyQXV0aC51c2VybmFtZSxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogdXNlckF1dGgucGFzc3dvcmQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRva2VuID0gcmVzLnRva2VuO1xuICAgICAgICAgICAgdG9rZW5DYWNoZVt1c2VyVGFnXSA9IHRva2VuO1xuXG4gICAgICAgICAgICBhcHAubG9nKFwiaW5mb1wiLCBgTG9nZ2VkIGluIHdpdGggWyR7dXNlclRhZ31dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY2xpZW50Lm9uU2VuZCA9IChyZXEpID0+IHtcbiAgICAgICAgICAgIHJlcS5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdWl0ZTtcbiJdfQ==