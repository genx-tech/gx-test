"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

const tokenCache = {};
let allure;

class Suite {
  constructor(name, {
    serverEntry,
    verbose
  }) {
    this.name = name;
    this.serverEntry = serverEntry || '../../src/index.js';
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error('Web server already started.');
    }

    const createWebServer = require(this.serverEntry);

    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    let err;
    await startWorker(async app => {
      const client = await this._getRestClient_(app, name, userTag);

      try {
        await testToRun(app, client);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require('allure-mocha/runtime');

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, {
    data,
    cleanUp
  }) {
    it(story, async function () {
      if (this.verbose) {
        console.log('Starting story:', story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === 'object') {
              allure.parameter(k, '*see attachment*');
              attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, cleanUp) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === 'function') return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, {
        data: preparedData,
        cleanUp
      });
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log('Step: ', step);
    }

    await body();
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = 'plain/text',
        content = obj;

    if (typeof obj !== 'string') {
      content = JSON.stringify(obj, null, 4);
      type = 'application/json';
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest.${name}` : `restClient.${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });
      token = res.token;
      tokenCache[userTag] = token;
      app.log('info', `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set('Authorization', `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJTdGFydGVycyIsInN0YXJ0V29ya2VyIiwidG9rZW5DYWNoZSIsImFsbHVyZSIsIlN1aXRlIiwiY29uc3RydWN0b3IiLCJuYW1lIiwic2VydmVyRW50cnkiLCJ2ZXJib3NlIiwic3RhcnRXZWJTZXJ2ZXJfIiwid2ViU2VydmVyIiwiRXJyb3IiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0UmVzdENsaWVudF8iLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsIl9nZXRSZXN0Q2xpZW50XyIsImUiLCJ3b3JrZXJOYW1lIiwiY29uZmlnTmFtZSIsImNvbmZpZ1BhdGgiLCJhcHBNb2R1bGVzUGF0aCIsImlnbm9yZVVuY2F1Z2h0IiwiZXhpc3QiLCJtZXNzYWdlIiwiaW5pdEFsbHVyZSIsImFsbHVyZU1vY2hhIiwidGVzdENhc2UiLCJzdG9yeSIsImJvZHkiLCJkYXRhIiwiY2xlYW5VcCIsIml0IiwiY29uc29sZSIsImxvZyIsImRlc2NyaXB0aW9uIiwiZXBpYyIsImZlYXR1cmUiLCJvd25lciIsInRhZyIsImlzc3VlcyIsInNldmVyaXR5IiwiaXNFbXB0eSIsImZvck93biIsImxpbmsiLCJudW0iLCJpc3N1ZSIsImNyZWF0ZVN0ZXAiLCJwYXJhbXMiLCJ2IiwiayIsInBhcmFtZXRlciIsImF0dGFjaE9iamVjdCIsInRlc3RDYXNlRnJvbUZpeHR1cmVzIiwicCIsInJlc29sdmUiLCJzdWl0ZURhdGEiLCJjYXNlcyIsIm90aGVycyIsInN0b3J5RGF0YSIsImNhc3RBcnJheSIsImZvckVhY2giLCJjYXNlRGF0YSIsImkiLCJwcmVwYXJlZERhdGEiLCJtYXBWYWx1ZXMiLCJleHBlY3RlZCIsInRlc3RTdGVwXyIsInN0ZXAiLCJvYmoiLCJ0eXBlIiwiY29udGVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJjcmVhdGVBdHRhY2htZW50IiwiZ2V0U2VydmljZSIsInNlcnZlciIsImh0dHBTZXJ2ZXIiLCJvblNlbnQiLCJ1cmwiLCJyZXN1bHQiLCJvblNlbmQiLCJ0b2tlbiIsInVzZXJBdXRoIiwiaXNQbGFpbk9iamVjdCIsInNldHRpbmdzIiwicmVzIiwicG9zdCIsImVuZHBvaW50IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInJlcSIsInNldCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFRRCxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLFFBQVEsRUFBRTtBQUFFQyxJQUFBQTtBQUFGO0FBQVosSUFBZ0NILE9BQU8sQ0FBQyxXQUFELENBQTdDOztBQUVBLE1BQU1JLFVBQVUsR0FBRyxFQUFuQjtBQUNBLElBQUlDLE1BQUo7O0FBRUEsTUFBTUMsS0FBTixDQUFZO0FBQ1JDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0FBQUVDLElBQUFBLFdBQUY7QUFBZUMsSUFBQUE7QUFBZixHQUFQLEVBQWlDO0FBQ3hDLFNBQUtGLElBQUwsR0FBWUEsSUFBWjtBQUNBLFNBQUtDLFdBQUwsR0FBbUJBLFdBQVcsSUFBSSxvQkFBbEM7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDSDs7QUFNRCxRQUFNQyxlQUFOLEdBQXdCO0FBQ3BCLFFBQUksS0FBS0MsU0FBVCxFQUFvQjtBQUNoQixZQUFNLElBQUlDLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0g7O0FBRUQsVUFBTUMsZUFBZSxHQUFHZCxPQUFPLENBQUMsS0FBS1MsV0FBTixDQUEvQjs7QUFDQSxTQUFLRyxTQUFMLEdBQWlCRSxlQUFl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Q0FBWUosUUFBUSxDQUFDSyxRQUFyQixFQUErQjtBQUFFQyxRQUFBQSxRQUFRLEVBQUVOLFFBQVEsQ0FBQ00sUUFBckI7QUFBK0JDLFFBQUFBLFFBQVEsRUFBRVAsUUFBUSxDQUFDTztBQUFsRCxPQUEvQixDQUFoQjtBQUNBUixNQUFBQSxLQUFLLEdBQUdJLEdBQUcsQ0FBQ0osS0FBWjtBQUNBN0YsTUFBQUEsVUFBVSxDQUFDcUIsT0FBRCxDQUFWLEdBQXNCd0UsS0FBdEI7QUFFQXBFLE1BQUFBLEdBQUcsQ0FBQ29CLEdBQUosQ0FBUSxNQUFSLEVBQWlCLG1CQUFrQnhCLE9BQVEsSUFBM0M7QUFDSDs7QUFFREssSUFBQUEsTUFBTSxDQUFDa0UsTUFBUCxHQUFpQlUsR0FBRCxJQUFTO0FBQ3JCQSxNQUFBQSxHQUFHLENBQUNDLEdBQUosQ0FBUSxlQUFSLEVBQTBCLFVBQVNWLEtBQU0sRUFBekM7QUFDSCxLQUZEOztBQUlBLFdBQU9uRSxNQUFQO0FBQ0g7O0FBdE5POztBQXlOWjhFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZHLEtBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5cbmNvbnN0IHRva2VuQ2FjaGUgPSB7fTtcbmxldCBhbGx1cmU7XG5cbmNsYXNzIFN1aXRlIHtcbiAgICBjb25zdHJ1Y3RvcihuYW1lLCB7IHNlcnZlckVudHJ5LCB2ZXJib3NlIH0pIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zZXJ2ZXJFbnRyeSA9IHNlcnZlckVudHJ5IHx8ICcuLi8uLi9zcmMvaW5kZXguanMnO1xuICAgICAgICB0aGlzLnZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7Kn0gc2VydmVyRW50cnkgLSBTZXJ2ZXIgZW50cnkgZmlsZSBwYXRoIChyZWxhdGl2ZSB0byB0ZXN0IHdvcmtpbmcgcGF0aClcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdlYlNlcnZlcl8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXZWIgc2VydmVyIGFscmVhZHkgc3RhcnRlZC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVdlYlNlcnZlciA9IHJlcXVpcmUodGhpcy5zZXJ2ZXJFbnRyeSk7XG4gICAgICAgIHRoaXMud2ViU2VydmVyID0gY3JlYXRlV2ViU2VydmVyKHtcbiAgICAgICAgICAgIGV4aXRPblVuY2F1Z2h0OiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCA9PSBudWxsIHx8IHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLm5vdC5iZS5vaygpO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQuYmUub2soKTtcblxuICAgICAgICByZXR1cm4gdGhpcy53ZWJTZXJ2ZXI7XG4gICAgfTtcblxuICAgIGFzeW5jIHN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLndlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RvcF8oKTsgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMud2ViU2VydmVyO1xuICAgICAgICB9ICAgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gYSB0ZXN0IGZ1bmN0aW9uIGluIGEgd29ya2VyXG4gICAgICogQHBhcmFtIHsqfSB0ZXN0VG9SdW4gXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0UmVzdENsaWVudF8obmFtZSwgdXNlclRhZywgdGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBlcnI7XG5cbiAgICAgICAgYXdhaXQgc3RhcnRXb3JrZXIoYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5fZ2V0UmVzdENsaWVudF8oYXBwLCBuYW1lLCB1c2VyVGFnKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGVzdFRvUnVuKGFwcCwgY2xpZW50KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH0sIHtcbiAgICAgICAgICAgIHdvcmtlck5hbWU6IFwidGVzdGVyXCIsICAgICAgICBcbiAgICAgICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICAgICAgY29uZmlnUGF0aDogXCIuL3Rlc3QvY29uZlwiLFxuICAgICAgICAgICAgYXBwTW9kdWxlc1BhdGg6IFwiYXBwX21vZHVsZXNcIixcbiAgICAgICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBzaG91bGQubm90LmV4aXN0KGVyciwgZXJyLm1lc3NhZ2UgfHwgZXJyKTtcbiAgICAgICAgfSAgICBcbiAgICB9XG5cbiAgICBpbml0QWxsdXJlKCkge1xuICAgICAgICBpZiAoIWFsbHVyZSkge1xuICAgICAgICAgICAgY29uc3QgYWxsdXJlTW9jaGEgPSByZXF1aXJlKCdhbGx1cmUtbW9jaGEvcnVudGltZScpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgYWxsdXJlID0gYWxsdXJlTW9jaGEuYWxsdXJlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdGVzdENhc2Uoc3RvcnksIGJvZHksIHsgZGF0YSwgY2xlYW5VcCB9KSB7XG4gICAgICAgIGl0KHN0b3J5LCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy52ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIHN0b3J5OicsIHN0b3J5KTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcbiAgICBcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gJiYgYWxsdXJlLmRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgZXBpYyAmJiBhbGx1cmUuZXBpYyhlcGljKTtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZSAmJiBhbGx1cmUuZmVhdHVyZShmZWF0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgb3duZXIgJiYgYWxsdXJlLm93bmVyKG93bmVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGFnICYmIGFsbHVyZS50YWcodGFnKTtcbiAgICAgICAgICAgICAgICAgICAgc2V2ZXJpdHkgJiYgYWxsdXJlLnNldmVyaXR5KHNldmVyaXR5KTtcbiAgICBcbiAgICAgICAgICAgICAgICAgICAgXy5pc0VtcHR5KGlzc3VlcykgfHwgKF8uZm9yT3duKGlzc3VlcywgKGxpbmssIG51bSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLmlzc3VlKG51bSwgbGluayk7XG4gICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICB9IFxuICAgIFxuICAgICAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG4gICAgICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoYHN0YXJ0ICR7c3Rvcnl9YCwgKCkgPT4ge30pKCk7ICAgICAgICAgICAgXG4gICAgXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oZGF0YS5wYXJhbXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCAnKnNlZSBhdHRhY2htZW50KicpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRhY2hPYmplY3QoYHBhcmFtWyR7a31dYCwgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgdik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2xlYW5VcCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xlYW5VcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHRlc3RDYXNlRnJvbUZpeHR1cmVzKHN0b3J5LCBib2R5LCBjbGVhblVwKSB7XG4gICAgICAgIGNvbnN0IHAgPSBwYXRoLnJlc29sdmUoYHRlc3QvZml4dHVyZXMvJHt0aGlzLm5hbWV9LmpzYCk7XG4gICAgICAgIGNvbnN0IHN1aXRlRGF0YSA9IHJlcXVpcmUocCk7XG4gICAgICAgIGlmICghc3VpdGVEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN1aXRlIGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9YCk7XG4gICAgXG4gICAgICAgIGNvbnN0IHsgY2FzZXMsIC4uLm90aGVycyB9ID0gc3VpdGVEYXRhOyAgICBcbiAgICBcbiAgICAgICAgY29uc3Qgc3RvcnlEYXRhID0gY2FzZXMgJiYgY2FzZXNbc3RvcnldOyAgIFxuICAgICAgICBpZiAoIXN0b3J5RGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdG9yeSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7dGhpcy5uYW1lfSwgc3Rvcnk6ICR7c3Rvcnl9YCk7XG4gICAgXG4gICAgICAgIF8uY2FzdEFycmF5KHN0b3J5RGF0YSkuZm9yRWFjaCgoY2FzZURhdGEsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByZXBhcmVkRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBhbGx1cmU6IG90aGVycyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IF8ubWFwVmFsdWVzKGNhc2VEYXRhLnBhcmFtcywgKHYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdigpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZDogY2FzZURhdGEuZXhwZWN0ZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy50ZXN0Q2FzZShgJHtzdG9yeX0jJHtpKzF9YCwgYm9keSwgeyBkYXRhOiBwcmVwYXJlZERhdGEsIGNsZWFuVXAgfSk7IFxuICAgICAgICB9KTsgICAgXG4gICAgfVxuXG4gICAgYXN5bmMgdGVzdFN0ZXBfKHN0ZXAsIGJvZHkpIHsgICAgXG4gICAgICAgIGlmIChhbGx1cmUpIHsgICAgICAgIFxuICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoc3RlcCwgKCkgPT4ge30pKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy52ZXJib3NlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnU3RlcDogJywgc3RlcCk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBib2R5KCk7XG4gICAgfSAgICBcblxuICAgIGF0dGFjaE9iamVjdChuYW1lLCBvYmopIHtcbiAgICAgICAgaWYgKCFhbGx1cmUpIHJldHVybjtcbiAgICBcbiAgICAgICAgbGV0IHR5cGUgPSAncGxhaW4vdGV4dCcsIGNvbnRlbnQgPSBvYmo7XG4gICAgXG4gICAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgICAgICB0eXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIGFsbHVyZS5jcmVhdGVBdHRhY2htZW50KG5hbWUsIGNvbnRlbnQsIHR5cGUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRSZXN0Q2xpZW50XyhhcHAsIG5hbWUsIHVzZXJUYWcpIHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gYXBwLmdldFNlcnZpY2UodGhpcy53ZWJTZXJ2ZXIgPyBgc3VwZXJUZXN0LiR7bmFtZX1gIDogYHJlc3RDbGllbnQuJHtuYW1lfWApO1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGNsaWVudC5zZXJ2ZXIgPSB0aGlzLndlYlNlcnZlci5odHRwU2VydmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjbGllbnQub25TZW50KSB7XG4gICAgICAgICAgICBjbGllbnQub25TZW50ID0gKHVybCwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QodXJsLCByZXN1bHQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdXNlclRhZykge1xuICAgICAgICAgICAgZGVsZXRlIGNsaWVudC5vblNlbmQ7IFxuICAgICAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICAgICAgfSAgICBcblxuICAgICAgICBsZXQgdG9rZW4sIHVzZXJBdXRoO1xuXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodXNlclRhZykpIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnLnVzZXJUYWddO1xuICAgICAgICAgICAgdXNlckF1dGggPSB1c2VyVGFnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdG9rZW4gPSB0b2tlbkNhY2hlW3VzZXJUYWddO1xuICAgICAgICAgICAgdXNlckF1dGggPSBhcHAuc2V0dGluZ3MudXNlckF1dGhbdXNlclRhZ107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgY2xpZW50LnBvc3QodXNlckF1dGguZW5kcG9pbnQsIHsgdXNlcm5hbWU6IHVzZXJBdXRoLnVzZXJuYW1lLCBwYXNzd29yZDogdXNlckF1dGgucGFzc3dvcmQgfSk7XG4gICAgICAgICAgICB0b2tlbiA9IHJlcy50b2tlbjtcbiAgICAgICAgICAgIHRva2VuQ2FjaGVbdXNlclRhZ10gPSB0b2tlbjsgICAgICAgIFxuXG4gICAgICAgICAgICBhcHAubG9nKCdpbmZvJywgYExvZ2dlZCBpbiB3aXRoIFske3VzZXJUYWd9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5vblNlbmQgPSAocmVxKSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgcmVxLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN1aXRlOyJdfQ==