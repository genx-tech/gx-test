"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("@genx/july");

const tokenCache = {};
let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry;
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = this.serverEntry ? require(this.serverEntry) : require.main.require("../../src/index.js");
    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    return this.startWorker_(async app => {
      const client = await this._getRestClient_(app, name, userTag);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log("Step: ", step);
    }

    if (body) {
      await body();
    }
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest-${name}` : `restClient-${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;
    let responseBodyKey = app.settings.responseBodyKey;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });

      if (responseBodyKey) {
        token = res[responseBodyKey].token;
      } else {
        token = res.token;
      }

      tokenCache[userTag] = token;
      app.log("info", `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set("Authorization", `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJ0b2tlbkNhY2hlIiwiYWxsdXJlIiwiU3VpdGUiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwic2VydmVyRW50cnkiLCJ2ZXJib3NlIiwic3RhcnRXZWJTZXJ2ZXJfIiwid2ViU2VydmVyIiwiRXJyb3IiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJtYWluIiwiZXhpdE9uVW5jYXVnaHQiLCJzdGFydGVkIiwic2hvdWxkIiwibm90IiwiYmUiLCJvayIsInN0YXJ0XyIsInN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfIiwic3RvcF8iLCJzdGFydFdvcmtlcl8iLCJ0ZXN0VG9SdW4iLCJTdGFydGVycyIsInN0YXJ0V29ya2VyIiwiZXJyIiwiYXBwIiwiZSIsIndvcmtlck5hbWUiLCJjb25maWdOYW1lIiwiY29uZmlnUGF0aCIsImFwcE1vZHVsZXNQYXRoIiwiaWdub3JlVW5jYXVnaHQiLCJleGlzdCIsIm1lc3NhZ2UiLCJzdGFydFJlc3RDbGllbnRfIiwidXNlclRhZyIsImNsaWVudCIsIl9nZXRSZXN0Q2xpZW50XyIsImluaXRBbGx1cmUiLCJhbGx1cmVNb2NoYSIsInRlc3RDYXNlIiwic3RvcnkiLCJib2R5IiwiZGF0YSIsImNsZWFuVXAiLCJza2lwIiwib25seSIsInNlbGYiLCJvcHQiLCJpdCIsImNvbnNvbGUiLCJsb2ciLCJkZXNjcmlwdGlvbiIsImVwaWMiLCJmZWF0dXJlIiwib3duZXIiLCJ0YWciLCJpc3N1ZXMiLCJzZXZlcml0eSIsImlzRW1wdHkiLCJmb3JPd24iLCJsaW5rIiwibnVtIiwiaXNzdWUiLCJjcmVhdGVTdGVwIiwicGFyYW1zIiwidiIsImsiLCJwYXJhbWV0ZXIiLCJhdHRhY2hPYmplY3QiLCJ0ZXN0Q2FzZUZyb21GaXh0dXJlcyIsInAiLCJyZXNvbHZlIiwic3VpdGVEYXRhIiwiY2FzZXMiLCJvdGhlcnMiLCJzdG9yeURhdGEiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY2FzZURhdGEiLCJpIiwicHJlcGFyZWREYXRhIiwibWFwVmFsdWVzIiwiZXhwZWN0ZWQiLCJiZW5jaG1hcmtfIiwibWFwT2ZNZXRob2RzIiwicGF5bG9hZCIsIkJlbmNobWFyayIsInN1aXRlIiwiZWFjaCIsImYiLCJhZGQiLCJQcm9taXNlIiwicmVqZWN0Iiwib24iLCJldmVudCIsImN5Y2xlTWVzc2FnZSIsIlN0cmluZyIsInRhcmdldCIsImNvbXBsZXRlTWVzc2FnZSIsImZpbHRlciIsIm1hcCIsInJ1biIsImFzeW5jIiwidGVzdFN0ZXBfIiwic3RlcCIsIm9iaiIsInR5cGUiLCJjb250ZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZUF0dGFjaG1lbnQiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJyZXNwb25zZUJvZHlLZXkiLCJzZXR0aW5ncyIsImlzUGxhaW5PYmplY3QiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwicmVxIiwic2V0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLE1BQU1FLFVBQVUsR0FBRyxFQUFuQjtBQUNBLElBQUlDLE1BQUo7O0FBeUJBLE1BQU1DLEtBQU4sQ0FBWTtBQVFSQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBT0MsT0FBUCxFQUFnQjtBQUN2QixTQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxVQUFNO0FBQUVFLE1BQUFBLFdBQUY7QUFBZUMsTUFBQUE7QUFBZixRQUEyQkYsT0FBTyxJQUFJLElBQVgsR0FBa0IsRUFBbEIsR0FBdUJBLE9BQXhEO0FBRUEsU0FBS0MsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDSDs7QUFPb0IsUUFBZkMsZUFBZSxHQUFHO0FBQ3BCLFFBQUksS0FBS0MsU0FBVCxFQUFvQjtBQUNoQixZQUFNLElBQUlDLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0g7O0FBRUQsVUFBTUMsZUFBZSxHQUFHLEtBQUtMLFdBQUwsR0FBbUJSLE9BQU8sQ0FBQyxLQUFLUSxXQUFOLENBQTFCLEdBQStDUixPQUFPLENBQUNjLElBQVIsQ0FBYWQsT0FBYixDQUFxQixvQkFBckIsQ0FBdkU7QUFDQSxTQUFLVyxTQUFMLEdBQWlCRSxlQUFlLENBQUM7QUFDN0JFLE1BQUFBLGNBQWMsRUFBRTtBQURhLEtBQUQsQ0FBaEM7QUFHQSxTQUFLSixTQUFMLENBQWVLLE9BQWYsSUFBMEIsSUFBMUIsSUFBa0MsS0FBS0wsU0FBTCxDQUFlSyxPQUFmLENBQXVCQyxNQUF2QixDQUE4QkMsR0FBOUIsQ0FBa0NDLEVBQWxDLENBQXFDQyxFQUFyQyxFQUFsQztBQUVBLFVBQU0sS0FBS1QsU0FBTCxDQUFlVSxNQUFmLEVBQU47QUFFQSxTQUFLVixTQUFMLENBQWVLLE9BQWYsQ0FBdUJDLE1BQXZCLENBQThCRSxFQUE5QixDQUFpQ0MsRUFBakM7QUFFQSxXQUFPLEtBQUtULFNBQVo7QUFDSDs7QUFPNEIsUUFBdkJXLHVCQUF1QixHQUFHO0FBQzVCLFFBQUksS0FBS1gsU0FBVCxFQUFvQjtBQUNoQixVQUFJLEtBQUtBLFNBQUwsQ0FBZUssT0FBbkIsRUFBNEI7QUFDeEIsY0FBTSxLQUFLTCxTQUFMLENBQWVZLEtBQWYsRUFBTjtBQUNIOztBQUVELGFBQU8sS0FBS1osU0FBWjtBQUNIO0FBQ0o7O0FBUWlCLFFBQVphLFlBQVksQ0FBQ0MsU0FBRCxFQUFZbEIsT0FBWixFQUFxQjtBQUNuQyxVQUFNO0FBQ0ZtQixNQUFBQSxRQUFRLEVBQUU7QUFBRUMsUUFBQUE7QUFBRjtBQURSLFFBRUYzQixPQUFPLENBQUMsV0FBRCxDQUZYOztBQUlBLFFBQUk0QixHQUFKO0FBRUEsVUFBTUQsV0FBVyxDQUNiLE1BQU9FLEdBQVAsSUFBZTtBQUNYLFVBQUk7QUFDQSxjQUFNSixTQUFTLENBQUNJLEdBQUQsQ0FBZjtBQUNILE9BRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDUkYsUUFBQUEsR0FBRyxHQUFHRSxDQUFOO0FBQ0g7QUFDSixLQVBZLEVBUWI7QUFDSUMsTUFBQUEsVUFBVSxFQUFFLFFBRGhCO0FBRUlDLE1BQUFBLFVBQVUsRUFBRSxNQUZoQjtBQUdJQyxNQUFBQSxVQUFVLEVBQUUsYUFIaEI7QUFJSUMsTUFBQUEsY0FBYyxFQUFFLGFBSnBCO0FBS0lDLE1BQUFBLGNBQWMsRUFBRSxJQUxwQjtBQU1JLFNBQUc1QjtBQU5QLEtBUmEsQ0FBakI7O0FBa0JBLFFBQUlxQixHQUFKLEVBQVM7QUFDTFgsTUFBQUEsTUFBTSxDQUFDQyxHQUFQLENBQVdrQixLQUFYLENBQWlCUixHQUFqQixFQUFzQkEsR0FBRyxDQUFDUyxPQUFKLElBQWVULEdBQXJDO0FBQ0g7QUFDSjs7QUFVcUIsUUFBaEJVLGdCQUFnQixDQUFDaEMsSUFBRCxFQUFPaUMsT0FBUCxFQUFnQmQsU0FBaEIsRUFBMkJsQixPQUEzQixFQUFvQztBQUN0RCxXQUFPLEtBQUtpQixZQUFMLENBQWtCLE1BQU9LLEdBQVAsSUFBZTtBQUNwQyxZQUFNVyxNQUFNLEdBQUcsTUFBTSxLQUFLQyxlQUFMLENBQXFCWixHQUFyQixFQUEwQnZCLElBQTFCLEVBQWdDaUMsT0FBaEMsQ0FBckI7QUFDQSxhQUFPZCxTQUFTLENBQUNJLEdBQUQsRUFBTVcsTUFBTixDQUFoQjtBQUNILEtBSE0sRUFHSmpDLE9BSEksQ0FBUDtBQUlIOztBQUtEbUMsRUFBQUEsVUFBVSxHQUFHO0FBQ1QsUUFBSSxDQUFDdkMsTUFBTCxFQUFhO0FBQ1QsWUFBTXdDLFdBQVcsR0FBRzNDLE9BQU8sQ0FBQyxzQkFBRCxDQUEzQjs7QUFDQUcsTUFBQUEsTUFBTSxHQUFHd0MsV0FBVyxDQUFDeEMsTUFBckI7QUFDSDtBQUNKOztBQVVEeUMsRUFBQUEsUUFBUSxDQUFDQyxLQUFELEVBQVFDLElBQVIsRUFBY3ZDLE9BQWQsRUFBdUI7QUFDM0IsVUFBTTtBQUFFd0MsTUFBQUEsSUFBRjtBQUFRQyxNQUFBQSxPQUFSO0FBQWlCQyxNQUFBQSxJQUFqQjtBQUF1QkMsTUFBQUE7QUFBdkIsUUFBZ0MzQyxPQUFPLElBQUksSUFBWCxHQUFrQixFQUFsQixHQUF1QkEsT0FBN0Q7QUFDQSxVQUFNNEMsSUFBSSxHQUFHLElBQWI7QUFFQSxRQUFJQyxHQUFKOztBQUVBLFFBQUlGLElBQUosRUFBVTtBQUNORSxNQUFBQSxHQUFHLEdBQUcsTUFBTjtBQUNILEtBRkQsTUFFTyxJQUFJSCxJQUFKLEVBQVU7QUFDYkcsTUFBQUEsR0FBRyxHQUFHLE1BQU47QUFDSDs7QUFFRCxLQUFDQSxHQUFHLEdBQUdDLEVBQUUsQ0FBQ0QsR0FBRCxDQUFMLEdBQWFDLEVBQWpCLEVBQXFCUixLQUFyQixFQUE0QixrQkFBa0I7QUFDMUMsVUFBSU0sSUFBSSxDQUFDMUMsT0FBVCxFQUFrQjtBQUNkNkMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksaUJBQVosRUFBK0JWLEtBQS9CO0FBQ0g7O0FBRUQsVUFBSTFDLE1BQUosRUFBWTtBQUNSLFlBQUk0QyxJQUFKLEVBQVU7QUFDTixnQkFBTTtBQUFFUyxZQUFBQSxXQUFGO0FBQWVDLFlBQUFBLElBQWY7QUFBcUJDLFlBQUFBLE9BQXJCO0FBQThCQyxZQUFBQSxLQUE5QjtBQUFxQ0MsWUFBQUEsR0FBckM7QUFBMENDLFlBQUFBLE1BQTFDO0FBQWtEQyxZQUFBQTtBQUFsRCxjQUErRGYsSUFBSSxDQUFDNUMsTUFBMUU7QUFFQXFELFVBQUFBLFdBQVcsSUFBSXJELE1BQU0sQ0FBQ3FELFdBQVAsQ0FBbUJBLFdBQW5CLENBQWY7QUFDQUMsVUFBQUEsSUFBSSxJQUFJdEQsTUFBTSxDQUFDc0QsSUFBUCxDQUFZQSxJQUFaLENBQVI7QUFDQUMsVUFBQUEsT0FBTyxJQUFJdkQsTUFBTSxDQUFDdUQsT0FBUCxDQUFlQSxPQUFmLENBQVg7QUFDQUMsVUFBQUEsS0FBSyxJQUFJeEQsTUFBTSxDQUFDd0QsS0FBUCxDQUFhQSxLQUFiLENBQVQ7QUFDQUMsVUFBQUEsR0FBRyxJQUFJekQsTUFBTSxDQUFDeUQsR0FBUCxDQUFXQSxHQUFYLENBQVA7QUFDQUUsVUFBQUEsUUFBUSxJQUFJM0QsTUFBTSxDQUFDMkQsUUFBUCxDQUFnQkEsUUFBaEIsQ0FBWjtBQUVBN0QsVUFBQUEsQ0FBQyxDQUFDOEQsT0FBRixDQUFVRixNQUFWLEtBQ0k1RCxDQUFDLENBQUMrRCxNQUFGLENBQVNILE1BQVQsRUFBaUIsQ0FBQ0ksSUFBRCxFQUFPQyxHQUFQLEtBQWU7QUFDNUIvRCxZQUFBQSxNQUFNLENBQUNnRSxLQUFQLENBQWFELEdBQWIsRUFBa0JELElBQWxCO0FBQ0gsV0FGRCxDQURKO0FBSUg7O0FBRUQ5RCxRQUFBQSxNQUFNLENBQUMwQyxLQUFQLENBQWFBLEtBQWI7QUFDQTFDLFFBQUFBLE1BQU0sQ0FBQ2lFLFVBQVAsQ0FBbUIsU0FBUXZCLEtBQU0sRUFBakMsRUFBb0MsTUFBTSxDQUFFLENBQTVDOztBQUVBLFlBQUlFLElBQUksSUFBSUEsSUFBSSxDQUFDc0IsTUFBakIsRUFBeUI7QUFDckJwRSxVQUFBQSxDQUFDLENBQUMrRCxNQUFGLENBQVNqQixJQUFJLENBQUNzQixNQUFkLEVBQXNCLENBQUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVO0FBQzVCLGdCQUFJLE9BQU9ELENBQVAsS0FBYSxRQUFqQixFQUEyQjtBQUN2Qm5FLGNBQUFBLE1BQU0sQ0FBQ3FFLFNBQVAsQ0FBaUJELENBQWpCLEVBQW9CLGtCQUFwQjtBQUNBcEIsY0FBQUEsSUFBSSxDQUFDc0IsWUFBTCxDQUFtQixTQUFRRixDQUFFLEdBQTdCLEVBQWlDRCxDQUFqQztBQUNILGFBSEQsTUFHTztBQUNIbkUsY0FBQUEsTUFBTSxDQUFDcUUsU0FBUCxDQUFpQkQsQ0FBakIsRUFBb0JELENBQXBCO0FBQ0g7QUFDSixXQVBEO0FBUUg7QUFDSjs7QUFFRCxVQUFJdEIsT0FBSixFQUFhO0FBQ1QsWUFBSTtBQUNBLGdCQUFNRixJQUFJLENBQUNDLElBQUQsQ0FBVjtBQUNILFNBRkQsU0FFVTtBQUNOLGdCQUFNQyxPQUFPLEVBQWI7QUFDSDtBQUNKLE9BTkQsTUFNTztBQUNILGNBQU1GLElBQUksQ0FBQ0MsSUFBRCxDQUFWO0FBQ0g7QUFDSixLQTlDRDtBQStDSDs7QUFRRDJCLEVBQUFBLG9CQUFvQixDQUFDN0IsS0FBRCxFQUFRQyxJQUFSLEVBQWN2QyxPQUFkLEVBQXVCO0FBQ3ZDLFVBQU1vRSxDQUFDLEdBQUc1RSxJQUFJLENBQUM2RSxPQUFMLENBQWMsaUJBQWdCLEtBQUt0RSxJQUFLLEtBQXhDLENBQVY7O0FBQ0EsVUFBTXVFLFNBQVMsR0FBRzdFLE9BQU8sQ0FBQzJFLENBQUQsQ0FBekI7O0FBQ0EsUUFBSSxDQUFDRSxTQUFMLEVBQWdCLE1BQU0sSUFBSWpFLEtBQUosQ0FBVyxnQ0FBK0IsS0FBS04sSUFBSyxFQUFwRCxDQUFOO0FBRWhCLFVBQU07QUFBRXdFLE1BQUFBLEtBQUY7QUFBUyxTQUFHQztBQUFaLFFBQXVCRixTQUE3QjtBQUVBLFVBQU1HLFNBQVMsR0FBR0YsS0FBSyxJQUFJQSxLQUFLLENBQUNqQyxLQUFELENBQWhDO0FBQ0EsUUFBSSxDQUFDbUMsU0FBTCxFQUFnQixNQUFNLElBQUlwRSxLQUFKLENBQVcsZ0NBQStCLEtBQUtOLElBQUssWUFBV3VDLEtBQU0sRUFBckUsQ0FBTjs7QUFFaEI1QyxJQUFBQSxDQUFDLENBQUNnRixTQUFGLENBQVlELFNBQVosRUFBdUJFLE9BQXZCLENBQStCLENBQUNDLFFBQUQsRUFBV0MsQ0FBWCxLQUFpQjtBQUM1QyxZQUFNQyxZQUFZLEdBQUc7QUFDakJsRixRQUFBQSxNQUFNLEVBQUU0RSxNQURTO0FBRWpCVixRQUFBQSxNQUFNLEVBQUVwRSxDQUFDLENBQUNxRixTQUFGLENBQVlILFFBQVEsQ0FBQ2QsTUFBckIsRUFBOEJDLENBQUQsSUFBTztBQUN4QyxjQUFJLE9BQU9BLENBQVAsS0FBYSxVQUFqQixFQUE2QixPQUFPQSxDQUFDLEVBQVI7QUFDN0IsaUJBQU9BLENBQVA7QUFDSCxTQUhPLENBRlM7QUFNakJpQixRQUFBQSxRQUFRLEVBQUVKLFFBQVEsQ0FBQ0k7QUFORixPQUFyQjtBQVNBLFdBQUszQyxRQUFMLENBQWUsR0FBRUMsS0FBTSxJQUFHdUMsQ0FBQyxHQUFHLENBQUUsRUFBaEMsRUFBbUN0QyxJQUFuQyxFQUF5QyxFQUFFLEdBQUd2QyxPQUFMO0FBQWN3QyxRQUFBQSxJQUFJLEVBQUVzQztBQUFwQixPQUF6QztBQUNILEtBWEQ7QUFZSDs7QUFPZSxRQUFWRyxVQUFVLENBQUNDLFlBQUQsRUFBZUMsT0FBZixFQUF3QjtBQUNwQyxVQUFNQyxTQUFTLEdBQUczRixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFDQSxVQUFNNEYsS0FBSyxHQUFHLElBQUlELFNBQVMsQ0FBQ3ZGLEtBQWQsRUFBZDs7QUFFQUgsSUFBQUEsQ0FBQyxDQUFDNEYsSUFBRixDQUFPSixZQUFQLEVBQXFCLENBQUNLLENBQUQsRUFBSXhGLElBQUosS0FBYTtBQUM5QnNGLE1BQUFBLEtBQUssQ0FBQ0csR0FBTixDQUFVekYsSUFBVixFQUFnQixZQUFZO0FBQ3hCd0YsUUFBQUEsQ0FBQyxDQUFDSixPQUFELENBQUQ7QUFDSCxPQUZEO0FBR0gsS0FKRDs7QUFNQSxXQUFPLElBQUlNLE9BQUosQ0FBWSxDQUFDcEIsT0FBRCxFQUFVcUIsTUFBVixLQUFxQjtBQUNwQyxZQUFNOUMsSUFBSSxHQUFHLElBQWI7QUFFQXlDLE1BQUFBLEtBQUssQ0FDQU0sRUFETCxDQUNRLE9BRFIsRUFDa0JDLEtBQUQsSUFBVztBQUNwQixjQUFNQyxZQUFZLEdBQUdDLE1BQU0sQ0FBQ0YsS0FBSyxDQUFDRyxNQUFQLENBQTNCO0FBQ0FoRCxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWTZDLFlBQVo7QUFDQSxhQUFLM0IsWUFBTCxDQUFrQixPQUFsQixFQUEyQjJCLFlBQTNCO0FBQ0gsT0FMTCxFQU1LRixFQU5MLENBTVEsVUFOUixFQU1vQixZQUFZO0FBQ3hCLGNBQU1LLGVBQWUsR0FBRyxvQkFBb0IsS0FBS0MsTUFBTCxDQUFZLFNBQVosRUFBdUJDLEdBQXZCLENBQTJCLE1BQTNCLENBQTVDO0FBQ0FuRCxRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWWdELGVBQVo7QUFDQXBELFFBQUFBLElBQUksQ0FBQ3NCLFlBQUwsQ0FBa0IsVUFBbEIsRUFBOEI4QixlQUE5QjtBQUNBM0IsUUFBQUEsT0FBTztBQUNWLE9BWEwsRUFZS3NCLEVBWkwsQ0FZUSxPQVpSLEVBWWtCQyxLQUFELElBQVdGLE1BQU0sQ0FBQ0ksTUFBTSxDQUFDRixLQUFLLENBQUNHLE1BQVAsQ0FBUCxDQVpsQyxFQWFLSSxHQWJMLENBYVM7QUFBRUMsUUFBQUEsS0FBSyxFQUFFO0FBQVQsT0FiVDtBQWNILEtBakJNLENBQVA7QUFrQkg7O0FBT2MsUUFBVEMsU0FBUyxDQUFDQyxJQUFELEVBQU8vRCxJQUFQLEVBQWE7QUFDeEIsUUFBSTNDLE1BQUosRUFBWTtBQUNSQSxNQUFBQSxNQUFNLENBQUNpRSxVQUFQLENBQWtCeUMsSUFBbEIsRUFBd0IsTUFBTSxDQUFFLENBQWhDO0FBQ0g7O0FBRUQsUUFBSSxLQUFLcEcsT0FBVCxFQUFrQjtBQUNkNkMsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksUUFBWixFQUFzQnNELElBQXRCO0FBQ0g7O0FBRUQsUUFBSS9ELElBQUosRUFBVTtBQUNOLFlBQU1BLElBQUksRUFBVjtBQUNIO0FBQ0o7O0FBT0QyQixFQUFBQSxZQUFZLENBQUNuRSxJQUFELEVBQU93RyxHQUFQLEVBQVk7QUFDcEIsUUFBSSxDQUFDM0csTUFBTCxFQUFhO0FBRWIsUUFBSTRHLElBQUksR0FBRyxZQUFYO0FBQUEsUUFDSUMsT0FBTyxHQUFHRixHQURkOztBQUdBLFFBQUksT0FBT0EsR0FBUCxLQUFlLFFBQW5CLEVBQTZCO0FBQ3pCRSxNQUFBQSxPQUFPLEdBQUdDLElBQUksQ0FBQ0MsU0FBTCxDQUFlSixHQUFmLEVBQW9CLElBQXBCLEVBQTBCLENBQTFCLENBQVY7QUFDQUMsTUFBQUEsSUFBSSxHQUFHLGtCQUFQO0FBQ0g7O0FBRUQ1RyxJQUFBQSxNQUFNLENBQUNnSCxnQkFBUCxDQUF3QjdHLElBQXhCLEVBQThCMEcsT0FBOUIsRUFBdUNELElBQXZDO0FBQ0g7O0FBRW9CLFFBQWZ0RSxlQUFlLENBQUNaLEdBQUQsRUFBTXZCLElBQU4sRUFBWWlDLE9BQVosRUFBcUI7QUFDdEMsVUFBTUMsTUFBTSxHQUFHWCxHQUFHLENBQUN1RixVQUFKLENBQWUsS0FBS3pHLFNBQUwsR0FBa0IsYUFBWUwsSUFBSyxFQUFuQyxHQUF3QyxjQUFhQSxJQUFLLEVBQXpFLENBQWY7O0FBQ0EsUUFBSSxLQUFLSyxTQUFULEVBQW9CO0FBQ2hCNkIsTUFBQUEsTUFBTSxDQUFDNkUsTUFBUCxHQUFnQixLQUFLMUcsU0FBTCxDQUFlMkcsVUFBL0I7QUFDSDs7QUFFRCxRQUFJLENBQUM5RSxNQUFNLENBQUMrRSxNQUFaLEVBQW9CO0FBQ2hCL0UsTUFBQUEsTUFBTSxDQUFDK0UsTUFBUCxHQUFnQixDQUFDQyxHQUFELEVBQU1DLE1BQU4sS0FBaUI7QUFDN0IsYUFBS2hELFlBQUwsQ0FBa0IrQyxHQUFsQixFQUF1QkMsTUFBdkI7QUFDSCxPQUZEO0FBR0g7O0FBRUQsUUFBSSxDQUFDbEYsT0FBTCxFQUFjO0FBQ1YsYUFBT0MsTUFBTSxDQUFDa0YsTUFBZDtBQUNBLGFBQU9sRixNQUFQO0FBQ0g7O0FBRUQsUUFBSW1GLEtBQUosRUFBV0MsUUFBWDtBQUNBLFFBQUlDLGVBQWUsR0FBR2hHLEdBQUcsQ0FBQ2lHLFFBQUosQ0FBYUQsZUFBbkM7O0FBRUEsUUFBSTVILENBQUMsQ0FBQzhILGFBQUYsQ0FBZ0J4RixPQUFoQixDQUFKLEVBQThCO0FBQzFCb0YsTUFBQUEsS0FBSyxHQUFHekgsVUFBVSxDQUFDcUMsT0FBTyxDQUFDQSxPQUFULENBQWxCO0FBQ0FxRixNQUFBQSxRQUFRLEdBQUdyRixPQUFYO0FBQ0gsS0FIRCxNQUdPO0FBQ0hvRixNQUFBQSxLQUFLLEdBQUd6SCxVQUFVLENBQUNxQyxPQUFELENBQWxCO0FBQ0FxRixNQUFBQSxRQUFRLEdBQUcvRixHQUFHLENBQUNpRyxRQUFKLENBQWFGLFFBQWIsQ0FBc0JyRixPQUF0QixDQUFYO0FBQ0g7O0FBRUQsUUFBSSxDQUFDb0YsS0FBTCxFQUFZO0FBQ1IsVUFBSUssR0FBRyxHQUFHLE1BQU14RixNQUFNLENBQUN5RixJQUFQLENBQVlMLFFBQVEsQ0FBQ00sUUFBckIsRUFBK0I7QUFDM0NDLFFBQUFBLFFBQVEsRUFBRVAsUUFBUSxDQUFDTyxRQUR3QjtBQUUzQ0MsUUFBQUEsUUFBUSxFQUFFUixRQUFRLENBQUNRO0FBRndCLE9BQS9CLENBQWhCOztBQUlBLFVBQUlQLGVBQUosRUFBcUI7QUFDakJGLFFBQUFBLEtBQUssR0FBR0ssR0FBRyxDQUFDSCxlQUFELENBQUgsQ0FBcUJGLEtBQTdCO0FBQ0gsT0FGRCxNQUVPO0FBQ0hBLFFBQUFBLEtBQUssR0FBR0ssR0FBRyxDQUFDTCxLQUFaO0FBQ0g7O0FBQ0R6SCxNQUFBQSxVQUFVLENBQUNxQyxPQUFELENBQVYsR0FBc0JvRixLQUF0QjtBQUVBOUYsTUFBQUEsR0FBRyxDQUFDMEIsR0FBSixDQUFRLE1BQVIsRUFBaUIsbUJBQWtCaEIsT0FBUSxJQUEzQztBQUNIOztBQUVEQyxJQUFBQSxNQUFNLENBQUNrRixNQUFQLEdBQWlCVyxHQUFELElBQVM7QUFDckJBLE1BQUFBLEdBQUcsQ0FBQ0MsR0FBSixDQUFRLGVBQVIsRUFBMEIsVUFBU1gsS0FBTSxFQUF6QztBQUNILEtBRkQ7O0FBSUEsV0FBT25GLE1BQVA7QUFDSDs7QUEvVU87O0FBa1ZaK0YsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEksS0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuXG5jb25zdCB0b2tlbkNhY2hlID0ge307XG5sZXQgYWxsdXJlO1xuXG4vKipcbiAqIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aFJlc3RDbGllbnRcbiAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgYXBwXG4gKiBAcGFyYW0ge1Jlc3RDbGllbnR9IGNsaWVudCAtIFRoZSByZXN0IGNsaWVudFxuICovXG5cbi8qKlxuICogVGVzdCBmdW5jdGlvbiB3aXRoIGEgd29ya2VyIGFwcC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aEFwcFxuICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBhcHBcbiAqL1xuXG4vKipcbiAqIFRlc3QgY2FzZSBib2R5LlxuICogQGNhbGxiYWNrIHRlc3RDYXNlQm9keVxuICogQHBhcmFtIHsqfSBkYXRhIC0gVGVzdCBkYXRhXG4gKi9cblxuLyoqXG4gKiBUZXN0IHN1aXRlIG9iamVjdC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBTdWl0ZSB7XG4gICAgLyoqXG4gICAgICogW3ByaXZhdGVdIFN1aXRlIHdpbGwgYmUgY3JlYXRlZCBieSB0ZXN0U3VpdGUgY3JlYXRvci5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFN1aXRlIG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gU3VpdGUgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5zZXJ2ZXJFbnRyeT1cIi4uLy4uL3NyYy9pbmRleC5qc1wiXSAtIFRoZSBlbnRyeSBmaWxlIG9mIEBnZW54L3NlcnZlciBpbnN0YW5jZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnZlcmJvc2U9ZmFsc2VdIC0gVmVyYm9zZSBtb2RlLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgY29uc3QgeyBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuc2VydmVyRW50cnkgPSBzZXJ2ZXJFbnRyeTtcbiAgICAgICAgdGhpcy52ZXJib3NlID0gdmVyYm9zZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCB0aGUgQGdlbngvc2VydmVyIGluc3RhY2UgZm9yIGNvZGUgY292ZXJhZ2UgdGVzdGluZy5cbiAgICAgKiBAYXN5bmNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0V2ViU2VydmVyXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJXZWIgc2VydmVyIGFscmVhZHkgc3RhcnRlZC5cIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjcmVhdGVXZWJTZXJ2ZXIgPSB0aGlzLnNlcnZlckVudHJ5ID8gcmVxdWlyZSh0aGlzLnNlcnZlckVudHJ5KSA6IHJlcXVpcmUubWFpbi5yZXF1aXJlKFwiLi4vLi4vc3JjL2luZGV4LmpzXCIpXG4gICAgICAgIHRoaXMud2ViU2VydmVyID0gY3JlYXRlV2ViU2VydmVyKHtcbiAgICAgICAgICAgIGV4aXRPblVuY2F1Z2h0OiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQgPT0gbnVsbCB8fCB0aGlzLndlYlNlcnZlci5zdGFydGVkLnNob3VsZC5ub3QuYmUub2soKTtcblxuICAgICAgICBhd2FpdCB0aGlzLndlYlNlcnZlci5zdGFydF8oKTtcblxuICAgICAgICB0aGlzLndlYlNlcnZlci5zdGFydGVkLnNob3VsZC5iZS5vaygpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLndlYlNlcnZlcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBzZXJ2ZXIgaWYgaXQgaXMgc3RhcnRlZC5cbiAgICAgKiBAYXN5bmNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLndlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RvcF8oKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMud2ViU2VydmVyO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgYSB3b3JrZXIgYXBwIGZvciB0ZXN0aW5nXG4gICAgICogQHBhcmFtIHt0ZXN0V2l0aFJlc3RDbGllbnR9IHRlc3RUb1J1biAtIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRXb3JrZXJfKHRlc3RUb1J1biwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBTdGFydGVyczogeyBzdGFydFdvcmtlciB9LFxuICAgICAgICB9ID0gcmVxdWlyZShcIkBnZW54L2FwcFwiKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBlcnI7XG5cbiAgICAgICAgYXdhaXQgc3RhcnRXb3JrZXIoXG4gICAgICAgICAgICBhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGVzdFRvUnVuKGFwcCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgd29ya2VyTmFtZTogXCJ0ZXN0ZXJcIixcbiAgICAgICAgICAgICAgICBjb25maWdOYW1lOiBcInRlc3RcIixcbiAgICAgICAgICAgICAgICBjb25maWdQYXRoOiBcIi4vdGVzdC9jb25mXCIsXG4gICAgICAgICAgICAgICAgYXBwTW9kdWxlc1BhdGg6IFwiYXBwX21vZHVsZXNcIixcbiAgICAgICAgICAgICAgICBpZ25vcmVVbmNhdWdodDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHNob3VsZC5ub3QuZXhpc3QoZXJyLCBlcnIubWVzc2FnZSB8fCBlcnIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgYSByZXN0IGNsaWVudCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGNvbmZpZyBrZXkgb2YgdGFyZ2V0IGVuZHBvaW50XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJUYWcgLSBUaGUgY29uZmlnIGtleSBvZiBwcmVkZWZpbmVkIHVzZXIgaWRlbnRpdHksIHBhc3MgbnVsbCBmb3IgZ3Vlc3QgbW9kZS5cbiAgICAgKiBAcGFyYW0ge3Rlc3RXaXRoUmVzdENsaWVudH0gdGVzdFRvUnVuIC0gVGVzdCBmdW5jdGlvbiB3aXRoIGEgY29ubmVjdGVkIHJlc3QgY2xpZW50LlxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyAtIE9wdGlvbnMgcGFzc2VkIHRoZSB0ZXN0IHdvcmtlciwgc2VlIHN0YXJ0V29ya2VyIG9mIEBnZW54L2FwcC5cbiAgICAgKiBAYXN5bmNcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFJlc3RDbGllbnRfKG5hbWUsIHVzZXJUYWcsIHRlc3RUb1J1biwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGFydFdvcmtlcl8oYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5fZ2V0UmVzdENsaWVudF8oYXBwLCBuYW1lLCB1c2VyVGFnKTtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0VG9SdW4oYXBwLCBjbGllbnQpO1xuICAgICAgICB9LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGluaXRBbGx1cmUoKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSB7XG4gICAgICAgICAgICBjb25zdCBhbGx1cmVNb2NoYSA9IHJlcXVpcmUoXCJhbGx1cmUtbW9jaGEvcnVudGltZVwiKTtcbiAgICAgICAgICAgIGFsbHVyZSA9IGFsbHVyZU1vY2hhLmFsbHVyZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmluZSBhIHRlc3QgY2FzZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RvcnkgLSBUZXN0IGNhc2UgdGl0bGUuXG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHkgLSBUZXN0IGNhc2UgYm9keSB0byB3cml0ZSBhY3R1YWwgdGVzdCBjb2RlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc11cbiAgICAgKiBAcHJvcGVydHkgeyp9IG9wdGlvbnMuZGF0YSAtIFRlc3QgZGF0YVxuICAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9wdGlvbnMuY2xlYW5VcCAtIENsZWFudXAgYWZ0ZXIgdGhlIGNhc2UgZW5kcyByZWdhcmRsZXNzIHdoZXRoZXIgaXQgaXMgc3VjY2Vzc2Z1bCBvciBub3QuXG4gICAgICovXG4gICAgdGVzdENhc2Uoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBjbGVhblVwLCBza2lwLCBvbmx5IH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIGxldCBvcHQ7XG5cbiAgICAgICAgaWYgKG9ubHkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2UgaWYgKHNraXApIHtcbiAgICAgICAgICAgIG9wdCA9IFwic2tpcFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgKG9wdCA/IGl0W29wdF0gOiBpdCkoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChzZWxmLnZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN0b3J5OlwiLCBzdG9yeSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcblxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiAmJiBhbGx1cmUuZGVzY3JpcHRpb24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlICYmIGFsbHVyZS5mZWF0dXJlKGZlYXR1cmUpO1xuICAgICAgICAgICAgICAgICAgICBvd25lciAmJiBhbGx1cmUub3duZXIob3duZXIpO1xuICAgICAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgICAgICBzZXZlcml0eSAmJiBhbGx1cmUuc2V2ZXJpdHkoc2V2ZXJpdHkpO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uaXNFbXB0eShpc3N1ZXMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvck93bihpc3N1ZXMsIChsaW5rLCBudW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUuaXNzdWUobnVtLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG4gICAgICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoYHN0YXJ0ICR7c3Rvcnl9YCwgKCkgPT4ge30pKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnBhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgXCIqc2VlIGF0dGFjaG1lbnQqXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXR0YWNoT2JqZWN0KGBwYXJhbVske2t9XWAsIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjbGVhblVwKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICAgICAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGVhblVwKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZXN0IGNhc2Ugd2l0aCBmaXh0dXJlcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RvcnlcbiAgICAgKiBAcGFyYW0ge3Rlc3RDYXNlQm9keX0gYm9keVxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cbiAgICAgKi9cbiAgICB0ZXN0Q2FzZUZyb21GaXh0dXJlcyhzdG9yeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCBwID0gcGF0aC5yZXNvbHZlKGB0ZXN0L2ZpeHR1cmVzLyR7dGhpcy5uYW1lfS5qc2ApO1xuICAgICAgICBjb25zdCBzdWl0ZURhdGEgPSByZXF1aXJlKHApO1xuICAgICAgICBpZiAoIXN1aXRlRGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdWl0ZSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7dGhpcy5uYW1lfWApO1xuXG4gICAgICAgIGNvbnN0IHsgY2FzZXMsIC4uLm90aGVycyB9ID0gc3VpdGVEYXRhO1xuXG4gICAgICAgIGNvbnN0IHN0b3J5RGF0YSA9IGNhc2VzICYmIGNhc2VzW3N0b3J5XTtcbiAgICAgICAgaWYgKCFzdG9yeURhdGEpIHRocm93IG5ldyBFcnJvcihgU3RvcnkgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX0sIHN0b3J5OiAke3N0b3J5fWApO1xuXG4gICAgICAgIF8uY2FzdEFycmF5KHN0b3J5RGF0YSkuZm9yRWFjaCgoY2FzZURhdGEsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByZXBhcmVkRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBhbGx1cmU6IG90aGVycyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IF8ubWFwVmFsdWVzKGNhc2VEYXRhLnBhcmFtcywgKHYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSBcImZ1bmN0aW9uXCIpIHJldHVybiB2KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBjYXNlRGF0YS5leHBlY3RlZCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMudGVzdENhc2UoYCR7c3Rvcnl9IyR7aSArIDF9YCwgYm9keSwgeyAuLi5vcHRpb25zLCBkYXRhOiBwcmVwYXJlZERhdGEgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1biBiZW5jaG1hcmsgYWdhaW5zdCBnaXZlbiBtZXRob2RzLlxuICAgICAqIEBwYXJhbSB7Kn0gbWFwT2ZNZXRob2RzIC0gTWFwIG9mIG5hbWUgdG8gZnVuY3Rpb24gd2l0aCBwYXlsb2FkXG4gICAgICogQHBhcmFtIHsqfSBwYXlsb2FkIFxuICAgICAqL1xuICAgIGFzeW5jIGJlbmNobWFya18obWFwT2ZNZXRob2RzLCBwYXlsb2FkKSB7XG4gICAgICAgIGNvbnN0IEJlbmNobWFyayA9IHJlcXVpcmUoXCJiZW5jaG1hcmtcIik7XG4gICAgICAgIGNvbnN0IHN1aXRlID0gbmV3IEJlbmNobWFyay5TdWl0ZSgpO1xuXG4gICAgICAgIF8uZWFjaChtYXBPZk1ldGhvZHMsIChmLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBzdWl0ZS5hZGQobmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGYocGF5bG9hZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgICAgICBzdWl0ZVxuICAgICAgICAgICAgICAgIC5vbihcImN5Y2xlXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjeWNsZU1lc3NhZ2UgPSBTdHJpbmcoZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QoXCJjeWNsZVwiLCBjeWNsZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiY29tcGxldGVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wbGV0ZU1lc3NhZ2UgPSBcIlRoZSBmYXN0ZXN0IGlzIFwiICsgdGhpcy5maWx0ZXIoXCJmYXN0ZXN0XCIpLm1hcChcIm5hbWVcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbXBsZXRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuYXR0YWNoT2JqZWN0KFwiY29tcGxldGVcIiwgY29tcGxldGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiZXJyb3JcIiwgKGV2ZW50KSA9PiByZWplY3QoU3RyaW5nKGV2ZW50LnRhcmdldCkpKVxuICAgICAgICAgICAgICAgIC5ydW4oeyBhc3luYzogdHJ1ZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lIGEgdGVzdCBzdGVwLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2JvZHldIC0gVGVzdCBzdGVwIGJvZHlcbiAgICAgKi9cbiAgICBhc3luYyB0ZXN0U3RlcF8oc3RlcCwgYm9keSkge1xuICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChzdGVwLCAoKSA9PiB7fSkoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnZlcmJvc2UpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3RlcDogXCIsIHN0ZXApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJvZHkpIHtcbiAgICAgICAgICAgIGF3YWl0IGJvZHkoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhbiBvYmplY3QgdG8gdGhlIHRlc3QgcmVwb3J0LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBvYmpcbiAgICAgKi9cbiAgICBhdHRhY2hPYmplY3QobmFtZSwgb2JqKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSByZXR1cm47XG5cbiAgICAgICAgbGV0IHR5cGUgPSBcInRleHQvcGxhaW5cIixcbiAgICAgICAgICAgIGNvbnRlbnQgPSBvYmo7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDQpO1xuICAgICAgICAgICAgdHlwZSA9IFwiYXBwbGljYXRpb24vanNvblwiO1xuICAgICAgICB9XG5cbiAgICAgICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgdXNlclRhZykge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBhcHAuZ2V0U2VydmljZSh0aGlzLndlYlNlcnZlciA/IGBzdXBlclRlc3QtJHtuYW1lfWAgOiBgcmVzdENsaWVudC0ke25hbWV9YCk7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgY2xpZW50LnNlcnZlciA9IHRoaXMud2ViU2VydmVyLmh0dHBTZXJ2ZXI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNsaWVudC5vblNlbnQpIHtcbiAgICAgICAgICAgIGNsaWVudC5vblNlbnQgPSAodXJsLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaE9iamVjdCh1cmwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF1c2VyVGFnKSB7XG4gICAgICAgICAgICBkZWxldGUgY2xpZW50Lm9uU2VuZDtcbiAgICAgICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdG9rZW4sIHVzZXJBdXRoO1xuICAgICAgICBsZXQgcmVzcG9uc2VCb2R5S2V5ID0gYXBwLnNldHRpbmdzLnJlc3BvbnNlQm9keUtleTtcblxuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHVzZXJUYWcpKSB7XG4gICAgICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZy51c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gdXNlclRhZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnXTtcbiAgICAgICAgICAgIHVzZXJBdXRoID0gYXBwLnNldHRpbmdzLnVzZXJBdXRoW3VzZXJUYWddO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGNsaWVudC5wb3N0KHVzZXJBdXRoLmVuZHBvaW50LCB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJBdXRoLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiB1c2VyQXV0aC5wYXNzd29yZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlQm9keUtleSkge1xuICAgICAgICAgICAgICAgIHRva2VuID0gcmVzW3Jlc3BvbnNlQm9keUtleV0udG9rZW47XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRva2VuID0gcmVzLnRva2VuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdG9rZW5DYWNoZVt1c2VyVGFnXSA9IHRva2VuO1xuXG4gICAgICAgICAgICBhcHAubG9nKFwiaW5mb1wiLCBgTG9nZ2VkIGluIHdpdGggWyR7dXNlclRhZ31dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY2xpZW50Lm9uU2VuZCA9IChyZXEpID0+IHtcbiAgICAgICAgICAgIHJlcS5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTdWl0ZTtcbiJdfQ==