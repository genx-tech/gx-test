"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("rk-utils");

const {
  Starters: {
    startWorker
  }
} = require("@genx/app");

const tokenCache = {};
let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry || "../../src/index.js";
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = require(this.serverEntry);

    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      should.not.exist(err, err.message || err);
    }
  }

  async startRestClient_(name, userTag, testToRun, options) {
    return this.startWorker_(async app => {
      const client = await this._getRestClient_(app, name, userTag);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();
    Object.entries(mapOfMethods).forEach(([name, f]) => {
      suite.add(name, function () {
        f(payload);
      });
    });
    return new Promise((resolve, reject) => {
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        this.attachObject("complete", cycleMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    if (allure) {
      allure.createStep(step, () => {})();
    }

    if (this.verbose) {
      console.log("Step: ", step);
    }

    if (body) {
      await body();
    }
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "plain/text",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, userTag) {
    const client = app.getService(this.webServer ? `superTest.${name}` : `restClient.${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!userTag) {
      delete client.onSend;
      return client;
    }

    let token, userAuth;

    if (_.isPlainObject(userTag)) {
      token = tokenCache[userTag.userTag];
      userAuth = userTag;
    } else {
      token = tokenCache[userTag];
      userAuth = app.settings.userAuth[userTag];
    }

    if (!token) {
      let res = await client.post(userAuth.endpoint, {
        username: userAuth.username,
        password: userAuth.password
      });
      token = res.token;
      tokenCache[userTag] = token;
      app.log("info", `Logged in with [${userTag}].`);
    }

    client.onSend = req => {
      req.set("Authorization", `Bearer ${token}`);
    };

    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJTdGFydGVycyIsInN0YXJ0V29ya2VyIiwidG9rZW5DYWNoZSIsImFsbHVyZSIsIlN1aXRlIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsInNlcnZlckVudHJ5IiwidmVyYm9zZSIsInN0YXJ0V2ViU2VydmVyXyIsIndlYlNlcnZlciIsIkVycm9yIiwiY3JlYXRlV2ViU2VydmVyIiwiZXhpdE9uVW5jYXVnaHQiLCJzdGFydGVkIiwic2hvdWxkIiwibm90IiwiYmUiLCJvayIsInN0YXJ0XyIsInN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfIiwic3RvcF8iLCJzdGFydFdvcmtlcl8iLCJ0ZXN0VG9SdW4iLCJlcnIiLCJhcHAiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInN0YXJ0UmVzdENsaWVudF8iLCJ1c2VyVGFnIiwiY2xpZW50IiwiX2dldFJlc3RDbGllbnRfIiwiaW5pdEFsbHVyZSIsImFsbHVyZU1vY2hhIiwidGVzdENhc2UiLCJzdG9yeSIsImJvZHkiLCJkYXRhIiwiY2xlYW5VcCIsInNraXAiLCJvbmx5Iiwic2VsZiIsIm9wdCIsIml0IiwiY29uc29sZSIsImxvZyIsImRlc2NyaXB0aW9uIiwiZXBpYyIsImZlYXR1cmUiLCJvd25lciIsInRhZyIsImlzc3VlcyIsInNldmVyaXR5IiwiaXNFbXB0eSIsImZvck93biIsImxpbmsiLCJudW0iLCJpc3N1ZSIsImNyZWF0ZVN0ZXAiLCJwYXJhbXMiLCJ2IiwiayIsInBhcmFtZXRlciIsImF0dGFjaE9iamVjdCIsInRlc3RDYXNlRnJvbUZpeHR1cmVzIiwicCIsInJlc29sdmUiLCJzdWl0ZURhdGEiLCJjYXNlcyIsIm90aGVycyIsInN0b3J5RGF0YSIsImNhc3RBcnJheSIsImZvckVhY2giLCJjYXNlRGF0YSIsImkiLCJwcmVwYXJlZERhdGEiLCJtYXBWYWx1ZXMiLCJleHBlY3RlZCIsImJlbmNobWFya18iLCJtYXBPZk1ldGhvZHMiLCJwYXlsb2FkIiwiQmVuY2htYXJrIiwic3VpdGUiLCJPYmplY3QiLCJlbnRyaWVzIiwiZiIsImFkZCIsIlByb21pc2UiLCJyZWplY3QiLCJvbiIsImV2ZW50IiwiY3ljbGVNZXNzYWdlIiwiU3RyaW5nIiwidGFyZ2V0IiwiY29tcGxldGVNZXNzYWdlIiwiZmlsdGVyIiwibWFwIiwicnVuIiwiYXN5bmMiLCJ0ZXN0U3RlcF8iLCJzdGVwIiwib2JqIiwidHlwZSIsImNvbnRlbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiY3JlYXRlQXR0YWNobWVudCIsImdldFNlcnZpY2UiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib25TZW50IiwidXJsIiwicmVzdWx0Iiwib25TZW5kIiwidG9rZW4iLCJ1c2VyQXV0aCIsImlzUGxhaW5PYmplY3QiLCJzZXR0aW5ncyIsInJlcyIsInBvc3QiLCJlbmRwb2ludCIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJyZXEiLCJzZXQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUQsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUNGRSxFQUFBQSxRQUFRLEVBQUU7QUFBRUMsSUFBQUE7QUFBRjtBQURSLElBRUZILE9BQU8sQ0FBQyxXQUFELENBRlg7O0FBSUEsTUFBTUksVUFBVSxHQUFHLEVBQW5CO0FBQ0EsSUFBSUMsTUFBSjs7QUF5QkEsTUFBTUMsS0FBTixDQUFZO0FBUVJDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPQyxPQUFQLEVBQWdCO0FBQ3ZCLFNBQUtELElBQUwsR0FBWUEsSUFBWjtBQUNBLFVBQU07QUFBRUUsTUFBQUEsV0FBRjtBQUFlQyxNQUFB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QUNLLFFBQXJCLEVBQStCO0FBQzNDQyxRQUFBQSxRQUFRLEVBQUVOLFFBQVEsQ0FBQ00sUUFEd0I7QUFFM0NDLFFBQUFBLFFBQVEsRUFBRVAsUUFBUSxDQUFDTztBQUZ3QixPQUEvQixDQUFoQjtBQUlBUixNQUFBQSxLQUFLLEdBQUdJLEdBQUcsQ0FBQ0osS0FBWjtBQUNBdkgsTUFBQUEsVUFBVSxDQUFDa0MsT0FBRCxDQUFWLEdBQXNCcUYsS0FBdEI7QUFFQS9GLE1BQUFBLEdBQUcsQ0FBQzBCLEdBQUosQ0FBUSxNQUFSLEVBQWlCLG1CQUFrQmhCLE9BQVEsSUFBM0M7QUFDSDs7QUFFREMsSUFBQUEsTUFBTSxDQUFDbUYsTUFBUCxHQUFpQlUsR0FBRCxJQUFTO0FBQ3JCQSxNQUFBQSxHQUFHLENBQUNDLEdBQUosQ0FBUSxlQUFSLEVBQTBCLFVBQVNWLEtBQU0sRUFBekM7QUFDSCxLQUZEOztBQUlBLFdBQU9wRixNQUFQO0FBQ0g7O0FBL1RPOztBQWtVWitGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpJLEtBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKFwicmstdXRpbHNcIik7XG5jb25zdCB7XG4gICAgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSxcbn0gPSByZXF1aXJlKFwiQGdlbngvYXBwXCIpO1xuXG5jb25zdCB0b2tlbkNhY2hlID0ge307XG5sZXQgYWxsdXJlO1xuXG4vKipcbiAqIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aFJlc3RDbGllbnRcbiAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgYXBwXG4gKiBAcGFyYW0ge1Jlc3RDbGllbnR9IGNsaWVudCAtIFRoZSByZXN0IGNsaWVudFxuICovXG5cbi8qKlxuICogVGVzdCBmdW5jdGlvbiB3aXRoIGEgd29ya2VyIGFwcC5cbiAqIEBjYWxsYmFjayB0ZXN0V2l0aEFwcFxuICogQHBhcmFtIHtBcHB9IGFwcCAtIFRoZSBhcHBcbiAqL1xuXG4vKipcbiAqIFRlc3QgY2FzZSBib2R5LlxuICogQGNhbGxiYWNrIHRlc3RDYXNlQm9keVxuICogQHBhcmFtIHsqfSBkYXRhIC0gVGVzdCBkYXRhXG4gKi9cblxuLyoqXG4gKiBUZXN0IHN1aXRlIG9iamVjdC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBTdWl0ZSB7XG4gICAgLyoqXG4gICAgICogW3ByaXZhdGVdIFN1aXRlIHdpbGwgYmUgY3JlYXRlZCBieSB0ZXN0U3VpdGUgY3JlYXRvci5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFN1aXRlIG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gU3VpdGUgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5zZXJ2ZXJFbnRyeT1cIi4uLy4uL3NyYy9pbmRleC5qc1wiXSAtIFRoZSBlbnRyeSBmaWxlIG9mIEBnZW54L3NlcnZlciBpbnN0YW5jZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnZlcmJvc2U9ZmFsc2VdIC0gVmVyYm9zZSBtb2RlLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgY29uc3QgeyBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuc2VydmVyRW50cnkgPSBzZXJ2ZXJFbnRyeSB8fCBcIi4uLy4uL3NyYy9pbmRleC5qc1wiO1xuICAgICAgICB0aGlzLnZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBAZ2VueC9zZXJ2ZXIgaW5zdGFjZSBmb3IgY29kZSBjb3ZlcmFnZSB0ZXN0aW5nLlxuICAgICAqIEBhc3luY1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRXZWJTZXJ2ZXJfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIldlYiBzZXJ2ZXIgYWxyZWFkeSBzdGFydGVkLlwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVdlYlNlcnZlciA9IHJlcXVpcmUodGhpcy5zZXJ2ZXJFbnRyeSk7XG4gICAgICAgIHRoaXMud2ViU2VydmVyID0gY3JlYXRlV2ViU2VydmVyKHtcbiAgICAgICAgICAgIGV4aXRPblVuY2F1Z2h0OiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2ViU2VydmVyLnN0YXJ0ZWQgPT0gbnVsbCB8fCB0aGlzLndlYlNlcnZlci5zdGFydGVkLnNob3VsZC5ub3QuYmUub2soKTtcblxuICAgICAgICBhd2FpdCB0aGlzLndlYlNlcnZlci5zdGFydF8oKTtcblxuICAgICAgICB0aGlzLndlYlNlcnZlci5zdGFydGVkLnNob3VsZC5iZS5vaygpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLndlYlNlcnZlcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBzZXJ2ZXIgaWYgaXQgaXMgc3RhcnRlZC5cbiAgICAgKiBAYXN5bmNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BXZWJTZXJ2ZXJJZlN0YXJ0ZWRfKCkge1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLndlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RvcF8oKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMud2ViU2VydmVyO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgYSB3b3JrZXIgYXBwIGZvciB0ZXN0aW5nXG4gICAgICogQHBhcmFtIHt0ZXN0V2l0aFJlc3RDbGllbnR9IHRlc3RUb1J1biAtIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRXb3JrZXJfKHRlc3RUb1J1biwgb3B0aW9ucykge1xuICAgICAgICBsZXQgZXJyO1xuXG4gICAgICAgIGF3YWl0IHN0YXJ0V29ya2VyKFxuICAgICAgICAgICAgYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRlc3RUb1J1bihhcHApO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHdvcmtlck5hbWU6IFwidGVzdGVyXCIsXG4gICAgICAgICAgICAgICAgY29uZmlnTmFtZTogXCJ0ZXN0XCIsXG4gICAgICAgICAgICAgICAgY29uZmlnUGF0aDogXCIuL3Rlc3QvY29uZlwiLFxuICAgICAgICAgICAgICAgIGFwcE1vZHVsZXNQYXRoOiBcImFwcF9tb2R1bGVzXCIsXG4gICAgICAgICAgICAgICAgaWdub3JlVW5jYXVnaHQ6IHRydWUsXG4gICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBzaG91bGQubm90LmV4aXN0KGVyciwgZXJyLm1lc3NhZ2UgfHwgZXJyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgcmVzdCBjbGllbnQgZm9yIHRlc3RpbmdcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBjb25maWcga2V5IG9mIHRhcmdldCBlbmRwb2ludFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VyVGFnIC0gVGhlIGNvbmZpZyBrZXkgb2YgcHJlZGVmaW5lZCB1c2VyIGlkZW50aXR5LCBwYXNzIG51bGwgZm9yIGd1ZXN0IG1vZGUuXG4gICAgICogQHBhcmFtIHt0ZXN0V2l0aFJlc3RDbGllbnR9IHRlc3RUb1J1biAtIFRlc3QgZnVuY3Rpb24gd2l0aCBhIGNvbm5lY3RlZCByZXN0IGNsaWVudC5cbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRSZXN0Q2xpZW50XyhuYW1lLCB1c2VyVGFnLCB0ZXN0VG9SdW4sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRXb3JrZXJfKGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMuX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgdXNlclRhZyk7XG4gICAgICAgICAgICByZXR1cm4gdGVzdFRvUnVuKGFwcCwgY2xpZW50KTtcbiAgICAgICAgfSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBpbml0QWxsdXJlKCkge1xuICAgICAgICBpZiAoIWFsbHVyZSkge1xuICAgICAgICAgICAgY29uc3QgYWxsdXJlTW9jaGEgPSByZXF1aXJlKFwiYWxsdXJlLW1vY2hhL3J1bnRpbWVcIik7XG4gICAgICAgICAgICBhbGx1cmUgPSBhbGx1cmVNb2NoYS5hbGx1cmU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWZpbmUgYSB0ZXN0IGNhc2UuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0b3J5IC0gVGVzdCBjYXNlIHRpdGxlLlxuICAgICAqIEBwYXJhbSB7dGVzdENhc2VCb2R5fSBib2R5IC0gVGVzdCBjYXNlIGJvZHkgdG8gd3JpdGUgYWN0dWFsIHRlc3QgY29kZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdXG4gICAgICogQHByb3BlcnR5IHsqfSBvcHRpb25zLmRhdGEgLSBUZXN0IGRhdGFcbiAgICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvcHRpb25zLmNsZWFuVXAgLSBDbGVhbnVwIGFmdGVyIHRoZSBjYXNlIGVuZHMgcmVnYXJkbGVzcyB3aGV0aGVyIGl0IGlzIHN1Y2Nlc3NmdWwgb3Igbm90LlxuICAgICAqL1xuICAgIHRlc3RDYXNlKHN0b3J5LCBib2R5LCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHsgZGF0YSwgY2xlYW5VcCwgc2tpcCwgb25seSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgICAgICBsZXQgb3B0O1xuXG4gICAgICAgIGlmIChvbmx5KSB7XG4gICAgICAgICAgICBvcHQgPSBcIm9ubHlcIjtcbiAgICAgICAgfSBlbHNlIGlmIChza2lwKSB7XG4gICAgICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIChvcHQgPyBpdFtvcHRdIDogaXQpKHN0b3J5LCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoc2VsZi52ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdGFydGluZyBzdG9yeTpcIiwgc3RvcnkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBkZXNjcmlwdGlvbiwgZXBpYywgZmVhdHVyZSwgb3duZXIsIHRhZywgaXNzdWVzLCBzZXZlcml0eSB9ID0gZGF0YS5hbGx1cmU7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gJiYgYWxsdXJlLmRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgZXBpYyAmJiBhbGx1cmUuZXBpYyhlcGljKTtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZSAmJiBhbGx1cmUuZmVhdHVyZShmZWF0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgb3duZXIgJiYgYWxsdXJlLm93bmVyKG93bmVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGFnICYmIGFsbHVyZS50YWcodGFnKTtcbiAgICAgICAgICAgICAgICAgICAgc2V2ZXJpdHkgJiYgYWxsdXJlLnNldmVyaXR5KHNldmVyaXR5KTtcblxuICAgICAgICAgICAgICAgICAgICBfLmlzRW1wdHkoaXNzdWVzKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oaXNzdWVzLCAobGluaywgbnVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLmlzc3VlKG51bSwgbGluayk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhbGx1cmUuc3Rvcnkoc3RvcnkpO1xuICAgICAgICAgICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKGBzdGFydCAke3N0b3J5fWAsICgpID0+IHt9KSgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JPd24oZGF0YS5wYXJhbXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIFwiKnNlZSBhdHRhY2htZW50KlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmF0dGFjaE9iamVjdChgcGFyYW1bJHtrfV1gLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2xlYW5VcCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY2xlYW5VcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVzdCBjYXNlIHdpdGggZml4dHVyZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0b3J5XG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHlcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXG4gICAgICovXG4gICAgdGVzdENhc2VGcm9tRml4dHVyZXMoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3RoaXMubmFtZX0uanNgKTtcbiAgICAgICAgY29uc3Qgc3VpdGVEYXRhID0gcmVxdWlyZShwKTtcbiAgICAgICAgaWYgKCFzdWl0ZURhdGEpIHRocm93IG5ldyBFcnJvcihgU3VpdGUgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX1gKTtcblxuICAgICAgICBjb25zdCB7IGNhc2VzLCAuLi5vdGhlcnMgfSA9IHN1aXRlRGF0YTtcblxuICAgICAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07XG4gICAgICAgIGlmICghc3RvcnlEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN0b3J5IGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHt0aGlzLm5hbWV9LCBzdG9yeTogJHtzdG9yeX1gKTtcblxuICAgICAgICBfLmNhc3RBcnJheShzdG9yeURhdGEpLmZvckVhY2goKGNhc2VEYXRhLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmVwYXJlZERhdGEgPSB7XG4gICAgICAgICAgICAgICAgYWxsdXJlOiBvdGhlcnMsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiBfLm1hcFZhbHVlcyhjYXNlRGF0YS5wYXJhbXMsICh2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gdigpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZDogY2FzZURhdGEuZXhwZWN0ZWQsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLnRlc3RDYXNlKGAke3N0b3J5fSMke2kgKyAxfWAsIGJvZHksIHsgLi4ub3B0aW9ucywgZGF0YTogcHJlcGFyZWREYXRhIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBiZW5jaG1hcmtfKG1hcE9mTWV0aG9kcywgcGF5bG9hZCkge1xuICAgICAgICBjb25zdCBCZW5jaG1hcmsgPSByZXF1aXJlKFwiYmVuY2htYXJrXCIpO1xuICAgICAgICBjb25zdCBzdWl0ZSA9IG5ldyBCZW5jaG1hcmsuU3VpdGUoKTtcblxuICAgICAgICBPYmplY3QuZW50cmllcyhtYXBPZk1ldGhvZHMpLmZvckVhY2goKFtuYW1lLCBmXSkgPT4ge1xuICAgICAgICAgICAgc3VpdGUuYWRkKG5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBmKHBheWxvYWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBzdWl0ZVxuICAgICAgICAgICAgICAgIC5vbihcImN5Y2xlXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjeWNsZU1lc3NhZ2UgPSBTdHJpbmcoZXZlbnQudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QoXCJjeWNsZVwiLCBjeWNsZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiY29tcGxldGVcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wbGV0ZU1lc3NhZ2UgPSBcIlRoZSBmYXN0ZXN0IGlzIFwiICsgdGhpcy5maWx0ZXIoXCJmYXN0ZXN0XCIpLm1hcChcIm5hbWVcIik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbXBsZXRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoT2JqZWN0KFwiY29tcGxldGVcIiwgY3ljbGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLm9uKFwiZXJyb3JcIiwgKGV2ZW50KSA9PiByZWplY3QoU3RyaW5nKGV2ZW50LnRhcmdldCkpKVxuICAgICAgICAgICAgICAgIC5ydW4oeyBhc3luYzogdHJ1ZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lIGEgdGVzdCBzdGVwLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGVwXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW2JvZHldIC0gVGVzdCBzdGVwIGJvZHlcbiAgICAgKi9cbiAgICBhc3luYyB0ZXN0U3RlcF8oc3RlcCwgYm9keSkge1xuICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChzdGVwLCAoKSA9PiB7fSkoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnZlcmJvc2UpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU3RlcDogXCIsIHN0ZXApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJvZHkpIHtcbiAgICAgICAgICAgIGF3YWl0IGJvZHkoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaCBhbiBvYmplY3QgdG8gdGhlIHRlc3QgcmVwb3J0LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBvYmpcbiAgICAgKi9cbiAgICBhdHRhY2hPYmplY3QobmFtZSwgb2JqKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSByZXR1cm47XG5cbiAgICAgICAgbGV0IHR5cGUgPSBcInBsYWluL3RleHRcIixcbiAgICAgICAgICAgIGNvbnRlbnQgPSBvYmo7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDQpO1xuICAgICAgICAgICAgdHlwZSA9IFwiYXBwbGljYXRpb24vanNvblwiO1xuICAgICAgICB9XG5cbiAgICAgICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFJlc3RDbGllbnRfKGFwcCwgbmFtZSwgdXNlclRhZykge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBhcHAuZ2V0U2VydmljZSh0aGlzLndlYlNlcnZlciA/IGBzdXBlclRlc3QuJHtuYW1lfWAgOiBgcmVzdENsaWVudC4ke25hbWV9YCk7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgY2xpZW50LnNlcnZlciA9IHRoaXMud2ViU2VydmVyLmh0dHBTZXJ2ZXI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNsaWVudC5vblNlbnQpIHtcbiAgICAgICAgICAgIGNsaWVudC5vblNlbnQgPSAodXJsLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaE9iamVjdCh1cmwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF1c2VyVGFnKSB7XG4gICAgICAgICAgICBkZWxldGUgY2xpZW50Lm9uU2VuZDtcbiAgICAgICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdG9rZW4sIHVzZXJBdXRoO1xuXG4gICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodXNlclRhZykpIHtcbiAgICAgICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnLnVzZXJUYWddO1xuICAgICAgICAgICAgdXNlckF1dGggPSB1c2VyVGFnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdG9rZW4gPSB0b2tlbkNhY2hlW3VzZXJUYWddO1xuICAgICAgICAgICAgdXNlckF1dGggPSBhcHAuc2V0dGluZ3MudXNlckF1dGhbdXNlclRhZ107XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgY2xpZW50LnBvc3QodXNlckF1dGguZW5kcG9pbnQsIHtcbiAgICAgICAgICAgICAgICB1c2VybmFtZTogdXNlckF1dGgudXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHVzZXJBdXRoLnBhc3N3b3JkLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0b2tlbiA9IHJlcy50b2tlbjtcbiAgICAgICAgICAgIHRva2VuQ2FjaGVbdXNlclRhZ10gPSB0b2tlbjtcblxuICAgICAgICAgICAgYXBwLmxvZyhcImluZm9cIiwgYExvZ2dlZCBpbiB3aXRoIFske3VzZXJUYWd9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNsaWVudC5vblNlbmQgPSAocmVxKSA9PiB7XG4gICAgICAgICAgICByZXEuc2V0KFwiQXV0aG9yaXphdGlvblwiLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3VpdGU7XG4iXX0=