"use strict";

require("source-map-support/register");

const path = require("path");

const {
  _
} = require("@genx/july");

const defaultUserAuth = require("./defaultUserAuth");

let allure;

class Suite {
  constructor(name, options) {
    this.name = name;
    const {
      serverEntry,
      verbose
    } = options == null ? {} : options;
    this.serverEntry = serverEntry;
    this.verbose = verbose;
  }

  async startWebServer_() {
    if (this.webServer) {
      throw new Error("Web server already started.");
    }

    const createWebServer = this.serverEntry ? require(this.serverEntry) : require.main.require("../../src/index.js");
    this.webServer = createWebServer({
      exitOnUncaught: false
    });
    this.webServer.started == null || this.webServer.started.should.not.be.ok();
    await this.webServer.start_();
    this.webServer.started.should.be.ok();
    return this.webServer;
  }

  async stopWebServerIfStarted_() {
    if (this.webServer) {
      if (this.webServer.started) {
        await this.webServer.stop_();
      }

      delete this.webServer;
    }
  }

  async startWorker_(testToRun, options) {
    const {
      Starters: {
        startWorker
      }
    } = require("@genx/app");

    let err;
    await startWorker(async app => {
      try {
        await testToRun(app);
      } catch (e) {
        err = e;
      }
    }, {
      workerName: "tester",
      configName: "test",
      configPath: "./test/conf",
      appModulesPath: "app_modules",
      ignoreUncaught: true,
      ...options
    });

    if (err) {
      throw err;
    }
  }

  async startRestClient_(serviceName, authenticator, testToRun, options) {
    return this.startWorker_(async app => {
      if (typeof options === "undefined") {
        if (typeof testToRun === "undefined") {
          testToRun = authenticator;
          authenticator = null;
        } else if (typeof testToRun === "object") {
          options = testToRun;
          testToRun = authenticator;
          authenticator = null;
        }
      }

      if (typeof authenticator === "string") {
        authenticator = defaultUserAuth(authenticator);
      }

      const client = await this._getRestClient_(app, serviceName, authenticator);
      return testToRun(app, client);
    }, options);
  }

  initAllure() {
    if (!allure) {
      const allureMocha = require("allure-mocha/runtime");

      allure = allureMocha.allure;
    }
  }

  testCase(story, body, options) {
    const {
      data,
      cleanUp,
      skip,
      only
    } = options == null ? {} : options;
    const self = this;
    let opt;

    if (only) {
      opt = "only";
    } else if (skip) {
      opt = "skip";
    }

    (opt ? it[opt] : it)(story, async function () {
      if (self.verbose) {
        console.log("Starting story:", story);
      }

      if (allure) {
        if (data) {
          const {
            description,
            epic,
            feature,
            owner,
            tag,
            issues,
            severity
          } = data.allure;
          description && allure.description(description);
          epic && allure.epic(epic);
          feature && allure.feature(feature);
          owner && allure.owner(owner);
          tag && allure.tag(tag);
          severity && allure.severity(severity);
          _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
            allure.issue(num, link);
          });
        }

        allure.story(story);
        allure.createStep(`start ${story}`, () => {})();

        if (data && data.params) {
          _.forOwn(data.params, (v, k) => {
            if (typeof v === "object") {
              allure.parameter(k, "*see attachment*");
              self.attachObject(`param[${k}]`, v);
            } else {
              allure.parameter(k, v);
            }
          });
        }
      }

      if (cleanUp) {
        try {
          await body(data);
        } finally {
          await cleanUp();
        }
      } else {
        await body(data);
      }
    });
  }

  testCaseFromFixtures(story, body, options) {
    const p = path.resolve(`test/fixtures/${this.name}.js`);

    const suiteData = require(p);

    if (!suiteData) throw new Error(`Suite data not found. Suite: ${this.name}`);
    const {
      cases,
      ...others
    } = suiteData;
    const storyData = cases && cases[story];
    if (!storyData) throw new Error(`Story data not found. Suite: ${this.name}, story: ${story}`);

    _.castArray(storyData).forEach((caseData, i) => {
      const preparedData = {
        allure: others,
        params: _.mapValues(caseData.params, v => {
          if (typeof v === "function") return v();
          return v;
        }),
        expected: caseData.expected
      };
      this.testCase(`${story}#${i + 1}`, body, { ...options,
        data: preparedData
      });
    });
  }

  async benchmark_(mapOfMethods, payload) {
    const Benchmark = require("benchmark");

    const suite = new Benchmark.Suite();

    _.each(mapOfMethods, (f, name) => {
      suite.add(name, function () {
        f(payload);
      });
    });

    return new Promise((resolve, reject) => {
      const self = this;
      suite.on("cycle", event => {
        const cycleMessage = String(event.target);
        console.log(cycleMessage);
        this.attachObject("cycle", cycleMessage);
      }).on("complete", function () {
        const completeMessage = "The fastest is " + this.filter("fastest").map("name");
        console.log(completeMessage);
        self.attachObject("complete", completeMessage);
        resolve();
      }).on("error", event => reject(String(event.target))).run({
        async: true
      });
    });
  }

  async testStep_(step, body) {
    const stepFn_ = allure ? allure.createStep(step, () => body()) : body;

    if (this.verbose) {
      console.log("Step: ", step);
    }

    await stepFn_();
  }

  attachObject(name, obj) {
    if (!allure) return;
    let type = "text/plain",
        content = obj;

    if (typeof obj !== "string") {
      content = JSON.stringify(obj, null, 4);
      type = "application/json";
    }

    allure.createAttachment(name, content, type);
  }

  async _getRestClient_(app, name, authenticator) {
    const client = app.getService(this.webServer ? `superTest-${name}` : `restClient-${name}`);

    if (this.webServer) {
      client.server = this.webServer.httpServer;
    }

    if (!client.onSent) {
      client.onSent = (url, result) => {
        this.attachObject(url, result);
      };
    }

    if (!authenticator) {
      delete client.onSend;
      return client;
    }

    await authenticator(app, client);
    return client;
  }

}

module.exports = Suite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWl0ZS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJkZWZhdWx0VXNlckF1dGgiLCJhbGx1cmUiLCJTdWl0ZSIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJzZXJ2ZXJFbnRyeSIsInZlcmJvc2UiLCJzdGFydFdlYlNlcnZlcl8iLCJ3ZWJTZXJ2ZXIiLCJFcnJvciIsImNyZWF0ZVdlYlNlcnZlciIsIm1haW4iLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJzdG9wXyIsInN0YXJ0V29ya2VyXyIsInRlc3RUb1J1biIsIlN0YXJ0ZXJzIiwic3RhcnRXb3JrZXIiLCJlcnIiLCJhcHAiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsInN0YXJ0UmVzdENsaWVudF8iLCJzZXJ2aWNlTmFtZSIsImF1dGhlbnRpY2F0b3IiLCJjbGllbnQiLCJfZ2V0UmVzdENsaWVudF8iLCJpbml0QWxsdXJlIiwiYWxsdXJlTW9jaGEiLCJ0ZXN0Q2FzZSIsInN0b3J5IiwiYm9keSIsImRhdGEiLCJjbGVhblVwIiwic2tpcCIsIm9ubHkiLCJzZWxmIiwib3B0IiwiaXQiLCJjb25zb2xlIiwibG9nIiwiZGVzY3JpcHRpb24iLCJlcGljIiwiZmVhdHVyZSIsIm93bmVyIiwidGFnIiwiaXNzdWVzIiwic2V2ZXJpdHkiLCJpc0VtcHR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwiY3JlYXRlU3RlcCIsInBhcmFtcyIsInYiLCJrIiwicGFyYW1ldGVyIiwiYXR0YWNoT2JqZWN0IiwidGVzdENhc2VGcm9tRml4dHVyZXMiLCJwIiwicmVzb2x2ZSIsInN1aXRlRGF0YSIsImNhc2VzIiwib3RoZXJzIiwic3RvcnlEYXRhIiwiY2FzdEFycmF5IiwiZm9yRWFjaCIsImNhc2VEYXRhIiwiaSIsInByZXBhcmVkRGF0YSIsIm1hcFZhbHVlcyIsImV4cGVjdGVkIiwiYmVuY2htYXJrXyIsIm1hcE9mTWV0aG9kcyIsInBheWxvYWQiLCJCZW5jaG1hcmsiLCJzdWl0ZSIsImVhY2giLCJmIiwiYWRkIiwiUHJvbWlzZSIsInJlamVjdCIsIm9uIiwiZXZlbnQiLCJjeWNsZU1lc3NhZ2UiLCJTdHJpbmciLCJ0YXJnZXQiLCJjb21wbGV0ZU1lc3NhZ2UiLCJmaWx0ZXIiLCJtYXAiLCJydW4iLCJhc3luYyIsInRlc3RTdGVwXyIsInN0ZXAiLCJzdGVwRm5fIiwib2JqIiwidHlwZSIsImNvbnRlbnQiLCJKU09OIiwic3RyaW5naWZ5IiwiY3JlYXRlQXR0YWNobWVudCIsImdldFNlcnZpY2UiLCJzZXJ2ZXIiLCJodHRwU2VydmVyIiwib25TZW50IiwidXJsIiwicmVzdWx0Iiwib25TZW5kIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFELE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLE1BQU1FLGVBQWUsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBQS9COztBQUVBLElBQUlHLE1BQUo7O0FBeUJBLE1BQU1DLEtBQU4sQ0FBWTtBQVFSQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBT0MsT0FBUCxFQUFnQjtBQUN2QixTQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDQSxVQUFNO0FBQUVFLE1BQUFBLFdBQUY7QUFBZUMsTUFBQUE7QUFBZixRQUEyQkYsT0FBTyxJQUFJLElBQVgsR0FBa0IsRUFBbEIsR0FBdUJBLE9BQXhEO0FBRUEsU0FBS0MsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDSDs7QUFPb0IsUUFBZkMsZUFBZSxHQUFHO0FBQ3BCLFFBQUksS0FBS0MsU0FBVCxFQUFvQjtBQUNoQixZQUFNLElBQUlDLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0g7O0FBRUQsVUFBTUMsZUFBZSxHQUFHLEtBQUtMLFdBQUwsR0FDbEJSLE9BQU8sQ0FBQyxLQUFLUSxXQUFOLENBRFcsR0FFbEJSLE9BQU8sQ0FBQ2MsSUFBUixDQUFhZCxPQUFiLENBQXFCLG9CQUFyQixDQUZOO0FBR0EsU0FBS1csU0FBTCxHQUFpQkUsZUFBZSxDQUFDO0FBQzdCRSxNQUFBQSxjQUFjLEVBQUU7QUFEYSxLQUFELENBQWhDO0FBR0EsU0FBS0osU0FBTCxDQUFlSyxPQUFmLElBQTBCLElBQTFCLElBQWtDLEtBQUtMLFNBQUwsQ0FBZUssT0FBZixDQUF1QkMsTUFBdkIsQ0FBOEJDLEdBQTlCLENBQWtDQyxFQUFsQyxDQUFxQ0MsRUFBckMsRUFBbEM7QUFFQSxVQUFNLEtBQUtULFNBQUwsQ0FBZVUsTUFBZixFQUFOO0FBRUEsU0FBS1YsU0FBTCxDQUFlSyxPQUFmLENBQXVCQyxNQUF2QixDQUE4QkUsRUFBOUIsQ0FBaUNDLEVBQWpDO0FBRUEsV0FBTyxLQUFLVCxTQUFaO0FBQ0g7O0FBTzRCLFFBQXZCVyx1QkFBdUIsR0FBRztBQUM1QixRQUFJLEtBQUtYLFNBQVQsRUFBb0I7QUFDaEIsVUFBSSxLQUFLQSxTQUFMLENBQWVLLE9BQW5CLEVBQTRCO0FBQ3hCLGNBQU0sS0FBS0wsU0FBTCxDQUFlWSxLQUFmLEVBQU47QUFDSDs7QUFFRCxhQUFPLEtBQUtaLFNBQVo7QUFDSDtBQUNKOztBQVFpQixRQUFaYSxZQUFZLENBQUNDLFNBQUQsRUFBWWxCLE9BQVosRUFBcUI7QUFDbkMsVUFBTTtBQUNGbUIsTUFBQUEsUUFBUSxFQUFFO0FBQUVDLFFBQUFBO0FBQUY7QUFEUixRQUVGM0IsT0FBTyxDQUFDLFdBQUQsQ0FGWDs7QUFJQSxRQUFJNEIsR0FBSjtBQUVBLFVBQU1ELFdBQVcsQ0FDYixNQUFPRSxHQUFQLElBQWU7QUFDWCxVQUFJO0FBQ0EsY0FBTUosU0FBUyxDQUFDSSxHQUFELENBQWY7QUFDSCxPQUZELENBRUUsT0FBT0MsQ0FBUCxFQUFVO0FBQ1JGLFFBQUFBLEdBQUcsR0FBR0UsQ0FBTjtBQUNIO0FBQ0osS0FQWSxFQVFiO0FBQ0lDLE1BQUFBLFVBQVUsRUFBRSxRQURoQjtBQUVJQyxNQUFBQSxVQUFVLEVBQUUsTUFGaEI7QUFHSUMsTUFBQUEsVUFBVSxFQUFFLGFBSGhCO0FBSUlDLE1BQUFBLGNBQWMsRUFBRSxhQUpwQjtBQUtJQyxNQUFBQSxjQUFjLEVBQUUsSUFMcEI7QUFNSSxTQUFHNUI7QUFOUCxLQVJhLENBQWpCOztBQWtCQSxRQUFJcUIsR0FBSixFQUFTO0FBQ0wsWUFBTUEsR0FBTjtBQUNIO0FBQ0o7O0FBVXFCLFFBQWhCUSxnQkFBZ0IsQ0FBQ0MsV0FBRCxFQUFjQyxhQUFkLEVBQTZCYixTQUE3QixFQUF3Q2xCLE9BQXhDLEVBQWlEO0FBQ25FLFdBQU8sS0FBS2lCLFlBQUwsQ0FBa0IsTUFBT0ssR0FBUCxJQUFlO0FBQ3BDLFVBQUksT0FBT3RCLE9BQVAsS0FBbUIsV0FBdkIsRUFBb0M7QUFDaEMsWUFBSSxPQUFPa0IsU0FBUCxLQUFxQixXQUF6QixFQUFzQztBQUNsQ0EsVUFBQUEsU0FBUyxHQUFHYSxhQUFaO0FBQ0FBLFVBQUFBLGFBQWEsR0FBRyxJQUFoQjtBQUNILFNBSEQsTUFHTyxJQUFJLE9BQU9iLFNBQVAsS0FBcUIsUUFBekIsRUFBbUM7QUFDdENsQixVQUFBQSxPQUFPLEdBQUdrQixTQUFWO0FBQ0FBLFVBQUFBLFNBQVMsR0FBR2EsYUFBWjtBQUNBQSxVQUFBQSxhQUFhLEdBQUcsSUFBaEI7QUFDSDtBQUNKOztBQUVELFVBQUksT0FBT0EsYUFBUCxLQUF5QixRQUE3QixFQUF1QztBQUNuQ0EsUUFBQUEsYUFBYSxHQUFHcEMsZUFBZSxDQUFDb0MsYUFBRCxDQUEvQjtBQUNIOztBQUVELFlBQU1DLE1BQU0sR0FBRyxNQUFNLEtBQUtDLGVBQUwsQ0FBcUJYLEdBQXJCLEVBQTBCUSxXQUExQixFQUF1Q0MsYUFBdkMsQ0FBckI7QUFDQSxhQUFPYixTQUFTLENBQUNJLEdBQUQsRUFBTVUsTUFBTixDQUFoQjtBQUNILEtBbEJNLEVBa0JKaEMsT0FsQkksQ0FBUDtBQW1CSDs7QUFLRGtDLEVBQUFBLFVBQVUsR0FBRztBQUNULFFBQUksQ0FBQ3RDLE1BQUwsRUFBYTtBQUNULFlBQU11QyxXQUFXLEdBQUcxQyxPQUFPLENBQUMsc0JBQUQsQ0FBM0I7O0FBQ0FHLE1BQUFBLE1BQU0sR0FBR3VDLFdBQVcsQ0FBQ3ZDLE1BQXJCO0FBQ0g7QUFDSjs7QUFVRHdDLEVBQUFBLFFBQVEsQ0FBQ0MsS0FBRCxFQUFRQyxJQUFSLEVBQWN0QyxPQUFkLEVBQXVCO0FBQzNCLFVBQU07QUFBRXVDLE1BQUFBLElBQUY7QUFBUUMsTUFBQUEsT0FBUjtBQUFpQkMsTUFBQUEsSUFBakI7QUFBdUJDLE1BQUFBO0FBQXZCLFFBQWdDMUMsT0FBTyxJQUFJLElBQVgsR0FBa0IsRUFBbEIsR0FBdUJBLE9BQTdEO0FBQ0EsVUFBTTJDLElBQUksR0FBRyxJQUFiO0FBRUEsUUFBSUMsR0FBSjs7QUFFQSxRQUFJRixJQUFKLEVBQVU7QUFDTkUsTUFBQUEsR0FBRyxHQUFHLE1BQU47QUFDSCxLQUZELE1BRU8sSUFBSUgsSUFBSixFQUFVO0FBQ2JHLE1BQUFBLEdBQUcsR0FBRyxNQUFOO0FBQ0g7O0FBRUQsS0FBQ0EsR0FBRyxHQUFHQyxFQUFFLENBQUNELEdBQUQsQ0FBTCxHQUFhQyxFQUFqQixFQUFxQlIsS0FBckIsRUFBNEIsa0JBQWtCO0FBQzFDLFVBQUlNLElBQUksQ0FBQ3pDLE9BQVQsRUFBa0I7QUFDZDRDLFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLGlCQUFaLEVBQStCVixLQUEvQjtBQUNIOztBQUVELFVBQUl6QyxNQUFKLEVBQVk7QUFDUixZQUFJMkMsSUFBSixFQUFVO0FBQ04sZ0JBQU07QUFBRVMsWUFBQUEsV0FBRjtBQUFlQyxZQUFBQSxJQUFmO0FBQXFCQyxZQUFBQSxPQUFyQjtBQUE4QkMsWUFBQUEsS0FBOUI7QUFBcUNDLFlBQUFBLEdBQXJDO0FBQTBDQyxZQUFBQSxNQUExQztBQUFrREMsWUFBQUE7QUFBbEQsY0FBK0RmLElBQUksQ0FBQzNDLE1BQTFFO0FBRUFvRCxVQUFBQSxXQUFXLElBQUlwRCxNQUFNLENBQUNvRCxXQUFQLENBQW1CQSxXQUFuQixDQUFmO0FBQ0FDLFVBQUFBLElBQUksSUFBSXJELE1BQU0sQ0FBQ3FELElBQVAsQ0FBWUEsSUFBWixDQUFSO0FBQ0FDLFVBQUFBLE9BQU8sSUFBSXRELE1BQU0sQ0FBQ3NELE9BQVAsQ0FBZUEsT0FBZixDQUFYO0FBQ0FDLFVBQUFBLEtBQUssSUFBSXZELE1BQU0sQ0FBQ3VELEtBQVAsQ0FBYUEsS0FBYixDQUFUO0FBQ0FDLFVBQUFBLEdBQUcsSUFBSXhELE1BQU0sQ0FBQ3dELEdBQVAsQ0FBV0EsR0FBWCxDQUFQO0FBQ0FFLFVBQUFBLFFBQVEsSUFBSTFELE1BQU0sQ0FBQzBELFFBQVAsQ0FBZ0JBLFFBQWhCLENBQVo7QUFFQTVELFVBQUFBLENBQUMsQ0FBQzZELE9BQUYsQ0FBVUYsTUFBVixLQUNJM0QsQ0FBQyxDQUFDOEQsTUFBRixDQUFTSCxNQUFULEVBQWlCLENBQUNJLElBQUQsRUFBT0MsR0FBUCxLQUFlO0FBQzVCOUQsWUFBQUEsTUFBTSxDQUFDK0QsS0FBUCxDQUFhRCxHQUFiLEVBQWtCRCxJQUFsQjtBQUNILFdBRkQsQ0FESjtBQUlIOztBQUVEN0QsUUFBQUEsTUFBTSxDQUFDeUMsS0FBUCxDQUFhQSxLQUFiO0FBQ0F6QyxRQUFBQSxNQUFNLENBQUNnRSxVQUFQLENBQW1CLFNBQVF2QixLQUFNLEVBQWpDLEVBQW9DLE1BQU0sQ0FBRSxDQUE1Qzs7QUFFQSxZQUFJRSxJQUFJLElBQUlBLElBQUksQ0FBQ3NCLE1BQWpCLEVBQXlCO0FBQ3JCbkUsVUFBQUEsQ0FBQyxDQUFDOEQsTUFBRixDQUFTakIsSUFBSSxDQUFDc0IsTUFBZCxFQUFzQixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUM1QixnQkFBSSxPQUFPRCxDQUFQLEtBQWEsUUFBakIsRUFBMkI7QUFDdkJsRSxjQUFBQSxNQUFNLENBQUNvRSxTQUFQLENBQWlCRCxDQUFqQixFQUFvQixrQkFBcEI7QUFDQXBCLGNBQUFBLElBQUksQ0FBQ3NCLFlBQUwsQ0FBbUIsU0FBUUYsQ0FBRSxHQUE3QixFQUFpQ0QsQ0FBakM7QUFDSCxhQUhELE1BR087QUFDSGxFLGNBQUFBLE1BQU0sQ0FBQ29FLFNBQVAsQ0FBaUJELENBQWpCLEVBQW9CRCxDQUFwQjtBQUNIO0FBQ0osV0FQRDtBQVFIO0FBQ0o7O0FBRUQsVUFBSXRCLE9BQUosRUFBYTtBQUNULFlBQUk7QUFDQSxnQkFBTUYsSUFBSSxDQUFDQyxJQUFELENBQVY7QUFDSCxTQUZELFNBRVU7QUFDTixnQkFBTUMsT0FBTyxFQUFiO0FBQ0g7QUFDSixPQU5ELE1BTU87QUFDSCxjQUFNRixJQUFJLENBQUNDLElBQUQsQ0FBVjtBQUNIO0FBQ0osS0E5Q0Q7QUErQ0g7O0FBUUQyQixFQUFBQSxvQkFBb0IsQ0FBQzdCLEtBQUQsRUFBUUMsSUFBUixFQUFjdEMsT0FBZCxFQUF1QjtBQUN2QyxVQUFNbUUsQ0FBQyxHQUFHM0UsSUFBSSxDQUFDNEUsT0FBTCxDQUFjLGlCQUFnQixLQUFLckUsSUFBSyxLQUF4QyxDQUFWOztBQUNBLFVBQU1zRSxTQUFTLEdBQUc1RSxPQUFPLENBQUMwRSxDQUFELENBQXpCOztBQUNBLFFBQUksQ0FBQ0UsU0FBTCxFQUFnQixNQUFNLElBQUloRSxLQUFKLENBQVcsZ0NBQStCLEtBQUtOLElBQUssRUFBcEQsQ0FBTjtBQUVoQixVQUFNO0FBQUV1RSxNQUFBQSxLQUFGO0FBQVMsU0FBR0M7QUFBWixRQUF1QkYsU0FBN0I7QUFFQSxVQUFNRyxTQUFTLEdBQUdGLEtBQUssSUFBSUEsS0FBSyxDQUFDakMsS0FBRCxDQUFoQztBQUNBLFFBQUksQ0FBQ21DLFNBQUwsRUFBZ0IsTUFBTSxJQUFJbkUsS0FBSixDQUFXLGdDQUErQixLQUFLTixJQUFLLFlBQVdzQyxLQUFNLEVBQXJFLENBQU47O0FBRWhCM0MsSUFBQUEsQ0FBQyxDQUFDK0UsU0FBRixDQUFZRCxTQUFaLEVBQXVCRSxPQUF2QixDQUErQixDQUFDQyxRQUFELEVBQVdDLENBQVgsS0FBaUI7QUFDNUMsWUFBTUMsWUFBWSxHQUFHO0FBQ2pCakYsUUFBQUEsTUFBTSxFQUFFMkUsTUFEUztBQUVqQlYsUUFBQUEsTUFBTSxFQUFFbkUsQ0FBQyxDQUFDb0YsU0FBRixDQUFZSCxRQUFRLENBQUNkLE1BQXJCLEVBQThCQyxDQUFELElBQU87QUFDeEMsY0FBSSxPQUFPQSxDQUFQLEtBQWEsVUFBakIsRUFBNkIsT0FBT0EsQ0FBQyxFQUFSO0FBQzdCLGlCQUFPQSxDQUFQO0FBQ0gsU0FITyxDQUZTO0FBTWpCaUIsUUFBQUEsUUFBUSxFQUFFSixRQUFRLENBQUNJO0FBTkYsT0FBckI7QUFTQSxXQUFLM0MsUUFBTCxDQUFlLEdBQUVDLEtBQU0sSUFBR3VDLENBQUMsR0FBRyxDQUFFLEVBQWhDLEVBQW1DdEMsSUFBbkMsRUFBeUMsRUFBRSxHQUFHdEMsT0FBTDtBQUFjdUMsUUFBQUEsSUFBSSxFQUFFc0M7QUFBcEIsT0FBekM7QUFDSCxLQVhEO0FBWUg7O0FBT2UsUUFBVkcsVUFBVSxDQUFDQyxZQUFELEVBQWVDLE9BQWYsRUFBd0I7QUFDcEMsVUFBTUMsU0FBUyxHQUFHMUYsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsVUFBTTJGLEtBQUssR0FBRyxJQUFJRCxTQUFTLENBQUN0RixLQUFkLEVBQWQ7O0FBRUFILElBQUFBLENBQUMsQ0FBQzJGLElBQUYsQ0FBT0osWUFBUCxFQUFxQixDQUFDSyxDQUFELEVBQUl2RixJQUFKLEtBQWE7QUFDOUJxRixNQUFBQSxLQUFLLENBQUNHLEdBQU4sQ0FBVXhGLElBQVYsRUFBZ0IsWUFBWTtBQUN4QnVGLFFBQUFBLENBQUMsQ0FBQ0osT0FBRCxDQUFEO0FBQ0gsT0FGRDtBQUdILEtBSkQ7O0FBTUEsV0FBTyxJQUFJTSxPQUFKLENBQVksQ0FBQ3BCLE9BQUQsRUFBVXFCLE1BQVYsS0FBcUI7QUFDcEMsWUFBTTlDLElBQUksR0FBRyxJQUFiO0FBRUF5QyxNQUFBQSxLQUFLLENBQ0FNLEVBREwsQ0FDUSxPQURSLEVBQ2tCQyxLQUFELElBQVc7QUFDcEIsY0FBTUMsWUFBWSxHQUFHQyxNQUFNLENBQUNGLEtBQUssQ0FBQ0csTUFBUCxDQUEzQjtBQUNBaEQsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVk2QyxZQUFaO0FBQ0EsYUFBSzNCLFlBQUwsQ0FBa0IsT0FBbEIsRUFBMkIyQixZQUEzQjtBQUNILE9BTEwsRUFNS0YsRUFOTCxDQU1RLFVBTlIsRUFNb0IsWUFBWTtBQUN4QixjQUFNSyxlQUFlLEdBQUcsb0JBQW9CLEtBQUtDLE1BQUwsQ0FBWSxTQUFaLEVBQXVCQyxHQUF2QixDQUEyQixNQUEzQixDQUE1QztBQUNBbkQsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlnRCxlQUFaO0FBQ0FwRCxRQUFBQSxJQUFJLENBQUNzQixZQUFMLENBQWtCLFVBQWxCLEVBQThCOEIsZUFBOUI7QUFDQTNCLFFBQUFBLE9BQU87QUFDVixPQVhMLEVBWUtzQixFQVpMLENBWVEsT0FaUixFQVlrQkMsS0FBRCxJQUFXRixNQUFNLENBQUNJLE1BQU0sQ0FBQ0YsS0FBSyxDQUFDRyxNQUFQLENBQVAsQ0FabEMsRUFhS0ksR0FiTCxDQWFTO0FBQUVDLFFBQUFBLEtBQUssRUFBRTtBQUFULE9BYlQ7QUFjSCxLQWpCTSxDQUFQO0FBa0JIOztBQU9jLFFBQVRDLFNBQVMsQ0FBQ0MsSUFBRCxFQUFPL0QsSUFBUCxFQUFhO0FBQ3hCLFVBQU1nRSxPQUFPLEdBQUcxRyxNQUFNLEdBQUdBLE1BQU0sQ0FBQ2dFLFVBQVAsQ0FBa0J5QyxJQUFsQixFQUF3QixNQUFNL0QsSUFBSSxFQUFsQyxDQUFILEdBQTJDQSxJQUFqRTs7QUFFQSxRQUFJLEtBQUtwQyxPQUFULEVBQWtCO0FBQ2Q0QyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxRQUFaLEVBQXNCc0QsSUFBdEI7QUFDSDs7QUFFRCxVQUFNQyxPQUFPLEVBQWI7QUFDSDs7QUFPRHJDLEVBQUFBLFlBQVksQ0FBQ2xFLElBQUQsRUFBT3dHLEdBQVAsRUFBWTtBQUNwQixRQUFJLENBQUMzRyxNQUFMLEVBQWE7QUFFYixRQUFJNEcsSUFBSSxHQUFHLFlBQVg7QUFBQSxRQUNJQyxPQUFPLEdBQUdGLEdBRGQ7O0FBR0EsUUFBSSxPQUFPQSxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDekJFLE1BQUFBLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEIsQ0FBMUIsQ0FBVjtBQUNBQyxNQUFBQSxJQUFJLEdBQUcsa0JBQVA7QUFDSDs7QUFFRDVHLElBQUFBLE1BQU0sQ0FBQ2dILGdCQUFQLENBQXdCN0csSUFBeEIsRUFBOEIwRyxPQUE5QixFQUF1Q0QsSUFBdkM7QUFDSDs7QUFFb0IsUUFBZnZFLGVBQWUsQ0FBQ1gsR0FBRCxFQUFNdkIsSUFBTixFQUFZZ0MsYUFBWixFQUEyQjtBQUM1QyxVQUFNQyxNQUFNLEdBQUdWLEdBQUcsQ0FBQ3VGLFVBQUosQ0FBZSxLQUFLekcsU0FBTCxHQUFrQixhQUFZTCxJQUFLLEVBQW5DLEdBQXdDLGNBQWFBLElBQUssRUFBekUsQ0FBZjs7QUFDQSxRQUFJLEtBQUtLLFNBQVQsRUFBb0I7QUFDaEI0QixNQUFBQSxNQUFNLENBQUM4RSxNQUFQLEdBQWdCLEtBQUsxRyxTQUFMLENBQWUyRyxVQUEvQjtBQUNIOztBQUVELFFBQUksQ0FBQy9FLE1BQU0sQ0FBQ2dGLE1BQVosRUFBb0I7QUFDaEJoRixNQUFBQSxNQUFNLENBQUNnRixNQUFQLEdBQWdCLENBQUNDLEdBQUQsRUFBTUMsTUFBTixLQUFpQjtBQUM3QixhQUFLakQsWUFBTCxDQUFrQmdELEdBQWxCLEVBQXVCQyxNQUF2QjtBQUNILE9BRkQ7QUFHSDs7QUFFRCxRQUFJLENBQUNuRixhQUFMLEVBQW9CO0FBQ2hCLGFBQU9DLE1BQU0sQ0FBQ21GLE1BQWQ7QUFDQSxhQUFPbkYsTUFBUDtBQUNIOztBQUVELFVBQU1ELGFBQWEsQ0FBQ1QsR0FBRCxFQUFNVSxNQUFOLENBQW5CO0FBRUEsV0FBT0EsTUFBUDtBQUNIOztBQWhVTzs7QUFtVVpvRixNQUFNLENBQUNDLE9BQVAsR0FBaUJ4SCxLQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZShcIkBnZW54L2p1bHlcIik7XG5cbmNvbnN0IGRlZmF1bHRVc2VyQXV0aCA9IHJlcXVpcmUoXCIuL2RlZmF1bHRVc2VyQXV0aFwiKTtcblxubGV0IGFsbHVyZTtcblxuLyoqXG4gKiBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gKiBAY2FsbGJhY2sgdGVzdFdpdGhSZXN0Q2xpZW50XG4gKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcFxuICogQHBhcmFtIHtSZXN0Q2xpZW50fSBjbGllbnQgLSBUaGUgcmVzdCBjbGllbnRcbiAqL1xuXG4vKipcbiAqIFRlc3QgZnVuY3Rpb24gd2l0aCBhIHdvcmtlciBhcHAuXG4gKiBAY2FsbGJhY2sgdGVzdFdpdGhBcHBcbiAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgYXBwXG4gKi9cblxuLyoqXG4gKiBUZXN0IGNhc2UgYm9keS5cbiAqIEBjYWxsYmFjayB0ZXN0Q2FzZUJvZHlcbiAqIEBwYXJhbSB7Kn0gZGF0YSAtIFRlc3QgZGF0YVxuICovXG5cbi8qKlxuICogVGVzdCBzdWl0ZSBvYmplY3QuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgU3VpdGUge1xuICAgIC8qKlxuICAgICAqIFtwcml2YXRlXSBTdWl0ZSB3aWxsIGJlIGNyZWF0ZWQgYnkgdGVzdFN1aXRlIGNyZWF0b3IuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBTdWl0ZSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIFN1aXRlIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuc2VydmVyRW50cnk9XCIuLi8uLi9zcmMvaW5kZXguanNcIl0gLSBUaGUgZW50cnkgZmlsZSBvZiBAZ2VueC9zZXJ2ZXIgaW5zdGFuY2UuXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy52ZXJib3NlPWZhbHNlXSAtIFZlcmJvc2UgbW9kZS5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIGNvbnN0IHsgc2VydmVyRW50cnksIHZlcmJvc2UgfSA9IG9wdGlvbnMgPT0gbnVsbCA/IHt9IDogb3B0aW9ucztcblxuICAgICAgICB0aGlzLnNlcnZlckVudHJ5ID0gc2VydmVyRW50cnk7XG4gICAgICAgIHRoaXMudmVyYm9zZSA9IHZlcmJvc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIEBnZW54L3NlcnZlciBpbnN0YWNlIGZvciBjb2RlIGNvdmVyYWdlIHRlc3RpbmcuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdGFydFdlYlNlcnZlcl8oKSB7XG4gICAgICAgIGlmICh0aGlzLndlYlNlcnZlcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2ViIHNlcnZlciBhbHJlYWR5IHN0YXJ0ZWQuXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3JlYXRlV2ViU2VydmVyID0gdGhpcy5zZXJ2ZXJFbnRyeVxuICAgICAgICAgICAgPyByZXF1aXJlKHRoaXMuc2VydmVyRW50cnkpXG4gICAgICAgICAgICA6IHJlcXVpcmUubWFpbi5yZXF1aXJlKFwiLi4vLi4vc3JjL2luZGV4LmpzXCIpO1xuICAgICAgICB0aGlzLndlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgICAgICBleGl0T25VbmNhdWdodDogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLndlYlNlcnZlci5zdGFydGVkID09IG51bGwgfHwgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQubm90LmJlLm9rKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRfKCk7XG5cbiAgICAgICAgdGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQuYmUub2soKTtcblxuICAgICAgICByZXR1cm4gdGhpcy53ZWJTZXJ2ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB0aGUgc2VydmVyIGlmIGl0IGlzIHN0YXJ0ZWQuXG4gICAgICogQGFzeW5jXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBhc3luYyBzdG9wV2ViU2VydmVySWZTdGFydGVkXygpIHtcbiAgICAgICAgaWYgKHRoaXMud2ViU2VydmVyKSB7XG4gICAgICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIuc3RhcnRlZCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMud2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndlYlNlcnZlcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGEgd29ya2VyIGFwcCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIC0gT3B0aW9ucyBwYXNzZWQgdGhlIHRlc3Qgd29ya2VyLCBzZWUgc3RhcnRXb3JrZXIgb2YgQGdlbngvYXBwLlxuICAgICAqIEBhc3luY1xuICAgICAqL1xuICAgIGFzeW5jIHN0YXJ0V29ya2VyXyh0ZXN0VG9SdW4sIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSxcbiAgICAgICAgfSA9IHJlcXVpcmUoXCJAZ2VueC9hcHBcIik7XG5cbiAgICAgICAgbGV0IGVycjtcblxuICAgICAgICBhd2FpdCBzdGFydFdvcmtlcihcbiAgICAgICAgICAgIGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0ZXN0VG9SdW4oYXBwKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICAgICAgICAgIGNvbmZpZ1BhdGg6IFwiLi90ZXN0L2NvbmZcIixcbiAgICAgICAgICAgICAgICBhcHBNb2R1bGVzUGF0aDogXCJhcHBfbW9kdWxlc1wiLFxuICAgICAgICAgICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgYSByZXN0IGNsaWVudCBmb3IgdGVzdGluZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlTmFtZSAtIFRoZSBjb25maWcga2V5IG9mIHRhcmdldCBlbmRwb2ludFxuICAgICAqIEBwYXJhbSB7ZnVuY3Rpb258c3RyaW5nfSBbYXV0aGVudGljYXRvcl0gLSBBdXRoZW50aWNhdG9yIHRvIGJlIHVzZWQsIGFzeW5jIChjbGllbnQpID0+IHt9LCBvciBwYXNzIGEgdXNlclRhZyB0byB1c2UgZGVmYXVsdCBhdXRoZW50aWNhdG9yLlxuICAgICAqIEBwYXJhbSB7dGVzdFdpdGhSZXN0Q2xpZW50fSB0ZXN0VG9SdW4gLSBUZXN0IGZ1bmN0aW9uIHdpdGggYSBjb25uZWN0ZWQgcmVzdCBjbGllbnQuXG4gICAgICogQHBhcmFtIHsqfSBbb3B0aW9uc10gLSBPcHRpb25zIHBhc3NlZCB0aGUgdGVzdCB3b3JrZXIsIHNlZSBzdGFydFdvcmtlciBvZiBAZ2VueC9hcHAuXG4gICAgICogQGFzeW5jXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRSZXN0Q2xpZW50XyhzZXJ2aWNlTmFtZSwgYXV0aGVudGljYXRvciwgdGVzdFRvUnVuLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXJ0V29ya2VyXyhhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlc3RUb1J1biA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICAgICAgICAgICAgICB0ZXN0VG9SdW4gPSBhdXRoZW50aWNhdG9yO1xuICAgICAgICAgICAgICAgICAgICBhdXRoZW50aWNhdG9yID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0ZXN0VG9SdW4gPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IHRlc3RUb1J1bjtcbiAgICAgICAgICAgICAgICAgICAgdGVzdFRvUnVuID0gYXV0aGVudGljYXRvcjtcbiAgICAgICAgICAgICAgICAgICAgYXV0aGVudGljYXRvciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGF1dGhlbnRpY2F0b3IgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICBhdXRoZW50aWNhdG9yID0gZGVmYXVsdFVzZXJBdXRoKGF1dGhlbnRpY2F0b3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLl9nZXRSZXN0Q2xpZW50XyhhcHAsIHNlcnZpY2VOYW1lLCBhdXRoZW50aWNhdG9yKTtcbiAgICAgICAgICAgIHJldHVybiB0ZXN0VG9SdW4oYXBwLCBjbGllbnQpO1xuICAgICAgICB9LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGluaXRBbGx1cmUoKSB7XG4gICAgICAgIGlmICghYWxsdXJlKSB7XG4gICAgICAgICAgICBjb25zdCBhbGx1cmVNb2NoYSA9IHJlcXVpcmUoXCJhbGx1cmUtbW9jaGEvcnVudGltZVwiKTtcbiAgICAgICAgICAgIGFsbHVyZSA9IGFsbHVyZU1vY2hhLmFsbHVyZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmluZSBhIHRlc3QgY2FzZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RvcnkgLSBUZXN0IGNhc2UgdGl0bGUuXG4gICAgICogQHBhcmFtIHt0ZXN0Q2FzZUJvZHl9IGJvZHkgLSBUZXN0IGNhc2UgYm9keSB0byB3cml0ZSBhY3R1YWwgdGVzdCBjb2RlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc11cbiAgICAgKiBAcHJvcGVydHkgeyp9IG9wdGlvbnMuZGF0YSAtIFRlc3QgZGF0YVxuICAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9wdGlvbnMuY2xlYW5VcCAtIENsZWFudXAgYWZ0ZXIgdGhlIGNhc2UgZW5kcyByZWdhcmRsZXNzIHdoZXRoZXIgaXQgaXMgc3VjY2Vzc2Z1bCBvciBub3QuXG4gICAgICovXG4gICAgdGVzdENhc2Uoc3RvcnksIGJvZHksIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBjbGVhblVwLCBza2lwLCBvbmx5IH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIGxldCBvcHQ7XG5cbiAgICAgICAgaWYgKG9ubHkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2UgaWYgKHNraXApIHtcbiAgICAgICAgICAgIG9wdCA9IFwic2tpcFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgKG9wdCA/IGl0W29wdF0gOiBpdCkoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChzZWxmLnZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN0b3J5OlwiLCBzdG9yeSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcblxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiAmJiBhbGx1cmUuZGVzY3JpcHRpb24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlICYmIGFsbHVyZS5mZWF0dXJlKGZlYXR1cmUpO1xuICAgICAgICAgICAgICAgICAgICBvd25lciAmJiBhbGx1cmUub3duZXIob3duZXIpO1xuICAgICAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgICAgICBzZXZlcml0eSAmJiBhbGx1cmUuc2V2ZXJpdHkoc2V2ZXJpdHkpO1xuXG4gICAgICAgICAgICAgICAgICAgIF8uaXNFbXB0eShpc3N1ZXMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvck93bihpc3N1ZXMsIChsaW5rLCBudW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUuaXNzdWUobnVtLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG4gICAgICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoYHN0YXJ0ICR7c3Rvcnl9YCwgKCkgPT4ge30pKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnBhcmFtcykge1xuICAgICAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgXCIqc2VlIGF0dGFjaG1lbnQqXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXR0YWNoT2JqZWN0KGBwYXJhbVske2t9XWAsIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChjbGVhblVwKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICAgICAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjbGVhblVwKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZXN0IGNhc2Ugd2l0aCBmaXh0dXJlcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RvcnlcbiAgICAgKiBAcGFyYW0ge3Rlc3RDYXNlQm9keX0gYm9keVxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cbiAgICAgKi9cbiAgICB0ZXN0Q2FzZUZyb21GaXh0dXJlcyhzdG9yeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCBwID0gcGF0aC5yZXNvbHZlKGB0ZXN0L2ZpeHR1cmVzLyR7dGhpcy5uYW1lfS5qc2ApO1xuICAgICAgICBjb25zdCBzdWl0ZURhdGEgPSByZXF1aXJlKHApO1xuICAgICAgICBpZiAoIXN1aXRlRGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdWl0ZSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7dGhpcy5uYW1lfWApO1xuXG4gICAgICAgIGNvbnN0IHsgY2FzZXMsIC4uLm90aGVycyB9ID0gc3VpdGVEYXRhO1xuXG4gICAgICAgIGNvbnN0IHN0b3J5RGF0YSA9IGNhc2VzICYmIGNhc2VzW3N0b3J5XTtcbiAgICAgICAgaWYgKCFzdG9yeURhdGEpIHRocm93IG5ldyBFcnJvcihgU3RvcnkgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3RoaXMubmFtZX0sIHN0b3J5OiAke3N0b3J5fWApO1xuXG4gICAgICAgIF8uY2FzdEFycmF5KHN0b3J5RGF0YSkuZm9yRWFjaCgoY2FzZURhdGEsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByZXBhcmVkRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBhbGx1cmU6IG90aGVycyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IF8ubWFwVmFsdWVzKGNhc2VEYXRhLnBhcmFtcywgKHYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSBcImZ1bmN0aW9uXCIpIHJldHVybiB2KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBjYXNlRGF0YS5leHBlY3RlZCxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMudGVzdENhc2UoYCR7c3Rvcnl9IyR7aSArIDF9YCwgYm9keSwgeyAuLi5vcHRpb25zLCBkYXRhOiBwcmVwYXJlZERhdGEgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1biBiZW5jaG1hcmsgYWdhaW5zdCBnaXZlbiBtZXRob2RzLlxuICAgICAqIEBwYXJhbSB7Kn0gbWFwT2ZNZXRob2RzIC0gTWFwIG9mIG5hbWUgdG8gZnVuY3Rpb24gd2l0aCBwYXlsb2FkXG4gICAgICogQHBhcmFtIHsqfSBwYXlsb2FkXG4gICAgICovXG4gICAgYXN5bmMgYmVuY2htYXJrXyhtYXBPZk1ldGhvZHMsIHBheWxvYWQpIHtcbiAgICAgICAgY29uc3QgQmVuY2htYXJrID0gcmVxdWlyZShcImJlbmNobWFya1wiKTtcbiAgICAgICAgY29uc3Qgc3VpdGUgPSBuZXcgQmVuY2htYXJrLlN1aXRlKCk7XG5cbiAgICAgICAgXy5lYWNoKG1hcE9mTWV0aG9kcywgKGYsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHN1aXRlLmFkZChuYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZihwYXlsb2FkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgICAgIHN1aXRlXG4gICAgICAgICAgICAgICAgLm9uKFwiY3ljbGVcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN5Y2xlTWVzc2FnZSA9IFN0cmluZyhldmVudC50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjeWNsZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaE9iamVjdChcImN5Y2xlXCIsIGN5Y2xlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAub24oXCJjb21wbGV0ZVwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRlTWVzc2FnZSA9IFwiVGhlIGZhc3Rlc3QgaXMgXCIgKyB0aGlzLmZpbHRlcihcImZhc3Rlc3RcIikubWFwKFwibmFtZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coY29tcGxldGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5hdHRhY2hPYmplY3QoXCJjb21wbGV0ZVwiLCBjb21wbGV0ZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAub24oXCJlcnJvclwiLCAoZXZlbnQpID0+IHJlamVjdChTdHJpbmcoZXZlbnQudGFyZ2V0KSkpXG4gICAgICAgICAgICAgICAgLnJ1bih7IGFzeW5jOiB0cnVlIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWZpbmUgYSB0ZXN0IHN0ZXAuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHN0ZXBcbiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbYm9keV0gLSBUZXN0IHN0ZXAgYm9keVxuICAgICAqL1xuICAgIGFzeW5jIHRlc3RTdGVwXyhzdGVwLCBib2R5KSB7XG4gICAgICAgIGNvbnN0IHN0ZXBGbl8gPSBhbGx1cmUgPyBhbGx1cmUuY3JlYXRlU3RlcChzdGVwLCAoKSA9PiBib2R5KCkpIDogYm9keTtcblxuICAgICAgICBpZiAodGhpcy52ZXJib3NlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0ZXA6IFwiLCBzdGVwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHN0ZXBGbl8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2ggYW4gb2JqZWN0IHRvIHRoZSB0ZXN0IHJlcG9ydC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gb2JqXG4gICAgICovXG4gICAgYXR0YWNoT2JqZWN0KG5hbWUsIG9iaikge1xuICAgICAgICBpZiAoIWFsbHVyZSkgcmV0dXJuO1xuXG4gICAgICAgIGxldCB0eXBlID0gXCJ0ZXh0L3BsYWluXCIsXG4gICAgICAgICAgICBjb250ZW50ID0gb2JqO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCA0KTtcbiAgICAgICAgICAgIHR5cGUgPSBcImFwcGxpY2F0aW9uL2pzb25cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGFsbHVyZS5jcmVhdGVBdHRhY2htZW50KG5hbWUsIGNvbnRlbnQsIHR5cGUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRSZXN0Q2xpZW50XyhhcHAsIG5hbWUsIGF1dGhlbnRpY2F0b3IpIHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gYXBwLmdldFNlcnZpY2UodGhpcy53ZWJTZXJ2ZXIgPyBgc3VwZXJUZXN0LSR7bmFtZX1gIDogYHJlc3RDbGllbnQtJHtuYW1lfWApO1xuICAgICAgICBpZiAodGhpcy53ZWJTZXJ2ZXIpIHtcbiAgICAgICAgICAgIGNsaWVudC5zZXJ2ZXIgPSB0aGlzLndlYlNlcnZlci5odHRwU2VydmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjbGllbnQub25TZW50KSB7XG4gICAgICAgICAgICBjbGllbnQub25TZW50ID0gKHVybCwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hPYmplY3QodXJsLCByZXN1bHQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXV0aGVudGljYXRvcikge1xuICAgICAgICAgICAgZGVsZXRlIGNsaWVudC5vblNlbmQ7XG4gICAgICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgYXV0aGVudGljYXRvcihhcHAsIGNsaWVudCk7XG5cbiAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3VpdGU7XG4iXX0=