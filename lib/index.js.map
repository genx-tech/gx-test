{"version":3,"sources":["../src/index.js"],"sourcesContent":["if (process.env.ASYNC_DUMP) {\n    require(\"./asyncDump\");\n}\n\nconst path = require(\"path\");\nconst { _ } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst Suite = require(\"./Suite\");\n\nconst SPECJS = \".spec.js\";\nconst DOTJS = \".js\";\n\nconst TEST_OPTS = \"test/test.local.js\"; \n\n/**\n * Test body used to define test cases.\n * @callback testSuiteBody\n * @param {Suite} suite - The test suite object\n */\n\n/**\n * Create a test suite.\n * @param {string} [file] - The test spec file name, just use __filename.\n * @param {testSuiteBody} body - To define test cased in this callback.\n * @param {object} [options]\n * @property {function} options.before - Prepare work before all test cases.\n * @property {function} options.after - Cleanup work after all test cases.\n * @property {string} [options.serverEntry=\"../../src/index.js\"] - The entry file of @genx/server instance.\n * @property {boolean} options.verbose - Verbose mode.\n */\nfunction testSuite(file, body, options) {\n    if (typeof options === 'undefined') {        \n        if (typeof file !== 'string') {\n            if (typeof body !== 'undefined') {\n                // two arguments\n                options = body;\n            } \n\n            body = file;\n\n            const dbgGetCallerFile = require(\"@genx/july/lib/commonjs/lang/dbgGetCallerFile\");\n            file = dbgGetCallerFile();\n        }\n    }\n\n    const {\n        before: onBefore,\n        after: onAfter,\n        beforeEach: onBeforeEachCase,\n        afterEach: onAfterEachCase,\n        serverEntry,\n        verbose,\n        skip,\n        only,\n    } = options == null ? {} : options;\n\n    const suiteName = path.basename(file, file.endsWith(SPECJS) ? SPECJS : DOTJS);\n    const testOptsFile = path.resolve(TEST_OPTS);\n    let testOpts;\n\n    if (fs.existsSync(testOptsFile)) {\n        testOpts = require(testOptsFile);\n    }\n\n    const suiteOptions = {\n        serverEntry,\n        verbose,\n        ...(testOpts ? _.pick(testOpts, [\"serverEntry\", \"verbose\"]) : {}),\n    };\n\n    const suite = new Suite(suiteName, suiteOptions);\n\n    let opt;\n\n    if (only) {\n        opt = \"only\";\n    } else if (skip) {\n        opt = \"skip\";\n    } else if (testOpts) {\n        const only = new Set(testOpts.only);\n\n        if (only.has(suiteName)) {\n            opt = \"only\";\n        } else {\n            if (!_.isEmpty(testOpts.only)) {\n                console.log(`Suite \"${suiteName}\" skipped.`);\n            } else {\n                const skip = new Set(testOpts.skip);\n                if (skip.has(suiteName)) {\n                    opt = \"skip\";\n                    console.log(`Suite \"${suiteName}\" skipped.`);\n                }\n            }\n        }\n    }\n\n    (opt ? describe[opt] : describe)(suiteName, function () {\n        before(async () => {\n            suite.initAllure();\n\n            if (verbose) {\n                console.log(\"Starting suite:\", suiteName);\n            }\n\n            if (process.env.COVER_MODE) {\n                await suite.startWebServer_();\n            }\n\n            if (onBefore) {\n                await onBefore();\n            }\n        });\n\n        after(async () => {\n            await suite.stopWebServerIfStarted_();\n\n            if (onAfter) {\n                await onAfter();\n            }\n\n            console.log();\n            if (verbose) {\n                console.log(\"Finished suite:\", suiteName);\n            }\n\n            if (process.env.ASYNC_DUMP) {\n                asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);\n            }\n        });\n\n        if (onBeforeEachCase) {\n            beforeEach(() => onBeforeEachCase(suite));\n        }\n\n        if (onAfterEachCase) {\n            afterEach(() => onAfterEachCase(suite));\n        }\n\n        body(suite);\n    });\n}\n\nmodule.exports = testSuite;\n"],"names":["process","env","ASYNC_DUMP","require","path","_","fs","Suite","SPECJS","DOTJS","TEST_OPTS","testSuite","file","body","options","dbgGetCallerFile","before","onBefore","after","onAfter","beforeEach","onBeforeEachCase","afterEach","onAfterEachCase","serverEntry","verbose","skip","only","suiteName","basename","endsWith","testOptsFile","resolve","testOpts","existsSync","suiteOptions","pick","suite","opt","Set","has","isEmpty","console","log","describe","initAllure","COVER_MODE","startWebServer_","stopWebServerIfStarted_","asyncDump","length","module","exports"],"mappings":"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"}