{"version":3,"sources":["../src/defaultUserAuth.js"],"sourcesContent":["const { _, get } = require(\"@genx/july\");\n\nconst tokenCache = {};\n\nfunction defaultUserAuth(userTag) {\n    return async (app, client) => {\n        if (!userTag) {\n            delete client.onSend;\n            return client;\n        }\n\n        let token, userAuth;\n\n        if (_.isPlainObject(userTag)) {\n            token = tokenCache[userTag.userTag];\n            userAuth = userTag;\n        } else {\n            token = tokenCache[userTag];\n            userAuth = app.settings.userAuth[userTag];\n        }\n\n        if (!token) {\n            if (!userAuth.endpoint || !userAuth.username || !userAuth.password) {\n                throw new Error(\n                    `\"endpoint\", \"username\", \"password\" is required for \"userAuth\" settings of user \"${userTag}\".`\n                );\n            }\n\n            let body = await client.post(\n                userAuth.endpoint,\n                {\n                    username: userAuth.username,\n                    password: userAuth.password,\n                },\n                userAuth.query,\n                userAuth.headers ? { headers: userAuth.headers } : null\n            );\n            if (userAuth.tokenKey) {\n                token = get(body, userAuth.tokenKey);\n            } else {\n                token = body.token;\n            }\n            tokenCache[userTag] = token;\n\n            app.log(\"info\", `Logged in with [${userTag}].`);\n        }\n\n        client.onSend = (req) => {\n            req.set(\"Authorization\", `Bearer ${token}`);\n        };\n    };\n}\n\nmodule.exports = defaultUserAuth;\n"],"names":["_","get","require","tokenCache","defaultUserAuth","userTag","app","client","onSend","token","userAuth","isPlainObject","settings","endpoint","username","password","Error","body","post","query","headers","tokenKey","log","req","set","module","exports"],"mappings":"AAAA,MAAM,EAAEA,CAAC,CAAA,EAAEC,GAAG,CAAA,EAAE,GAAGC,OAAO,CAAC,YAAY,CAAC,AAAC;AAEzC,MAAMC,UAAU,GAAG,EAAE,AAAC;AAEtB,SAASC,eAAe,CAACC,OAAO,EAAE;IAC9B,OAAO,OAAOC,GAAG,EAAEC,MAAM,GAAK;QAC1B,IAAI,CAACF,OAAO,EAAE;YACV,OAAOE,MAAM,CAACC,MAAM,CAAC;YACrB,OAAOD,MAAM,CAAC;SACjB;QAED,IAAIE,KAAK,EAAEC,QAAQ,AAAC;QAEpB,IAAIV,CAAC,CAACW,aAAa,CAACN,OAAO,CAAC,EAAE;YAC1BI,KAAK,GAAGN,UAAU,CAACE,OAAO,CAACA,OAAO,CAAC,CAAC;YACpCK,QAAQ,GAAGL,OAAO,CAAC;SACtB,MAAM;YACHI,KAAK,GAAGN,UAAU,CAACE,OAAO,CAAC,CAAC;YAC5BK,QAAQ,GAAGJ,GAAG,CAACM,QAAQ,CAACF,QAAQ,CAACL,OAAO,CAAC,CAAC;SAC7C;QAED,IAAI,CAACI,KAAK,EAAE;YACR,IAAI,CAACC,QAAQ,CAACG,QAAQ,IAAI,CAACH,QAAQ,CAACI,QAAQ,IAAI,CAACJ,QAAQ,CAACK,QAAQ,EAAE;gBAChE,MAAM,IAAIC,KAAK,CACX,CAAC,gFAAgF,EAAEX,OAAO,CAAC,EAAE,CAAC,CACjG,CAAC;aACL;YAED,IAAIY,IAAI,GAAG,MAAMV,MAAM,CAACW,IAAI,CACxBR,QAAQ,CAACG,QAAQ,EACjB;gBACIC,QAAQ,EAAEJ,QAAQ,CAACI,QAAQ;gBAC3BC,QAAQ,EAAEL,QAAQ,CAACK,QAAQ;aAC9B,EACDL,QAAQ,CAACS,KAAK,EACdT,QAAQ,CAACU,OAAO,GAAG;gBAAEA,OAAO,EAAEV,QAAQ,CAACU,OAAO;aAAE,GAAG,IAAI,CAC1D,AAAC;YACF,IAAIV,QAAQ,CAACW,QAAQ,EAAE;gBACnBZ,KAAK,GAAGR,GAAG,CAACgB,IAAI,EAAEP,QAAQ,CAACW,QAAQ,CAAC,CAAC;aACxC,MAAM;gBACHZ,KAAK,GAAGQ,IAAI,CAACR,KAAK,CAAC;aACtB;YACDN,UAAU,CAACE,OAAO,CAAC,GAAGI,KAAK,CAAC;YAE5BH,GAAG,CAACgB,GAAG,CAAC,MAAM,EAAE,CAAC,gBAAgB,EAAEjB,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC;SACnD;QAEDE,MAAM,CAACC,MAAM,GAAG,CAACe,GAAG,GAAK;YACrBA,GAAG,CAACC,GAAG,CAAC,eAAe,EAAE,CAAC,OAAO,EAAEf,KAAK,CAAC,CAAC,CAAC,CAAC;SAC/C,CAAC;KACL,CAAC;CACL;AAEDgB,MAAM,CAACC,OAAO,GAAGtB,eAAe,CAAC"}