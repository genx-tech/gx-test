"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require("./asyncDump");
}

const path = require("path");

const {
  _,
  fs
} = require("rk-utils");

const Suite = require("./Suite");

function testSuite(file, body, options) {
  const {
    before: onBefore,
    after: onAfter,
    serverEntry,
    verbose,
    skip,
    only
  } = options == null ? {} : options;
  const suiteName = path.basename(file, ".spec.js");
  const testOptsFile = path.resolve("test/test.local.js");
  let testOpts;

  if (fs.existsSync(testOptsFile)) {
    testOpts = require(testOptsFile);
  }

  const suiteOptions = {
    serverEntry,
    verbose,
    ...(testOpts ? _.pick(testOpts, ['serverEntry', 'verbose']) : {})
  };
  const suite = new Suite(suiteName, suiteOptions);
  let opt;

  if (only) {
    opt = "only";
  } else if (skip) {
    opt = "skip";
  } else if (testOpts) {
    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = "only";
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = "skip";
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      suite.initAllure();

      if (verbose) {
        console.log("Starting suite:", suiteName);
      }

      if (process.env.COVER_MODE) {
        await suite.startWebServer_();
      }

      if (onBefore) {
        await onBefore();
      }
    });
    after(async () => {
      await suite.stopWebServerIfStarted_();

      if (onAfter) {
        await onAfter();
      }

      console.log();

      if (verbose) {
        console.log("Finished suite:", suiteName);
      }

      if (process.env.ASYNC_DUMP) {
        asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
      }
    });
    body(suite);
  });
}

module.exports = testSuite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3VpdGUiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsIm9wdGlvbnMiLCJiZWZvcmUiLCJvbkJlZm9yZSIsImFmdGVyIiwib25BZnRlciIsInNlcnZlckVudHJ5IiwidmVyYm9zZSIsInNraXAiLCJvbmx5Iiwic3VpdGVOYW1lIiwiYmFzZW5hbWUiLCJ0ZXN0T3B0c0ZpbGUiLCJyZXNvbHZlIiwidGVzdE9wdHMiLCJleGlzdHNTeW5jIiwic3VpdGVPcHRpb25zIiwicGljayIsInN1aXRlIiwib3B0IiwiU2V0IiwiaGFzIiwiaXNFbXB0eSIsImNvbnNvbGUiLCJsb2ciLCJkZXNjcmliZSIsImluaXRBbGx1cmUiLCJDT1ZFUl9NT0RFIiwic3RhcnRXZWJTZXJ2ZXJfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJhc3luY0R1bXAiLCJsZW5ndGgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBSUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCQyxFQUFBQSxPQUFPLENBQUMsYUFBRCxDQUFQO0FBQ0g7O0FBRUQsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxPQUFPLENBQUMsVUFBRCxDQUF6Qjs7QUFDQSxNQUFNSSxLQUFLLEdBQUdKLE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQWtCQSxTQUFTSyxTQUFULENBQW1CQyxJQUFuQixFQUF5QkMsSUFBekIsRUFBK0JDLE9BQS9CLEVBQXdDO0FBQ3BDLFFBQU07QUFBRUMsSUFBQUEsTUFBTSxFQUFFQyxRQUFWO0FBQW9CQyxJQUFBQSxLQUFLLEVBQUVDLE9BQTNCO0FBQW9DQyxJQUFBQSxX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QUFSLENBQVksaUJBQVosRUFBK0JkLFNBQS9CO0FBQ0g7O0FBRUQsVUFBSXBCLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFoQixFQUE0QjtBQUN4QnNDLFFBQUFBLFNBQVMsQ0FBQ3hDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFaLENBQXVCdUMsTUFBdkIsR0FBZ0MsQ0FBaEMsR0FBb0N6QyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBaEQsR0FBNkQsSUFBOUQsQ0FBVDtBQUNIO0FBQ0osS0FmSSxDQUFMO0FBaUJBUSxJQUFBQSxJQUFJLENBQUNrQixLQUFELENBQUo7QUFDSCxHQW5DRDtBQW9DSDs7QUFFRGMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbkMsU0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJpZiAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCkge1xuICAgIHJlcXVpcmUoXCIuL2FzeW5jRHVtcFwiKTtcbn1cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgeyBfLCBmcyB9ID0gcmVxdWlyZShcInJrLXV0aWxzXCIpO1xuY29uc3QgU3VpdGUgPSByZXF1aXJlKFwiLi9TdWl0ZVwiKTtcblxuLyoqXG4gKiBUZXN0IGJvZHkgdXNlZCB0byBkZWZpbmUgdGVzdCBjYXNlcy5cbiAqIEBjYWxsYmFjayB0ZXN0U3VpdGVCb2R5XG4gKiBAcGFyYW0ge1N1aXRlfSBzdWl0ZSAtIFRoZSB0ZXN0IHN1aXRlIG9iamVjdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgdGVzdCBzdWl0ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlIC0gVGhlIHRlc3Qgc3BlYyBmaWxlIG5hbWUsIGp1c3QgdXNlIF9fZmlsZW5hbWUuXG4gKiBAcGFyYW0ge3Rlc3RTdWl0ZUJvZHl9IGJvZHkgLSBUbyBkZWZpbmUgdGVzdCBjYXNlZCBpbiB0aGlzIGNhbGxiYWNrLlxuICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXVxuICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5iZWZvcmUgLSBQcmVwYXJlIHdvcmsgYmVmb3JlIGFsbCB0ZXN0IGNhc2VzLlxuICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5hZnRlciAtIENsZWFudXAgd29yayBhZnRlciBhbGwgdGVzdCBjYXNlcy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5zZXJ2ZXJFbnRyeT1cIi4uLy4uL3NyYy9pbmRleC5qc1wiXSAtIFRoZSBlbnRyeSBmaWxlIG9mIEBnZW54L3NlcnZlciBpbnN0YW5jZS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb3B0aW9ucy52ZXJib3NlIC0gVmVyYm9zZSBtb2RlLlxuICovXG5mdW5jdGlvbiB0ZXN0U3VpdGUoZmlsZSwgYm9keSwgb3B0aW9ucykge1xuICAgIGNvbnN0IHsgYmVmb3JlOiBvbkJlZm9yZSwgYWZ0ZXI6IG9uQWZ0ZXIsIHNlcnZlckVudHJ5LCB2ZXJib3NlLCBza2lwLCBvbmx5IH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG5cbiAgICBjb25zdCBzdWl0ZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsIFwiLnNwZWMuanNcIik7XG4gICAgY29uc3QgdGVzdE9wdHNGaWxlID0gcGF0aC5yZXNvbHZlKFwidGVzdC90ZXN0LmxvY2FsLmpzXCIpO1xuICAgIGxldCB0ZXN0T3B0cztcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHRlc3RPcHRzRmlsZSkpIHtcbiAgICAgICAgdGVzdE9wdHMgPSByZXF1aXJlKHRlc3RPcHRzRmlsZSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VpdGVPcHRpb25zID0ge1xuICAgICAgICBzZXJ2ZXJFbnRyeSxcbiAgICAgICAgdmVyYm9zZSxcbiAgICAgICAgLi4uKHRlc3RPcHRzID8gXy5waWNrKHRlc3RPcHRzLCBbICdzZXJ2ZXJFbnRyeScsICd2ZXJib3NlJyBdKSA6IHt9KVxuICAgIH07XG5cbiAgICBjb25zdCBzdWl0ZSA9IG5ldyBTdWl0ZShzdWl0ZU5hbWUsIHN1aXRlT3B0aW9ucyk7XG5cbiAgICBsZXQgb3B0O1xuXG4gICAgaWYgKG9ubHkpIHtcbiAgICAgICAgb3B0ID0gXCJvbmx5XCI7XG4gICAgfSBlbHNlIGlmIChza2lwKSB7XG4gICAgICAgIG9wdCA9IFwic2tpcFwiO1xuICAgIH0gZWxzZSBpZiAodGVzdE9wdHMpIHtcbiAgICAgICAgY29uc3Qgb25seSA9IG5ldyBTZXQodGVzdE9wdHMub25seSk7XG5cbiAgICAgICAgaWYgKG9ubHkuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkodGVzdE9wdHMub25seSkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBza2lwID0gbmV3IFNldCh0ZXN0T3B0cy5za2lwKTtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcC5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAob3B0ID8gZGVzY3JpYmVbb3B0XSA6IGRlc2NyaWJlKShzdWl0ZU5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHN1aXRlLmluaXRBbGx1cmUoKTtcblxuICAgICAgICAgICAgaWYgKHZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN1aXRlOlwiLCBzdWl0ZU5hbWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHN1aXRlLnN0YXJ0V2ViU2VydmVyXygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob25CZWZvcmUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvbkJlZm9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBzdWl0ZS5zdG9wV2ViU2VydmVySWZTdGFydGVkXygpO1xuXG4gICAgICAgICAgICBpZiAob25BZnRlcikge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgIGlmICh2ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGaW5pc2hlZCBzdWl0ZTpcIiwgc3VpdGVOYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICAgICAgICAgICAgICBhc3luY0R1bXAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUC5sZW5ndGggPiAxID8gcHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCA6IG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBib2R5KHN1aXRlKTtcbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB0ZXN0U3VpdGU7XG4iXX0=