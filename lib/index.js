"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require("./asyncDump");
}

const path = require("path");

const {
  _
} = require("@genx/july");

const {
  fs
} = require("@genx/sys");

const Suite = require("./Suite");

const SPECJS = ".spec.js";
const DOTJS = ".js";
const TEST_OPTS = "test/test.local.js";

function testSuite(file, body, options) {
  if (typeof options === 'undefined') {
    if (typeof file !== 'string') {
      if (typeof body !== 'undefined') {
        options = body;
      }

      body = file;

      const dbgGetCallerFile = require("@genx/july/lib/commonjs/lang/dbgGetCallerFile").default;

      file = dbgGetCallerFile();
    }
  }

  const {
    before: onBefore,
    after: onAfter,
    beforeEach: onBeforeEachCase,
    afterEach: onAfterEachCase,
    serverEntry,
    verbose,
    skip,
    only
  } = options == null ? {} : options;
  const suiteName = path.basename(file, file.endsWith(SPECJS) ? SPECJS : DOTJS);
  const testOptsFile = path.resolve(TEST_OPTS);
  let testOpts;

  if (fs.existsSync(testOptsFile)) {
    testOpts = require(testOptsFile);
  }

  const suiteOptions = {
    serverEntry,
    verbose,
    ...(testOpts ? _.pick(testOpts, ["serverEntry", "verbose"]) : {})
  };
  const suite = new Suite(suiteName, suiteOptions);
  let opt;

  if (only) {
    opt = "only";
  } else if (skip) {
    opt = "skip";
  } else if (testOpts) {
    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = "only";
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = "skip";
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      suite.initAllure();

      if (verbose) {
        console.log("Starting suite:", suiteName);
      }

      if (process.env.COVER_MODE) {
        await suite.startWebServer_();
      }

      if (onBefore) {
        await onBefore();
      }
    });
    after(async () => {
      await suite.stopWebServerIfStarted_();

      if (onAfter) {
        await onAfter();
      }

      console.log();

      if (verbose) {
        console.log("Finished suite:", suiteName);
      }

      if (process.env.ASYNC_DUMP) {
        asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
      }
    });

    if (onBeforeEachCase) {
      beforeEach(() => onBeforeEachCase(suite));
    }

    if (onAfterEachCase) {
      afterEach(() => onAfterEachCase(suite));
    }

    body(suite);
  });
}

module.exports = testSuite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3VpdGUiLCJTUEVDSlMiLCJET1RKUyIsIlRFU1RfT1BUUyIsInRlc3RTdWl0ZSIsImZpbGUiLCJib2R5Iiwib3B0aW9ucyIsImRiZ0dldENhbGxlckZpbGUiLCJkZWZhdWx0IiwiYmVmb3JlIiwib25CZWZvcmUiLCJhZnRlciIsIm9uQWZ0ZXIiLCJiZWZvcmVFYWNoIiwib25CZWZvcmVFYWNoQ2FzZSIsImFmdGVyRWFjaCIsIm9uQWZ0ZXJFYWNoQ2FzZSIsInNlcnZlckVudHJ5IiwidmVyYm9zZSIsInNraXAiLCJvbmx5Iiwic3VpdGVOYW1lIiwiYmFzZW5hbWUiLCJlbmRzV2l0aCIsInRlc3RPcHRzRmlsZSIsInJlc29sdmUiLCJ0ZXN0T3B0cyIsImV4aXN0c1N5bmMiLCJzdWl0ZU9wdGlvbnMiLCJwaWNrIiwic3VpdGUiLCJvcHQiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsImxvZyIsImRlc2NyaWJlIiwiaW5pdEFsbHVyZSIsIkNPVkVSX01PREUiLCJzdGFydFdlYlNlcnZlcl8iLCJzdG9wV2ViU2VydmVySWZTdGFydGVkXyIsImFzeW5jRHVtcCIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFJQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBaEIsRUFBNEI7QUFDeEJDLEVBQUFBLE9BQU8sQ0FBQyxhQUFELENBQVA7QUFDSDs7QUFFRCxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsWUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBU0gsT0FBTyxDQUFDLFdBQUQsQ0FBdEI7O0FBQ0EsTUFBTUksS0FBSyxHQUFH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QUFDbEJELE1BQUFBLFVBQVUsQ0FBQyxNQUFNQyxnQkFBZ0IsQ0FBQ2dCLEtBQUQsQ0FBdkIsQ0FBVjtBQUNIOztBQUVELFFBQUlkLGVBQUosRUFBcUI7QUFDakJELE1BQUFBLFNBQVMsQ0FBQyxNQUFNQyxlQUFlLENBQUNjLEtBQUQsQ0FBdEIsQ0FBVDtBQUNIOztBQUVEekIsSUFBQUEsSUFBSSxDQUFDeUIsS0FBRCxDQUFKO0FBQ0gsR0EzQ0Q7QUE0Q0g7O0FBRURjLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFDLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICByZXF1aXJlKFwiLi9hc3luY0R1bXBcIik7XG59XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZShcIkBnZW54L2p1bHlcIik7XG5jb25zdCB7IGZzIH0gPSByZXF1aXJlKFwiQGdlbngvc3lzXCIpO1xuY29uc3QgU3VpdGUgPSByZXF1aXJlKFwiLi9TdWl0ZVwiKTtcblxuY29uc3QgU1BFQ0pTID0gXCIuc3BlYy5qc1wiO1xuY29uc3QgRE9USlMgPSBcIi5qc1wiO1xuXG5jb25zdCBURVNUX09QVFMgPSBcInRlc3QvdGVzdC5sb2NhbC5qc1wiOyBcblxuLyoqXG4gKiBUZXN0IGJvZHkgdXNlZCB0byBkZWZpbmUgdGVzdCBjYXNlcy5cbiAqIEBjYWxsYmFjayB0ZXN0U3VpdGVCb2R5XG4gKiBAcGFyYW0ge1N1aXRlfSBzdWl0ZSAtIFRoZSB0ZXN0IHN1aXRlIG9iamVjdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgdGVzdCBzdWl0ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBbZmlsZV0gLSBUaGUgdGVzdCBzcGVjIGZpbGUgbmFtZSwganVzdCB1c2UgX19maWxlbmFtZS5cbiAqIEBwYXJhbSB7dGVzdFN1aXRlQm9keX0gYm9keSAtIFRvIGRlZmluZSB0ZXN0IGNhc2VkIGluIHRoaXMgY2FsbGJhY2suXG4gKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdXG4gKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvcHRpb25zLmJlZm9yZSAtIFByZXBhcmUgd29yayBiZWZvcmUgYWxsIHRlc3QgY2FzZXMuXG4gKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvcHRpb25zLmFmdGVyIC0gQ2xlYW51cCB3b3JrIGFmdGVyIGFsbCB0ZXN0IGNhc2VzLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLnNlcnZlckVudHJ5PVwiLi4vLi4vc3JjL2luZGV4LmpzXCJdIC0gVGhlIGVudHJ5IGZpbGUgb2YgQGdlbngvc2VydmVyIGluc3RhbmNlLlxuICogQHByb3BlcnR5IHtib29sZWFufSBvcHRpb25zLnZlcmJvc2UgLSBWZXJib3NlIG1vZGUuXG4gKi9cbmZ1bmN0aW9uIHRlc3RTdWl0ZShmaWxlLCBib2R5LCBvcHRpb25zKSB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAndW5kZWZpbmVkJykgeyAgICAgICAgXG4gICAgICAgIGlmICh0eXBlb2YgZmlsZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAvLyB0d28gYXJndW1lbnRzXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IGJvZHk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBib2R5ID0gZmlsZTtcblxuICAgICAgICAgICAgY29uc3QgZGJnR2V0Q2FsbGVyRmlsZSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5L2xpYi9jb21tb25qcy9sYW5nL2RiZ0dldENhbGxlckZpbGVcIikuZGVmYXVsdDtcbiAgICAgICAgICAgIGZpbGUgPSBkYmdHZXRDYWxsZXJGaWxlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICAgIGJlZm9yZTogb25CZWZvcmUsXG4gICAgICAgIGFmdGVyOiBvbkFmdGVyLFxuICAgICAgICBiZWZvcmVFYWNoOiBvbkJlZm9yZUVhY2hDYXNlLFxuICAgICAgICBhZnRlckVhY2g6IG9uQWZ0ZXJFYWNoQ2FzZSxcbiAgICAgICAgc2VydmVyRW50cnksXG4gICAgICAgIHZlcmJvc2UsXG4gICAgICAgIHNraXAsXG4gICAgICAgIG9ubHksXG4gICAgfSA9IG9wdGlvbnMgPT0gbnVsbCA/IHt9IDogb3B0aW9ucztcblxuICAgIGNvbnN0IHN1aXRlTmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZSwgZmlsZS5lbmRzV2l0aChTUEVDSlMpID8gU1BFQ0pTIDogRE9USlMpO1xuICAgIGNvbnN0IHRlc3RPcHRzRmlsZSA9IHBhdGgucmVzb2x2ZShURVNUX09QVFMpO1xuICAgIGxldCB0ZXN0T3B0cztcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHRlc3RPcHRzRmlsZSkpIHtcbiAgICAgICAgdGVzdE9wdHMgPSByZXF1aXJlKHRlc3RPcHRzRmlsZSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VpdGVPcHRpb25zID0ge1xuICAgICAgICBzZXJ2ZXJFbnRyeSxcbiAgICAgICAgdmVyYm9zZSxcbiAgICAgICAgLi4uKHRlc3RPcHRzID8gXy5waWNrKHRlc3RPcHRzLCBbXCJzZXJ2ZXJFbnRyeVwiLCBcInZlcmJvc2VcIl0pIDoge30pLFxuICAgIH07XG5cbiAgICBjb25zdCBzdWl0ZSA9IG5ldyBTdWl0ZShzdWl0ZU5hbWUsIHN1aXRlT3B0aW9ucyk7XG5cbiAgICBsZXQgb3B0O1xuXG4gICAgaWYgKG9ubHkpIHtcbiAgICAgICAgb3B0ID0gXCJvbmx5XCI7XG4gICAgfSBlbHNlIGlmIChza2lwKSB7XG4gICAgICAgIG9wdCA9IFwic2tpcFwiO1xuICAgIH0gZWxzZSBpZiAodGVzdE9wdHMpIHtcbiAgICAgICAgY29uc3Qgb25seSA9IG5ldyBTZXQodGVzdE9wdHMub25seSk7XG5cbiAgICAgICAgaWYgKG9ubHkuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkodGVzdE9wdHMub25seSkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBza2lwID0gbmV3IFNldCh0ZXN0T3B0cy5za2lwKTtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcC5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAob3B0ID8gZGVzY3JpYmVbb3B0XSA6IGRlc2NyaWJlKShzdWl0ZU5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHN1aXRlLmluaXRBbGx1cmUoKTtcblxuICAgICAgICAgICAgaWYgKHZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN1aXRlOlwiLCBzdWl0ZU5hbWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHN1aXRlLnN0YXJ0V2ViU2VydmVyXygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob25CZWZvcmUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvbkJlZm9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBzdWl0ZS5zdG9wV2ViU2VydmVySWZTdGFydGVkXygpO1xuXG4gICAgICAgICAgICBpZiAob25BZnRlcikge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgIGlmICh2ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGaW5pc2hlZCBzdWl0ZTpcIiwgc3VpdGVOYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICAgICAgICAgICAgICBhc3luY0R1bXAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUC5sZW5ndGggPiAxID8gcHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCA6IG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAob25CZWZvcmVFYWNoQ2FzZSkge1xuICAgICAgICAgICAgYmVmb3JlRWFjaCgoKSA9PiBvbkJlZm9yZUVhY2hDYXNlKHN1aXRlKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob25BZnRlckVhY2hDYXNlKSB7XG4gICAgICAgICAgICBhZnRlckVhY2goKCkgPT4gb25BZnRlckVhY2hDYXNlKHN1aXRlKSk7XG4gICAgICAgIH1cblxuICAgICAgICBib2R5KHN1aXRlKTtcbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB0ZXN0U3VpdGU7XG4iXX0=