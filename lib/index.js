"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require("./asyncDump");
}

const path = require("path");

const {
  _,
  fs
} = require("rk-utils");

const Suite = require("./Suite");

function testSuite(file, body, options) {
  const {
    before: onBefore,
    after: onAfter,
    serverEntry,
    verbose,
    skip,
    only
  } = options == null ? {} : options;
  const suiteName = path.basename(file, ".spec.js");
  const suite = new Suite(suiteName, {
    serverEntry,
    verbose
  });
  const testOptsFile = path.resolve("test/test.local.js");
  let opt;

  if (only) {
    opt = "only";
  } else if (skip) {
    opt = "skip";
  } else if (fs.existsSync(testOptsFile)) {
    const testOpts = require(testOptsFile);

    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = "only";
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = "skip";
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      suite.initAllure();

      if (verbose) {
        console.log("Starting suite:", suiteName);
      }

      if (process.env.COVER_MODE) {
        await suite.startWebServer_();
      }

      if (onBefore) {
        await onBefore();
      }
    });
    after(async () => {
      await suite.stopWebServerIfStarted_();

      if (onAfter) {
        await onAfter();
      }

      console.log();

      if (verbose) {
        console.log("Finished suite:", suiteName);
      }

      if (process.env.ASYNC_DUMP) {
        asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
      }
    });
    body(suite);
  });
}

module.exports = testSuite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3VpdGUiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsIm9wdGlvbnMiLCJiZWZvcmUiLCJvbkJlZm9yZSIsImFmdGVyIiwib25BZnRlciIsInNlcnZlckVudHJ5IiwidmVyYm9zZSIsInNraXAiLCJvbmx5Iiwic3VpdGVOYW1lIiwiYmFzZW5hbWUiLCJzdWl0ZSIsInRlc3RPcHRzRmlsZSIsInJlc29sdmUiLCJvcHQiLCJleGlzdHNTeW5jIiwidGVzdE9wdHMiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsImxvZyIsImRlc2NyaWJlIiwiaW5pdEFsbHVyZSIsIkNPVkVSX01PREUiLCJzdGFydFdlYlNlcnZlcl8iLCJzdG9wV2ViU2VydmVySWZTdGFydGVkXyIsImFzeW5jRHVtcCIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFJQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBaEIsRUFBNEI7QUFDeEJDLEVBQUFBLE9BQU8sQ0FBQyxhQUFELENBQVA7QUFDSDs7QUFFRCxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILE9BQU8sQ0FBQyxVQUFELENBQXpCOztBQUNBLE1BQU1JLEtBQUssR0FBR0osT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBa0JBLFNBQVNLLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxJQUF6QixFQUErQkMsT0FBL0IsRUFBd0M7QUFDcEMsUUFBTTtBQUFFQyxJQUFBQSxNQUFNLEVBQUVDLFFBQVY7QUFBb0JDLElBQUFBLEtBQUssRUFBRUMsT0FBM0I7QUFBb0NDLElBQUFBLFdBQXBDO0FBQWlEQyxJQUFBQSxPQUFq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QUNIO0FBQ0osS0FmSSxDQUFMO0FBaUJBUSxJQUFBQSxJQUFJLENBQUNZLEtBQUQsQ0FBSjtBQUNILEdBbkNEO0FBb0NIOztBQUVEa0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCakMsU0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJpZiAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCkge1xuICAgIHJlcXVpcmUoXCIuL2FzeW5jRHVtcFwiKTtcbn1cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgeyBfLCBmcyB9ID0gcmVxdWlyZShcInJrLXV0aWxzXCIpO1xuY29uc3QgU3VpdGUgPSByZXF1aXJlKFwiLi9TdWl0ZVwiKTtcblxuLyoqXG4gKiBUZXN0IGJvZHkgdXNlZCB0byBkZWZpbmUgdGVzdCBjYXNlcy5cbiAqIEBjYWxsYmFjayB0ZXN0U3VpdGVCb2R5XG4gKiBAcGFyYW0ge1N1aXRlfSBzdWl0ZSAtIFRoZSB0ZXN0IHN1aXRlIG9iamVjdFxuICovXG5cbi8qKlxuICogQ3JlYXRlIGEgdGVzdCBzdWl0ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlIC0gVGhlIHRlc3Qgc3BlYyBmaWxlIG5hbWUsIGp1c3QgdXNlIF9fZmlsZW5hbWUuXG4gKiBAcGFyYW0ge3Rlc3RTdWl0ZUJvZHl9IGJvZHkgLSBUbyBkZWZpbmUgdGVzdCBjYXNlZCBpbiB0aGlzIGNhbGxiYWNrLlxuICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXVxuICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5iZWZvcmUgLSBQcmVwYXJlIHdvcmsgYmVmb3JlIGFsbCB0ZXN0IGNhc2VzLlxuICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb3B0aW9ucy5hZnRlciAtIENsZWFudXAgd29yayBhZnRlciBhbGwgdGVzdCBjYXNlcy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5zZXJ2ZXJFbnRyeT1cIi4uLy4uL3NyYy9pbmRleC5qc1wiXSAtIFRoZSBlbnRyeSBmaWxlIG9mIEBnZW54L3NlcnZlciBpbnN0YW5jZS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb3B0aW9ucy52ZXJib3NlIC0gVmVyYm9zZSBtb2RlLlxuICovXG5mdW5jdGlvbiB0ZXN0U3VpdGUoZmlsZSwgYm9keSwgb3B0aW9ucykge1xuICAgIGNvbnN0IHsgYmVmb3JlOiBvbkJlZm9yZSwgYWZ0ZXI6IG9uQWZ0ZXIsIHNlcnZlckVudHJ5LCB2ZXJib3NlLCBza2lwLCBvbmx5IH0gPSBvcHRpb25zID09IG51bGwgPyB7fSA6IG9wdGlvbnM7XG5cbiAgICBjb25zdCBzdWl0ZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsIFwiLnNwZWMuanNcIik7XG4gICAgY29uc3Qgc3VpdGUgPSBuZXcgU3VpdGUoc3VpdGVOYW1lLCB7IHNlcnZlckVudHJ5LCB2ZXJib3NlIH0pO1xuXG4gICAgY29uc3QgdGVzdE9wdHNGaWxlID0gcGF0aC5yZXNvbHZlKFwidGVzdC90ZXN0LmxvY2FsLmpzXCIpO1xuXG4gICAgbGV0IG9wdDtcblxuICAgIGlmIChvbmx5KSB7XG4gICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgIH0gZWxzZSBpZiAoc2tpcCkge1xuICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICB9IGVsc2UgaWYgKGZzLmV4aXN0c1N5bmModGVzdE9wdHNGaWxlKSkge1xuICAgICAgICBjb25zdCB0ZXN0T3B0cyA9IHJlcXVpcmUodGVzdE9wdHNGaWxlKTtcbiAgICAgICAgY29uc3Qgb25seSA9IG5ldyBTZXQodGVzdE9wdHMub25seSk7XG5cbiAgICAgICAgaWYgKG9ubHkuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkodGVzdE9wdHMub25seSkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBza2lwID0gbmV3IFNldCh0ZXN0T3B0cy5za2lwKTtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcC5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAob3B0ID8gZGVzY3JpYmVbb3B0XSA6IGRlc2NyaWJlKShzdWl0ZU5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHN1aXRlLmluaXRBbGx1cmUoKTtcblxuICAgICAgICAgICAgaWYgKHZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN0YXJ0aW5nIHN1aXRlOlwiLCBzdWl0ZU5hbWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHN1aXRlLnN0YXJ0V2ViU2VydmVyXygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob25CZWZvcmUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvbkJlZm9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBzdWl0ZS5zdG9wV2ViU2VydmVySWZTdGFydGVkXygpO1xuXG4gICAgICAgICAgICBpZiAob25BZnRlcikge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgIGlmICh2ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJGaW5pc2hlZCBzdWl0ZTpcIiwgc3VpdGVOYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICAgICAgICAgICAgICBhc3luY0R1bXAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUC5sZW5ndGggPiAxID8gcHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCA6IG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBib2R5KHN1aXRlKTtcbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB0ZXN0U3VpdGU7XG4iXX0=