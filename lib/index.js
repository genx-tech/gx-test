"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require('./asyncDump');
}

const path = require('path');

const {
  _,
  fs
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

let webServer, allure;

async function startWebServer(serverEntry) {
  const createWebServer = require(serverEntry || '../../src/index.js');

  webServer = createWebServer({
    exitOnUncaught: false
  });
  webServer.started == null || webServer.started.should.not.be.ok();
  await webServer.start_();
  webServer.started.should.be.ok();
  return webServer;
}

;

exports.startRestClient = async (name, userTag, testToRun, options) => {
  let err;
  await startWorker(async app => {
    const client = await getRestClient(app, name, userTag);

    try {
      await testToRun(app, client);
    } catch (e) {
      err = e;
    }
  }, {
    workerName: "tester",
    configName: "test",
    configPath: "./test/conf",
    appModulesPath: "app_modules",
    ignoreUncaught: true,
    ...options
  });

  if (err) {
    should.not.exist(err, err.message || err);
  }
};

const tokenCache = {};

async function getRestClient(app, name, userTag) {
  const client = app.getService(webServer ? `superTest.${name}` : `restClient.${name}`);

  if (webServer) {
    client.server = webServer.httpServer;
  }

  if (!client.onSent) {
    client.onSent = (url, result) => {
      attachObject(url, result);
    };
  }

  if (!userTag) {
    delete client.onSend;
    return client;
  }

  let token, userAuth;

  if (_.isPlainObject(userTag)) {
    token = tokenCache[userTag.userTag];
    userAuth = userTag;
  } else {
    token = tokenCache[userTag];
    userAuth = app.settings.userAuth[userTag];
  }

  if (!token) {
    let res = await client.post(userAuth.endpoint, {
      username: userAuth.username,
      password: userAuth.password
    });
    token = res.token;
    tokenCache[userTag] = token;
    app.log('info', `Logged in with [${userTag}].`);
  }

  client.onSend = req => {
    req.set('Authorization', `Bearer ${token}`);
  };

  return client;
}

;
let suiteName, verboseEnabled;

exports.testSuite = (file, body, {
  before: onBefore,
  after: onAfter,
  serverEntry,
  verbose
} = {}) => {
  suiteName = path.basename(file, '.spec.js');
  verboseEnabled = verbose;
  const testOptsFile = path.resolve('test/test.local.js');
  let opt;

  if (fs.existsSync(testOptsFile)) {
    const testOpts = require(testOptsFile);

    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = 'only';
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = 'skip';
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      const allureMocha = require('allure-mocha/runtime');

      allure = allureMocha.allure;
      console.log('allure', allure);

      if (process.env.COVER_MODE) {
        webServer = await startWebServer(serverEntry);
      }

      if (onBefore) {
        await onBefore();
      }
    });

    if (process.env.COVER_MODE || onAfter || process.env.ASYNC_DUMP) {
      after(async () => {
        console.log();

        if (webServer && webServer.started) {
          await webServer.stop_();
          webServer = undefined;
        }

        if (onAfter) {
          await onAfter();
        }

        if (process.env.ASYNC_DUMP) {
          asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
        }
      });
    }

    body();
  });
};

function testCase(story, body, data) {
  it(story, async function () {
    if (allure) {
      if (data) {
        const {
          description,
          epic,
          feature,
          owner,
          tag,
          issues,
          severity
        } = data.allure;
        console.log(data.allure);
        description && allure.description(description);
        epic && allure.epic(epic);
        feature && allure.feature(feature);
        owner && allure.owner(owner);
        tag && allure.tag(tag);
        severity && allure.severity(severity);
        _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
          allure.issue(num, link);
        });
      }

      allure.story(story);
      allure.createStep(`start ${story}`, () => {})();

      if (data && data.params) {
        _.forOwn(data.params, (v, k) => {
          if (typeof v === 'object') {
            allure.parameter(k, '*see attachment*');
            attachObject(`param[${k}]`, v);
          } else {
            allure.parameter(k, v);
          }
        });
      }
    }

    await body(data);
  });
}

exports.testCase = testCase;

exports.testCaseFromFixtures = (story, body) => {
  const p = path.resolve(`test/fixtures/${suiteName}.js`);

  const suiteData = require(p);

  if (!suiteData) throw new Error(`Suite data not found. Suite: ${suiteName}`);
  const {
    cases,
    ...others
  } = suiteData;
  const storyData = cases && cases[story];
  if (!storyData) throw new Error(`Story data not found. Suite: ${suiteName}, story: ${story}`);

  _.castArray(storyData).forEach((caseData, i) => {
    const preparedData = {
      allure: others,
      params: _.mapValues(caseData.params, v => {
        if (typeof v === 'function') return v();
        return v;
      }),
      expected: caseData.expected
    };
    testCase(`${story}#${i + 1}`, body, preparedData);
  });
};

function attachObject(name, obj) {
  if (!allure) return;
  let type = 'plain/text',
      content = obj;

  if (typeof obj !== 'string') {
    content = JSON.stringify(obj, null, 4);
    type = 'application/json';
  }

  allure.createAttachment(name, content, type);
}

exports.attachObject = attachObject;

exports.testStep = async (step, body) => {
  if (allure) {
    console.log('allure.createStep');
    allure.createStep(step, () => {})();
  }

  if (verboseEnabled) {
    console.log('Step: ', step);
  }

  await body();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3RhcnRlcnMiLCJzdGFydFdvcmtlciIsIndlYlNlcnZlciIsImFsbHVyZSIsInN0YXJ0V2ViU2VydmVyIiwic2VydmVyRW50cnkiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwiZXhwb3J0cyIsInN0YXJ0UmVzdENsaWVudCIsIm5hbWUiLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsImdldFJlc3RDbGllbnQiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInRva2VuQ2FjaGUiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsImF0dGFjaE9iamVjdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibG9nIiwicmVxIiwic2V0Iiwic3VpdGVOYW1lIiwidmVyYm9zZUVuYWJsZWQiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsImJlZm9yZSIsIm9uQmVmb3JlIiwiYWZ0ZXIiLCJvbkFmdGVyIiwidmVyYm9zZSIsImJhc2VuYW1lIiwidGVzdE9wdHNGaWxlIiwicmVzb2x2ZSIsIm9wdCIsImV4aXN0c1N5bmMiLCJ0ZXN0T3B0cyIsIm9ubHkiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsInNraXAiLCJkZXNjcmliZSIsImFsbHVyZU1vY2hhIiwiQ09WRVJfTU9ERSIsInN0b3BfIiwidW5kZWZpbmVkIiwiYXN5bmNEdW1wIiwibGVuZ3RoIiwidGVzdENhc2UiLCJzdG9yeSIsImRhdGEiLCJpdCIsImRlc2NyaXB0aW9uIiwiZXBpYyIsImZlYXR1cmUiLCJvd25lciIsInRhZyIsImlzc3VlcyIsInNldmVyaXR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwiY3JlYXRlU3RlcCIsInBhcmFtcyIsInYiLCJrIiwicGFyYW1ldGVyIiwidGVzdENhc2VGcm9tRml4dHVyZXMiLCJwIiwic3VpdGVEYXRhIiwiRXJyb3IiLCJjYXNlcyIsIm90aGVycyIsInN0b3J5RGF0YSIsImNhc3RBcnJheSIsImZvckVhY2giLCJjYXNlRGF0YSIsImkiLCJwcmVwYXJlZERhdGEiLCJtYXBWYWx1ZXMiLCJleHBlY3RlZCIsIm9iaiIsInR5cGUiLCJjb250ZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZUF0dGFjaG1lbnQiLCJ0ZXN0U3RlcCIsInN0ZXAiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFJQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBaEIsRUFBNEI7QUFDeEJDLEVBQUFBLE9BQU8sQ0FBQyxhQUFELENBQVA7QUFDSDs7QUFFRCxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILE9BQU8sQ0FBQyxVQUFELENBQXpCOztBQUNBLE1BQU07QUFBRUksRUFBQUEsUUFBUSxFQUFFO0FBQUVDLElBQUFBO0FBQUY7QUFBWixJQUFnQ0wsT0FBTyxDQUFDLFdBQUQsQ0FBN0M7O0FBRUEsSUFBSU0sU0FBSixFQUFlQyxNQUFmOztBQU1BLGVBQWVDLGNBQWYsQ0FBOEJDLFdBQTlCLEVBQTJDO0FBQ3ZDLFFBQU1DLGVBQWUsR0FBR1YsT0FBTyxDQUFDUyxXQUFXLElBQUksb0JBQWhCLENBQS9COztBQUNBSCxFQUFBQSxTQUFTLEdB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LENBQUM4RixVQUFQLENBQWtCMEIsSUFBbEIsRUFBd0IsTUFBTSxDQUFFLENBQWhDO0FBQ0g7O0FBRUQsTUFBSXJFLGNBQUosRUFBb0I7QUFDaEJtQixJQUFBQSxPQUFPLENBQUN2QixHQUFSLENBQVksUUFBWixFQUFzQnlFLElBQXRCO0FBQ0g7O0FBRUQsUUFBTWxFLElBQUksRUFBVjtBQUNILENBWkQiLCJzb3VyY2VzQ29udGVudCI6WyJpZiAocHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCkge1xuICAgIHJlcXVpcmUoJy4vYXN5bmNEdW1wJyk7XG59XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBTdGFydGVyczogeyBzdGFydFdvcmtlciB9IH0gPSByZXF1aXJlKCdAZ2VueC9hcHAnKTtcblxubGV0IHdlYlNlcnZlciwgYWxsdXJlO1xuXG4vKipcbiAqIFxuICogQHBhcmFtIHsqfSBzZXJ2ZXJFbnRyeSAtIFNlcnZlciBlbnRyeSBmaWxlIHBhdGggKHJlbGF0aXZlIHRvIHRlc3Qgd29ya2luZyBwYXRoKVxuICovXG5hc3luYyBmdW5jdGlvbiBzdGFydFdlYlNlcnZlcihzZXJ2ZXJFbnRyeSkge1xuICAgIGNvbnN0IGNyZWF0ZVdlYlNlcnZlciA9IHJlcXVpcmUoc2VydmVyRW50cnkgfHwgJy4uLy4uL3NyYy9pbmRleC5qcycpO1xuICAgIHdlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgIGV4aXRPblVuY2F1Z2h0OiBmYWxzZVxuICAgIH0pO1xuICAgIHdlYlNlcnZlci5zdGFydGVkID09IG51bGwgfHwgd2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLm5vdC5iZS5vaygpO1xuICAgIFxuICAgIGF3YWl0IHdlYlNlcnZlci5zdGFydF8oKTtcblxuICAgIHdlYlNlcnZlci5zdGFydGVkLnNob3VsZC5iZS5vaygpO1xuXG4gICAgcmV0dXJuIHdlYlNlcnZlcjtcbn07XG5cbi8qKlxuICogUnVuIGEgdGVzdCBmdW5jdGlvbiBpbiBhIHdvcmtlclxuICogQHBhcmFtIHsqfSB0ZXN0VG9SdW4gXG4gKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gKi9cbmV4cG9ydHMuc3RhcnRSZXN0Q2xpZW50ID0gYXN5bmMgKG5hbWUsIHVzZXJUYWcsIHRlc3RUb1J1biwgb3B0aW9ucykgPT4ge1xuICAgIGxldCBlcnI7XG5cbiAgICBhd2FpdCBzdGFydFdvcmtlcihhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IGdldFJlc3RDbGllbnQoYXBwLCBuYW1lLCB1c2VyVGFnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRlc3RUb1J1bihhcHAsIGNsaWVudCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfSwge1xuICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLCAgICAgICAgXG4gICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICBjb25maWdQYXRoOiBcIi4vdGVzdC9jb25mXCIsXG4gICAgICAgIGFwcE1vZHVsZXNQYXRoOiBcImFwcF9tb2R1bGVzXCIsXG4gICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAuLi5vcHRpb25zXG4gICAgfSk7XG5cbiAgICBpZiAoZXJyKSB7XG4gICAgICAgIHNob3VsZC5ub3QuZXhpc3QoZXJyLCBlcnIubWVzc2FnZSB8fCBlcnIpO1xuICAgIH0gICAgXG59O1xuXG5jb25zdCB0b2tlbkNhY2hlID0ge307XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlc3RDbGllbnQoYXBwLCBuYW1lLCB1c2VyVGFnKSB7XG4gICAgY29uc3QgY2xpZW50ID0gYXBwLmdldFNlcnZpY2Uod2ViU2VydmVyID8gYHN1cGVyVGVzdC4ke25hbWV9YCA6IGByZXN0Q2xpZW50LiR7bmFtZX1gKTtcbiAgICBpZiAod2ViU2VydmVyKSB7XG4gICAgICAgIGNsaWVudC5zZXJ2ZXIgPSB3ZWJTZXJ2ZXIuaHR0cFNlcnZlcjtcbiAgICB9XG5cbiAgICBpZiAoIWNsaWVudC5vblNlbnQpIHtcbiAgICAgICAgY2xpZW50Lm9uU2VudCA9ICh1cmwsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgYXR0YWNoT2JqZWN0KHVybCwgcmVzdWx0KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXJUYWcpIHtcbiAgICAgICAgZGVsZXRlIGNsaWVudC5vblNlbmQ7IFxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH0gICAgXG5cbiAgICBsZXQgdG9rZW4sIHVzZXJBdXRoO1xuXG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdCh1c2VyVGFnKSkge1xuICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZy51c2VyVGFnXTtcbiAgICAgICAgdXNlckF1dGggPSB1c2VyVGFnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnXTtcbiAgICAgICAgdXNlckF1dGggPSBhcHAuc2V0dGluZ3MudXNlckF1dGhbdXNlclRhZ107XG4gICAgfVxuXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgY2xpZW50LnBvc3QodXNlckF1dGguZW5kcG9pbnQsIHsgdXNlcm5hbWU6IHVzZXJBdXRoLnVzZXJuYW1lLCBwYXNzd29yZDogdXNlckF1dGgucGFzc3dvcmQgfSk7XG4gICAgICAgIHRva2VuID0gcmVzLnRva2VuO1xuICAgICAgICB0b2tlbkNhY2hlW3VzZXJUYWddID0gdG9rZW47ICAgICAgICBcblxuICAgICAgICBhcHAubG9nKCdpbmZvJywgYExvZ2dlZCBpbiB3aXRoIFske3VzZXJUYWd9XS5gKTtcbiAgICB9XG5cbiAgICBjbGllbnQub25TZW5kID0gKHJlcSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgcmVxLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xpZW50O1xufTtcblxubGV0IHN1aXRlTmFtZSwgdmVyYm9zZUVuYWJsZWQ7XG5cbmV4cG9ydHMudGVzdFN1aXRlID0gKGZpbGUsIGJvZHksIHsgYmVmb3JlOiBvbkJlZm9yZSwgYWZ0ZXI6IG9uQWZ0ZXIsIHNlcnZlckVudHJ5LCB2ZXJib3NlIH0gPSB7fSkgPT4ge1xuICAgIHN1aXRlTmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZSwgJy5zcGVjLmpzJyk7XG4gICAgdmVyYm9zZUVuYWJsZWQgPSB2ZXJib3NlO1xuXG4gICAgY29uc3QgdGVzdE9wdHNGaWxlID0gcGF0aC5yZXNvbHZlKCd0ZXN0L3Rlc3QubG9jYWwuanMnKTtcblxuICAgIGxldCBvcHQ7ICAgIFxuXG4gICAgaWYgKGZzLmV4aXN0c1N5bmModGVzdE9wdHNGaWxlKSkge1xuICAgICAgICBjb25zdCB0ZXN0T3B0cyA9IHJlcXVpcmUodGVzdE9wdHNGaWxlKTsgICAgICAgIFxuICAgICAgICBjb25zdCBvbmx5ID0gbmV3IFNldCh0ZXN0T3B0cy5vbmx5KTsgICAgICAgIFxuXG4gICAgICAgIGlmIChvbmx5LmhhcyhzdWl0ZU5hbWUpKSB7XG4gICAgICAgICAgICBvcHQgPSAnb25seSc7ICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh0ZXN0T3B0cy5vbmx5KSkgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBza2lwID0gbmV3IFNldCh0ZXN0T3B0cy5za2lwKTtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcC5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBvcHQgPSAnc2tpcCc7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdWl0ZSBcIiR7c3VpdGVOYW1lfVwiIHNraXBwZWQuYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9ICAgICAgICBcbiAgICB9XG5cbiAgICAob3B0ID8gZGVzY3JpYmVbb3B0XSA6IGRlc2NyaWJlKShzdWl0ZU5hbWUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFsbHVyZU1vY2hhID0gcmVxdWlyZSgnYWxsdXJlLW1vY2hhL3J1bnRpbWUnKTsgICAgICAgICAgICBcbiAgICAgICAgICAgIGFsbHVyZSA9IGFsbHVyZU1vY2hhLmFsbHVyZTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdhbGx1cmUnLCBhbGx1cmUpOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5DT1ZFUl9NT0RFKSB7XG4gICAgICAgICAgICAgICB3ZWJTZXJ2ZXIgPSBhd2FpdCBzdGFydFdlYlNlcnZlcihzZXJ2ZXJFbnRyeSk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChvbkJlZm9yZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9uQmVmb3JlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pOyAgIFxuXG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5DT1ZFUl9NT0RFIHx8IG9uQWZ0ZXIgfHwgcHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCkge1xuICAgICAgICAgICAgYWZ0ZXIoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2ViU2VydmVyICYmIHdlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgICAgYXdhaXQgd2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICAgICAgICAgd2ViU2VydmVyID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgIFxuICAgICAgICAgICAgICAgIGlmIChvbkFmdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzeW5jRHVtcChwcm9jZXNzLmVudi5BU1lOQ19EVU1QLmxlbmd0aCA+IDEgPyBwcm9jZXNzLmVudi5BU1lOQ19EVU1QIDogbnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7ICAgXG4gICAgICAgIH1cblxuICAgICAgICBib2R5KCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RDYXNlKHN0b3J5LCBib2R5LCBkYXRhKSB7XG4gICAgaXQoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEuYWxsdXJlKTtcblxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uICYmIGFsbHVyZS5kZXNjcmlwdGlvbihkZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgZXBpYyAmJiBhbGx1cmUuZXBpYyhlcGljKTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlICYmIGFsbHVyZS5mZWF0dXJlKGZlYXR1cmUpO1xuICAgICAgICAgICAgICAgIG93bmVyICYmIGFsbHVyZS5vd25lcihvd25lcik7XG4gICAgICAgICAgICAgICAgdGFnICYmIGFsbHVyZS50YWcodGFnKTtcbiAgICAgICAgICAgICAgICBzZXZlcml0eSAmJiBhbGx1cmUuc2V2ZXJpdHkoc2V2ZXJpdHkpO1xuXG4gICAgICAgICAgICAgICAgXy5pc0VtcHR5KGlzc3VlcykgfHwgKF8uZm9yT3duKGlzc3VlcywgKGxpbmssIG51bSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhbGx1cmUuaXNzdWUobnVtLCBsaW5rKTtcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBhbGx1cmUuc3Rvcnkoc3RvcnkpO1xuICAgICAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoYHN0YXJ0ICR7c3Rvcnl9YCwgKCkgPT4ge30pKCk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChkYXRhICYmIGRhdGEucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24oZGF0YS5wYXJhbXMsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgJypzZWUgYXR0YWNobWVudConKTsgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRhY2hPYmplY3QoYHBhcmFtWyR7a31dYCwgdik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssIHYpO1xuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IGJvZHkoZGF0YSk7XG4gICAgfSk7XG59XG5cbmV4cG9ydHMudGVzdENhc2UgPSB0ZXN0Q2FzZTtcblxuZXhwb3J0cy50ZXN0Q2FzZUZyb21GaXh0dXJlcyA9IChzdG9yeSwgYm9keSkgPT4ge1xuICAgIGNvbnN0IHAgPSBwYXRoLnJlc29sdmUoYHRlc3QvZml4dHVyZXMvJHtzdWl0ZU5hbWV9LmpzYCk7XG4gICAgY29uc3Qgc3VpdGVEYXRhID0gcmVxdWlyZShwKTtcbiAgICBpZiAoIXN1aXRlRGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdWl0ZSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7c3VpdGVOYW1lfWApO1xuXG4gICAgY29uc3QgeyBjYXNlcywgLi4ub3RoZXJzIH0gPSBzdWl0ZURhdGE7ICAgIFxuXG4gICAgY29uc3Qgc3RvcnlEYXRhID0gY2FzZXMgJiYgY2FzZXNbc3RvcnldOyAgIFxuICAgIGlmICghc3RvcnlEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN0b3J5IGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHtzdWl0ZU5hbWV9LCBzdG9yeTogJHtzdG9yeX1gKTtcblxuICAgIF8uY2FzdEFycmF5KHN0b3J5RGF0YSkuZm9yRWFjaCgoY2FzZURhdGEsIGkpID0+IHtcbiAgICAgICAgY29uc3QgcHJlcGFyZWREYXRhID0ge1xuICAgICAgICAgICAgYWxsdXJlOiBvdGhlcnMsXG4gICAgICAgICAgICBwYXJhbXM6IF8ubWFwVmFsdWVzKGNhc2VEYXRhLnBhcmFtcywgKHYpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdmdW5jdGlvbicpIHJldHVybiB2KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGV4cGVjdGVkOiBjYXNlRGF0YS5leHBlY3RlZFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0ZXN0Q2FzZShgJHtzdG9yeX0jJHtpKzF9YCwgYm9keSwgcHJlcGFyZWREYXRhKTsgXG4gICAgfSk7ICAgIFxufVxuXG5mdW5jdGlvbiBhdHRhY2hPYmplY3QobmFtZSwgb2JqKSB7XG4gICAgLy9jb25zdCB7IGFsbHVyZSB9ID0gcmVxdWlyZSgnYWxsdXJlLW1vY2hhL3J1bnRpbWUnKTtcbiAgICBpZiAoIWFsbHVyZSkgcmV0dXJuO1xuXG4gICAgbGV0IHR5cGUgPSAncGxhaW4vdGV4dCcsIGNvbnRlbnQgPSBvYmo7XG5cbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgIHR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgfVxuXG4gICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG59XG5cbmV4cG9ydHMuYXR0YWNoT2JqZWN0ID0gYXR0YWNoT2JqZWN0O1xuXG5leHBvcnRzLnRlc3RTdGVwID0gYXN5bmMgKHN0ZXAsIGJvZHkpID0+IHtcbiAgICAvL2NvbnN0IHsgYWxsdXJlIH0gPSByZXF1aXJlKCdhbGx1cmUtbW9jaGEvcnVudGltZScpO1xuICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ2FsbHVyZS5jcmVhdGVTdGVwJyk7XG4gICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IHt9KSgpO1xuICAgIH1cblxuICAgIGlmICh2ZXJib3NlRW5hYmxlZCkge1xuICAgICAgICBjb25zb2xlLmxvZygnU3RlcDogJywgc3RlcCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9keSgpO1xufSJdfQ==