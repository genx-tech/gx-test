"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require('./asyncDump');
}

const path = require('path');

const {
  _,
  fs
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

let webServer;

async function startWebServer(serverEntry) {
  const createWebServer = require(serverEntry || '../../src/index.js');

  webServer = createWebServer({
    exitOnUncaught: false
  });
  webServer.started == null || webServer.started.should.not.be.ok();
  await webServer.start_();
  webServer.started.should.be.ok();
  return webServer;
}

;

exports.startRestClient = async (name, userTag, testToRun, options) => {
  let err;
  await startWorker(async app => {
    const client = await getRestClient(app, name, userTag);

    try {
      await testToRun(app, client);
    } catch (e) {
      err = e;
    }
  }, {
    workerName: "tester",
    configName: "test",
    configPath: "./test/conf",
    appModulesPath: "app_modules",
    ignoreUncaught: true,
    ...options
  });

  if (err) {
    should.not.exist(err, err.message || err);
  }
};

const tokenCache = {};

async function getRestClient(app, name, userTag) {
  const client = app.getService(webServer ? `superTest.${name}` : `restClient.${name}`);

  if (webServer) {
    client.server = webServer.httpServer;
  }

  if (!client.onSent) {
    client.onSent = (url, result) => {
      attachObject(url, result);
    };
  }

  if (!userTag) {
    delete client.onSend;
    return client;
  }

  let token, userAuth;

  if (_.isPlainObject(userTag)) {
    token = tokenCache[userTag.userTag];
    userAuth = userTag;
  } else {
    token = tokenCache[userTag];
    userAuth = app.settings.userAuth[userTag];
  }

  if (!token) {
    let res = await client.post(userAuth.endpoint, {
      username: userAuth.username,
      password: userAuth.password
    });
    token = res.token;
    tokenCache[userTag] = token;
    app.log('info', `Logged in with [${userTag}].`);
  }

  client.onSend = req => {
    req.set('Authorization', `Bearer ${token}`);
  };

  return client;
}

;
let suiteName, verboseEnabled;

exports.testSuite = (file, body, {
  before: onBefore,
  after: onAfter,
  serverEntry,
  verbose
} = {}) => {
  suiteName = path.basename(file, '.spec.js');
  verboseEnabled = verbose;
  const testOptsFile = path.resolve('test/test.local.js');
  let opt;

  if (fs.existsSync(testOptsFile)) {
    const testOpts = require(testOptsFile);

    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = 'only';
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = 'skip';
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    if (process.env.COVER_MODE || onBefore) {
      before(async () => {
        if (process.env.COVER_MODE) {
          webServer = await startWebServer(serverEntry);
        }

        if (onBefore) {
          await onBefore();
        }
      });
    }

    if (process.env.COVER_MODE || onAfter || process.env.ASYNC_DUMP) {
      after(async () => {
        console.log();

        if (webServer && webServer.started) {
          await webServer.stop_();
          webServer = undefined;
        }

        if (onAfter) {
          await onAfter();
        }

        if (process.env.ASYNC_DUMP) {
          asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
        }
      });
    }

    body();
  });
};

function testCase(story, body, data) {
  it(story, async function () {
    const {
      allure
    } = require('allure-mocha/runtime');

    if (allure) {
      if (data) {
        const {
          description,
          epic,
          feature,
          owner,
          tag,
          issues,
          severity
        } = data.allure;
        description && allure.description(description);
        epic && allure.epic(epic);
        feature && allure.feature(feature);
        owner && allure.owner(owner);
        tag && allure.tag(tag);
        severity && allure.severity(severity);
        _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
          allure.issue(num, link);
        });
      }

      allure.story(story);
      allure.createStep(`start ${story}`, () => {})();

      if (data && data.params) {
        _.forOwn(data.params, (v, k) => {
          if (typeof v === 'object') {
            allure.parameter(k, '*see attachment*');
            attachObject(`param[${k}]`, v);
          } else {
            allure.parameter(k, v);
          }
        });
      }
    }

    await body(data);
  });
}

exports.testCase = testCase;

exports.testCaseFromFixtures = (story, body) => {
  const p = path.resolve(`test/fixtures/${suiteName}.js`);

  const suiteData = require(p);

  if (!suiteData) throw new Error(`Suite data not found. Suite: ${suiteName}`);
  const {
    cases,
    ...others
  } = suiteData;
  const storyData = cases && cases[story];
  if (!storyData) throw new Error(`Story data not found. Suite: ${suiteName}, story: ${story}`);

  _.castArray(storyData).forEach((caseData, i) => {
    const preparedData = {
      allure: others,
      params: _.mapValues(caseData.params, v => {
        if (typeof v === 'function') return v();
        return v;
      }),
      expected: caseData.expected
    };
    testCase(`${story}#${i + 1}`, body, preparedData);
  });
};

function attachObject(name, obj) {
  const {
    allure
  } = require('allure-mocha/runtime');

  if (!allure) return;
  let type = 'plain/text',
      content = obj;

  if (typeof obj !== 'string') {
    content = JSON.stringify(obj, null, 4);
    type = 'application/json';
  }

  allure.createAttachment(name, content, type);
}

exports.attachObject = attachObject;

exports.testStep = async (step, body) => {
  const {
    allure
  } = require('allure-mocha/runtime');

  if (allure) {
    allure.createStep(step, () => {})();
  }

  if (verboseEnabled) {
    console.log('Step: ', step);
  }

  await body();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3RhcnRlcnMiLCJzdGFydFdvcmtlciIsIndlYlNlcnZlciIsInN0YXJ0V2ViU2VydmVyIiwic2VydmVyRW50cnkiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwiZXhwb3J0cyIsInN0YXJ0UmVzdENsaWVudCIsIm5hbWUiLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsImdldFJlc3RDbGllbnQiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInRva2VuQ2FjaGUiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsImF0dGFjaE9iamVjdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibG9nIiwicmVxIiwic2V0Iiwic3VpdGVOYW1lIiwidmVyYm9zZUVuYWJsZWQiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsImJlZm9yZSIsIm9uQmVmb3JlIiwiYWZ0ZXIiLCJvbkFmdGVyIiwidmVyYm9zZSIsImJhc2VuYW1lIiwidGVzdE9wdHNGaWxlIiwicmVzb2x2ZSIsIm9wdCIsImV4aXN0c1N5bmMiLCJ0ZXN0T3B0cyIsIm9ubHkiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsInNraXAiLCJkZXNjcmliZSIsIkNPVkVSX01PREUiLCJzdG9wXyIsInVuZGVmaW5lZCIsImFzeW5jRHVtcCIsImxlbmd0aCIsInRlc3RDYXNlIiwic3RvcnkiLCJkYXRhIiwiaXQiLCJhbGx1cmUiLCJkZXNjcmlwdGlvbiIsImVwaWMiLCJmZWF0dXJlIiwib3duZXIiLCJ0YWciLCJpc3N1ZXMiLCJzZXZlcml0eSIsImZvck93biIsImxpbmsiLCJudW0iLCJpc3N1ZSIsImNyZWF0ZVN0ZXAiLCJwYXJhbXMiLCJ2IiwiayIsInBhcmFtZXRlciIsInRlc3RDYXNlRnJvbUZpeHR1cmVzIiwicCIsInN1aXRlRGF0YSIsIkVycm9yIiwiY2FzZXMiLCJvdGhlcnMiLCJzdG9yeURhdGEiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY2FzZURhdGEiLCJpIiwicHJlcGFyZWREYXRhIiwibWFwVmFsdWVzIiwiZXhwZWN0ZWQiLCJvYmoiLCJ0eXBlIiwiY29udGVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJjcmVhdGVBdHRhY2htZW50IiwidGVzdFN0ZXAiLCJzdGVwIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBSUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCQyxFQUFBQSxPQUFPLENBQUMsYUFBRCxDQUFQO0FBQ0g7O0FBRUQsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxPQUFPLENBQUMsVUFBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBLFFBQVEsRUFBRTtBQUFFQyxJQUFBQTtBQUFGO0FBQVosSUFBZ0NMLE9BQU8sQ0FBQyxXQUFELENBQTdDOztBQUVBLElBQUlNLFNBQUo7O0FBTUEsZUFBZUMsY0FBZixDQUE4QkMsV0FBOUIsRUFBMkM7QUFDdkMsUUFBTUMsZUFBZSxHQUFHVCxPQUFPLENBQUNRLFdBQVcsSUFBSSxvQkFBaEIsQ0FBL0I7O0FBQ0FGLEVBQUFBLFNBQVMsR0FBR0csZUFBZSxDQUFDO0FBQ3hCQyxJQUFBQSxjQUFjLEVBQUU7QUFEUSxHQUFELENBQTNCO0FBR0FKLEVBQUFBLFNBQVMsQ0FBQ0ssT0FBVixJQUFxQixJQUFyQixJQUE2QkwsU0FBUyxDQUFDSyxPQUFWLENBQWtCQyxNQUFsQixDQUF5QkMsR0FBekIsQ0FBNkJDLEVBQTdCLENBQWdDQyxFQUFoQyxFQUE3QjtBQUVBLFFBQU1ULFNBQVMsQ0FBQ1UsTUFBVixFQUFOO0FBRUFWLEVBQUFBLFNBQVMsQ0FBQ0ssT0FBVixDQUFrQkMsTUFBbEIsQ0FBeUJFLEVBQXpCLENBQTRCQyxFQUE1QjtBQUVBLFNBQU9ULFNBQVA7QUFDSDs7QUFBQTs7QUFPRFcsT0FBTyxDQUFDQyxlQUFSLEdBQTBCLE9BQU9DLElBQVAsRUFBYUMsT0FBYixFQUFzQkMsU0FBdEIsRUFBaUNDLE9BQWpDLEtBQTZDO0FBQ25FLE1BQUlDLEdBQUo7QUFFQSxRQUFNbEIsV0FBVyxDQUFDLE1BQU9tQixHQUFQLElBQWU7QUFDN0IsVUFBTUMsTUFBTSxHQUFHLE1BQU1DLGFBQWEsQ0FBQ0YsR0FBRCxFQUFNTCxJQUFOLEVBQVlDLE9BQVosQ0FBbEM7O0FBQ0EsUUFBSTtBQUNBLFlBQU1DLFNBQVMsQ0FBQ0csR0FBRCxFQUFNQyxNQUFOLENBQWY7QUFDSCxLQUZELENBRUUsT0FBT0UsQ0FBUCxFQUFVO0FBQ1JKLE1BQUFBLEdBQUcsR0FBR0ksQ0FBTjtBQUNIO0FBRUosR0FSZ0IsRUFRZDtBQUNDQyxJQUFBQSxVQUFVLEVBQUUsUUFEYjtBQUVDQyxJQUFBQSxVQUFVLEVBQUUsTUFGYjtBQUdDQyxJQUFBQSxVQUFVLEVBQUUsYUFIYjtBQUlDQyxJQUFBQSxjQUFjLEVBQUUsYUFKakI7QUFLQ0MsSUFBQUEsY0FBYyxFQUFFLElBTGpCO0FBTUMsT0FBR1Y7QUFOSixHQVJjLENBQWpCOztBQWlCQSxNQUFJQyxHQUFKLEVBQVM7QUFDTFgsSUFBQUEsTUFBTSxDQUFDQyxHQUFQLENBQVdvQixLQUFYLENBQWlCVixHQUFqQixFQUFzQkEsR0FBRyxDQUFDVyxPQUFKLElBQWVYLEdBQXJDO0FBQ0g7QUFDSixDQXZCRDs7QUF5QkEsTUFBTVksVUFBVSxHQUFHLEVBQW5COztBQUVBLGVBQWVULGFBQWYsQ0FBNkJGLEdBQTdCLEVBQWtDTCxJQUFsQyxFQUF3Q0MsT0FBeEMsRUFBaUQ7QUFDN0MsUUFBTUssTUFBTSxHQUFHRCxHQUFHLENBQUNZLFVBQUosQ0FBZTlCLFNBQVMsR0FBSSxhQUFZYSxJQUFLLEVBQXJCLEdBQTBCLGNBQWFBLElBQUssRUFBcEUsQ0FBZjs7QUFDQSxNQUFJYixTQUFKLEVBQWU7QUFDWG1CLElBQUFBLE1BQU0sQ0FBQ1ksTUFBUCxHQUFnQi9CLFNBQVMsQ0FBQ2dDLFVBQTFCO0FBQ0g7O0FBRUQsTUFBSSxDQUFDYixNQUFNLENBQUNjLE1BQVosRUFBb0I7QUFDaEJkLElBQUFBLE1BQU0sQ0FBQ2MsTUFBUCxHQUFnQixDQUFDQyxHQUFELEVBQU1DLE1BQU4sS0FBaUI7QUFDN0JDLE1BQUFBLFlBQVksQ0FBQ0YsR0FBRCxFQUFNQyxNQUFOLENBQVo7QUFDSCxLQUZEO0FBR0g7O0FBRUQsTUFBSSxDQUFDckIsT0FBTCxFQUFjO0FBQ1YsV0FBT0ssTUFBTSxDQUFDa0IsTUFBZDtBQUNBLFdBQU9sQixNQUFQO0FBQ0g7O0FBRUQsTUFBSW1CLEtBQUosRUFBV0MsUUFBWDs7QUFFQSxNQUFJM0MsQ0FBQyxDQUFDNEMsYUFBRixDQUFnQjFCLE9BQWhCLENBQUosRUFBOEI7QUFDMUJ3QixJQUFBQSxLQUFLLEdBQUdULFVBQVUsQ0FBQ2YsT0FBTyxDQUFDQSxPQUFULENBQWxCO0FBQ0F5QixJQUFBQSxRQUFRLEdBQUd6QixPQUFYO0FBQ0gsR0FIRCxNQUdPO0FBQ0h3QixJQUFBQSxLQUFLLEdBQUdULFVBQVUsQ0FBQ2YsT0FBRCxDQUFsQjtBQUNBeUIsSUFBQUEsUUFBUSxHQUFHckIsR0FBRyxDQUFDdUIsUUFBSixDQUFhRixRQUFiLENBQXNCekIsT0FBdEIsQ0FBWDtBQUNIOztBQUVELE1BQUksQ0FBQ3dCLEtBQUwsRUFBWTtBQUNSLFFBQUlJLEdBQUcsR0FBRyxNQUFNdkIsTUFBTSxDQUFDd0IsSUFBUCxDQUFZSixRQUFRLENBQUNLLFFBQXJCLEVBQStCO0FBQUVDLE1BQUFBLFFBQVEsRUFBRU4sUUFBUSxDQUFDTSxRQUFyQjtBQUErQkMsTUFBQUEsUUFBUSxFQUFFUCxRQUFRLENBQUNPO0FBQWxELEtBQS9CLENBQWhCO0FBQ0FSLElBQUFBLEtBQUssR0FBR0ksR0FBRyxDQUFDSixLQUFaO0FBQ0FULElBQUFBLFVBQVUsQ0FBQ2YsT0FBRCxDQUFWLEdBQXNCd0IsS0FBdEI7QUFFQXBCLElBQUFBLEdBQUcsQ0FBQzZCLEdBQUosQ0FBUSxNQUFSLEVBQWlCLG1CQUFrQmpDLE9BQVEsSUFBM0M7QUFDSDs7QUFFREssRUFBQUEsTUFBTSxDQUFDa0IsTUFBUCxHQUFpQlcsR0FBRCxJQUFTO0FBQ3JCQSxJQUFBQSxHQUFHLENBQUNDLEdBQUosQ0FBUSxlQUFSLEVBQTBCLFVBQVNYLEtBQU0sRUFBekM7QUFDSCxHQUZEOztBQUlBLFNBQU9uQixNQUFQO0FBQ0g7O0FBQUE7QUFFRCxJQUFJK0IsU0FBSixFQUFlQyxjQUFmOztBQUVBeEMsT0FBTyxDQUFDeUMsU0FBUixHQUFvQixDQUFDQyxJQUFELEVBQU9DLElBQVAsRUFBYTtBQUFFQyxFQUFBQSxNQUFNLEVBQUVDLFFBQVY7QUFBb0JDLEVBQUFBLEtBQUssRUFBRUMsT0FBM0I7QUFBb0N4RCxFQUFBQSxXQUFwQztBQUFpRHlELEVBQUFBO0FBQWpELElBQTZELEVBQTFFLEtBQWlGO0FBQ2pHVCxFQUFBQSxTQUFTLEdBQUd2RCxJQUFJLENBQUNpRSxRQUFMLENBQWNQLElBQWQsRUFBb0IsVUFBcEIsQ0FBWjtBQUNBRixFQUFBQSxjQUFjLEdBQUdRLE9BQWpCO0FBRUEsUUFBTUUsWUFBWSxHQUFHbEUsSUFBSSxDQUFDbUUsT0FBTCxDQUFhLG9CQUFiLENBQXJCO0FBRUEsTUFBSUMsR0FBSjs7QUFFQSxNQUFJbEUsRUFBRSxDQUFDbUUsVUFBSCxDQUFjSCxZQUFkLENBQUosRUFBaUM7QUFDN0IsVUFBTUksUUFBUSxHQUFHdkUsT0FBTyxDQUFDbUUsWUFBRCxDQUF4Qjs7QUFDQSxVQUFNSyxJQUFJLEdBQUcsSUFBSUMsR0FBSixDQUFRRixRQUFRLENBQUNDLElBQWpCLENBQWI7O0FBRUEsUUFBSUEsSUFBSSxDQUFDRSxHQUFMLENBQVNsQixTQUFULENBQUosRUFBeUI7QUFDckJhLE1BQUFBLEdBQUcsR0FBRyxNQUFOO0FBQ0gsS0FGRCxNQUVPO0FBQ0gsVUFBSSxDQUFDbkUsQ0FBQyxDQUFDeUUsT0FBRixDQUFVSixRQUFRLENBQUNDLElBQW5CLENBQUwsRUFBK0I7QUFDM0JJLFFBQUFBLE9BQU8sQ0FBQ3ZCLEdBQVIsQ0FBYSxVQUFTRyxTQUFVLFlBQWhDO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsY0FBTXFCLElBQUksR0FBRyxJQUFJSixHQUFKLENBQVFGLFFBQVEsQ0FBQ00sSUFBakIsQ0FBYjs7QUFDQSxZQUFJQSxJQUFJLENBQUNILEdBQUwsQ0FBU2xCLFNBQVQsQ0FBSixFQUF5QjtBQUNyQmEsVUFBQUEsR0FBRyxHQUFHLE1BQU47QUFDQU8sVUFBQUEsT0FBTyxDQUFDdkIsR0FBUixDQUFhLFVBQVNHLFNBQVUsWUFBaEM7QUFDSDtBQUNKO0FBQ0o7QUFDSjs7QUFFRCxHQUFDYSxHQUFHLEdBQUdTLFFBQVEsQ0FBQ1QsR0FBRCxDQUFYLEdBQW1CUyxRQUF2QixFQUFpQ3RCLFNBQWpDLEVBQTRDLFlBQVk7QUFDcEQsUUFBSTNELE9BQU8sQ0FBQ0MsR0FBUixDQUFZaUYsVUFBWixJQUEwQmpCLFFBQTlCLEVBQXdDO0FBQ3BDRCxNQUFBQSxNQUFNLENBQUMsWUFBWTtBQUNmLFlBQUloRSxPQUFPLENBQUNDLEdBQVIsQ0FBWWlGLFVBQWhCLEVBQTRCO0FBQ3pCekUsVUFBQUEsU0FBUyxHQUFHLE1BQU1DLGNBQWMsQ0FBQ0MsV0FBRCxDQUFoQztBQUNGOztBQUVELFlBQUlzRCxRQUFKLEVBQWM7QUFDVixnQkFBTUEsUUFBUSxFQUFkO0FBQ0g7QUFDSixPQVJLLENBQU47QUFTSDs7QUFFRCxRQUFJakUsT0FBTyxDQUFDQyxHQUFSLENBQVlpRixVQUFaLElBQTBCZixPQUExQixJQUFxQ25FLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFyRCxFQUFpRTtBQUM3RGdFLE1BQUFBLEtBQUssQ0FBQyxZQUFZO0FBQ2RhLFFBQUFBLE9BQU8sQ0FBQ3ZCLEdBQVI7O0FBRUEsWUFBSS9DLFNBQVMsSUFBSUEsU0FBUyxDQUFDSyxPQUEzQixFQUFvQztBQUNqQyxnQkFBTUwsU0FBUyxDQUFDMEUsS0FBVixFQUFOO0FBQ0ExRSxVQUFBQSxTQUFTLEdBQUcyRSxTQUFaO0FBQ0Y7O0FBRUQsWUFBSWpCLE9BQUosRUFBYTtBQUNULGdCQUFNQSxPQUFPLEVBQWI7QUFDSDs7QUFFRCxZQUFJbkUsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCbUYsVUFBQUEsU0FBUyxDQUFDckYsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQVosQ0FBdUJvRixNQUF2QixHQUFnQyxDQUFoQyxHQUFvQ3RGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFoRCxHQUE2RCxJQUE5RCxDQUFUO0FBQ0g7QUFDSixPQWZJLENBQUw7QUFnQkg7O0FBRUQ2RCxJQUFBQSxJQUFJO0FBQ1AsR0FqQ0Q7QUFrQ0gsQ0E3REQ7O0FBK0RBLFNBQVN3QixRQUFULENBQWtCQyxLQUFsQixFQUF5QnpCLElBQXpCLEVBQStCMEIsSUFBL0IsRUFBcUM7QUFDakNDLEVBQUFBLEVBQUUsQ0FBQ0YsS0FBRCxFQUFRLGtCQUFrQjtBQUN4QixVQUFNO0FBQUVHLE1BQUFBO0FBQUYsUUFBYXhGLE9BQU8sQ0FBQyxzQkFBRCxDQUExQjs7QUFFQSxRQUFJd0YsTUFBSixFQUFZO0FBQ1IsVUFBSUYsSUFBSixFQUFVO0FBQ04sY0FBTTtBQUFFRyxVQUFBQSxXQUFGO0FBQWVDLFVBQUFBLElBQWY7QUFBcUJDLFVBQUFBLE9BQXJCO0FBQThCQyxVQUFBQSxLQUE5QjtBQUFxQ0MsVUFBQUEsR0FBckM7QUFBMENDLFVBQUFBLE1BQTFDO0FBQWtEQyxVQUFBQTtBQUFsRCxZQUErRFQsSUFBSSxDQUFDRSxNQUExRTtBQUlBQyxRQUFBQSxXQUFXLElBQUlELE1BQU0sQ0FBQ0MsV0FBUCxDQUFtQkEsV0FBbkIsQ0FBZjtBQUNBQyxRQUFBQSxJQUFJLElBQUlGLE1BQU0sQ0FBQ0UsSUFBUCxDQUFZQSxJQUFaLENBQVI7QUFDQUMsUUFBQUEsT0FBTyxJQUFJSCxNQUFNLENBQUNHLE9BQVAsQ0FBZUEsT0FBZixDQUFYO0FBQ0FDLFFBQUFBLEtBQUssSUFBSUosTUFBTSxDQUFDSSxLQUFQLENBQWFBLEtBQWIsQ0FBVDtBQUNBQyxRQUFBQSxHQUFHLElBQUlMLE1BQU0sQ0FBQ0ssR0FBUCxDQUFXQSxHQUFYLENBQVA7QUFDQUUsUUFBQUEsUUFBUSxJQUFJUCxNQUFNLENBQUNPLFFBQVAsQ0FBZ0JBLFFBQWhCLENBQVo7QUFFQTdGLFFBQUFBLENBQUMsQ0FBQ3lFLE9BQUYsQ0FBVW1CLE1BQVYsS0FBc0I1RixDQUFDLENBQUM4RixNQUFGLENBQVNGLE1BQVQsRUFBaUIsQ0FBQ0csSUFBRCxFQUFPQyxHQUFQLEtBQWU7QUFDbERWLFVBQUFBLE1BQU0sQ0FBQ1csS0FBUCxDQUFhRCxHQUFiLEVBQWtCRCxJQUFsQjtBQUNILFNBRnFCLENBQXRCO0FBR0g7O0FBRURULE1BQUFBLE1BQU0sQ0FBQ0gsS0FBUCxDQUFhQSxLQUFiO0FBQ0FHLE1BQUFBLE1BQU0sQ0FBQ1ksVUFBUCxDQUFtQixTQUFRZixLQUFNLEVBQWpDLEVBQW9DLE1BQU0sQ0FBRSxDQUE1Qzs7QUFFQSxVQUFJQyxJQUFJLElBQUlBLElBQUksQ0FBQ2UsTUFBakIsRUFBeUI7QUFDckJuRyxRQUFBQSxDQUFDLENBQUM4RixNQUFGLENBQVNWLElBQUksQ0FBQ2UsTUFBZCxFQUFzQixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUM1QixjQUFJLE9BQU9ELENBQVAsS0FBYSxRQUFqQixFQUEyQjtBQUN2QmQsWUFBQUEsTUFBTSxDQUFDZ0IsU0FBUCxDQUFpQkQsQ0FBakIsRUFBb0Isa0JBQXBCO0FBQ0E3RCxZQUFBQSxZQUFZLENBQUUsU0FBUTZELENBQUUsR0FBWixFQUFnQkQsQ0FBaEIsQ0FBWjtBQUNILFdBSEQsTUFHTztBQUNIZCxZQUFBQSxNQUFNLENBQUNnQixTQUFQLENBQWlCRCxDQUFqQixFQUFvQkQsQ0FBcEI7QUFDSDtBQUNKLFNBUEQ7QUFRSDtBQUNKOztBQUVELFVBQU0xQyxJQUFJLENBQUMwQixJQUFELENBQVY7QUFDSCxHQXJDQyxDQUFGO0FBc0NIOztBQUVEckUsT0FBTyxDQUFDbUUsUUFBUixHQUFtQkEsUUFBbkI7O0FBRUFuRSxPQUFPLENBQUN3RixvQkFBUixHQUErQixDQUFDcEIsS0FBRCxFQUFRekIsSUFBUixLQUFpQjtBQUM1QyxRQUFNOEMsQ0FBQyxHQUFHekcsSUFBSSxDQUFDbUUsT0FBTCxDQUFjLGlCQUFnQlosU0FBVSxLQUF4QyxDQUFWOztBQUNBLFFBQU1tRCxTQUFTLEdBQUczRyxPQUFPLENBQUMwRyxDQUFELENBQXpCOztBQUNBLE1BQUksQ0FBQ0MsU0FBTCxFQUFnQixNQUFNLElBQUlDLEtBQUosQ0FBVyxnQ0FBK0JwRCxTQUFVLEVBQXBELENBQU47QUFFaEIsUUFBTTtBQUFFcUQsSUFBQUEsS0FBRjtBQUFTLE9BQUdDO0FBQVosTUFBdUJILFNBQTdCO0FBRUEsUUFBTUksU0FBUyxHQUFHRixLQUFLLElBQUlBLEtBQUssQ0FBQ3hCLEtBQUQsQ0FBaEM7QUFDQSxNQUFJLENBQUMwQixTQUFMLEVBQWdCLE1BQU0sSUFBSUgsS0FBSixDQUFXLGdDQUErQnBELFNBQVUsWUFBVzZCLEtBQU0sRUFBckUsQ0FBTjs7QUFFaEJuRixFQUFBQSxDQUFDLENBQUM4RyxTQUFGLENBQVlELFNBQVosRUFBdUJFLE9BQXZCLENBQStCLENBQUNDLFFBQUQsRUFBV0MsQ0FBWCxLQUFpQjtBQUM1QyxVQUFNQyxZQUFZLEdBQUc7QUFDakI1QixNQUFBQSxNQUFNLEVBQUVzQixNQURTO0FBRWpCVCxNQUFBQSxNQUFNLEVBQUVuRyxDQUFDLENBQUNtSCxTQUFGLENBQVlILFFBQVEsQ0FBQ2IsTUFBckIsRUFBOEJDLENBQUQsSUFBTztBQUN4QyxZQUFJLE9BQU9BLENBQVAsS0FBYSxVQUFqQixFQUE2QixPQUFPQSxDQUFDLEVBQVI7QUFDN0IsZUFBT0EsQ0FBUDtBQUNILE9BSE8sQ0FGUztBQU1qQmdCLE1BQUFBLFFBQVEsRUFBRUosUUFBUSxDQUFDSTtBQU5GLEtBQXJCO0FBU0FsQyxJQUFBQSxRQUFRLENBQUUsR0FBRUMsS0FBTSxJQUFHOEIsQ0FBQyxHQUFDLENBQUUsRUFBakIsRUFBb0J2RCxJQUFwQixFQUEwQndELFlBQTFCLENBQVI7QUFDSCxHQVhEO0FBWUgsQ0F0QkQ7O0FBd0JBLFNBQVMxRSxZQUFULENBQXNCdkIsSUFBdEIsRUFBNEJvRyxHQUE1QixFQUFpQztBQUM3QixRQUFNO0FBQUUvQixJQUFBQTtBQUFGLE1BQWF4RixPQUFPLENBQUMsc0JBQUQsQ0FBMUI7O0FBQ0EsTUFBSSxDQUFDd0YsTUFBTCxFQUFhO0FBRWIsTUFBSWdDLElBQUksR0FBRyxZQUFYO0FBQUEsTUFBeUJDLE9BQU8sR0FBR0YsR0FBbkM7O0FBRUEsTUFBSSxPQUFPQSxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDekJFLElBQUFBLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEIsQ0FBMUIsQ0FBVjtBQUNBQyxJQUFBQSxJQUFJLEdBQUcsa0JBQVA7QUFDSDs7QUFFRGhDLEVBQUFBLE1BQU0sQ0FBQ29DLGdCQUFQLENBQXdCekcsSUFBeEIsRUFBOEJzRyxPQUE5QixFQUF1Q0QsSUFBdkM7QUFDSDs7QUFFRHZHLE9BQU8sQ0FBQ3lCLFlBQVIsR0FBdUJBLFlBQXZCOztBQUVBekIsT0FBTyxDQUFDNEcsUUFBUixHQUFtQixPQUFPQyxJQUFQLEVBQWFsRSxJQUFiLEtBQXNCO0FBQ3JDLFFBQU07QUFBRTRCLElBQUFBO0FBQUYsTUFBYXhGLE9BQU8sQ0FBQyxzQkFBRCxDQUExQjs7QUFDQSxNQUFJd0YsTUFBSixFQUFZO0FBQ1JBLElBQUFBLE1BQU0sQ0FBQ1ksVUFBUCxDQUFrQjBCLElBQWxCLEVBQXdCLE1BQU0sQ0FBRSxDQUFoQztBQUNIOztBQUVELE1BQUlyRSxjQUFKLEVBQW9CO0FBQ2hCbUIsSUFBQUEsT0FBTyxDQUFDdkIsR0FBUixDQUFZLFFBQVosRUFBc0J5RSxJQUF0QjtBQUNIOztBQUVELFFBQU1sRSxJQUFJLEVBQVY7QUFDSCxDQVhEIiwic291cmNlc0NvbnRlbnQiOlsiaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICByZXF1aXJlKCcuL2FzeW5jRHVtcCcpO1xufVxuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5cbmxldCB3ZWJTZXJ2ZXI7XG5cbi8qKlxuICogXG4gKiBAcGFyYW0geyp9IHNlcnZlckVudHJ5IC0gU2VydmVyIGVudHJ5IGZpbGUgcGF0aCAocmVsYXRpdmUgdG8gdGVzdCB3b3JraW5nIHBhdGgpXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0V2ViU2VydmVyKHNlcnZlckVudHJ5KSB7XG4gICAgY29uc3QgY3JlYXRlV2ViU2VydmVyID0gcmVxdWlyZShzZXJ2ZXJFbnRyeSB8fCAnLi4vLi4vc3JjL2luZGV4LmpzJyk7XG4gICAgd2ViU2VydmVyID0gY3JlYXRlV2ViU2VydmVyKHtcbiAgICAgICAgZXhpdE9uVW5jYXVnaHQ6IGZhbHNlXG4gICAgfSk7XG4gICAgd2ViU2VydmVyLnN0YXJ0ZWQgPT0gbnVsbCB8fCB3ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQubm90LmJlLm9rKCk7XG4gICAgXG4gICAgYXdhaXQgd2ViU2VydmVyLnN0YXJ0XygpO1xuXG4gICAgd2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLmJlLm9rKCk7XG5cbiAgICByZXR1cm4gd2ViU2VydmVyO1xufTtcblxuLyoqXG4gKiBSdW4gYSB0ZXN0IGZ1bmN0aW9uIGluIGEgd29ya2VyXG4gKiBAcGFyYW0geyp9IHRlc3RUb1J1biBcbiAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAqL1xuZXhwb3J0cy5zdGFydFJlc3RDbGllbnQgPSBhc3luYyAobmFtZSwgdXNlclRhZywgdGVzdFRvUnVuLCBvcHRpb25zKSA9PiB7XG4gICAgbGV0IGVycjtcblxuICAgIGF3YWl0IHN0YXJ0V29ya2VyKGFzeW5jIChhcHApID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgZ2V0UmVzdENsaWVudChhcHAsIG5hbWUsIHVzZXJUYWcpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGVzdFRvUnVuKGFwcCwgY2xpZW50KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICB9LCB7XG4gICAgICAgIHdvcmtlck5hbWU6IFwidGVzdGVyXCIsICAgICAgICBcbiAgICAgICAgY29uZmlnTmFtZTogXCJ0ZXN0XCIsXG4gICAgICAgIGNvbmZpZ1BhdGg6IFwiLi90ZXN0L2NvbmZcIixcbiAgICAgICAgYXBwTW9kdWxlc1BhdGg6IFwiYXBwX21vZHVsZXNcIixcbiAgICAgICAgaWdub3JlVW5jYXVnaHQ6IHRydWUsXG4gICAgICAgIC4uLm9wdGlvbnNcbiAgICB9KTtcblxuICAgIGlmIChlcnIpIHtcbiAgICAgICAgc2hvdWxkLm5vdC5leGlzdChlcnIsIGVyci5tZXNzYWdlIHx8IGVycik7XG4gICAgfSAgICBcbn07XG5cbmNvbnN0IHRva2VuQ2FjaGUgPSB7fTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVzdENsaWVudChhcHAsIG5hbWUsIHVzZXJUYWcpIHtcbiAgICBjb25zdCBjbGllbnQgPSBhcHAuZ2V0U2VydmljZSh3ZWJTZXJ2ZXIgPyBgc3VwZXJUZXN0LiR7bmFtZX1gIDogYHJlc3RDbGllbnQuJHtuYW1lfWApO1xuICAgIGlmICh3ZWJTZXJ2ZXIpIHtcbiAgICAgICAgY2xpZW50LnNlcnZlciA9IHdlYlNlcnZlci5odHRwU2VydmVyO1xuICAgIH1cblxuICAgIGlmICghY2xpZW50Lm9uU2VudCkge1xuICAgICAgICBjbGllbnQub25TZW50ID0gKHVybCwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBhdHRhY2hPYmplY3QodXJsLCByZXN1bHQpO1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGlmICghdXNlclRhZykge1xuICAgICAgICBkZWxldGUgY2xpZW50Lm9uU2VuZDsgXG4gICAgICAgIHJldHVybiBjbGllbnQ7XG4gICAgfSAgICBcblxuICAgIGxldCB0b2tlbiwgdXNlckF1dGg7XG5cbiAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHVzZXJUYWcpKSB7XG4gICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnLnVzZXJUYWddO1xuICAgICAgICB1c2VyQXV0aCA9IHVzZXJUYWc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdG9rZW4gPSB0b2tlbkNhY2hlW3VzZXJUYWddO1xuICAgICAgICB1c2VyQXV0aCA9IGFwcC5zZXR0aW5ncy51c2VyQXV0aFt1c2VyVGFnXTtcbiAgICB9XG5cbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgIGxldCByZXMgPSBhd2FpdCBjbGllbnQucG9zdCh1c2VyQXV0aC5lbmRwb2ludCwgeyB1c2VybmFtZTogdXNlckF1dGgudXNlcm5hbWUsIHBhc3N3b3JkOiB1c2VyQXV0aC5wYXNzd29yZCB9KTtcbiAgICAgICAgdG9rZW4gPSByZXMudG9rZW47XG4gICAgICAgIHRva2VuQ2FjaGVbdXNlclRhZ10gPSB0b2tlbjsgICAgICAgIFxuXG4gICAgICAgIGFwcC5sb2coJ2luZm8nLCBgTG9nZ2VkIGluIHdpdGggWyR7dXNlclRhZ31dLmApO1xuICAgIH1cblxuICAgIGNsaWVudC5vblNlbmQgPSAocmVxKSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICByZXEuc2V0KCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke3Rva2VufWApO1xuICAgIH1cblxuICAgIHJldHVybiBjbGllbnQ7XG59O1xuXG5sZXQgc3VpdGVOYW1lLCB2ZXJib3NlRW5hYmxlZDtcblxuZXhwb3J0cy50ZXN0U3VpdGUgPSAoZmlsZSwgYm9keSwgeyBiZWZvcmU6IG9uQmVmb3JlLCBhZnRlcjogb25BZnRlciwgc2VydmVyRW50cnksIHZlcmJvc2UgfSA9IHt9KSA9PiB7XG4gICAgc3VpdGVOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLnNwZWMuanMnKTtcbiAgICB2ZXJib3NlRW5hYmxlZCA9IHZlcmJvc2U7XG5cbiAgICBjb25zdCB0ZXN0T3B0c0ZpbGUgPSBwYXRoLnJlc29sdmUoJ3Rlc3QvdGVzdC5sb2NhbC5qcycpO1xuXG4gICAgbGV0IG9wdDsgICAgXG5cbiAgICBpZiAoZnMuZXhpc3RzU3luYyh0ZXN0T3B0c0ZpbGUpKSB7XG4gICAgICAgIGNvbnN0IHRlc3RPcHRzID0gcmVxdWlyZSh0ZXN0T3B0c0ZpbGUpOyAgICAgICAgXG4gICAgICAgIGNvbnN0IG9ubHkgPSBuZXcgU2V0KHRlc3RPcHRzLm9ubHkpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKG9ubHkuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgIG9wdCA9ICdvbmx5JzsgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHRlc3RPcHRzLm9ubHkpKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdWl0ZSBcIiR7c3VpdGVOYW1lfVwiIHNraXBwZWQuYCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNraXAgPSBuZXcgU2V0KHRlc3RPcHRzLnNraXApO1xuICAgICAgICAgICAgICAgIGlmIChza2lwLmhhcyhzdWl0ZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9ICdza2lwJztcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0gICAgICAgIFxuICAgIH1cblxuICAgIChvcHQgPyBkZXNjcmliZVtvcHRdIDogZGVzY3JpYmUpKHN1aXRlTmFtZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSB8fCBvbkJlZm9yZSkge1xuICAgICAgICAgICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSkge1xuICAgICAgICAgICAgICAgICAgIHdlYlNlcnZlciA9IGF3YWl0IHN0YXJ0V2ViU2VydmVyKHNlcnZlckVudHJ5KTtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICBcbiAgICAgICAgICAgICAgICBpZiAob25CZWZvcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb25CZWZvcmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTsgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5DT1ZFUl9NT0RFIHx8IG9uQWZ0ZXIgfHwgcHJvY2Vzcy5lbnYuQVNZTkNfRFVNUCkge1xuICAgICAgICAgICAgYWZ0ZXIoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2ViU2VydmVyICYmIHdlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgICAgYXdhaXQgd2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICAgICAgICAgd2ViU2VydmVyID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgIFxuICAgICAgICAgICAgICAgIGlmIChvbkFmdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgICAgICAgICAgICAgICAgIGFzeW5jRHVtcChwcm9jZXNzLmVudi5BU1lOQ19EVU1QLmxlbmd0aCA+IDEgPyBwcm9jZXNzLmVudi5BU1lOQ19EVU1QIDogbnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7ICAgXG4gICAgICAgIH1cblxuICAgICAgICBib2R5KCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RDYXNlKHN0b3J5LCBib2R5LCBkYXRhKSB7XG4gICAgaXQoc3RvcnksIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgeyBhbGx1cmUgfSA9IHJlcXVpcmUoJ2FsbHVyZS1tb2NoYS9ydW50aW1lJyk7XG5cbiAgICAgICAgaWYgKGFsbHVyZSkge1xuICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGRlc2NyaXB0aW9uLCBlcGljLCBmZWF0dXJlLCBvd25lciwgdGFnLCBpc3N1ZXMsIHNldmVyaXR5IH0gPSBkYXRhLmFsbHVyZTtcblxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coZGF0YS5hbGx1cmUpO1xuXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gJiYgYWxsdXJlLmRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgIGZlYXR1cmUgJiYgYWxsdXJlLmZlYXR1cmUoZmVhdHVyZSk7XG4gICAgICAgICAgICAgICAgb3duZXIgJiYgYWxsdXJlLm93bmVyKG93bmVyKTtcbiAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgIHNldmVyaXR5ICYmIGFsbHVyZS5zZXZlcml0eShzZXZlcml0eSk7XG5cbiAgICAgICAgICAgICAgICBfLmlzRW1wdHkoaXNzdWVzKSB8fCAoXy5mb3JPd24oaXNzdWVzLCAobGluaywgbnVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFsbHVyZS5pc3N1ZShudW0sIGxpbmspO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG4gICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChgc3RhcnQgJHtzdG9yeX1gLCAoKSA9PiB7fSkoKTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCAnKnNlZSBhdHRhY2htZW50KicpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGF0dGFjaE9iamVjdChgcGFyYW1bJHtrfV1gLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgdik7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0cy50ZXN0Q2FzZSA9IHRlc3RDYXNlO1xuXG5leHBvcnRzLnRlc3RDYXNlRnJvbUZpeHR1cmVzID0gKHN0b3J5LCBib2R5KSA9PiB7XG4gICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3N1aXRlTmFtZX0uanNgKTtcbiAgICBjb25zdCBzdWl0ZURhdGEgPSByZXF1aXJlKHApO1xuICAgIGlmICghc3VpdGVEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN1aXRlIGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHtzdWl0ZU5hbWV9YCk7XG5cbiAgICBjb25zdCB7IGNhc2VzLCAuLi5vdGhlcnMgfSA9IHN1aXRlRGF0YTsgICAgXG5cbiAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07ICAgXG4gICAgaWYgKCFzdG9yeURhdGEpIHRocm93IG5ldyBFcnJvcihgU3RvcnkgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3N1aXRlTmFtZX0sIHN0b3J5OiAke3N0b3J5fWApO1xuXG4gICAgXy5jYXN0QXJyYXkoc3RvcnlEYXRhKS5mb3JFYWNoKChjYXNlRGF0YSwgaSkgPT4ge1xuICAgICAgICBjb25zdCBwcmVwYXJlZERhdGEgPSB7XG4gICAgICAgICAgICBhbGx1cmU6IG90aGVycyxcbiAgICAgICAgICAgIHBhcmFtczogXy5tYXBWYWx1ZXMoY2FzZURhdGEucGFyYW1zLCAodikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHYoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgZXhwZWN0ZWQ6IGNhc2VEYXRhLmV4cGVjdGVkXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRlc3RDYXNlKGAke3N0b3J5fSMke2krMX1gLCBib2R5LCBwcmVwYXJlZERhdGEpOyBcbiAgICB9KTsgICAgXG59XG5cbmZ1bmN0aW9uIGF0dGFjaE9iamVjdChuYW1lLCBvYmopIHtcbiAgICBjb25zdCB7IGFsbHVyZSB9ID0gcmVxdWlyZSgnYWxsdXJlLW1vY2hhL3J1bnRpbWUnKTtcbiAgICBpZiAoIWFsbHVyZSkgcmV0dXJuO1xuXG4gICAgbGV0IHR5cGUgPSAncGxhaW4vdGV4dCcsIGNvbnRlbnQgPSBvYmo7XG5cbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgIHR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgfVxuXG4gICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG59XG5cbmV4cG9ydHMuYXR0YWNoT2JqZWN0ID0gYXR0YWNoT2JqZWN0O1xuXG5leHBvcnRzLnRlc3RTdGVwID0gYXN5bmMgKHN0ZXAsIGJvZHkpID0+IHtcbiAgICBjb25zdCB7IGFsbHVyZSB9ID0gcmVxdWlyZSgnYWxsdXJlLW1vY2hhL3J1bnRpbWUnKTtcbiAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IHt9KSgpO1xuICAgIH1cblxuICAgIGlmICh2ZXJib3NlRW5hYmxlZCkge1xuICAgICAgICBjb25zb2xlLmxvZygnU3RlcDogJywgc3RlcCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9keSgpO1xufSJdfQ==