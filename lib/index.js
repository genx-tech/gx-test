"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require('./asyncDump');
}

const path = require('path');

const {
  _,
  fs
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

let webServer, allure;

async function startWebServer(serverEntry) {
  const createWebServer = require(serverEntry || '../../src/index.js');

  webServer = createWebServer({
    exitOnUncaught: false
  });
  webServer.started == null || webServer.started.should.not.be.ok();
  await webServer.start_();
  webServer.started.should.be.ok();
  return webServer;
}

;

exports.startRestClient = async (name, userTag, testToRun, options) => {
  let err;
  await startWorker(async app => {
    const client = await getRestClient(app, name, userTag);

    try {
      await testToRun(app, client);
    } catch (e) {
      err = e;
    }
  }, {
    workerName: "tester",
    configName: "test",
    configPath: "./test/conf",
    appModulesPath: "app_modules",
    ignoreUncaught: true,
    ...options
  });

  if (err) {
    should.not.exist(err, err.message || err);
  }
};

const tokenCache = {};

async function getRestClient(app, name, userTag) {
  const client = app.getService(webServer ? `superTest.${name}` : `restClient.${name}`);

  if (webServer) {
    client.server = webServer.httpServer;
  }

  if (!client.onSent) {
    client.onSent = (url, result) => {
      attachObject(url, result);
    };
  }

  if (!userTag) {
    delete client.onSend;
    return client;
  }

  let token, userAuth;

  if (_.isPlainObject(userTag)) {
    token = tokenCache[userTag.userTag];
    userAuth = userTag;
  } else {
    token = tokenCache[userTag];
    userAuth = app.settings.userAuth[userTag];
  }

  if (!token) {
    let res = await client.post(userAuth.endpoint, {
      username: userAuth.username,
      password: userAuth.password
    });
    token = res.token;
    tokenCache[userTag] = token;
    app.log('info', `Logged in with [${userTag}].`);
  }

  client.onSend = req => {
    req.set('Authorization', `Bearer ${token}`);
  };

  return client;
}

;
let suiteName, verboseEnabled;

exports.testSuite = (file, body, {
  before: onBefore,
  after: onAfter,
  serverEntry,
  verbose
} = {}) => {
  suiteName = path.basename(file, '.spec.js');
  verboseEnabled = verbose;
  const testOptsFile = path.resolve('test/test.local.js');
  let opt;

  if (fs.existsSync(testOptsFile)) {
    const testOpts = require(testOptsFile);

    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = 'only';
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = 'skip';
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      const allureMocha = require('allure-mocha/runtime');

      allure = allureMocha.allure;

      if (verboseEnabled) {
        console.log('Starting suite:', suiteName);
      }

      if (process.env.COVER_MODE) {
        webServer = await startWebServer(serverEntry);
      }

      if (onBefore) {
        await onBefore();
      }
    });
    after(async () => {
      if (webServer && webServer.started) {
        await webServer.stop_();
        webServer = undefined;
      }

      if (onAfter) {
        await onAfter();
      }

      if (verboseEnabled) {
        console.log('Finished suite:', suiteName);
      }

      console.log();

      if (process.env.ASYNC_DUMP) {
        asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
      }
    });
    body();
  });
};

function testCase(story, body, data) {
  it(story, async function () {
    if (verboseEnabled) {
      console.log('Starting story:', story);
    }

    if (allure) {
      if (data) {
        const {
          description,
          epic,
          feature,
          owner,
          tag,
          issues,
          severity
        } = data.allure;
        description && allure.description(description);
        epic && allure.epic(epic);
        feature && allure.feature(feature);
        owner && allure.owner(owner);
        tag && allure.tag(tag);
        severity && allure.severity(severity);
        _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
          allure.issue(num, link);
        });
      }

      allure.story(story);
      allure.createStep(`start ${story}`, () => {})();

      if (data && data.params) {
        _.forOwn(data.params, (v, k) => {
          if (typeof v === 'object') {
            allure.parameter(k, '*see attachment*');
            attachObject(`param[${k}]`, v);
          } else {
            allure.parameter(k, v);
          }
        });
      }
    }

    await body(data);
  });
}

exports.testCase = testCase;

exports.testCaseFromFixtures = (story, body) => {
  const p = path.resolve(`test/fixtures/${suiteName}.js`);

  const suiteData = require(p);

  if (!suiteData) throw new Error(`Suite data not found. Suite: ${suiteName}`);
  const {
    cases,
    ...others
  } = suiteData;
  const storyData = cases && cases[story];
  if (!storyData) throw new Error(`Story data not found. Suite: ${suiteName}, story: ${story}`);

  _.castArray(storyData).forEach((caseData, i) => {
    const preparedData = {
      allure: others,
      params: _.mapValues(caseData.params, v => {
        if (typeof v === 'function') return v();
        return v;
      }),
      expected: caseData.expected
    };
    testCase(`${story}#${i + 1}`, body, preparedData);
  });
};

function attachObject(name, obj) {
  if (!allure) return;
  let type = 'plain/text',
      content = obj;

  if (typeof obj !== 'string') {
    content = JSON.stringify(obj, null, 4);
    type = 'application/json';
  }

  allure.createAttachment(name, content, type);
}

exports.attachObject = attachObject;

exports.testStep = async (step, body) => {
  if (allure) {
    allure.createStep(step, () => {})();
  }

  if (verboseEnabled) {
    console.log('Step: ', step);
  }

  await body();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3RhcnRlcnMiLCJzdGFydFdvcmtlciIsIndlYlNlcnZlciIsImFsbHVyZSIsInN0YXJ0V2ViU2VydmVyIiwic2VydmVyRW50cnkiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwiZXhwb3J0cyIsInN0YXJ0UmVzdENsaWVudCIsIm5hbWUiLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsImdldFJlc3RDbGllbnQiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInRva2VuQ2FjaGUiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsImF0dGFjaE9iamVjdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibG9nIiwicmVxIiwic2V0Iiwic3VpdGVOYW1lIiwidmVyYm9zZUVuYWJsZWQiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsImJlZm9yZSIsIm9uQmVmb3JlIiwiYWZ0ZXIiLCJvbkFmdGVyIiwidmVyYm9zZSIsImJhc2VuYW1lIiwidGVzdE9wdHNGaWxlIiwicmVzb2x2ZSIsIm9wdCIsImV4aXN0c1N5bmMiLCJ0ZXN0T3B0cyIsIm9ubHkiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsInNraXAiLCJkZXNjcmliZSIsImFsbHVyZU1vY2hhIiwiQ09WRVJfTU9ERSIsInN0b3BfIiwidW5kZWZpbmVkIiwiYXN5bmNEdW1wIiwibGVuZ3RoIiwidGVzdENhc2UiLCJzdG9yeSIsImRhdGEiLCJpdCIsImRlc2NyaXB0aW9uIiwiZXBpYyIsImZlYXR1cmUiLCJvd25lciIsInRhZyIsImlzc3VlcyIsInNldmVyaXR5IiwiZm9yT3duIiwibGluayIsIm51bSIsImlzc3VlIiwiY3JlYXRlU3RlcCIsInBhcmFtcyIsInYiLCJrIiwicGFyYW1ldGVyIiwidGVzdENhc2VGcm9tRml4dHVyZXMiLCJwIiwic3VpdGVEYXRhIiwiRXJyb3IiLCJjYXNlcyIsIm90aGVycyIsInN0b3J5RGF0YSIsImNhc3RBcnJheSIsImZvckVhY2giLCJjYXNlRGF0YSIsImkiLCJwcmVwYXJlZERhdGEiLCJtYXBWYWx1ZXMiLCJleHBlY3RlZCIsIm9iaiIsInR5cGUiLCJjb250ZW50IiwiSlNPTiIsInN0cmluZ2lmeSIsImNyZWF0ZUF0dGFjaG1lbnQiLCJ0ZXN0U3RlcCIsInN0ZXAiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxJQUFJQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsVUFBaEIsRUFBNEI7QUFDeEJDLEVBQUFBLE9BQU8sQ0FBQyxhQUFELENBQVA7QUFDSDs7QUFFRCxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILE9BQU8sQ0FBQyxVQUFELENBQXpCOztBQUNBLE1BQU07QUFBRUksRUFBQUEsUUFBUSxFQUFFO0FBQUVDLElBQUFBO0FBQUY7QUFBWixJQUFnQ0wsT0FBTyxDQUFDLFdBQUQsQ0FBN0M7O0FBRUEsSUFBSU0sU0FBSixFQUFlQyxNQUFmOztBQU1BLGVBQWVDLGNBQWYsQ0FBOEJDLFdBQTlCLEVBQTJDO0FBQ3ZDLFFBQU1DLGVBQWUsR0FBR1YsT0FBTyxDQUFDUyxXQUFXLElBQUksb0JBQWhCLENBQS9COztBQUNBSCxFQUFBQSxTQUFTLEdB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QUFDOEYsVUFBUCxDQUFrQjBCLElBQWxCLEVBQXdCLE1BQU0sQ0FBRSxDQUFoQztBQUNIOztBQUVELE1BQUlyRSxjQUFKLEVBQW9CO0FBQ2hCbUIsSUFBQUEsT0FBTyxDQUFDdkIsR0FBUixDQUFZLFFBQVosRUFBc0J5RSxJQUF0QjtBQUNIOztBQUVELFFBQU1sRSxJQUFJLEVBQVY7QUFDSCxDQVZEIiwic291cmNlc0NvbnRlbnQiOlsiaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICByZXF1aXJlKCcuL2FzeW5jRHVtcCcpO1xufVxuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgU3RhcnRlcnM6IHsgc3RhcnRXb3JrZXIgfSB9ID0gcmVxdWlyZSgnQGdlbngvYXBwJyk7XG5cbmxldCB3ZWJTZXJ2ZXIsIGFsbHVyZTtcblxuLyoqXG4gKiBcbiAqIEBwYXJhbSB7Kn0gc2VydmVyRW50cnkgLSBTZXJ2ZXIgZW50cnkgZmlsZSBwYXRoIChyZWxhdGl2ZSB0byB0ZXN0IHdvcmtpbmcgcGF0aClcbiAqL1xuYXN5bmMgZnVuY3Rpb24gc3RhcnRXZWJTZXJ2ZXIoc2VydmVyRW50cnkpIHtcbiAgICBjb25zdCBjcmVhdGVXZWJTZXJ2ZXIgPSByZXF1aXJlKHNlcnZlckVudHJ5IHx8ICcuLi8uLi9zcmMvaW5kZXguanMnKTtcbiAgICB3ZWJTZXJ2ZXIgPSBjcmVhdGVXZWJTZXJ2ZXIoe1xuICAgICAgICBleGl0T25VbmNhdWdodDogZmFsc2VcbiAgICB9KTtcbiAgICB3ZWJTZXJ2ZXIuc3RhcnRlZCA9PSBudWxsIHx8IHdlYlNlcnZlci5zdGFydGVkLnNob3VsZC5ub3QuYmUub2soKTtcbiAgICBcbiAgICBhd2FpdCB3ZWJTZXJ2ZXIuc3RhcnRfKCk7XG5cbiAgICB3ZWJTZXJ2ZXIuc3RhcnRlZC5zaG91bGQuYmUub2soKTtcblxuICAgIHJldHVybiB3ZWJTZXJ2ZXI7XG59O1xuXG4vKipcbiAqIFJ1biBhIHRlc3QgZnVuY3Rpb24gaW4gYSB3b3JrZXJcbiAqIEBwYXJhbSB7Kn0gdGVzdFRvUnVuIFxuICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICovXG5leHBvcnRzLnN0YXJ0UmVzdENsaWVudCA9IGFzeW5jIChuYW1lLCB1c2VyVGFnLCB0ZXN0VG9SdW4sIG9wdGlvbnMpID0+IHtcbiAgICBsZXQgZXJyO1xuXG4gICAgYXdhaXQgc3RhcnRXb3JrZXIoYXN5bmMgKGFwcCkgPT4ge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBhd2FpdCBnZXRSZXN0Q2xpZW50KGFwcCwgbmFtZSwgdXNlclRhZyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0ZXN0VG9SdW4oYXBwLCBjbGllbnQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgIH0sIHtcbiAgICAgICAgd29ya2VyTmFtZTogXCJ0ZXN0ZXJcIiwgICAgICAgIFxuICAgICAgICBjb25maWdOYW1lOiBcInRlc3RcIixcbiAgICAgICAgY29uZmlnUGF0aDogXCIuL3Rlc3QvY29uZlwiLFxuICAgICAgICBhcHBNb2R1bGVzUGF0aDogXCJhcHBfbW9kdWxlc1wiLFxuICAgICAgICBpZ25vcmVVbmNhdWdodDogdHJ1ZSxcbiAgICAgICAgLi4ub3B0aW9uc1xuICAgIH0pO1xuXG4gICAgaWYgKGVycikge1xuICAgICAgICBzaG91bGQubm90LmV4aXN0KGVyciwgZXJyLm1lc3NhZ2UgfHwgZXJyKTtcbiAgICB9ICAgIFxufTtcblxuY29uc3QgdG9rZW5DYWNoZSA9IHt9O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRSZXN0Q2xpZW50KGFwcCwgbmFtZSwgdXNlclRhZykge1xuICAgIGNvbnN0IGNsaWVudCA9IGFwcC5nZXRTZXJ2aWNlKHdlYlNlcnZlciA/IGBzdXBlclRlc3QuJHtuYW1lfWAgOiBgcmVzdENsaWVudC4ke25hbWV9YCk7XG4gICAgaWYgKHdlYlNlcnZlcikge1xuICAgICAgICBjbGllbnQuc2VydmVyID0gd2ViU2VydmVyLmh0dHBTZXJ2ZXI7XG4gICAgfVxuXG4gICAgaWYgKCFjbGllbnQub25TZW50KSB7XG4gICAgICAgIGNsaWVudC5vblNlbnQgPSAodXJsLCByZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGF0dGFjaE9iamVjdCh1cmwsIHJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKCF1c2VyVGFnKSB7XG4gICAgICAgIGRlbGV0ZSBjbGllbnQub25TZW5kOyBcbiAgICAgICAgcmV0dXJuIGNsaWVudDtcbiAgICB9ICAgIFxuXG4gICAgbGV0IHRva2VuLCB1c2VyQXV0aDtcblxuICAgIGlmIChfLmlzUGxhaW5PYmplY3QodXNlclRhZykpIHtcbiAgICAgICAgdG9rZW4gPSB0b2tlbkNhY2hlW3VzZXJUYWcudXNlclRhZ107XG4gICAgICAgIHVzZXJBdXRoID0gdXNlclRhZztcbiAgICB9IGVsc2Uge1xuICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZ107XG4gICAgICAgIHVzZXJBdXRoID0gYXBwLnNldHRpbmdzLnVzZXJBdXRoW3VzZXJUYWddO1xuICAgIH1cblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGNsaWVudC5wb3N0KHVzZXJBdXRoLmVuZHBvaW50LCB7IHVzZXJuYW1lOiB1c2VyQXV0aC51c2VybmFtZSwgcGFzc3dvcmQ6IHVzZXJBdXRoLnBhc3N3b3JkIH0pO1xuICAgICAgICB0b2tlbiA9IHJlcy50b2tlbjtcbiAgICAgICAgdG9rZW5DYWNoZVt1c2VyVGFnXSA9IHRva2VuOyAgICAgICAgXG5cbiAgICAgICAgYXBwLmxvZygnaW5mbycsIGBMb2dnZWQgaW4gd2l0aCBbJHt1c2VyVGFnfV0uYCk7XG4gICAgfVxuXG4gICAgY2xpZW50Lm9uU2VuZCA9IChyZXEpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgIHJlcS5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7dG9rZW59YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNsaWVudDtcbn07XG5cbmxldCBzdWl0ZU5hbWUsIHZlcmJvc2VFbmFibGVkO1xuXG5leHBvcnRzLnRlc3RTdWl0ZSA9IChmaWxlLCBib2R5LCB7IGJlZm9yZTogb25CZWZvcmUsIGFmdGVyOiBvbkFmdGVyLCBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSB9ID0ge30pID0+IHtcbiAgICBzdWl0ZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGUsICcuc3BlYy5qcycpO1xuICAgIHZlcmJvc2VFbmFibGVkID0gdmVyYm9zZTtcblxuICAgIGNvbnN0IHRlc3RPcHRzRmlsZSA9IHBhdGgucmVzb2x2ZSgndGVzdC90ZXN0LmxvY2FsLmpzJyk7XG5cbiAgICBsZXQgb3B0OyAgICBcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHRlc3RPcHRzRmlsZSkpIHtcbiAgICAgICAgY29uc3QgdGVzdE9wdHMgPSByZXF1aXJlKHRlc3RPcHRzRmlsZSk7ICAgICAgICBcbiAgICAgICAgY29uc3Qgb25seSA9IG5ldyBTZXQodGVzdE9wdHMub25seSk7ICAgICAgICBcblxuICAgICAgICBpZiAob25seS5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgb3B0ID0gJ29ubHknOyAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkodGVzdE9wdHMub25seSkpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2tpcCA9IG5ldyBTZXQodGVzdE9wdHMuc2tpcCk7XG4gICAgICAgICAgICAgICAgaWYgKHNraXAuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gJ3NraXAnO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSAgICAgICAgXG4gICAgfVxuXG4gICAgKG9wdCA/IGRlc2NyaWJlW29wdF0gOiBkZXNjcmliZSkoc3VpdGVOYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhbGx1cmVNb2NoYSA9IHJlcXVpcmUoJ2FsbHVyZS1tb2NoYS9ydW50aW1lJyk7ICAgICAgICAgICAgXG4gICAgICAgICAgICBhbGx1cmUgPSBhbGx1cmVNb2NoYS5hbGx1cmU7XG5cbiAgICAgICAgICAgIGlmICh2ZXJib3NlRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTdGFydGluZyBzdWl0ZTonLCBzdWl0ZU5hbWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuQ09WRVJfTU9ERSkge1xuICAgICAgICAgICAgICAgd2ViU2VydmVyID0gYXdhaXQgc3RhcnRXZWJTZXJ2ZXIoc2VydmVyRW50cnkpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAob25CZWZvcmUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvbkJlZm9yZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICBcblxuICAgICAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBpZiAod2ViU2VydmVyICYmIHdlYlNlcnZlci5zdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgd2ViU2VydmVyLnN0b3BfKCk7XG4gICAgICAgICAgICAgICAgd2ViU2VydmVyID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAob25BZnRlcikge1xuICAgICAgICAgICAgICAgIGF3YWl0IG9uQWZ0ZXIoKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodmVyYm9zZUVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRmluaXNoZWQgc3VpdGU6Jywgc3VpdGVOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgICAgICAgICAgICAgYXN5bmNEdW1wKHByb2Nlc3MuZW52LkFTWU5DX0RVTVAubGVuZ3RoID4gMSA/IHByb2Nlc3MuZW52LkFTWU5DX0RVTVAgOiBudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7IFxuXG4gICAgICAgIGJvZHkoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gdGVzdENhc2Uoc3RvcnksIGJvZHksIGRhdGEpIHtcbiAgICBpdChzdG9yeSwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodmVyYm9zZUVuYWJsZWQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTdGFydGluZyBzdG9yeTonLCBzdG9yeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgZGVzY3JpcHRpb24sIGVwaWMsIGZlYXR1cmUsIG93bmVyLCB0YWcsIGlzc3Vlcywgc2V2ZXJpdHkgfSA9IGRhdGEuYWxsdXJlO1xuXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gJiYgYWxsdXJlLmRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICBlcGljICYmIGFsbHVyZS5lcGljKGVwaWMpO1xuICAgICAgICAgICAgICAgIGZlYXR1cmUgJiYgYWxsdXJlLmZlYXR1cmUoZmVhdHVyZSk7XG4gICAgICAgICAgICAgICAgb3duZXIgJiYgYWxsdXJlLm93bmVyKG93bmVyKTtcbiAgICAgICAgICAgICAgICB0YWcgJiYgYWxsdXJlLnRhZyh0YWcpO1xuICAgICAgICAgICAgICAgIHNldmVyaXR5ICYmIGFsbHVyZS5zZXZlcml0eShzZXZlcml0eSk7XG5cbiAgICAgICAgICAgICAgICBfLmlzRW1wdHkoaXNzdWVzKSB8fCAoXy5mb3JPd24oaXNzdWVzLCAobGluaywgbnVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFsbHVyZS5pc3N1ZShudW0sIGxpbmspO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGFsbHVyZS5zdG9yeShzdG9yeSk7XG4gICAgICAgICAgICBhbGx1cmUuY3JlYXRlU3RlcChgc3RhcnQgJHtzdG9yeX1gLCAoKSA9PiB7fSkoKTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihkYXRhLnBhcmFtcywgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCAnKnNlZSBhdHRhY2htZW50KicpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGF0dGFjaE9iamVjdChgcGFyYW1bJHtrfV1gLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbHVyZS5wYXJhbWV0ZXIoaywgdik7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgYm9keShkYXRhKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0cy50ZXN0Q2FzZSA9IHRlc3RDYXNlO1xuXG5leHBvcnRzLnRlc3RDYXNlRnJvbUZpeHR1cmVzID0gKHN0b3J5LCBib2R5KSA9PiB7XG4gICAgY29uc3QgcCA9IHBhdGgucmVzb2x2ZShgdGVzdC9maXh0dXJlcy8ke3N1aXRlTmFtZX0uanNgKTtcbiAgICBjb25zdCBzdWl0ZURhdGEgPSByZXF1aXJlKHApO1xuICAgIGlmICghc3VpdGVEYXRhKSB0aHJvdyBuZXcgRXJyb3IoYFN1aXRlIGRhdGEgbm90IGZvdW5kLiBTdWl0ZTogJHtzdWl0ZU5hbWV9YCk7XG5cbiAgICBjb25zdCB7IGNhc2VzLCAuLi5vdGhlcnMgfSA9IHN1aXRlRGF0YTsgICAgXG5cbiAgICBjb25zdCBzdG9yeURhdGEgPSBjYXNlcyAmJiBjYXNlc1tzdG9yeV07ICAgXG4gICAgaWYgKCFzdG9yeURhdGEpIHRocm93IG5ldyBFcnJvcihgU3RvcnkgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3N1aXRlTmFtZX0sIHN0b3J5OiAke3N0b3J5fWApO1xuXG4gICAgXy5jYXN0QXJyYXkoc3RvcnlEYXRhKS5mb3JFYWNoKChjYXNlRGF0YSwgaSkgPT4ge1xuICAgICAgICBjb25zdCBwcmVwYXJlZERhdGEgPSB7XG4gICAgICAgICAgICBhbGx1cmU6IG90aGVycyxcbiAgICAgICAgICAgIHBhcmFtczogXy5tYXBWYWx1ZXMoY2FzZURhdGEucGFyYW1zLCAodikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHYoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdjtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgZXhwZWN0ZWQ6IGNhc2VEYXRhLmV4cGVjdGVkXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRlc3RDYXNlKGAke3N0b3J5fSMke2krMX1gLCBib2R5LCBwcmVwYXJlZERhdGEpOyBcbiAgICB9KTsgICAgXG59XG5cbmZ1bmN0aW9uIGF0dGFjaE9iamVjdChuYW1lLCBvYmopIHtcbiAgICBpZiAoIWFsbHVyZSkgcmV0dXJuO1xuXG4gICAgbGV0IHR5cGUgPSAncGxhaW4vdGV4dCcsIGNvbnRlbnQgPSBvYmo7XG5cbiAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KG9iaiwgbnVsbCwgNCk7XG4gICAgICAgIHR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgfVxuXG4gICAgYWxsdXJlLmNyZWF0ZUF0dGFjaG1lbnQobmFtZSwgY29udGVudCwgdHlwZSk7XG59XG5cbmV4cG9ydHMuYXR0YWNoT2JqZWN0ID0gYXR0YWNoT2JqZWN0O1xuXG5leHBvcnRzLnRlc3RTdGVwID0gYXN5bmMgKHN0ZXAsIGJvZHkpID0+IHsgICAgXG4gICAgaWYgKGFsbHVyZSkgeyAgICAgICAgXG4gICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKHN0ZXAsICgpID0+IHt9KSgpO1xuICAgIH1cblxuICAgIGlmICh2ZXJib3NlRW5hYmxlZCkge1xuICAgICAgICBjb25zb2xlLmxvZygnU3RlcDogJywgc3RlcCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9keSgpO1xufSJdfQ==