"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require('./asyncDump');
}

const path = require('path');

const {
  _,
  fs
} = require('rk-utils');

const {
  Starters: {
    startWorker
  }
} = require('@genx/app');

let webServer;

async function startWebServer(serverEntry) {
  const createWebServer = require(serverEntry || '../../src/index.js');

  webServer = createWebServer({
    exitOnUncaught: false
  });
  webServer.started == null || webServer.started.should.not.be.ok();
  await webServer.start_();
  webServer.started.should.be.ok();
  return webServer;
}

;

exports.startRestClient = async (name, userTag, testToRun, options) => {
  let err;
  await startWorker(async app => {
    const client = await getRestClient(app, name, userTag);

    try {
      await testToRun(app, client);
    } catch (e) {
      err = e;
    }
  }, {
    workerName: "tester",
    configName: "test",
    configPath: "./test/conf",
    appModulesPath: "app_modules",
    ignoreUncaught: true,
    ...options
  });

  if (err) {
    should.not.exist(err, err.message || err);
  }
};

const tokenCache = {};

async function getRestClient(app, name, userTag) {
  const client = app.getService(webServer ? `superTest.${name}` : `restClient.${name}`);

  if (webServer) {
    client.server = webServer.httpServer;
  }

  if (!client.onSent) {
    client.onSent = (url, result) => {
      attachObject(url, result);
    };
  }

  if (!userTag) {
    delete client.onSend;
    return client;
  }

  let token, userAuth;

  if (_.isPlainObject(userTag)) {
    token = tokenCache[userTag.userTag];
    userAuth = userTag;
  } else {
    token = tokenCache[userTag];
    userAuth = app.settings.userAuth[userTag];
  }

  if (!token) {
    let res = await client.post(userAuth.endpoint, {
      username: userAuth.username,
      password: userAuth.password
    });
    token = res.token;
    tokenCache[userTag] = token;
    app.log('info', `Logged in with [${userTag}].`);
  }

  client.onSend = req => {
    req.set('Authorization', `Bearer ${token}`);
  };

  return client;
}

;
let suiteName;

exports.testSuite = (file, body, {
  before: onBefore,
  after: onAfter,
  serverEntry
} = {}) => {
  suiteName = path.basename(file, '.spec.js');
  const testOptsFile = path.resolve('test/test.local.js');
  let opt;

  if (fs.existsSync(testOptsFile)) {
    const testOpts = require(testOptsFile);

    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = 'only';
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = 'skip';
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    if (process.env.COVER_MODE || onBefore) {
      before(async () => {
        if (process.env.COVER_MODE) {
          webServer = await startWebServer(serverEntry);
        }

        if (onBefore) {
          await onBefore();
        }
      });
    }

    if (process.env.COVER_MODE || onAfter || process.env.ASYNC_DUMP) {
      after(async () => {
        console.log();

        if (webServer && webServer.started) {
          await webServer.stop_();
          webServer = undefined;
        }

        if (onAfter) {
          await onAfter();
        }

        if (process.env.ASYNC_DUMP) {
          asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
        }
      });
    }

    body();
  });
};

function testCase(story, body, data) {
  it(story, async function () {
    const {
      allure
    } = require('allure-mocha/runtime');

    if (allure) {
      if (data) {
        const {
          description,
          epic,
          feature,
          owner,
          tag,
          issues,
          severity
        } = data.allure;
        description && allure.description(description);
        epic && allure.epic(epic);
        feature && allure.feature(feature);
        owner && allure.owner(owner);
        tag && allure.tag(tag);
        severity && allure.severity(severity);
        _.isEmpty(issues) || _.forOwn(issues, (link, num) => {
          allure.issue(num, link);
        });
      }

      allure.story(story);
      allure.createStep(`start ${story}`, () => {})();

      if (data && data.params) {
        _.forOwn(data.params, (v, k) => {
          if (typeof v === 'object') {
            allure.parameter(k, '*see attachment*');
            attachObject(`param[${k}]`, v);
          } else {
            allure.parameter(k, v);
          }
        });
      }
    }

    await body(data);
  });
}

exports.testCase = testCase;

exports.testCaseFromFixtures = (story, body) => {
  const p = path.resolve(`test/fixtures/${suiteName}.js`);

  const suiteData = require(p);

  if (!suiteData) throw new Error(`Suite data not found. Suite: ${suiteName}`);
  const {
    cases,
    ...others
  } = suiteData;
  const storyData = cases && cases[story];
  if (!storyData) throw new Error(`Story data not found. Suite: ${suiteName}, story: ${story}`);

  _.castArray(storyData).forEach((caseData, i) => {
    const preparedData = {
      allure: others,
      params: _.mapValues(caseData.params, v => {
        if (typeof v === 'function') return v();
        return v;
      }),
      expected: caseData.expected
    };
    testCase(`${story}#${i + 1}`, body, preparedData);
  });
};

function attachObject(name, obj) {
  const {
    allure
  } = require('allure-mocha/runtime');

  if (!allure) return;
  let type = 'plain/text',
      content = obj;

  if (typeof obj !== 'string') {
    content = JSON.stringify(obj, null, 4);
    type = 'application/json';
  }

  allure.createAttachment(name, content, type);
}

exports.attachObject = attachObject;

exports.testStep = async (step, body) => {
  const {
    allure
  } = require('allure-mocha/runtime');

  if (allure) {
    allure.createStep(step, () => {})();
  }

  await body();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3RhcnRlcnMiLCJzdGFydFdvcmtlciIsIndlYlNlcnZlciIsInN0YXJ0V2ViU2VydmVyIiwic2VydmVyRW50cnkiLCJjcmVhdGVXZWJTZXJ2ZXIiLCJleGl0T25VbmNhdWdodCIsInN0YXJ0ZWQiLCJzaG91bGQiLCJub3QiLCJiZSIsIm9rIiwic3RhcnRfIiwiZXhwb3J0cyIsInN0YXJ0UmVzdENsaWVudCIsIm5hbWUiLCJ1c2VyVGFnIiwidGVzdFRvUnVuIiwib3B0aW9ucyIsImVyciIsImFwcCIsImNsaWVudCIsImdldFJlc3RDbGllbnQiLCJlIiwid29ya2VyTmFtZSIsImNvbmZpZ05hbWUiLCJjb25maWdQYXRoIiwiYXBwTW9kdWxlc1BhdGgiLCJpZ25vcmVVbmNhdWdodCIsImV4aXN0IiwibWVzc2FnZSIsInRva2VuQ2FjaGUiLCJnZXRTZXJ2aWNlIiwic2VydmVyIiwiaHR0cFNlcnZlciIsIm9uU2VudCIsInVybCIsInJlc3VsdCIsImF0dGFjaE9iamVjdCIsIm9uU2VuZCIsInRva2VuIiwidXNlckF1dGgiLCJpc1BsYWluT2JqZWN0Iiwic2V0dGluZ3MiLCJyZXMiLCJwb3N0IiwiZW5kcG9pbnQiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwibG9nIiwicmVxIiwic2V0Iiwic3VpdGVOYW1lIiwidGVzdFN1aXRlIiwiZmlsZSIsImJvZHkiLCJiZWZvcmUiLCJvbkJlZm9yZSIsImFmdGVyIiwib25BZnRlciIsImJhc2VuYW1lIiwidGVzdE9wdHNGaWxlIiwicmVzb2x2ZSIsIm9wdCIsImV4aXN0c1N5bmMiLCJ0ZXN0T3B0cyIsIm9ubHkiLCJTZXQiLCJoYXMiLCJpc0VtcHR5IiwiY29uc29sZSIsInNraXAiLCJkZXNjcmliZSIsIkNPVkVSX01PREUiLCJzdG9wXyIsInVuZGVmaW5lZCIsImFzeW5jRHVtcCIsImxlbmd0aCIsInRlc3RDYXNlIiwic3RvcnkiLCJkYXRhIiwiaXQiLCJhbGx1cmUiLCJkZXNjcmlwdGlvbiIsImVwaWMiLCJmZWF0dXJlIiwib3duZXIiLCJ0YWciLCJpc3N1ZXMiLCJzZXZlcml0eSIsImZvck93biIsImxpbmsiLCJudW0iLCJpc3N1ZSIsImNyZWF0ZVN0ZXAiLCJwYXJhbXMiLCJ2IiwiayIsInBhcmFtZXRlciIsInRlc3RDYXNlRnJvbUZpeHR1cmVzIiwicCIsInN1aXRlRGF0YSIsIkVycm9yIiwiY2FzZXMiLCJvdGhlcnMiLCJzdG9yeURhdGEiLCJjYXN0QXJyYXkiLCJmb3JFYWNoIiwiY2FzZURhdGEiLCJpIiwicHJlcGFyZWREYXRhIiwibWFwVmFsdWVzIiwiZXhwZWN0ZWQiLCJvYmoiLCJ0eXBlIiwiY29udGVudCIsIkpTT04iLCJzdHJpbmdpZnkiLCJjcmVhdGVBdHRhY2htZW50IiwidGVzdFN0ZXAiLCJzdGVwIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBSUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCQyxFQUFBQSxPQUFPLENBQUMsYUFBRCxDQUFQO0FBQ0g7O0FBRUQsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxPQUFPLENBQUMsVUFBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBLFFBQVEsRUFBRTtBQUFFQyxJQUFBQTtBQUFGO0FBQVosSUFBZ0NMLE9BQU8sQ0FBQyxXQUFELENBQTdDOztBQUVBLElBQUlNLFNBQUo7O0FBTUEsZUFBZUMsY0FBZixDQUE4QkMsV0FBOUIsRUFBMkM7QUFDdkMsUUFBTUMsZUFBZSxHQUFHVCxPQUFPLENBQUNRLFdBQVcsSUFBSSxvQkFBaEIsQ0FBL0I7O0FBQ0FGLEVBQUFBLFNBQVMsR0FBR0csZUFBZSxDQUFDO0FBQ3hCQyxJQUFBQSxjQUFjLEVBQUU7QUFEUSxHQUFELENBQTNC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XG4gICAgcmVxdWlyZSgnLi9hc3luY0R1bXAnKTtcbn1cblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFN0YXJ0ZXJzOiB7IHN0YXJ0V29ya2VyIH0gfSA9IHJlcXVpcmUoJ0BnZW54L2FwcCcpO1xuXG5sZXQgd2ViU2VydmVyO1xuXG4vKipcbiAqIFxuICogQHBhcmFtIHsqfSBzZXJ2ZXJFbnRyeSAtIFNlcnZlciBlbnRyeSBmaWxlIHBhdGggKHJlbGF0aXZlIHRvIHRlc3Qgd29ya2luZyBwYXRoKVxuICovXG5hc3luYyBmdW5jdGlvbiBzdGFydFdlYlNlcnZlcihzZXJ2ZXJFbnRyeSkge1xuICAgIGNvbnN0IGNyZWF0ZVdlYlNlcnZlciA9IHJlcXVpcmUoc2VydmVyRW50cnkgfHwgJy4uLy4uL3NyYy9pbmRleC5qcycpO1xuICAgIHdlYlNlcnZlciA9IGNyZWF0ZVdlYlNlcnZlcih7XG4gICAgICAgIGV4aXRPblVuY2F1Z2h0OiBmYWxzZVxuICAgIH0pO1xuICAgIHdlYlNlcnZlci5zdGFydGVkID09IG51bGwgfHwgd2ViU2VydmVyLnN0YXJ0ZWQuc2hvdWxkLm5vdC5iZS5vaygpO1xuICAgIFxuICAgIGF3YWl0IHdlYlNlcnZlci5zdGFydF8oKTtcblxuICAgIHdlYlNlcnZlci5zdGFydGVkLnNob3VsZC5iZS5vaygpO1xuXG4gICAgcmV0dXJuIHdlYlNlcnZlcjtcbn07XG5cbi8qKlxuICogUnVuIGEgdGVzdCBmdW5jdGlvbiBpbiBhIHdvcmtlclxuICogQHBhcmFtIHsqfSB0ZXN0VG9SdW4gXG4gKiBAcmV0dXJucyB7UHJvbWlzZS48Kj59XG4gKi9cbmV4cG9ydHMuc3RhcnRSZXN0Q2xpZW50ID0gYXN5bmMgKG5hbWUsIHVzZXJUYWcsIHRlc3RUb1J1biwgb3B0aW9ucykgPT4ge1xuICAgIGxldCBlcnI7XG5cbiAgICBhd2FpdCBzdGFydFdvcmtlcihhc3luYyAoYXBwKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IGdldFJlc3RDbGllbnQoYXBwLCBuYW1lLCB1c2VyVGFnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRlc3RUb1J1bihhcHAsIGNsaWVudCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGVyciA9IGU7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfSwge1xuICAgICAgICB3b3JrZXJOYW1lOiBcInRlc3RlclwiLCAgICAgICAgXG4gICAgICAgIGNvbmZpZ05hbWU6IFwidGVzdFwiLFxuICAgICAgICBjb25maWdQYXRoOiBcIi4vdGVzdC9jb25mXCIsXG4gICAgICAgIGFwcE1vZHVsZXNQYXRoOiBcImFwcF9tb2R1bGVzXCIsXG4gICAgICAgIGlnbm9yZVVuY2F1Z2h0OiB0cnVlLFxuICAgICAgICAuLi5vcHRpb25zXG4gICAgfSk7XG5cbiAgICBpZiAoZXJyKSB7XG4gICAgICAgIHNob3VsZC5ub3QuZXhpc3QoZXJyLCBlcnIubWVzc2FnZSB8fCBlcnIpO1xuICAgIH0gICAgXG59O1xuXG5jb25zdCB0b2tlbkNhY2hlID0ge307XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlc3RDbGllbnQoYXBwLCBuYW1lLCB1c2VyVGFnKSB7XG4gICAgY29uc3QgY2xpZW50ID0gYXBwLmdldFNlcnZpY2Uod2ViU2VydmVyID8gYHN1cGVyVGVzdC4ke25hbWV9YCA6IGByZXN0Q2xpZW50LiR7bmFtZX1gKTtcbiAgICBpZiAod2ViU2VydmVyKSB7XG4gICAgICAgIGNsaWVudC5zZXJ2ZXIgPSB3ZWJTZXJ2ZXIuaHR0cFNlcnZlcjtcbiAgICB9XG5cbiAgICBpZiAoIWNsaWVudC5vblNlbnQpIHtcbiAgICAgICAgY2xpZW50Lm9uU2VudCA9ICh1cmwsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgYXR0YWNoT2JqZWN0KHVybCwgcmVzdWx0KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIXVzZXJUYWcpIHtcbiAgICAgICAgZGVsZXRlIGNsaWVudC5vblNlbmQ7IFxuICAgICAgICByZXR1cm4gY2xpZW50O1xuICAgIH0gICAgXG5cbiAgICBsZXQgdG9rZW4sIHVzZXJBdXRoO1xuXG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdCh1c2VyVGFnKSkge1xuICAgICAgICB0b2tlbiA9IHRva2VuQ2FjaGVbdXNlclRhZy51c2VyVGFnXTtcbiAgICAgICAgdXNlckF1dGggPSB1c2VyVGFnO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRva2VuID0gdG9rZW5DYWNoZVt1c2VyVGFnXTtcbiAgICAgICAgdXNlckF1dGggPSBhcHAuc2V0dGluZ3MudXNlckF1dGhbdXNlclRhZ107XG4gICAgfVxuXG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgY2xpZW50LnBvc3QodXNlckF1dGguZW5kcG9pbnQsIHsgdXNlcm5hbWU6IHVzZXJBdXRoLnVzZXJuYW1lLCBwYXNzd29yZDogdXNlckF1dGgucGFzc3dvcmQgfSk7XG4gICAgICAgIHRva2VuID0gcmVzLnRva2VuO1xuICAgICAgICB0b2tlbkNhY2hlW3VzZXJUYWddID0gdG9rZW47ICAgICAgICBcblxuICAgICAgICBhcHAubG9nKCdpbmZvJywgYExvZ2dlZCBpbiB3aXRoIFske3VzZXJUYWd9XS5gKTtcbiAgICB9XG5cbiAgICBjbGllbnQub25TZW5kID0gKHJlcSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgcmVxLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHt0b2tlbn1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xpZW50O1xufTtcblxubGV0IHN1aXRlTmFtZTtcblxuZXhwb3J0cy50ZXN0U3VpdGUgPSAoZmlsZSwgYm9keSwgeyBiZWZvcmU6IG9uQmVmb3JlLCBhZnRlcjogb25BZnRlciwgc2VydmVyRW50cnkgfSA9IHt9KSA9PiB7XG4gICAgc3VpdGVOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCAnLnNwZWMuanMnKTtcblxuICAgIGNvbnN0IHRlc3RPcHRzRmlsZSA9IHBhdGgucmVzb2x2ZSgndGVzdC90ZXN0LmxvY2FsLmpzJyk7XG5cbiAgICBsZXQgb3B0OyAgICBcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHRlc3RPcHRzRmlsZSkpIHtcbiAgICAgICAgY29uc3QgdGVzdE9wdHMgPSByZXF1aXJlKHRlc3RPcHRzRmlsZSk7ICAgICAgICBcbiAgICAgICAgY29uc3Qgb25seSA9IG5ldyBTZXQodGVzdE9wdHMub25seSk7ICAgICAgICBcblxuICAgICAgICBpZiAob25seS5oYXMoc3VpdGVOYW1lKSkge1xuICAgICAgICAgICAgb3B0ID0gJ29ubHknOyAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkodGVzdE9wdHMub25seSkpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2tpcCA9IG5ldyBTZXQodGVzdE9wdHMuc2tpcCk7XG4gICAgICAgICAgICAgICAgaWYgKHNraXAuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gJ3NraXAnO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU3VpdGUgXCIke3N1aXRlTmFtZX1cIiBza2lwcGVkLmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSAgICAgICAgXG4gICAgfVxuXG4gICAgKG9wdCA/IGRlc2NyaWJlW29wdF0gOiBkZXNjcmliZSkoc3VpdGVOYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5DT1ZFUl9NT0RFIHx8IG9uQmVmb3JlKSB7XG4gICAgICAgICAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5DT1ZFUl9NT0RFKSB7XG4gICAgICAgICAgICAgICAgICAgd2ViU2VydmVyID0gYXdhaXQgc3RhcnRXZWJTZXJ2ZXIoc2VydmVyRW50cnkpO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgIFxuICAgICAgICAgICAgICAgIGlmIChvbkJlZm9yZSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBvbkJlZm9yZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pOyAgIFxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52LkNPVkVSX01PREUgfHwgb25BZnRlciB8fCBwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgICAgICAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcblxuICAgICAgICAgICAgICAgIGlmICh3ZWJTZXJ2ZXIgJiYgd2ViU2VydmVyLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICBhd2FpdCB3ZWJTZXJ2ZXIuc3RvcF8oKTtcbiAgICAgICAgICAgICAgICAgICB3ZWJTZXJ2ZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgXG4gICAgICAgICAgICAgICAgaWYgKG9uQWZ0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb25BZnRlcigpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFTWU5DX0RVTVApIHtcbiAgICAgICAgICAgICAgICAgICAgYXN5bmNEdW1wKHByb2Nlc3MuZW52LkFTWU5DX0RVTVAubGVuZ3RoID4gMSA/IHByb2Nlc3MuZW52LkFTWU5DX0RVTVAgOiBudWxsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTsgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGJvZHkoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gdGVzdENhc2Uoc3RvcnksIGJvZHksIGRhdGEpIHtcbiAgICBpdChzdG9yeSwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zdCB7IGFsbHVyZSB9ID0gcmVxdWlyZSgnYWxsdXJlLW1vY2hhL3J1bnRpbWUnKTtcblxuICAgICAgICBpZiAoYWxsdXJlKSB7XG4gICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgZGVzY3JpcHRpb24sIGVwaWMsIGZlYXR1cmUsIG93bmVyLCB0YWcsIGlzc3Vlcywgc2V2ZXJpdHkgfSA9IGRhdGEuYWxsdXJlO1xuXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhkYXRhLmFsbHVyZSk7XG5cbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiAmJiBhbGx1cmUuZGVzY3JpcHRpb24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgIGVwaWMgJiYgYWxsdXJlLmVwaWMoZXBpYyk7XG4gICAgICAgICAgICAgICAgZmVhdHVyZSAmJiBhbGx1cmUuZmVhdHVyZShmZWF0dXJlKTtcbiAgICAgICAgICAgICAgICBvd25lciAmJiBhbGx1cmUub3duZXIob3duZXIpO1xuICAgICAgICAgICAgICAgIHRhZyAmJiBhbGx1cmUudGFnKHRhZyk7XG4gICAgICAgICAgICAgICAgc2V2ZXJpdHkgJiYgYWxsdXJlLnNldmVyaXR5KHNldmVyaXR5KTtcblxuICAgICAgICAgICAgICAgIF8uaXNFbXB0eShpc3N1ZXMpIHx8IChfLmZvck93bihpc3N1ZXMsIChsaW5rLCBudW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYWxsdXJlLmlzc3VlKG51bSwgbGluayk7XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgYWxsdXJlLnN0b3J5KHN0b3J5KTtcbiAgICAgICAgICAgIGFsbHVyZS5jcmVhdGVTdGVwKGBzdGFydCAke3N0b3J5fWAsICgpID0+IHt9KSgpOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnBhcmFtcykge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGRhdGEucGFyYW1zLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGx1cmUucGFyYW1ldGVyKGssICcqc2VlIGF0dGFjaG1lbnQqJyk7ICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgYXR0YWNoT2JqZWN0KGBwYXJhbVske2t9XWAsIHYpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsdXJlLnBhcmFtZXRlcihrLCB2KTtcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBib2R5KGRhdGEpO1xuICAgIH0pO1xufVxuXG5leHBvcnRzLnRlc3RDYXNlID0gdGVzdENhc2U7XG5cbmV4cG9ydHMudGVzdENhc2VGcm9tRml4dHVyZXMgPSAoc3RvcnksIGJvZHkpID0+IHtcbiAgICBjb25zdCBwID0gcGF0aC5yZXNvbHZlKGB0ZXN0L2ZpeHR1cmVzLyR7c3VpdGVOYW1lfS5qc2ApO1xuICAgIGNvbnN0IHN1aXRlRGF0YSA9IHJlcXVpcmUocCk7XG4gICAgaWYgKCFzdWl0ZURhdGEpIHRocm93IG5ldyBFcnJvcihgU3VpdGUgZGF0YSBub3QgZm91bmQuIFN1aXRlOiAke3N1aXRlTmFtZX1gKTtcblxuICAgIGNvbnN0IHsgY2FzZXMsIC4uLm90aGVycyB9ID0gc3VpdGVEYXRhOyAgICBcblxuICAgIGNvbnN0IHN0b3J5RGF0YSA9IGNhc2VzICYmIGNhc2VzW3N0b3J5XTsgICBcbiAgICBpZiAoIXN0b3J5RGF0YSkgdGhyb3cgbmV3IEVycm9yKGBTdG9yeSBkYXRhIG5vdCBmb3VuZC4gU3VpdGU6ICR7c3VpdGVOYW1lfSwgc3Rvcnk6ICR7c3Rvcnl9YCk7XG5cbiAgICBfLmNhc3RBcnJheShzdG9yeURhdGEpLmZvckVhY2goKGNhc2VEYXRhLCBpKSA9PiB7XG4gICAgICAgIGNvbnN0IHByZXBhcmVkRGF0YSA9IHtcbiAgICAgICAgICAgIGFsbHVyZTogb3RoZXJzLFxuICAgICAgICAgICAgcGFyYW1zOiBfLm1hcFZhbHVlcyhjYXNlRGF0YS5wYXJhbXMsICh2KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdigpO1xuICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBleHBlY3RlZDogY2FzZURhdGEuZXhwZWN0ZWRcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGVzdENhc2UoYCR7c3Rvcnl9IyR7aSsxfWAsIGJvZHksIHByZXBhcmVkRGF0YSk7IFxuICAgIH0pOyAgICBcbn1cblxuZnVuY3Rpb24gYXR0YWNoT2JqZWN0KG5hbWUsIG9iaikge1xuICAgIGNvbnN0IHsgYWxsdXJlIH0gPSByZXF1aXJlKCdhbGx1cmUtbW9jaGEvcnVudGltZScpO1xuICAgIGlmICghYWxsdXJlKSByZXR1cm47XG5cbiAgICBsZXQgdHlwZSA9ICdwbGFpbi90ZXh0JywgY29udGVudCA9IG9iajtcblxuICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnc3RyaW5nJykge1xuICAgICAgICBjb250ZW50ID0gSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCA0KTtcbiAgICAgICAgdHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbiAgICB9XG5cbiAgICBhbGx1cmUuY3JlYXRlQXR0YWNobWVudChuYW1lLCBjb250ZW50LCB0eXBlKTtcbn1cblxuZXhwb3J0cy5hdHRhY2hPYmplY3QgPSBhdHRhY2hPYmplY3Q7XG5cbmV4cG9ydHMudGVzdFN0ZXAgPSBhc3luYyAoc3RlcCwgYm9keSkgPT4ge1xuICAgIGNvbnN0IHsgYWxsdXJlIH0gPSByZXF1aXJlKCdhbGx1cmUtbW9jaGEvcnVudGltZScpO1xuICAgIGlmIChhbGx1cmUpIHtcbiAgICAgICAgYWxsdXJlLmNyZWF0ZVN0ZXAoc3RlcCwgKCkgPT4ge30pKCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9keSgpO1xufSJdfQ==