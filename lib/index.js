"use strict";

require("source-map-support/register");

if (process.env.ASYNC_DUMP) {
  require("./asyncDump");
}

const path = require("path");

const {
  _
} = require("@genx/july");

const {
  fs
} = require("@genx/sys");

const Suite = require("./Suite");

function testSuite(file, body, options) {
  const {
    before: onBefore,
    after: onAfter,
    serverEntry,
    verbose,
    skip,
    only
  } = options == null ? {} : options;
  const suiteName = path.basename(file, ".spec.js");
  const testOptsFile = path.resolve("test/test.local.js");
  let testOpts;

  if (fs.existsSync(testOptsFile)) {
    testOpts = require(testOptsFile);
  }

  const suiteOptions = {
    serverEntry,
    verbose,
    ...(testOpts ? _.pick(testOpts, ['serverEntry', 'verbose']) : {})
  };
  const suite = new Suite(suiteName, suiteOptions);
  let opt;

  if (only) {
    opt = "only";
  } else if (skip) {
    opt = "skip";
  } else if (testOpts) {
    const only = new Set(testOpts.only);

    if (only.has(suiteName)) {
      opt = "only";
    } else {
      if (!_.isEmpty(testOpts.only)) {
        console.log(`Suite "${suiteName}" skipped.`);
      } else {
        const skip = new Set(testOpts.skip);

        if (skip.has(suiteName)) {
          opt = "skip";
          console.log(`Suite "${suiteName}" skipped.`);
        }
      }
    }
  }

  (opt ? describe[opt] : describe)(suiteName, function () {
    before(async () => {
      suite.initAllure();

      if (verbose) {
        console.log("Starting suite:", suiteName);
      }

      if (process.env.COVER_MODE) {
        await suite.startWebServer_();
      }

      if (onBefore) {
        await onBefore();
      }
    });
    after(async () => {
      await suite.stopWebServerIfStarted_();

      if (onAfter) {
        await onAfter();
      }

      console.log();

      if (verbose) {
        console.log("Finished suite:", suiteName);
      }

      if (process.env.ASYNC_DUMP) {
        asyncDump(process.env.ASYNC_DUMP.length > 1 ? process.env.ASYNC_DUMP : null);
      }
    });
    body(suite);
  });
}

module.exports = testSuite;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiQVNZTkNfRFVNUCIsInJlcXVpcmUiLCJwYXRoIiwiXyIsImZzIiwiU3VpdGUiLCJ0ZXN0U3VpdGUiLCJmaWxlIiwiYm9keSIsIm9wdGlvbnMiLCJiZWZvcmUiLCJvbkJlZm9yZSIsImFmdGVyIiwib25BZnRlciIsInNlcnZlckVudHJ5IiwidmVyYm9zZSIsInNraXAiLCJvbmx5Iiwic3VpdGVOYW1lIiwiYmFzZW5hbWUiLCJ0ZXN0T3B0c0ZpbGUiLCJyZXNvbHZlIiwidGVzdE9wdHMiLCJleGlzdHNTeW5jIiwic3VpdGVPcHRpb25zIiwicGljayIsInN1aXRlIiwib3B0IiwiU2V0IiwiaGFzIiwiaXNFbXB0eSIsImNvbnNvbGUiLCJsb2ciLCJkZXNjcmliZSIsImluaXRBbGx1cmUiLCJDT1ZFUl9NT0RFIiwic3RhcnRXZWJTZXJ2ZXJfIiwic3RvcFdlYlNlcnZlcklmU3RhcnRlZF8iLCJhc3luY0R1bXAiLCJsZW5ndGgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBSUEsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCQyxFQUFBQSxPQUFPLENBQUMsYUFBRCxDQUFQO0FBQ0g7O0FBRUQsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBUUYsT0FBTyxDQUFDLFlBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQVNILE9BQU8sQ0FBQyxXQUFELENBQXRCOztBQUNBLE1BQU1JLEtBQUssR0FBR0osT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBa0JBLFNBQVNLLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxJQUF6QixFQUErQkMsT0FBL0IsRUFBd0M7QUFDcEMsUUFBTTtBQUFFQyxJQUFBQSxNQUFNLEVBQUVDLFFBQVY7QUFBb0JD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akIsT0FBSixFQUFhO0FBQ1RnQixRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxpQkFBWixFQUErQmQsU0FBL0I7QUFDSDs7QUFFRCxVQUFJcEIsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQWhCLEVBQTRCO0FBQ3hCc0MsUUFBQUEsU0FBUyxDQUFDeEMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQVosQ0FBdUJ1QyxNQUF2QixHQUFnQyxDQUFoQyxHQUFvQ3pDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxVQUFoRCxHQUE2RCxJQUE5RCxDQUFUO0FBQ0g7QUFDSixLQWZJLENBQUw7QUFpQkFRLElBQUFBLElBQUksQ0FBQ2tCLEtBQUQsQ0FBSjtBQUNILEdBbkNEO0FBb0NIOztBQUVEYyxNQUFNLENBQUNDLE9BQVAsR0FBaUJuQyxTQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImlmIChwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgcmVxdWlyZShcIi4vYXN5bmNEdW1wXCIpO1xufVxuXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuY29uc3QgeyBmcyB9ID0gcmVxdWlyZShcIkBnZW54L3N5c1wiKTtcbmNvbnN0IFN1aXRlID0gcmVxdWlyZShcIi4vU3VpdGVcIik7XG5cbi8qKlxuICogVGVzdCBib2R5IHVzZWQgdG8gZGVmaW5lIHRlc3QgY2FzZXMuXG4gKiBAY2FsbGJhY2sgdGVzdFN1aXRlQm9keVxuICogQHBhcmFtIHtTdWl0ZX0gc3VpdGUgLSBUaGUgdGVzdCBzdWl0ZSBvYmplY3RcbiAqL1xuXG4vKipcbiAqIENyZWF0ZSBhIHRlc3Qgc3VpdGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gZmlsZSAtIFRoZSB0ZXN0IHNwZWMgZmlsZSBuYW1lLCBqdXN0IHVzZSBfX2ZpbGVuYW1lLlxuICogQHBhcmFtIHt0ZXN0U3VpdGVCb2R5fSBib2R5IC0gVG8gZGVmaW5lIHRlc3QgY2FzZWQgaW4gdGhpcyBjYWxsYmFjay5cbiAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc11cbiAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9wdGlvbnMuYmVmb3JlIC0gUHJlcGFyZSB3b3JrIGJlZm9yZSBhbGwgdGVzdCBjYXNlcy5cbiAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9wdGlvbnMuYWZ0ZXIgLSBDbGVhbnVwIHdvcmsgYWZ0ZXIgYWxsIHRlc3QgY2FzZXMuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuc2VydmVyRW50cnk9XCIuLi8uLi9zcmMvaW5kZXguanNcIl0gLSBUaGUgZW50cnkgZmlsZSBvZiBAZ2VueC9zZXJ2ZXIgaW5zdGFuY2UuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IG9wdGlvbnMudmVyYm9zZSAtIFZlcmJvc2UgbW9kZS5cbiAqL1xuZnVuY3Rpb24gdGVzdFN1aXRlKGZpbGUsIGJvZHksIG9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGJlZm9yZTogb25CZWZvcmUsIGFmdGVyOiBvbkFmdGVyLCBzZXJ2ZXJFbnRyeSwgdmVyYm9zZSwgc2tpcCwgb25seSB9ID0gb3B0aW9ucyA9PSBudWxsID8ge30gOiBvcHRpb25zO1xuXG4gICAgY29uc3Qgc3VpdGVOYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlLCBcIi5zcGVjLmpzXCIpO1xuICAgIGNvbnN0IHRlc3RPcHRzRmlsZSA9IHBhdGgucmVzb2x2ZShcInRlc3QvdGVzdC5sb2NhbC5qc1wiKTtcbiAgICBsZXQgdGVzdE9wdHM7XG5cbiAgICBpZiAoZnMuZXhpc3RzU3luYyh0ZXN0T3B0c0ZpbGUpKSB7XG4gICAgICAgIHRlc3RPcHRzID0gcmVxdWlyZSh0ZXN0T3B0c0ZpbGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHN1aXRlT3B0aW9ucyA9IHtcbiAgICAgICAgc2VydmVyRW50cnksXG4gICAgICAgIHZlcmJvc2UsXG4gICAgICAgIC4uLih0ZXN0T3B0cyA/IF8ucGljayh0ZXN0T3B0cywgWyAnc2VydmVyRW50cnknLCAndmVyYm9zZScgXSkgOiB7fSlcbiAgICB9O1xuXG4gICAgY29uc3Qgc3VpdGUgPSBuZXcgU3VpdGUoc3VpdGVOYW1lLCBzdWl0ZU9wdGlvbnMpO1xuXG4gICAgbGV0IG9wdDtcblxuICAgIGlmIChvbmx5KSB7XG4gICAgICAgIG9wdCA9IFwib25seVwiO1xuICAgIH0gZWxzZSBpZiAoc2tpcCkge1xuICAgICAgICBvcHQgPSBcInNraXBcIjtcbiAgICB9IGVsc2UgaWYgKHRlc3RPcHRzKSB7XG4gICAgICAgIGNvbnN0IG9ubHkgPSBuZXcgU2V0KHRlc3RPcHRzLm9ubHkpO1xuXG4gICAgICAgIGlmIChvbmx5LmhhcyhzdWl0ZU5hbWUpKSB7XG4gICAgICAgICAgICBvcHQgPSBcIm9ubHlcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHRlc3RPcHRzLm9ubHkpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFN1aXRlIFwiJHtzdWl0ZU5hbWV9XCIgc2tpcHBlZC5gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2tpcCA9IG5ldyBTZXQodGVzdE9wdHMuc2tpcCk7XG4gICAgICAgICAgICAgICAgaWYgKHNraXAuaGFzKHN1aXRlTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gXCJza2lwXCI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdWl0ZSBcIiR7c3VpdGVOYW1lfVwiIHNraXBwZWQuYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgKG9wdCA/IGRlc2NyaWJlW29wdF0gOiBkZXNjcmliZSkoc3VpdGVOYW1lLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBzdWl0ZS5pbml0QWxsdXJlKCk7XG5cbiAgICAgICAgICAgIGlmICh2ZXJib3NlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdGFydGluZyBzdWl0ZTpcIiwgc3VpdGVOYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52LkNPVkVSX01PREUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBzdWl0ZS5zdGFydFdlYlNlcnZlcl8oKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG9uQmVmb3JlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgb25CZWZvcmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYWZ0ZXIoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgc3VpdGUuc3RvcFdlYlNlcnZlcklmU3RhcnRlZF8oKTtcblxuICAgICAgICAgICAgaWYgKG9uQWZ0ZXIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvbkFmdGVyKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgICAgICBpZiAodmVyYm9zZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRmluaXNoZWQgc3VpdGU6XCIsIHN1aXRlTmFtZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5BU1lOQ19EVU1QKSB7XG4gICAgICAgICAgICAgICAgYXN5bmNEdW1wKHByb2Nlc3MuZW52LkFTWU5DX0RVTVAubGVuZ3RoID4gMSA/IHByb2Nlc3MuZW52LkFTWU5DX0RVTVAgOiBudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYm9keShzdWl0ZSk7XG4gICAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gdGVzdFN1aXRlO1xuIl19